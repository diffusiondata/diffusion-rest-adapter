Diffusion REST Adapter
# REST to Streaming Adapter

`TODO: Rename the project`

## Configuration Model

The configuration model is made of four top level sections, Active, Diffusion, Services and Truststore.

### Active

Indicates if the model is considered active.
If the model is not active the client should close itself.
It is intended to trigger an orderly shutdown of the client.

### Diffusion

The Diffusion section describes the server to connect the client to.
It contains the `host`, `port`, `secure`, `principal` and `password`.
The `host`, `port` and `secure` may not be null, they identify the server to connect to.
The `principal` and `password` can be null, they identify the client to the server.

### Services

The Services section contains a list of services.

#### Service

The Service describes a REST service to poll.
It contains the `host`, `port`, `secure`, `pollPeriod`, `topicRoot`, `endpoints` and `security`.
The `host`, `port` and `secure` indicate the location of the REST service.
The `topicRoot` is the part of the topic tree the service will be mapped to.
The `security` describes how to the HTTP client will authenticate with the service.
The `endpoints` are the endpoints to poll.

#### Endpoint

The Endpoint describes an endpoint of a REST service to poll.
It contains the `name`, `url` and `topic`.
The `url` indicates the URL of the service to poll.
The `topic` indicates the topic that should be updated with the result of the poll, this topic is relative to the
`topicRoot` of the service.

#### Security

The Security describes how to authenticate with the service.
Currently supported is `basic` which contains the `principal` and `credential` used to respond to a basic
authentication request.
Basic authentication will not be performed over an insecure connection.

### Truststore

The truststore is a string identifying the location of a keystore containing the trusted certificates of both the
Diffusion server and any REST services.
An SSLContext is constructed from this.
The string will first be resolved against the classpath to try to load the keystore as a resource.
If the keystore is not present as a resource it will try to load the keystore from the filesystem relative to the
current working directory.

## Filesystem configuration persistence

The configuration model consists of two files `rest.json` and `rest.version.json`.
The `rest.version.json` file contains a single number that describes the version of the model.
The `rest.json` file contains the configuration model serialised as JSON.
The files are parsed and generated by Jackson's JSON data binding features, all JSON processing is delegated to it.
The `rest.version.json` file is used to determine which version of the `Model` class the `rest.json` should be bound to.

### Model conversion

Once the model has been loaded it is converted to the latest implementation of the model.
Adding default values or inferring values from the previous model.
The filesystem persistence will write back changes to the model after the conversion process.

## Topic management

An update source is registered for each service.
When it becomes active a `JSON` topic will be created for each endpoint of the service.

The client will request that the topics are removed with the session for each service.

## Polling

The client polls each endpoint at the rate configured for the service.
When a response is received it is converted to a `JSON` value and published to the Diffusion topic created for the
endpoint.

## Reconfiguration

### Detecting reconfiguration

The client currently support polling a persisted model for changes.
When a change is detected it will reconfigure to use the new model.

### Applying reconfiguration

The client will perform a partial reconfiguration to update only what has changed.
On reconfiguration new components are first created and started.
Once the new components are in place the old components are stopped and removed.
The new components may be in standby until the old components are stopped.

## Building

### Running integration tests

The integration tests require a Diffusion server to run against.
They are run by the profile, `integration-test`, enabled when the environmental property `DIFFUSION_HOME` is set.
They use the `diffusion-maven-plugin` to start up and shutdown the the Diffusion server.
The `diffusion-maven-plugin` requires a system dependency to run, these `systemPath` for this dependency is relative to
the `DIFFUSION_HOME` environmental variable.

There are two categories for the integration tests, Embedded service tests and live service tests.
The embedded service tests host their own REST services embedded within the JVM process.
The live service tests use REST services generally available on the internet.
The only the embedded service tests are run by default.
To run only the live service tests enable the profile `live-services-test`.
To run both the embedded services tests and the live service tests enable the profile `all-tests`.

### Build artifact overview

#### adapter-client

The `adapter-client` module creates an executable JAR with all dependencies shaded in.
It loads the configuration model from the filesystem in the current working directory.
If the client is closed the JVM process will be terminated.

### adapter

The `adapter` module is more suitable for embedding the adapter in other applications.
It expects to be notified of changes to the model.

## Connecting to Diffusion

The session will require the `register_handler`, `modify_topic` and `update_topic` permissions to function correctly.
If the session fails to connect to Diffusion the client is closed.

### Connection loss

If the connection is lost the session will attempt to recover.
If recovery fails the client is closed.

## Polling REST services

If the initial poll of a REST endpoint fails no topic will be created for it.
If the topic does not exist with the same metadata or it cannot be created no subsequent polls will be made.
Redirection responses will be followed.

## Backup adapter clients

Multiple instances of the adapter client can be run, but only one client will poll a given REST service and update
Diffusion with the result.

Each service will either be in a `standby` or `active` state.
This state is co-ordinated with other adapter clients and control sessions using update sources on the root topic for
the service.
This state can be observed through a `ServiceListener`.
Only when the service is `active` will the client poll it and update Diffusion.
A client can have both active and standby services.

When a client with `active` services closes one client with the service in `standby` will switch to `active` and take
over.
If there is no other client configured with the service the topics associated with the service will be removed.
