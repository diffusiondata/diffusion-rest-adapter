!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.diffusion=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(){},{}],2:[function(_dereq_,module,exports){function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var length,type=typeof subject;if("number"===type)length=subject>0?subject>>>0:0;else if("string"===type)"base64"===encoding&&(subject=base64clean(subject)),length=Buffer.byteLength(subject,encoding);else{if("object"!==type||null===subject)throw new TypeError("must start with number, buffer, array or string");"Buffer"===subject.type&&isArray(subject.data)&&(subject=subject.data),length=+subject.length>0?Math.floor(+subject.length):0}if(this.length>kMaxLength)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength.toString(16)+" bytes");var buf;Buffer.TYPED_ARRAY_SUPPORT?buf=Buffer._augment(new Uint8Array(length)):(buf=this,buf.length=length,buf._isBuffer=!0);var i;if(Buffer.TYPED_ARRAY_SUPPORT&&"number"==typeof subject.byteLength)buf._set(subject);else if(isArrayish(subject))if(Buffer.isBuffer(subject))for(i=0;length>i;i++)buf[i]=subject.readUInt8(i);else for(i=0;length>i;i++)buf[i]=(subject[i]%256+256)%256;else if("string"===type)buf.write(subject,0,encoding);else if("number"===type&&!Buffer.TYPED_ARRAY_SUPPORT&&!noZero)for(i=0;length>i;i++)buf[i]=0;return buf}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var byte=parseInt(string.substr(2*i,2),16);if(isNaN(byte))throw new Error("Invalid hex string");buf[offset+i]=byte}return i}function utf8Write(buf,string,offset,length){var charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length);return charsWritten}function asciiWrite(buf,string,offset,length){var charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length);return charsWritten}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){var charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length);return charsWritten}function utf16leWrite(buf,string,offset,length){var charsWritten=blitBuffer(utf16leToBytes(string),buf,offset,length,2);return charsWritten}function base64Slice(buf,start,end){return base64.fromByteArray(0===start&&end===buf.length?buf:buf.slice(start,end))}function utf8Slice(buf,start,end){var res="",tmp="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)buf[i]<=127?(res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]),tmp=""):tmp+="%"+buf[i].toString(16);return res+decodeUtf8Char(tmp)}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function binarySlice(buf,start,end){return asciiSlice(buf,start,end)}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);for(var out="",i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){for(str=stringtrim(str).replace(INVALID_BASE64_RE,"");str.length%4!==0;)str+="=";return str}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&"object"==typeof subject&&"number"==typeof subject.length}function toHex(n){if(16>n)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){for(var byteArray=[],i=0;i<str.length;i++){var b=str.charCodeAt(i);if(127>=b)byteArray.push(b);else{var start=i;b>=55296&&57343>=b&&i++;for(var h=encodeURIComponent(str.slice(start,i+1)).substr(1).split("%"),j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}}return byteArray}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str){for(var c,hi,lo,byteArray=[],i=0;i<str.length;i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length,unitSize){unitSize&&(length-=length%unitSize);for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}var base64=_dereq_("base64-js"),ieee754=_dereq_("ieee754"),isArray=_dereq_("is-array");exports.Buffer=Buffer,exports.SlowBuffer=Buffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var kMaxLength=1073741823;Buffer.TYPED_ARRAY_SUPPORT=function(){try{var buf=new ArrayBuffer(0),arr=new Uint8Array(buf);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===new Uint8Array(1).subarray(1,1).byteLength}catch(e){return!1}}(),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);len>i&&a[i]===b[i];i++);if(i!==len&&(x=a[i],y=b[i]),y>x)return-1;if(x>y)return 1;return 0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,totalLength){if(!isArray(list))throw new TypeError("Usage: Buffer.concat(list[, length])");if(0===list.length)return new Buffer(0);if(1===list.length)return list[0];var i;if(void 0===totalLength)for(totalLength=0,i=0;i<list.length;i++)totalLength+=list[i].length;var buf=new Buffer(totalLength),pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=function(str,encoding){var ret;switch(str+="",encoding||"utf8"){case"ascii":case"binary":case"raw":ret=str.length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=2*str.length;break;case"hex":ret=str.length>>>1;break;case"utf8":case"utf-8":ret=utf8ToBytes(str).length;break;case"base64":ret=base64ToBytes(str).length;break;default:ret=str.length}return ret},Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0,Buffer.prototype.toString=function(encoding,start,end){var loweredCase=!1;if(start>>>=0,end=void 0===end||1/0===end?this.length:end>>>0,encoding||(encoding="utf8"),0>start&&(start=0),end>this.length&&(end=this.length),start>=end)return"";for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return 0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return Buffer.compare(this,b)},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset))isFinite(length)||(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=length,length=swap}offset=Number(offset)||0;var remaining=this.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining,encoding=String(encoding||"utf8").toLowerCase();var ret;switch(encoding){case"hex":ret=hexWrite(this,string,offset,length);break;case"utf8":case"utf-8":ret=utf8Write(this,string,offset,length);break;case"ascii":ret=asciiWrite(this,string,offset,length);break;case"binary":ret=binaryWrite(this,string,offset,length);break;case"base64":ret=base64Write(this,string,offset,length);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=utf16leWrite(this,string,offset,length);break;default:throw new TypeError("Unknown encoding: "+encoding)}return ret},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},Buffer.prototype.slice=function(start,end){var len=this.length;if(start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)return Buffer._augment(this.subarray(start,end));for(var sliceLen=end-start,newBuf=new Buffer(sliceLen,void 0,!0),i=0;sliceLen>i;i++)newBuf[i]=this[i+start];return newBuf},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readInt8=function(offset,noAssert){if(noAssert||checkOffset(offset,1,this.length),!(128&this[offset]))return this[offset];return-1*(255-this[offset]+1)},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(start||(start=0),end||0===end||(end=this.length),target_start||(target_start=0),end===start)return;if(0===target.length||0===source.length)return;if(start>end)throw new TypeError("sourceEnd < sourceStart");if(0>target_start||target_start>=target.length)throw new TypeError("targetStart out of bounds");if(0>start||start>=source.length)throw new TypeError("sourceStart out of bounds");if(0>end||end>source.length)throw new TypeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-target_start<end-start&&(end=target.length-target_start+start);var len=end-start;if(1e3>len||!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;len>i;i++)target[i+target_start]=this[i+start];else target._set(this.subarray(start,start+len),target_start)},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),start>end)throw new TypeError("end < start");if(end===start)return;if(0===this.length)return;if(0>start||start>=this.length)throw new TypeError("start out of bounds");if(0>end||end>this.length)throw new TypeError("end out of bounds");var i;if("number"==typeof value)for(i=start;end>i;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString()),len=bytes.length;for(i=start;end>i;i++)this[i]=bytes[i%len]}return this},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var buf=new Uint8Array(this.length),i=0,len=buf.length;len>i;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr.constructor=Buffer,arr._isBuffer=!0,arr._get=arr.get,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-z]/g},{"base64-js":3,ieee754:4,"is-array":5}],3:[function(_dereq_,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";function decode(elt){var code=elt.charCodeAt(0);if(code===PLUS)return 62;if(code===SLASH)return 63;if(NUMBER>code)return-1;if(NUMBER+10>code)return code-NUMBER+26+26;if(UPPER+26>code)return code-UPPER;if(LOWER+26>code)return code-LOWER+26}function b64ToByteArray(b64){function push(v){arr[L++]=v}var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3)),push((16711680&tmp)>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4,push(255&tmp)):1===placeHolders&&(tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2,push(tmp>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}var i,temp,length,extraBytes=uint8.length%3,output="";for(i=0,length=uint8.length-extraBytes;length>i;i+=3)temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output+=tripletToBase64(temp);switch(extraBytes){case 1:temp=uint8[uint8.length-1],output+=encode(temp>>2),output+=encode(temp<<4&63),output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1],output+=encode(temp>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,PLUS="+".charCodeAt(0),SLASH="/".charCodeAt(0),NUMBER="0".charCodeAt(0),LOWER="a".charCodeAt(0),UPPER="A".charCodeAt(0);exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}("undefined"==typeof exports?this.base64js={}:exports)},{}],4:[function(_dereq_,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?0/0:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||1/0===value?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],5:[function(_dereq_,module){var isArray=Array.isArray,str=Object.prototype.toString;module.exports=isArray||function(val){return!!val&&"[object Array]"==str.call(val)}},{}],6:[function(_dereq_,module){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")}},{}],7:[function(_dereq_,module){!function(factory){if("function"==typeof define&&define.amd)define([],factory);else if("object"==typeof module){var HashMap=module.exports=factory();HashMap.HashMap=HashMap}else this.HashMap=factory()}(function(){function HashMap(other){switch(this.clear(),arguments.length){case 0:break;case 1:this.copy(other);break;default:multi(this,arguments)}}function multi(map,args){for(var i=0;i<args.length;i+=2)map.set(args[i],args[i+1])}function chain(fn){return function(){return fn.apply(this,arguments),this}}function hide(obj,prop){Object.defineProperty&&Object.defineProperty(obj,prop,{enumerable:!1})}var proto=HashMap.prototype={constructor:HashMap,get:function(key){var data=this._data[this.hash(key)];return data&&data[1]},set:function(key,value){this._data[this.hash(key)]=[key,value]},multi:function(){multi(this,arguments)},copy:function(other){for(var key in other._data)this._data[key]=other._data[key]},has:function(key){return this.hash(key)in this._data},search:function(value){for(var key in this._data)if(this._data[key][1]===value)return this._data[key][0];return null},remove:function(key){delete this._data[this.hash(key)]},type:function(key){var str=Object.prototype.toString.call(key),type=str.slice(8,-1).toLowerCase();if("domwindow"===type&&!key)return key+"";return type},keys:function(){var keys=[];return this.forEach(function(value,key){keys.push(key)}),keys},values:function(){var values=[];return this.forEach(function(value){values.push(value)}),values},count:function(){return this.keys().length},clear:function(){this._data={}},clone:function(){return new HashMap(this)},hash:function(key){switch(this.type(key)){case"undefined":case"null":case"boolean":case"number":case"regexp":return key+"";case"date":return"♣"+key.getTime();case"string":return"♠"+key;case"array":for(var hashes=[],i=0;i<key.length;i++)hashes[i]=this.hash(key[i]);return"♥"+hashes.join("⁞");default:return key._hmuid_||(key._hmuid_=++HashMap.uid,hide(key,"_hmuid_")),"♦"+key._hmuid_}},forEach:function(func,ctx){for(var key in this._data){var data=this._data[key];func.call(ctx||this,data[1],data[0])}}};HashMap.uid=0;for(var method in proto){if("constructor"===method||!proto.hasOwnProperty(method))continue;var fn=proto[method];-1===fn.toString().indexOf("return ")&&(proto[method]=chain(fn))}return HashMap})},{}],8:[function(_dereq_,module){module.exports="function"==typeof Object.create?function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],9:[function(_dereq_,module){!function(root,definition){"use strict";"object"==typeof module&&module.exports&&"function"==typeof _dereq_?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):root.log=definition()}(this,function(){"use strict";function realMethod(methodName){return typeof console===undefinedType?!1:void 0!==console[methodName]?bindMethod(console,methodName):void 0!==console.log?bindMethod(console,"log"):noop}function bindMethod(obj,methodName){var method=obj[methodName];if("function"==typeof method.bind)return method.bind(obj);try{return Function.prototype.bind.call(method,obj)}catch(e){return function(){return Function.prototype.apply.apply(method,[obj,arguments])}}}function enableLoggingWhenConsoleArrives(methodName,level,loggerName){return function(){typeof console!==undefinedType&&(replaceLoggingMethods.call(this,level,loggerName),this[methodName].apply(this,arguments))}}function replaceLoggingMethods(level,loggerName){for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];this[methodName]=level>i?noop:this.methodFactory(methodName,level,loggerName)}}function defaultMethodFactory(methodName){return realMethod(methodName)||enableLoggingWhenConsoleArrives.apply(this,arguments)}function Logger(name,defaultLevel,factory){function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||"silent").toUpperCase();try{return void(window.localStorage[storageKey]=levelName)}catch(ignore){}try{window.document.cookie=encodeURIComponent(storageKey)+"="+levelName+";"}catch(ignore){}}function getPersistedLevel(){var storedLevel;try{storedLevel=window.localStorage[storageKey]}catch(ignore){}if(typeof storedLevel===undefinedType)try{var cookie=window.document.cookie,location=cookie.indexOf(encodeURIComponent(storageKey)+"=");location&&(storedLevel=/^([^;]+)/.exec(cookie.slice(location))[1])}catch(ignore){}return void 0===self.levels[storedLevel]&&(storedLevel=void 0),storedLevel}var currentLevel,self=this,storageKey="loglevel";name&&(storageKey+=":"+name),self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.methodFactory=factory||defaultMethodFactory,self.getLevel=function(){return currentLevel},self.setLevel=function(level,persist){if("string"==typeof level&&void 0!==self.levels[level.toUpperCase()]&&(level=self.levels[level.toUpperCase()]),!("number"==typeof level&&level>=0&&level<=self.levels.SILENT))throw"log.setLevel() called with invalid level: "+level;if(currentLevel=level,persist!==!1&&persistLevelIfPossible(level),replaceLoggingMethods.call(self,level,name),typeof console===undefinedType&&level<self.levels.SILENT)return"No console available for logging"},self.setDefaultLevel=function(level){getPersistedLevel()||self.setLevel(level,!1)},self.enableAll=function(persist){self.setLevel(self.levels.TRACE,persist)},self.disableAll=function(persist){self.setLevel(self.levels.SILENT,persist)};var initialLevel=getPersistedLevel();null==initialLevel&&(initialLevel=null==defaultLevel?"WARN":defaultLevel),self.setLevel(initialLevel,!1)}var noop=function(){},undefinedType="undefined",logMethods=["trace","debug","info","warn","error"],defaultLogger=new Logger,_loggersByName={};defaultLogger.getLogger=function(name){if("string"!=typeof name||""===name)throw new TypeError("You must supply a name when creating a logger.");var logger=_loggersByName[name];return logger||(logger=_loggersByName[name]=new Logger(name,defaultLogger.getLevel(),defaultLogger.methodFactory)),logger};var _log=typeof window!==undefinedType?window.log:void 0;return defaultLogger.noConflict=function(){return typeof window!==undefinedType&&window.log===defaultLogger&&(window.log=_log),defaultLogger},defaultLogger})},{}],10:[function(_dereq_,module,exports){!function(global){"use strict";var Long=function(low,high,unsigned){this.low=0|low,this.high=0|high,this.unsigned=!!unsigned};Long.isLong=function(obj){return(obj&&obj instanceof Long)===!0};var INT_CACHE={},UINT_CACHE={};Long.fromInt=function(value,unsigned){var obj,cachedObj;if(unsigned){if(value>>>=0,value>=0&&256>value&&(cachedObj=UINT_CACHE[value]))return cachedObj;return obj=new Long(value,0>(0|value)?-1:0,!0),value>=0&&256>value&&(UINT_CACHE[value]=obj),obj
}if(value=0|value,value>=-128&&128>value&&(cachedObj=INT_CACHE[value]))return cachedObj;return obj=new Long(value,0>value?-1:0,!1),value>=-128&&128>value&&(INT_CACHE[value]=obj),obj},Long.fromNumber=function(value,unsigned){if(unsigned=!!unsigned,isNaN(value)||!isFinite(value))return Long.ZERO;if(!unsigned&&-TWO_PWR_63_DBL>=value)return Long.MIN_VALUE;if(!unsigned&&value+1>=TWO_PWR_63_DBL)return Long.MAX_VALUE;if(unsigned&&value>=TWO_PWR_64_DBL)return Long.MAX_UNSIGNED_VALUE;if(0>value)return Long.fromNumber(-value,unsigned).negate();return new Long(value%TWO_PWR_32_DBL|0,value/TWO_PWR_32_DBL|0,unsigned)},Long.fromBits=function(lowBits,highBits,unsigned){return new Long(lowBits,highBits,unsigned)},Long.fromString=function(str,unsigned,radix){if(0===str.length)throw Error("number format error: empty string");if("NaN"===str||"Infinity"===str||"+Infinity"===str||"-Infinity"===str)return Long.ZERO;if("number"==typeof unsigned&&(radix=unsigned,unsigned=!1),radix=radix||10,2>radix||radix>36)throw Error("radix out of range: "+radix);var p;if((p=str.indexOf("-"))>0)throw Error('number format error: interior "-" character: '+str);if(0===p)return Long.fromString(str.substring(1),unsigned,radix).negate();for(var radixToPower=Long.fromNumber(Math.pow(radix,8)),result=Long.ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(8>size){var power=Long.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Long.fromNumber(value))}else result=result.multiply(radixToPower),result=result.add(Long.fromNumber(value))}return result.unsigned=unsigned,result},Long.fromValue=function(val){if("number"==typeof val)return Long.fromNumber(val);if("string"==typeof val)return Long.fromString(val);if(Long.isLong(val))return val;return new Long(val.low,val.high,val.unsigned)};var TWO_PWR_16_DBL=65536,TWO_PWR_24_DBL=1<<24,TWO_PWR_32_DBL=TWO_PWR_16_DBL*TWO_PWR_16_DBL,TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=Long.fromInt(TWO_PWR_24_DBL);Long.ZERO=Long.fromInt(0),Long.UZERO=Long.fromInt(0,!0),Long.ONE=Long.fromInt(1),Long.UONE=Long.fromInt(1,!0),Long.NEG_ONE=Long.fromInt(-1),Long.MAX_VALUE=Long.fromBits(-1,2147483647,!1),Long.MAX_UNSIGNED_VALUE=Long.fromBits(-1,-1,!0),Long.MIN_VALUE=Long.fromBits(0,-2147483648,!1),Long.prototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},Long.prototype.toNumber=function(){if(this.unsigned)return(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0);return this.high*TWO_PWR_32_DBL+(this.low>>>0)},Long.prototype.toString=function(radix){if(radix=radix||10,2>radix||radix>36)throw RangeError("radix out of range: "+radix);if(this.isZero())return"0";var rem;if(this.isNegative()){if(this.equals(Long.MIN_VALUE)){var radixLong=Long.fromNumber(radix),div=this.div(radixLong);return rem=div.multiply(radixLong).subtract(this),div.toString(radix)+rem.toInt().toString(radix)}return"-"+this.negate().toString(radix)}var radixToPower=Long.fromNumber(Math.pow(radix,6),this.unsigned);rem=this;for(var result="";;){var remDiv=rem.div(radixToPower),intval=rem.subtract(remDiv.multiply(radixToPower)).toInt()>>>0,digits=intval.toString(radix);if(rem=remDiv,rem.isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},Long.prototype.getHighBits=function(){return this.high},Long.prototype.getHighBitsUnsigned=function(){return this.high>>>0},Long.prototype.getLowBits=function(){return this.low},Long.prototype.getLowBitsUnsigned=function(){return this.low>>>0},Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var val=0!=this.high?this.high:this.low,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high?bit+33:bit+1},Long.prototype.isZero=function(){return 0===this.high&&0===this.low},Long.prototype.isNegative=function(){return!this.unsigned&&this.high<0},Long.prototype.isPositive=function(){return this.unsigned||this.high>=0},Long.prototype.isOdd=function(){return 1===(1&this.low)},Long.prototype.isEven=function(){return 0===(1&this.low)},Long.prototype.equals=function(other){if(Long.isLong(other)||(other=Long.fromValue(other)),this.unsigned!==other.unsigned&&this.high>>>31===1&&other.high>>>31===1)return!1;return this.high===other.high&&this.low===other.low},Long.prototype.notEquals=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),!this.equals(other)},Long.prototype.lessThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<0},Long.prototype.lessThanOrEqual=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<=0},Long.prototype.greaterThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)>0},Long.prototype.greaterThanOrEqual=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)>=0},Long.prototype.compare=function(other){if(this.equals(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();if(thisNeg&&!otherNeg)return-1;if(!thisNeg&&otherNeg)return 1;if(!this.unsigned)return this.subtract(other).isNegative()?-1:1;return other.high>>>0>this.high>>>0||other.high===this.high&&other.low>>>0>this.low>>>0?-1:1},Long.prototype.negate=function(){if(!this.unsigned&&this.equals(Long.MIN_VALUE))return Long.MIN_VALUE;return this.not().add(Long.ONE)},Long.prototype.add=function(addend){Long.isLong(addend)||(addend=Long.fromValue(addend));var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=addend.high>>>16,b32=65535&addend.high,b16=addend.low>>>16,b00=65535&addend.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00+b00,c16+=c00>>>16,c00&=65535,c16+=a16+b16,c32+=c16>>>16,c16&=65535,c32+=a32+b32,c48+=c32>>>16,c32&=65535,c48+=a48+b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.subtract=function(subtrahend){return Long.isLong(subtrahend)||(subtrahend=Long.fromValue(subtrahend)),this.add(subtrahend.negate())},Long.prototype.multiply=function(multiplier){if(this.isZero())return Long.ZERO;if(Long.isLong(multiplier)||(multiplier=Long.fromValue(multiplier)),multiplier.isZero())return Long.ZERO;if(this.equals(Long.MIN_VALUE))return multiplier.isOdd()?Long.MIN_VALUE:Long.ZERO;if(multiplier.equals(Long.MIN_VALUE))return this.isOdd()?Long.MIN_VALUE:Long.ZERO;if(this.isNegative())return multiplier.isNegative()?this.negate().multiply(multiplier.negate()):this.negate().multiply(multiplier).negate();if(multiplier.isNegative())return this.multiply(multiplier.negate()).negate();if(this.lessThan(TWO_PWR_24)&&multiplier.lessThan(TWO_PWR_24))return Long.fromNumber(this.toNumber()*multiplier.toNumber(),this.unsigned);var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=multiplier.high>>>16,b32=65535&multiplier.high,b16=multiplier.low>>>16,b00=65535&multiplier.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00*b00,c16+=c00>>>16,c00&=65535,c16+=a16*b00,c32+=c16>>>16,c16&=65535,c16+=a00*b16,c32+=c16>>>16,c16&=65535,c32+=a32*b00,c48+=c32>>>16,c32&=65535,c32+=a16*b16,c48+=c32>>>16,c32&=65535,c32+=a00*b32,c48+=c32>>>16,c32&=65535,c48+=a48*b00+a32*b16+a16*b32+a00*b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.div=function(divisor){if(Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),divisor.isZero())throw new Error("division by zero");if(this.isZero())return this.unsigned?Long.UZERO:Long.ZERO;var approx,rem,res;if(this.equals(Long.MIN_VALUE)){if(divisor.equals(Long.ONE)||divisor.equals(Long.NEG_ONE))return Long.MIN_VALUE;if(divisor.equals(Long.MIN_VALUE))return Long.ONE;var halfThis=this.shiftRight(1);return approx=halfThis.div(divisor).shiftLeft(1),approx.equals(Long.ZERO)?divisor.isNegative()?Long.ONE:Long.NEG_ONE:(rem=this.subtract(divisor.multiply(approx)),res=approx.add(rem.div(divisor)))}if(divisor.equals(Long.MIN_VALUE))return this.unsigned?Long.UZERO:Long.ZERO;if(this.isNegative()){if(divisor.isNegative())return this.negate().div(divisor.negate());return this.negate().div(divisor).negate()}if(divisor.isNegative())return this.div(divisor.negate()).negate();for(res=Long.ZERO,rem=this;rem.greaterThanOrEqual(divisor);){approx=Math.max(1,Math.floor(rem.toNumber()/divisor.toNumber()));for(var log2=Math.ceil(Math.log(approx)/Math.LN2),delta=48>=log2?1:Math.pow(2,log2-48),approxRes=Long.fromNumber(approx),approxRem=approxRes.multiply(divisor);approxRem.isNegative()||approxRem.greaterThan(rem);)approx-=delta,approxRes=Long.fromNumber(approx,this.unsigned),approxRem=approxRes.multiply(divisor);approxRes.isZero()&&(approxRes=Long.ONE),res=res.add(approxRes),rem=rem.subtract(approxRem)}return res},Long.prototype.modulo=function(divisor){return Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),this.subtract(this.div(divisor).multiply(divisor))},Long.prototype.not=function(){return Long.fromBits(~this.low,~this.high,this.unsigned)},Long.prototype.and=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low&other.low,this.high&other.high,this.unsigned)},Long.prototype.or=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low|other.low,this.high|other.high,this.unsigned)},Long.prototype.xor=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low^other.low,this.high^other.high,this.unsigned)},Long.prototype.shiftLeft=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:32>numBits?Long.fromBits(this.low<<numBits,this.high<<numBits|this.low>>>32-numBits,this.unsigned):Long.fromBits(0,this.low<<numBits-32,this.unsigned)},Long.prototype.shiftRight=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:32>numBits?Long.fromBits(this.low>>>numBits|this.high<<32-numBits,this.high>>numBits,this.unsigned):Long.fromBits(this.high>>numBits-32,this.high>=0?0:-1,this.unsigned)},Long.prototype.shiftRightUnsigned=function(numBits){if(Long.isLong(numBits)&&(numBits=numBits.toInt()),numBits&=63,0===numBits)return this;var high=this.high;if(32>numBits){var low=this.low;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits,this.unsigned)}return 32===numBits?Long.fromBits(high,0,this.unsigned):Long.fromBits(high>>>numBits-32,0,this.unsigned)},Long.prototype.toSigned=function(){if(!this.unsigned)return this;return new Long(this.low,this.high,!1)},Long.prototype.toUnsigned=function(){if(this.unsigned)return this;return new Long(this.low,this.high,!0)},"function"==typeof _dereq_&&"object"==typeof module&&module&&"object"==typeof exports&&exports?module.exports=Long:"function"==typeof define&&define.amd?define(function(){return Long}):(global.dcodeIO=global.dcodeIO||{}).Long=Long}(this)},{}],11:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){var makePromise=_dereq_("./makePromise"),Scheduler=_dereq_("./Scheduler"),async=_dereq_("./env").asap;return makePromise({scheduler:new Scheduler(async)})})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"./Scheduler":12,"./env":24,"./makePromise":26}],12:[function(_dereq_,module){!function(define){"use strict";define(function(){function Scheduler(async){this._async=async,this._running=!1,this._queue=this,this._queueLen=0,this._afterQueue={},this._afterQueueLen=0;var self=this;this.drain=function(){self._drain()}}return Scheduler.prototype.enqueue=function(task){this._queue[this._queueLen++]=task,this.run()},Scheduler.prototype.afterQueue=function(task){this._afterQueue[this._afterQueueLen++]=task,this.run()},Scheduler.prototype.run=function(){this._running||(this._running=!0,this._async(this.drain))},Scheduler.prototype._drain=function(){for(var i=0;i<this._queueLen;++i)this._queue[i].run(),this._queue[i]=void 0;for(this._queueLen=0,this._running=!1,i=0;i<this._afterQueueLen;++i)this._afterQueue[i].run(),this._afterQueue[i]=void 0;this._afterQueueLen=0},Scheduler})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],13:[function(_dereq_,module){!function(define){"use strict";define(function(){function TimeoutError(message){Error.call(this),this.message=message,this.name=TimeoutError.name,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,TimeoutError)}return TimeoutError.prototype=Object.create(Error.prototype),TimeoutError.prototype.constructor=TimeoutError,TimeoutError})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],14:[function(_dereq_,module){!function(define){"use strict";define(function(){function makeApply(Promise,call){function apply(f,thisArg,args){var p=Promise._defer(),l=args.length,params=new Array(l);return callAndResolve({f:f,thisArg:thisArg,args:args,params:params,i:l-1,call:call},p._handler),p}function callAndResolve(c,h){if(c.i<0)return call(c.f,c.thisArg,c.params,h);var handler=Promise._handler(c.args[c.i]);handler.fold(callAndResolveNext,c,void 0,h)}function callAndResolveNext(c,x,h){c.params[c.i]=x,c.i-=1,callAndResolve(c,h)}return arguments.length<2&&(call=tryCatchResolve),apply}function tryCatchResolve(f,thisArg,args,resolver){try{resolver.resolve(f.apply(thisArg,args))}catch(e){resolver.reject(e)}}return makeApply.tryCatchResolve=tryCatchResolve,makeApply})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],15:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){var state=_dereq_("../state"),applier=_dereq_("../apply");return function(Promise){function any(promises){function handleFulfill(x){errors=null,this.resolve(x)}function handleReject(e){if(this.resolved)return;errors.push(e),0===--pending&&this.reject(errors)}for(var h,x,p=Promise._defer(),resolver=p._handler,l=promises.length>>>0,pending=l,errors=[],i=0;l>i;++i){if(x=promises[i],void 0===x&&!(i in promises)){--pending;continue}if(h=Promise._handler(x),h.state()>0){resolver.become(h),Promise._visitRemaining(promises,i,h);break}h.visit(resolver,handleFulfill,handleReject)}return 0===pending&&resolver.reject(new RangeError("any(): array must not be empty")),p}function some(promises,n){function fulfill(x){if(this.resolved)return;results.push(x),0===--nFulfill&&(errors=null,this.resolve(results))}function reject(e){if(this.resolved)return;errors.push(e),0===--nReject&&(results=null,this.reject(errors))}var nReject,x,i,p=Promise._defer(),resolver=p._handler,results=[],errors=[],l=promises.length>>>0,nFulfill=0;for(i=0;l>i;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;++nFulfill}for(n=Math.max(n,0),nReject=nFulfill-n+1,nFulfill=Math.min(n,nFulfill),n>nFulfill?resolver.reject(new RangeError("some(): array must contain at least "+n+" item(s), but had "+nFulfill)):0===nFulfill&&resolver.resolve(results),i=0;l>i;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;Promise._handler(x).visit(resolver,fulfill,reject,resolver.notify)}return p}function map(promises,f){return Promise._traverse(f,promises)}function filter(promises,predicate){var a=slice.call(promises);return Promise._traverse(predicate,a).then(function(keep){return filterSync(a,keep)})}function filterSync(promises,keep){for(var l=keep.length,filtered=new Array(l),i=0,j=0;l>i;++i)keep[i]&&(filtered[j++]=Promise._handler(promises[i]).value);return filtered.length=j,filtered}function settle(promises){return all(promises.map(settleOne))}function settleOne(p){var h=Promise._handler(p);if(0===h.state())return toPromise(p).then(state.fulfilled,state.rejected);return h._unreport(),state.inspect(h)}function reduce(promises,f){return arguments.length>2?ar.call(promises,liftCombine(f),arguments[2]):ar.call(promises,liftCombine(f))}function reduceRight(promises,f){return arguments.length>2?arr.call(promises,liftCombine(f),arguments[2]):arr.call(promises,liftCombine(f))}function liftCombine(f){return function(z,x,i){return applyFold(f,void 0,[z,x,i])}}var applyFold=applier(Promise),toPromise=Promise.resolve,all=Promise.all,ar=Array.prototype.reduce,arr=Array.prototype.reduceRight,slice=Array.prototype.slice;return Promise.any=any,Promise.some=some,Promise.settle=settle,Promise.map=map,Promise.filter=filter,Promise.reduce=reduce,Promise.reduceRight=reduceRight,Promise.prototype.spread=function(onFulfilled){return this.then(all).then(function(array){return onFulfilled.apply(this,array)})},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"../apply":14,"../state":27}],16:[function(_dereq_,module){!function(define){"use strict";define(function(){function rejectInvalidPredicate(){throw new TypeError("catch predicate must be a function")}function evaluatePredicate(e,predicate){return isError(predicate)?e instanceof predicate:predicate(e)}function isError(predicate){return predicate===Error||null!=predicate&&predicate.prototype instanceof Error}function maybeThenable(x){return("object"==typeof x||"function"==typeof x)&&null!==x}function identity(x){return x}return function(Promise){function createCatchFilter(handler,predicate){return function(e){return evaluatePredicate(e,predicate)?handler.call(this,e):reject(e)}}function runSideEffect(handler,thisArg,propagate,value){var result=handler.call(thisArg);return maybeThenable(result)?propagateValue(result,propagate,value):propagate(value)}function propagateValue(result,propagate,x){return resolve(result).then(function(){return propagate(x)})}var resolve=Promise.resolve,reject=Promise.reject,origCatch=Promise.prototype["catch"];return Promise.prototype.done=function(onResult,onError){this._handler.visit(this._handler.receiver,onResult,onError)},Promise.prototype["catch"]=Promise.prototype.otherwise=function(onRejected){if(arguments.length<2)return origCatch.call(this,onRejected);if("function"!=typeof onRejected)return this.ensure(rejectInvalidPredicate);return origCatch.call(this,createCatchFilter(arguments[1],onRejected))},Promise.prototype["finally"]=Promise.prototype.ensure=function(handler){if("function"!=typeof handler)return this;return this.then(function(x){return runSideEffect(handler,this,identity,x)},function(e){return runSideEffect(handler,this,reject,e)})},Promise.prototype["else"]=Promise.prototype.orElse=function(defaultValue){return this.then(void 0,function(){return defaultValue})},Promise.prototype["yield"]=function(value){return this.then(function(){return value})},Promise.prototype.tap=function(onFulfilledSideEffect){return this.then(onFulfilledSideEffect)["yield"](this)},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],17:[function(_dereq_,module){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype.fold=function(f,z){var promise=this._beget();return this._handler.fold(function(z,x,to){Promise._handler(z).fold(function(x,z,to){to.resolve(f.call(this,z,x))},x,this,to)},z,promise._handler.receiver,promise._handler),promise},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],18:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){var inspect=_dereq_("../state").inspect;return function(Promise){return Promise.prototype.inspect=function(){return inspect(Promise._handler(this))},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"../state":27}],19:[function(_dereq_,module){!function(define){"use strict";define(function(){return function(Promise){function iterate(f,condition,handler,x){return unfold(function(x){return[x,f(x)]},condition,handler,x)}function unfold(unspool,condition,handler,x){function next(item,newSeed){return resolve(handler(item)).then(function(){return unfold(unspool,condition,handler,newSeed)})}return resolve(x).then(function(seed){return resolve(condition(seed)).then(function(done){return done?seed:resolve(unspool(seed)).spread(next)})})}var resolve=Promise.resolve;return Promise.iterate=iterate,Promise.unfold=unfold,Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],20:[function(_dereq_,module){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype.progress=function(onProgress){return this.then(void 0,void 0,onProgress)},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],21:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){function setTimeout(f,ms,x,y){return env.setTimer(function(){f(x,y,ms)},ms)}var env=_dereq_("../env"),TimeoutError=_dereq_("../TimeoutError");return function(Promise){function handleDelay(ms,x,h){setTimeout(resolveDelay,ms,x,h)}function resolveDelay(x,h){h.resolve(x)}function onTimeout(reason,h,ms){var e="undefined"==typeof reason?new TimeoutError("timed out after "+ms+"ms"):reason;h.reject(e)}return Promise.prototype.delay=function(ms){var p=this._beget();return this._handler.fold(handleDelay,ms,void 0,p._handler),p},Promise.prototype.timeout=function(ms,reason){var p=this._beget(),h=p._handler,t=setTimeout(onTimeout,ms,reason,p._handler);return this._handler.visit(h,function(x){env.clearTimer(t),this.resolve(x)},function(x){env.clearTimer(t),this.reject(x)},h.notify),p},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"../TimeoutError":13,"../env":24}],22:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){function throwit(e){throw e}function noop(){}var setTimer=_dereq_("../env").setTimer,format=_dereq_("../format");return function(Promise){function report(r){r.handled||(reported.push(r),logError("Potentially unhandled rejection ["+r.id+"] "+format.formatError(r.value)))}function unreport(r){var i=reported.indexOf(r);i>=0&&(reported.splice(i,1),logInfo("Handled previous rejection ["+r.id+"] "+format.formatObject(r.value)))}function enqueue(f,x){tasks.push(f,x),null===running&&(running=setTimer(flush,0))}function flush(){for(running=null;tasks.length>0;)tasks.shift()(tasks.shift())}var localConsole,logError=noop,logInfo=noop;"undefined"!=typeof console&&(localConsole=console,logError="undefined"!=typeof localConsole.error?function(e){localConsole.error(e)}:function(e){localConsole.log(e)},logInfo="undefined"!=typeof localConsole.info?function(e){localConsole.info(e)}:function(e){localConsole.log(e)}),Promise.onPotentiallyUnhandledRejection=function(rejection){enqueue(report,rejection)},Promise.onPotentiallyUnhandledRejectionHandled=function(rejection){enqueue(unreport,rejection)},Promise.onFatalRejection=function(rejection){enqueue(throwit,rejection.value)};var tasks=[],reported=[],running=null;return Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"../env":24,"../format":25}],23:[function(_dereq_,module){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype["with"]=Promise.prototype.withThis=function(receiver){var p=this._beget(),child=p._handler;return child.receiver=receiver,this._handler.chain(child,receiver),p},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],24:[function(_dereq_,module){(function(process){!function(define){"use strict";define(function(_dereq_){function isNode(){return"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process)}function hasMutationObserver(){return"function"==typeof MutationObserver&&MutationObserver||"function"==typeof WebKitMutationObserver&&WebKitMutationObserver}function initMutationObserver(MutationObserver){function run(){var f=scheduled;scheduled=void 0,f()}var scheduled,node=document.createTextNode(""),o=new MutationObserver(run);o.observe(node,{characterData:!0});var i=0;return function(f){scheduled=f,node.data=i^=1}}var MutationObs,capturedSetTimeout="undefined"!=typeof setTimeout&&setTimeout,setTimer=function(f,ms){return setTimeout(f,ms)},clearTimer=function(t){return clearTimeout(t)},asap=function(f){return capturedSetTimeout(f,0)};if(isNode())asap=function(f){return process.nextTick(f)};else if(MutationObs=hasMutationObserver())asap=initMutationObserver(MutationObs);else if(!capturedSetTimeout){var vertxRequire=_dereq_,vertx=vertxRequire("vertx");setTimer=function(f,ms){return vertx.setTimer(ms,f)},clearTimer=vertx.cancelTimer,asap=vertx.runOnLoop||vertx.runOnContext}return{setTimer:setTimer,clearTimer:clearTimer,asap:asap}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})}).call(this,_dereq_("FWaASH"))},{FWaASH:6}],25:[function(_dereq_,module){!function(define){"use strict";define(function(){function formatError(e){var s="object"==typeof e&&null!==e&&e.stack?e.stack:formatObject(e);return e instanceof Error?s:s+" (WARNING: non-Error used)"}function formatObject(o){var s=String(o);return"[object Object]"===s&&"undefined"!=typeof JSON&&(s=tryStringify(o,s)),s}function tryStringify(x,defaultValue){try{return JSON.stringify(x)}catch(e){return defaultValue}}return{formatError:formatError,formatObject:formatObject,tryStringify:tryStringify}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],26:[function(_dereq_,module){(function(process){!function(define){"use strict";define(function(){return function(environment){function Promise(resolver,handler){this._handler=resolver===Handler?handler:init(resolver)}function init(resolver){function promiseResolve(x){handler.resolve(x)}function promiseReject(reason){handler.reject(reason)}function promiseNotify(x){handler.notify(x)}var handler=new Pending;try{resolver(promiseResolve,promiseReject,promiseNotify)}catch(e){promiseReject(e)}return handler}function resolve(x){return isPromise(x)?x:new Promise(Handler,new Async(getHandler(x)))}function reject(x){return new Promise(Handler,new Async(new Rejected(x)))}function never(){return foreverPendingPromise}function defer(){return new Promise(Handler,new Pending)}function begetFrom(parent,Promise){var child=new Pending(parent.receiver,parent.join().context);return new Promise(Handler,child)}function all(promises){return traverseWith(snd,null,promises)}function traverse(f,promises){return traverseWith(tryCatch2,f,promises)}function traverseWith(tryMap,f,promises){function mapAt(i,x,resolver){resolver.resolved||traverseAt(promises,settleAt,i,tryMap(f,x,i),resolver)}function settleAt(i,x,resolver){results[i]=x,0===--pending&&resolver.become(new Fulfilled(results))}for(var x,handler="function"==typeof f?mapAt:settleAt,resolver=new Pending,pending=promises.length>>>0,results=new Array(pending),i=0;i<promises.length&&!resolver.resolved;++i){if(x=promises[i],void 0===x&&!(i in promises)){--pending;continue}traverseAt(promises,handler,i,x,resolver)}return 0===pending&&resolver.become(new Fulfilled(results)),new Promise(Handler,resolver)}function traverseAt(promises,handler,i,x,resolver){if(maybeThenable(x)){var h=getHandlerMaybeThenable(x),s=h.state();0===s?h.fold(handler,i,void 0,resolver):s>0?handler(i,h.value,resolver):(resolver.become(h),visitRemaining(promises,i+1,h))}else handler(i,x,resolver)}function visitRemaining(promises,start,handler){for(var i=start;i<promises.length;++i)markAsHandled(getHandler(promises[i]),handler)}function markAsHandled(h,handler){if(h===handler)return;var s=h.state();0===s?h.visit(h,void 0,h._unreport):0>s&&h._unreport()}function race(promises){if("object"!=typeof promises||null===promises)return reject(new TypeError("non-iterable passed to race()"));return 0===promises.length?never():1===promises.length?resolve(promises[0]):runRace(promises)}function runRace(promises){var i,x,h,resolver=new Pending;for(i=0;i<promises.length;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;if(h=getHandler(x),0!==h.state()){resolver.become(h),visitRemaining(promises,i+1,h);break}h.visit(resolver,resolver.resolve,resolver.reject)}return new Promise(Handler,resolver)}function getHandler(x){if(isPromise(x))return x._handler.join();return maybeThenable(x)?getHandlerUntrusted(x):new Fulfilled(x)}function getHandlerMaybeThenable(x){return isPromise(x)?x._handler.join():getHandlerUntrusted(x)}function getHandlerUntrusted(x){try{var untrustedThen=x.then;return"function"==typeof untrustedThen?new Thenable(untrustedThen,x):new Fulfilled(x)}catch(e){return new Rejected(e)}}function Handler(){}function FailIfRejected(){}function Pending(receiver,inheritedContext){Promise.createContext(this,inheritedContext),this.consumers=void 0,this.receiver=receiver,this.handler=void 0,this.resolved=!1}function Async(handler){this.handler=handler}function Thenable(then,thenable){Pending.call(this),tasks.enqueue(new AssimilateTask(then,thenable,this))}function Fulfilled(x){Promise.createContext(this),this.value=x}function Rejected(x){Promise.createContext(this),this.id=++errorId,this.value=x,this.handled=!1,this.reported=!1,this._report()}function ReportTask(rejection,context){this.rejection=rejection,this.context=context}function UnreportTask(rejection){this.rejection=rejection}function cycle(){return new Rejected(new TypeError("Promise cycle"))}function ContinuationTask(continuation,handler){this.continuation=continuation,this.handler=handler}function ProgressTask(value,handler){this.handler=handler,this.value=value}function AssimilateTask(then,thenable,resolver){this._then=then,this.thenable=thenable,this.resolver=resolver}function tryAssimilate(then,thenable,resolve,reject,notify){try{then.call(thenable,resolve,reject,notify)}catch(e){reject(e)}}function Fold(f,z,c,to){this.f=f,this.z=z,this.c=c,this.to=to,this.resolver=failIfRejected,this.receiver=this}function isPromise(x){return x instanceof Promise}function maybeThenable(x){return("object"==typeof x||"function"==typeof x)&&null!==x}function runContinuation1(f,h,receiver,next){if("function"!=typeof f)return next.become(h);Promise.enterContext(h),tryCatchReject(f,h.value,receiver,next),Promise.exitContext()}function runContinuation3(f,x,h,receiver,next){if("function"!=typeof f)return next.become(h);Promise.enterContext(h),tryCatchReject3(f,x,h.value,receiver,next),Promise.exitContext()}function runNotify(f,x,h,receiver,next){if("function"!=typeof f)return next.notify(x);Promise.enterContext(h),tryCatchReturn(f,x,receiver,next),Promise.exitContext()}function tryCatch2(f,a,b){try{return f(a,b)}catch(e){return reject(e)}}function tryCatchReject(f,x,thisArg,next){try{next.become(getHandler(f.call(thisArg,x)))}catch(e){next.become(new Rejected(e))}}function tryCatchReject3(f,x,y,thisArg,next){try{f.call(thisArg,x,y,next)}catch(e){next.become(new Rejected(e))}}function tryCatchReturn(f,x,thisArg,next){try{next.notify(f.call(thisArg,x))}catch(e){next.notify(e)}}function inherit(Parent,Child){Child.prototype=objectCreate(Parent.prototype),Child.prototype.constructor=Child}function snd(x,y){return y}function noop(){}function initEmitRejection(){if("undefined"!=typeof process&&null!==process&&"function"==typeof process.emit)return function(type,rejection){return"unhandledRejection"===type?process.emit(type,rejection.value,rejection):process.emit(type,rejection)};if("undefined"!=typeof self&&"function"==typeof CustomEvent)return function(noop,self,CustomEvent){var hasCustomEvent=!1;try{var ev=new CustomEvent("unhandledRejection");hasCustomEvent=ev instanceof CustomEvent}catch(e){}return hasCustomEvent?function(type,rejection){var ev=new CustomEvent(type,{detail:{reason:rejection.value,key:rejection},bubbles:!1,cancelable:!0});return!self.dispatchEvent(ev)}:noop}(noop,self,CustomEvent);return noop}var tasks=environment.scheduler,emitRejection=initEmitRejection(),objectCreate=Object.create||function(proto){function Child(){}return Child.prototype=proto,new Child
};Promise.resolve=resolve,Promise.reject=reject,Promise.never=never,Promise._defer=defer,Promise._handler=getHandler,Promise.prototype.then=function(onFulfilled,onRejected,onProgress){var parent=this._handler,state=parent.join().state();if("function"!=typeof onFulfilled&&state>0||"function"!=typeof onRejected&&0>state)return new this.constructor(Handler,parent);var p=this._beget(),child=p._handler;return parent.chain(child,parent.receiver,onFulfilled,onRejected,onProgress),p},Promise.prototype["catch"]=function(onRejected){return this.then(void 0,onRejected)},Promise.prototype._beget=function(){return begetFrom(this._handler,this.constructor)},Promise.all=all,Promise.race=race,Promise._traverse=traverse,Promise._visitRemaining=visitRemaining,Handler.prototype.when=Handler.prototype.become=Handler.prototype.notify=Handler.prototype.fail=Handler.prototype._unreport=Handler.prototype._report=noop,Handler.prototype._state=0,Handler.prototype.state=function(){return this._state},Handler.prototype.join=function(){for(var h=this;void 0!==h.handler;)h=h.handler;return h},Handler.prototype.chain=function(to,receiver,fulfilled,rejected,progress){this.when({resolver:to,receiver:receiver,fulfilled:fulfilled,rejected:rejected,progress:progress})},Handler.prototype.visit=function(receiver,fulfilled,rejected,progress){this.chain(failIfRejected,receiver,fulfilled,rejected,progress)},Handler.prototype.fold=function(f,z,c,to){this.when(new Fold(f,z,c,to))},inherit(Handler,FailIfRejected),FailIfRejected.prototype.become=function(h){h.fail()};var failIfRejected=new FailIfRejected;inherit(Handler,Pending),Pending.prototype._state=0,Pending.prototype.resolve=function(x){this.become(getHandler(x))},Pending.prototype.reject=function(x){if(this.resolved)return;this.become(new Rejected(x))},Pending.prototype.join=function(){if(!this.resolved)return this;for(var h=this;void 0!==h.handler;)if(h=h.handler,h===this)return this.handler=cycle();return h},Pending.prototype.run=function(){var q=this.consumers,handler=this.handler;this.handler=this.handler.join(),this.consumers=void 0;for(var i=0;i<q.length;++i)handler.when(q[i])},Pending.prototype.become=function(handler){if(this.resolved)return;this.resolved=!0,this.handler=handler,void 0!==this.consumers&&tasks.enqueue(this),void 0!==this.context&&handler._report(this.context)},Pending.prototype.when=function(continuation){this.resolved?tasks.enqueue(new ContinuationTask(continuation,this.handler)):void 0===this.consumers?this.consumers=[continuation]:this.consumers.push(continuation)},Pending.prototype.notify=function(x){this.resolved||tasks.enqueue(new ProgressTask(x,this))},Pending.prototype.fail=function(context){var c="undefined"==typeof context?this.context:context;this.resolved&&this.handler.join().fail(c)},Pending.prototype._report=function(context){this.resolved&&this.handler.join()._report(context)},Pending.prototype._unreport=function(){this.resolved&&this.handler.join()._unreport()},inherit(Handler,Async),Async.prototype.when=function(continuation){tasks.enqueue(new ContinuationTask(continuation,this))},Async.prototype._report=function(context){this.join()._report(context)},Async.prototype._unreport=function(){this.join()._unreport()},inherit(Pending,Thenable),inherit(Handler,Fulfilled),Fulfilled.prototype._state=1,Fulfilled.prototype.fold=function(f,z,c,to){runContinuation3(f,z,this,c,to)},Fulfilled.prototype.when=function(cont){runContinuation1(cont.fulfilled,this,cont.receiver,cont.resolver)};var errorId=0;inherit(Handler,Rejected),Rejected.prototype._state=-1,Rejected.prototype.fold=function(f,z,c,to){to.become(this)},Rejected.prototype.when=function(cont){"function"==typeof cont.rejected&&this._unreport(),runContinuation1(cont.rejected,this,cont.receiver,cont.resolver)},Rejected.prototype._report=function(context){tasks.afterQueue(new ReportTask(this,context))},Rejected.prototype._unreport=function(){if(this.handled)return;this.handled=!0,tasks.afterQueue(new UnreportTask(this))},Rejected.prototype.fail=function(context){this.reported=!0,emitRejection("unhandledRejection",this),Promise.onFatalRejection(this,void 0===context?this.context:context)},ReportTask.prototype.run=function(){this.rejection.handled||this.rejection.reported||(this.rejection.reported=!0,emitRejection("unhandledRejection",this.rejection)||Promise.onPotentiallyUnhandledRejection(this.rejection,this.context))},UnreportTask.prototype.run=function(){this.rejection.reported&&(emitRejection("rejectionHandled",this.rejection)||Promise.onPotentiallyUnhandledRejectionHandled(this.rejection))},Promise.createContext=Promise.enterContext=Promise.exitContext=Promise.onPotentiallyUnhandledRejection=Promise.onPotentiallyUnhandledRejectionHandled=Promise.onFatalRejection=noop;var foreverPendingHandler=new Handler,foreverPendingPromise=new Promise(Handler,foreverPendingHandler);return ContinuationTask.prototype.run=function(){this.handler.join().when(this.continuation)},ProgressTask.prototype.run=function(){var q=this.handler.consumers;if(void 0===q)return;for(var c,i=0;i<q.length;++i)c=q[i],runNotify(c.progress,this.value,this.handler,c.receiver,c.resolver)},AssimilateTask.prototype.run=function(){function _resolve(x){h.resolve(x)}function _reject(x){h.reject(x)}function _notify(x){h.notify(x)}var h=this.resolver;tryAssimilate(this._then,this.thenable,_resolve,_reject,_notify)},Fold.prototype.fulfilled=function(x){this.f.call(this.c,this.z,x,this.to)},Fold.prototype.rejected=function(x){this.to.reject(x)},Fold.prototype.progress=function(x){this.to.notify(x)},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})}).call(this,_dereq_("FWaASH"))},{FWaASH:6}],27:[function(_dereq_,module){!function(define){"use strict";define(function(){function toPendingState(){return{state:"pending"}}function toRejectedState(e){return{state:"rejected",reason:e}}function toFulfilledState(x){return{state:"fulfilled",value:x}}function inspect(handler){var state=handler.state();return 0===state?toPendingState():state>0?toFulfilledState(handler.value):toRejectedState(handler.value)}return{pending:toPendingState,fulfilled:toFulfilledState,rejected:toRejectedState,inspect:inspect}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],28:[function(_dereq_,module){!function(define){"use strict";define(function(_dereq_){function when(x,onFulfilled,onRejected,onProgress){var p=Promise.resolve(x);if(arguments.length<2)return p;return p.then(onFulfilled,onRejected,onProgress)}function promise(resolver){return new Promise(resolver)}function lift(f){return function(){for(var i=0,l=arguments.length,a=new Array(l);l>i;++i)a[i]=arguments[i];return apply(f,this,a)}}function attempt(f){for(var i=0,l=arguments.length-1,a=new Array(l);l>i;++i)a[i]=arguments[i+1];return apply(f,this,a)}function defer(){return new Deferred}function Deferred(){function resolve(x){p._handler.resolve(x)}function reject(x){p._handler.reject(x)}function notify(x){p._handler.notify(x)}var p=Promise._defer();this.promise=p,this.resolve=resolve,this.reject=reject,this.notify=notify,this.resolver={resolve:resolve,reject:reject,notify:notify}}function isPromiseLike(x){return x&&"function"==typeof x.then}function join(){return Promise.all(arguments)}function all(promises){return when(promises,Promise.all)}function settle(promises){return when(promises,Promise.settle)}function map(promises,mapFunc){return when(promises,function(promises){return Promise.map(promises,mapFunc)})}function filter(promises,predicate){return when(promises,function(promises){return Promise.filter(promises,predicate)})}var timed=_dereq_("./lib/decorators/timed"),array=_dereq_("./lib/decorators/array"),flow=_dereq_("./lib/decorators/flow"),fold=_dereq_("./lib/decorators/fold"),inspect=_dereq_("./lib/decorators/inspect"),generate=_dereq_("./lib/decorators/iterate"),progress=_dereq_("./lib/decorators/progress"),withThis=_dereq_("./lib/decorators/with"),unhandledRejection=_dereq_("./lib/decorators/unhandledRejection"),TimeoutError=_dereq_("./lib/TimeoutError"),Promise=[array,flow,fold,generate,progress,inspect,withThis,timed,unhandledRejection].reduce(function(Promise,feature){return feature(Promise)},_dereq_("./lib/Promise")),apply=_dereq_("./lib/apply")(Promise);return when.promise=promise,when.resolve=Promise.resolve,when.reject=Promise.reject,when.lift=lift,when["try"]=attempt,when.attempt=attempt,when.iterate=Promise.iterate,when.unfold=Promise.unfold,when.join=join,when.all=all,when.settle=settle,when.any=lift(Promise.any),when.some=lift(Promise.some),when.race=lift(Promise.race),when.map=map,when.filter=filter,when.reduce=lift(Promise.reduce),when.reduceRight=lift(Promise.reduceRight),when.isPromiseLike=isPromiseLike,when.Promise=Promise,when.defer=defer,when.TimeoutError=TimeoutError,when})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(_dereq_)})},{"./lib/Promise":11,"./lib/TimeoutError":13,"./lib/apply":14,"./lib/decorators/array":15,"./lib/decorators/flow":16,"./lib/decorators/fold":17,"./lib/decorators/inspect":18,"./lib/decorators/iterate":19,"./lib/decorators/progress":20,"./lib/decorators/timed":21,"./lib/decorators/unhandledRejection":22,"./lib/decorators/with":23}],29:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],RecordContent=interface("RecordContent",["get","records","forEach"]);RecordContent.Record=interface("Record",["get","fields","forEach"]),RecordContent.Builder=interface("RecordContentBuilder",["add","set","build","addAndBuild","setAndBuild"]),RecordContent.Builder.Record=interface("RecordContentRecordBuilder",["add","set"]),module.exports=RecordContent},{"util/interface":263}],30:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],DataType=_dereq_("../datatype");module.exports=interface("BinaryDataType",DataType,["from"])},{"../datatype":34,"util/interface":263}],31:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("BinaryDelta",["hasChanges"])},{"util/interface":263}],32:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Bytes=_dereq_("../bytes");module.exports=interface("Binary",Bytes,["get","diff","apply"])},{"../bytes":33,"util/interface":263}],33:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("Bytes",["length","asBuffer","copyTo"])},{"util/interface":263}],34:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("DataType",["name","readValue","writeValue","deltaType"])},{"util/interface":263}],35:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("DataTypes",["binary","json","get"])},{"util/interface":263}],36:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("DeltaType",["name","diff","apply","readDelta","writeDelta","noChange","isValueCheaper"])},{"util/interface":263}],37:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],DataType=_dereq_("../datatype");module.exports=interface("JSONDataType",DataType,["from"])},{"../datatype":34,"util/interface":263}],38:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Bytes=_dereq_("../bytes");module.exports=interface("JSON",Bytes,["get","diff","apply"])},{"../bytes":33,"util/interface":263}],39:[function(_dereq_,module){var SessionImpl=_dereq_("session/session-impl"),DataTypes=_dereq_("data/datatypes"),Metadata=_dereq_("metadata/metadata"),Topics=_dereq_("./topics/topics"),TopicSelectors=_dereq_("./selectors/topic-selectors"),ErrorReport=_dereq_("services/error-report"),ClientControl=_dereq_("services/control/client-control-options"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),log=_dereq_("util/logger");log.setLevel("SILENT");var logger=log.create("Diffusion"),diffusion={version:"5.8.0",build:"0_01#39360",log:function(level){log.setLevel(level)},connect:function(options){function onClose(reason){logger.debug("Session closed",reason),session.off({connect:onConnect,close:onClose}),emitter.error(reason)}function onConnect(session){logger.info("Session connected",session.toString()),session.off({connect:onConnect,close:onClose}),emitter.emit("connect",session)}var sessionImpl=new SessionImpl(options),session=sessionImpl.get(),emitter=new Emitter,r=new Result(emitter);return session.on({connect:onConnect,close:onClose}),sessionImpl.connect(),r},datatypes:DataTypes,selectors:TopicSelectors,metadata:Metadata,topics:Topics,errorReport:ErrorReport,clients:ClientControl};module.exports=diffusion},{"./selectors/topic-selectors":279,"./topics/topics":281,"data/datatypes":90,"events/emitter":95,"events/result":96,"metadata/metadata":119,"services/control/client-control-options":159,"services/error-report":183,"session/session-impl":239,"util/logger":264}],40:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],ErrorReport=interface("ErrorReport",["message","line","column"]);module.exports=ErrorReport},{"util/interface":263}],41:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("Result",["then"])},{"util/interface":263}],42:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("Stream",["on","off"])},{"util/interface":263}],43:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("Subscription",Stream,["selector","asType","view","transform","close"])},{"./stream":42,"util/interface":263}],44:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("TypedSubscription",Stream,["selector","close"])},{"./stream":42,"util/interface":263}],45:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("View",Stream,["get"])},{"./stream":42,"util/interface":263}],46:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],ClientControl=interface("ClientControl",["getSessionProperties","setSessionPropertiesListener","SessionEventType"]);ClientControl.SessionPropertiesListener=interface("SessionPropertiesListener",["onActive","onClose","onSessionOpen","onSessionEvent","onSessionClose"]),module.exports=ClientControl},{"util/interface":263}],47:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Messages=interface("Messaging",["send","listen","addHandler"]);Messages.MessageStream=interface("MessageStream"),Messages.MessageHandler=interface("MessageHandler",["onMessage","onActive","onClose"]),Messages.Priority={NORMAL:0,HIGH:1,LOW:2},Messages.Message={},Messages.SessionMessage={},module.exports=Messages},{"util/interface":263}],48:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],SystemPrincipal=interface("SystemPrincipal",["name","roles"]),Role=interface("Role",["name","global","default","topic","inherits"]),SecurityConfiguration=interface("SecurityConfiguration",["named","anonymous","roles"]),SystemAuthenticationConfiguration=interface("SystemAuthenticationConfiguration",["principals","anonymous"]),SecurityScriptBuilder=interface("SecurityScriptBuilder",["build","setRolesForAnonymousSessions","setRolesForNamedSessions","setGlobalPermissions","setDefaultTopicPermissions","removeTopicPermissions","setTopicPermissions","setRoleIncludes"]),SystemAuthenticationScriptBuilder=interface("SystemAuthenticationScriptBuilder",["build","assignRoles","addPrincipal","setPassword","verifyPassword","removePrincipal","allowAnonymousConnections","denyAnonymousConnections","abstainAnonymousConnections"]),Security=interface("Security",["getPrincipal","changePrincipal","getSecurityConfiguration","getSystemAuthenticationConfiguration","updateSecurityStore","updateAuthenticationStore","securityScriptBuilder","authenticationScriptBuilder"]);Security.SecurityScriptBuilder=SecurityScriptBuilder,Security.SystemAuthenticationScriptBuilder=SystemAuthenticationScriptBuilder,Security.SecurityConfiguration=SecurityConfiguration,Security.SystemAuthenticationConfiguration=SystemAuthenticationConfiguration,Security.Role=Role,Security.SystemPrincipal=SystemPrincipal,module.exports=Security},{"util/interface":263}],49:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports.TopicControl=interface("TopicControl",["add","remove","removeWithSession","update","registerUpdateSource","addMissingTopicHandler"]),module.exports.MissingTopicHandler=interface("MissingTopicHandler",["onMissingTopic","onRegister","onClose","onError"]),module.exports.MissingTopicNotification=interface("MissingTopicNotification",["path","selector","sessionID","proceed","cancel"]),module.exports.TopicUpdateHandler=interface("TopicUpdateHandler",["onRegister","onActive","onStandBy","onClose"]),module.exports.Updater=interface("Updater",["update"]),module.exports.TopicAddFailReason={EXISTS:{id:1,reason:"The topic already exists with the same details"},EXISTS_MISMATCH:{id:2,reason:"The topic already exists, with different details"},INVALID_PATH:{id:3,reason:"The topic path is invalid"},INVALID_DETAILS:{id:4,reason:"The topic details are invalid"},USER_CODE_ERROR:{id:5,reason:"A user supplied class could not be found or instantiated"},TOPIC_NOT_FOUND:{id:6,reason:"A referenced topic could not be found"},PERMISSIONS_FAILURE:{id:7,reason:"Invalid permissions to add a topic at the specified path"},INITIALISE_ERROR:{id:8,reason:"The topic could not be initialised, supplied value may be of the wrong format"},UNEXPECTED_ERROR:{id:9,reason:"An unexpected error occured while creating the topic"}},module.exports.UpdateFailReason={SUCCESS:0,INCOMPATIBLE_UPDATE:1,UPDATE_FAILED:2,INVALID_UPDATER:3,MISSING_TOPIC:4,INVALID_ADDRESS:5,DUPLICATES:6,EXCLUSIVE_UPDATER_CONFLICT:7}},{"util/interface":263}],50:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Topics=interface("Topics",["subscribe","unsubscribe","stream","view"]);module.exports=Topics},{"util/interface":263}],51:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Metadata=interface("Metadata",["String","Integer","Decimal","Stateless","RecordContent"]);Metadata.Stateless=interface("Stateless",[]),Metadata.String=interface("String",["value"]),Metadata.Integer=interface("Integer",["value"]),Metadata.Decimal=interface("Decimal",["value","scale"]),Metadata.RecordContent=interface("RecordContent",["occurs","addRecord","getRecord","getRecords","string","integer","decimal","builder","parse"]),Metadata.RecordContent.Record=interface("Record",["name","occurs","addField","getField","getFields"]),Metadata.RecordContent.Field=interface("MField",["name","type","occurs"]),module.exports=Metadata},{"util/interface":263}],52:[function(_dereq_,module){function connectionActivityMonitorFactory(connection,response){var pingTimeout=response.systemPingPeriod*pingTimeoutFactor;return new ConnectionActivityMonitor(pingTimeout,connection)}var ConnectionActivityMonitor=_dereq_("./connection-activity-monitor"),pingTimeoutFactor=2;module.exports=connectionActivityMonitorFactory},{"./connection-activity-monitor":53}],53:[function(_dereq_,module){function ConnectionActivityMonitor(pingTimeout,connection){var currentTimeout=null;this.onSystemPing=function(){null!==currentTimeout&&(clearTimeout(currentTimeout),currentTimeout=setTimeout(connection.closeIdleConnection.bind(connection),pingTimeout))},this.shutdown=function(){null!==currentTimeout&&(clearTimeout(currentTimeout),currentTimeout=null)},currentTimeout=setTimeout(connection.closeIdleConnection.bind(connection),pingTimeout)}module.exports=ConnectionActivityMonitor},{}],54:[function(_dereq_,module){function SessionActivityMonitor(connectionActivityMonitorFactory){var currentConnectionMonitor=null;this.onNewConnection=function(connection,response){currentConnectionMonitor=connectionActivityMonitorFactory(connection,response)},this.onConnectionClosed=function(){null!==currentConnectionMonitor&&(currentConnectionMonitor.shutdown(),currentConnectionMonitor=null)},this.onSystemPing=function(){null!==currentConnectionMonitor&&currentConnectionMonitor.onSystemPing()}}module.exports={NOOP:{onNewConnection:function(){},onConnectionClosed:function(){},onSystemPing:function(){}},create:function(connectionActivityMonitorFactory){return new SessionActivityMonitor(connectionActivityMonitorFactory)}}},{}],55:[function(_dereq_,module){module.exports.types={UINT:0,INT:1,BYTES:2,STRING:3,ARRAY:4,MAP:5,SEMANTIC:6,SIMPLE:7,FLOAT:7},module.exports.additional={FALSE:20,TRUE:21,NULL:22,UNDEFINED:23,SIMPLE:24,HALF_PRECISION:25,SINGLE_PRECISION:26,DOUBLE_PRECISION:27,BREAK:31},module.exports.tokens={ARRAY_START:"[",ARRAY_END:"]",MAP_START:"{",MAP_END:"}",FIELD:"&",VALUE:"*"}},{}],56:[function(_dereq_,module){function Context(){function tail(){return stack[stack.length-1]}var stack=[{len:-1,type:"root"}];this.push=function(type,len){len=void 0===len?-1:len,stack.push({len:len,type:type})},this.pop=function(){return stack.pop()},this.next=function(){switch(tail().len){case 0:throw new Error("Exceeded expected collection limit");case-1:return;default:return tail().len=tail().len-1}},this.remaining=function(val){if(void 0===val)return 0!==tail().len;tail().len=val},this.type=function(){return tail().type}}module.exports=Context},{}],57:[function(_dereq_,module){(function(Buffer){function decode(token,tokeniser){switch(token.type){case tokens.VALUE:return token.value;case tokens.MAP_START:for(var obj={};;){var field=tokeniser.nextToken();if(null===field)throw new Error("Unexpected EOF (reading: map key)");if(field.type===tokens.MAP_END)break;var value=tokeniser.nextToken();if(null===value||value.type===tokens.MAP_END)throw new Error("Unexpected EOF (reading: map value)");obj[field.value]=decode(value,tokeniser)}return obj;case tokens.ARRAY_START:for(var arr=[];;){var element=tokeniser.nextToken();if(null===element)throw new Error("Unexpected EOF (reading: array value)");if(element.type===tokens.ARRAY_END)break;arr.push(decode(element,tokeniser))}return arr;default:throw new Error("Unexpected token: "+JSON.stringify(token))}}var Tokeniser=_dereq_("cbor/tokeniser"),tokens=_dereq_("cbor/consts").tokens;module.exports=function(initial,offset,length){var tokeniser=Buffer.isBuffer(initial)?new Tokeniser(initial,offset,length):initial;this.hasRemaining=tokeniser.hasRemaining,this.nextValue=function(){if(tokeniser.hasRemaining())return decode(tokeniser.nextToken(),tokeniser);throw new Error("Token stream exhausted")}}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"cbor/consts":55,"cbor/tokeniser":59}],58:[function(_dereq_,module){(function(Buffer){function Encoder(initial){function writeByte(b){bos.write(b)}function writeBuffer(buf,offset,length){offset=offset||0,length=void 0===length?buf.length:length,bos.writeMany(buf,offset,length)}function writeUint16(v){writeByte(v>>8&255),writeByte(255&v)}function writeUint32(v){writeUint16(v>>16&65535),writeUint16(65535&v)}function writeUint64(v){writeUint32(Math.floor(v/4294967296)),writeUint32(v%4294967296)}function writeToken(type,val){var first=type<<5;24>val?writeByte(first|val):256>val?(writeByte(24|first),writeByte(val)):65536>val?(writeByte(25|first),writeUint16(val)):4294967296>val?(writeByte(26|first),writeUint32(val)):(writeByte(27|first),writeUint64(val))}function writeNumber(val){if(val.toString().indexOf(".")>-1){var buf=new Buffer(8);buf.writeDoubleBE(val,0),writeByte(types.SIMPLE<<5|additional.DOUBLE_PRECISION),writeBuffer(buf)}else 0>val?writeToken(types.INT,-1-val):writeToken(types.UINT,val)}function writeString(val){var buf=new Buffer(val,"utf-8");writeToken(types.STRING,buf.length),writeBuffer(buf)}function writeBinary(val,offset,length){length=void 0===length?val.length:length,writeToken(types.BYTES,length),writeBuffer(val,offset,length)}function writeBoolean(val){val?writeToken(types.SIMPLE,additional.TRUE):writeToken(types.SIMPLE,additional.FALSE)}function writeUndefined(){writeToken(types.SIMPLE,additional.UNDEFINED)}function writeNull(){writeToken(types.SIMPLE,additional.NULL)}function writeObject(val){var keys=Object.keys(val);writeToken(types.MAP,keys.length);for(var i=0;i<keys.length;++i)self.encode(keys[i]),self.encode(val[keys[i]])}function writeArray(val){writeToken(types.ARRAY,val.length);for(var i=0;i<val.length;++i)self.encode(val[i])}var bos=initial||new BufferOutputStream,self=this;this.encode=function(value,offset,length){if(null===value)writeNull();else if(void 0===value)writeUndefined();else if(value===!0)writeBoolean(!0);else if(value===!1)writeBoolean(!1);else switch(typeof value){case"string":writeString(value);break;case"number":writeNumber(value);break;case"object":Buffer.isBuffer(value)?writeBinary(value,offset,length):Array.isArray(value)?writeArray(value):writeObject(value)}return self},this.flush=function(){var res=bos.getBuffer();return bos=new BufferOutputStream,res}}var BufferOutputStream=_dereq_("io/buffer-output-stream"),consts=_dereq_("cbor/consts"),additional=consts.additional,types=consts.types;module.exports=Encoder}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"cbor/consts":55,"io/buffer-output-stream":114}],59:[function(_dereq_,module){(function(Buffer){function isValueToken(t){return t===tokens.VALUE||t===tokens.MAP_END||t===tokens.ARRAY_END}function Tokeniser(data,offset,length){function readValue(header){switch(header.type){case types.UINT:return readHeaderValue(header);case types.INT:return-1-readHeaderValue(header);case types.BYTES:return readBuffer(readHeaderValue(header));case types.STRING:return readBuffer(readHeaderValue(header)).toString("utf-8");case types.SIMPLE:return readSimpleValue(header.raw)}}function readSimpleValue(type){switch(type){case additional.TRUE:return!0;case additional.FALSE:return!1;case additional.NULL:return null;case additional.BREAK:return BREAK_FLAG;case additional.HALF_PRECISION:return readFloat16();case additional.SINGLE_PRECISION:return readFloat32();case additional.DOUBLE_PRECISION:return readFloat64()}}function readByte(){if(pos<data.length)return data[pos++];throw new Error("Exhausted token stream")}function readBuffer(len){var buf=new Buffer(len);return data.copy(buf,0,pos,pos+=len),buf}function readUint16(){var res=data.readUInt16BE(pos);return pos+=2,res}function readUint32(){var res=data.readUInt32BE(pos);return pos+=4,res}function readUint64(){return 4294967296*readUint32()+readUint32()}function readFloat16(){var h=readUint16(),f=1023&h,s=(32768&h)>>15,e=(31744&h)>>10,sign=s?-1:1;if(0===e)return sign*Math.pow(2,-14)*(f/Math.pow(2,10));if(31===e)return f?0/0:1/0*sign;return sign*Math.pow(2,e-15)*(1+f/Math.pow(2,10))}function readFloat32(){var res=data.readFloatBE(pos);return pos+=4,res}function readFloat64(){var res=data.readDoubleBE(pos);return pos+=8,res}function readHeader(){var header=readByte();return{type:header>>5,raw:31&header}}function readHeaderValue(header){var low=header.raw;if(24>low)return low;if(low===additional.SIMPLE)return readByte();if(low===additional.HALF_PRECISION)return readUint16();if(low===additional.SINGLE_PRECISION)return readUint32();if(low===additional.DOUBLE_PRECISION)return readUint64();if(low===additional.BREAK)return BREAK_FLAG}function readCollectionLength(header){var l=readHeaderValue(header);if(l===BREAK_FLAG)return-1;return l}length=void 0===length?data.length:length;var token,context=new Context,self=this,pos=offset||0;this.reset=function(){context=new Context,token=void 0,pos=offset||0},this.hasRemaining=function(){var ctx=context.type(),len="root"===ctx?length:length+1;return len>pos},this.nextToken=function(){if(!self.hasRemaining())return null;var ctx=context.type(),p=pos;if(("object"===ctx||"array"===ctx)&&(context.remaining()&&isValueToken(token)&&context.next(),!context.remaining()))return token="object"===ctx?tokens.MAP_END:tokens.ARRAY_END,context.pop(),{pos:p,type:token};var value,header=readHeader();switch(header.type){case types.INT:case types.UINT:case types.FLOAT:case types.BYTES:case types.STRING:case types.SIMPLE:token="object"===ctx&&token!==tokens.FIELD?tokens.FIELD:tokens.VALUE,value=readValue(header);break;case types.ARRAY:context.push("array",readCollectionLength(header)),token=tokens.ARRAY_START;break;case types.MAP:context.push("object",readCollectionLength(header)),token=tokens.MAP_START;break;default:throw new Error("Unkown CBOR header type: "+header.type)}if(value===BREAK_FLAG)return context.remaining(0),self.nextToken();return{pos:p,type:token,value:value}}}var Context=_dereq_("./context"),consts=_dereq_("./consts"),additional=consts.additional,tokens=consts.tokens,types=consts.types,BREAK_FLAG=new Error;module.exports=Tokeniser}).call(this,_dereq_("buffer").Buffer)},{"./consts":55,"./context":56,buffer:2}],60:[function(_dereq_,module){module.exports={COMMUNICATION_FAILURE:{id:100,reason:"Communication with server failed"},SESSION_CLOSED:{id:101,reason:"Session is closed"},REQUEST_TIME_OUT:{id:102,reason:"Request time out"},ACCESS_DENIED:{id:103,reason:"Access denied"},TOPIC_TREE_REGISTRATION_CONFLICT:{id:200,reason:"A conflicting, pre-existing registration exists on the same branch of the topic tree"}}},{}],61:[function(_dereq_,module){function InternalSession(conversationSet,serviceRegistry,connectionFactory,opts){function close(reason){fsm.change("closed")?(conversationSet.discardAll(reason),emitter.close(reason)):log.debug("Unable to handle session close, session state: ",fsm.state)}function replaceConversationSet(err){conversationSet.replace(err)}var sessionID,token,sessionActivityMonitor,emitter=Emitter.assign(this),principal="",fsm=FSM.create("initialising",{initialising:["connecting"],connecting:["connected","closing"],connected:["disconnected","closing"],disconnected:["reconnecting","closing"],reconnecting:["connected","closing"],closing:["closed"],closed:[]});fsm.on("change",function(previous,current){log.info("State changed: "+previous+" -> "+current)});var self=this;this.getState=function(){return fsm.state},this.getConversationSet=function(){return conversationSet},this.isConnected=function(){return"connected"===fsm.state},this.getServiceRegistry=function(){return serviceRegistry},this.getSessionId=function(){return sessionID},this.setPrincipal=function(newPrincipal){principal=newPrincipal},this.checkConnected=function(emitter){return self.isConnected()?!0:(emitter.error(new Error("The session is not connected. Operations are not possible at this time.")),!1)};var transports=Transports.create();transports.on({"transport-selected":function(name){emitter.emit("transport-selected",name)},cascade:function(){emitter.emit("cascade")}});var connection=connectionFactory.create(Aliases.create(),transports,opts.reconnect.timeout,256),serviceAdapter=new ServiceAdapter(this,serialisers,connection.send),serviceLocator=new ServiceLocator(this,serialisers,serviceAdapter),topicCache=new TopicCache(DataTypes),topicStreamRegistry=new StreamRegistry(topicCache),topicRouting=new TopicRouting(serviceAdapter,topicCache,topicStreamRegistry);serviceRegistry.addListener(serviceAdapter.addService);var attempts=0,reconnect=function(opts){if(fsm.change("reconnecting")){log.info("Reconnect attempt ("+ ++attempts+")");var request=ConnectionRequest.reconnect(token,connection.getAvailableSequence(),connection.lastReceivedSequence);connection.connect(request,opts,opts.reconnect.timeout)}else log.debug("Unable to attempt reconnect, session state: ",fsm.state)},abort=function(reason){fsm.change("closing")?(log.debug("Aborting reconnect"),close(reason||CloseReason.RECONNECT_ABORTED)):log.debug("Unable to abort reconnect, session state: ",fsm.state)};this.connect=function(){if(fsm.change("connecting")){var reconnectTimeout,request=ConnectionRequest.connect();
connection.on("data",topicRouting.route),connection.on("close",close),sessionActivityMonitor=opts.activityMonitor?sessionActivityMonitorModule.create(connectionActivityMonitorFactory):sessionActivityMonitorModule.NOOP,connection.on("disconnect",function(reason){log.debug("Connection disconnected, reason: ",reason),fsm.change("disconnected")||"reconnecting"===fsm.state?(sessionActivityMonitor.onConnectionClosed(),opts.reconnect.timeout>0&&reason.canReconnect?(opts.token=token,"disconnected"===fsm.state&&(emitter.emit("disconnect",reason),reconnectTimeout=setTimeout(function(){"connected"!==fsm.state&&abort(CloseReason.CONNECTION_TIMEOUT)},opts.reconnect.timeout)),opts.reconnect.strategy(curry(reconnect,opts),abort,reason)):abort(reason)):fsm.change("closing")?close(reason):(sessionActivityMonitor.onConnectionClosed(),log.debug("Unable to handle session disconnect, session state: ",fsm.state))}),connection.on("connect",function(response){fsm.change("connected")?(token=response.token,response.response===ResponseCode.OK?(sessionID=response.identity,sessionActivityMonitor.onNewConnection(connection,response),emitter.emit("connect",response.identity)):(response.response===ResponseCode.RECONNECTED||response.response===ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS)&&(clearTimeout(reconnectTimeout),response.response===ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS?(connection.resetSequences(),replaceConversationSet(new Error("Peer is disconnected")),log.info("Reconnected session, but messages may have been lost")):log.info("Reconnected session"),sessionActivityMonitor.onNewConnection(connection,response),emitter.emit("reconnect"))):log.trace("Unknown connection response: ",response)}),log.debug("Connecting with options:",opts),log.trace("Connecting with request:",request);try{connection.connect(request,opts)}catch(e){log.warn("Connection error",e),emitter.emit("error",e),fsm.change("closing")&&close(CloseReason.CONNECTION_ERROR)}opts.principal&&(principal=opts.principal)}else log.warn("Unable to connect, session state: ",fsm.state),emitter.emit("error",new Error("Unable to connect, session state: "+fsm.state))},this.close=function(){fsm.change("closing")?(sessionActivityMonitor.onConnectionClosed(),connection.close(CloseReason.CLOSED_BY_CLIENT)):log.debug("Unable to close, session state: ",fsm.state)},this.getServiceLocator=function(){return serviceLocator},this.getServiceAdapter=function(){return serviceAdapter},this.getPrincipal=function(){return principal},this.getStreamRegistry=function(){return topicStreamRegistry},this.getRouting=function(){return topicRouting},this.onSystemPing=function(){sessionActivityMonitor.onSystemPing()}}var Emitter=_dereq_("events/emitter"),sessionActivityMonitorModule=_dereq_("activity/session-activity-monitor"),ServiceAdapter=_dereq_("client/service-adapter"),ServiceLocator=_dereq_("client/service-locator"),StreamRegistry=_dereq_("routing/stream-registry"),TopicRouting=_dereq_("routing/topic-routing"),TopicCache=_dereq_("routing/topic-cache"),DataTypes=_dereq_("data/datatypes"),serialisers=_dereq_("services/serialisers"),ConnectionRequest=_dereq_("protocol/connection-request"),ResponseCode=_dereq_("protocol/response-code"),CloseReason=_dereq_("v4-stack/close-reason"),Transports=_dereq_("transports/transports"),Aliases=_dereq_("v4-stack/aliases"),log=_dereq_("util/logger").create("Internal Session"),curry=(_dereq_("../../options"),_dereq_("util/function").curry),FSM=_dereq_("util/fsm"),connectionActivityMonitorFactory=_dereq_("activity/connection-activity-monitor-factory");module.exports=InternalSession},{"../../options":277,"activity/connection-activity-monitor-factory":52,"activity/session-activity-monitor":54,"client/service-adapter":62,"client/service-locator":63,"data/datatypes":90,"events/emitter":95,"protocol/connection-request":125,"protocol/response-code":128,"routing/stream-registry":129,"routing/topic-cache":134,"routing/topic-routing":135,"services/serialisers":203,"transports/transports":255,"util/fsm":261,"util/function":262,"util/logger":264,"v4-stack/aliases":271,"v4-stack/close-reason":272}],62:[function(_dereq_,module){function ServiceAdapter(internalSession,serialisers,sender){function sendMessage(header,command,serialiser){var msg=Message.create({type:Message.types.DELTA,topic:"@"});headerSerialiser.write(msg,header),serialiser.write(msg,command),log.trace("Sending command request: "+header,command),sender(msg)}function handleRequest(header,input){var listener=listeners[header.service];if(listener)log.trace("Received command request for service: "+header),listener(header,input);else{log.error("Received command request for unknown service: "+header);var error=new CommandError(type.COMMUNICATION_FAILURE,"Unknown client service: "+header.service);sendMessage(header.createErrorHeader(),error,errorSerialiser)}}function handleResponse(header,input){log.trace("Received command response: "+header),conversations.respond(header.cid,input)}function handleError(header,input){var error=errorSerialiser.read(input);log.warn("Command Error received",error.message),conversations.discard(header.cid,new Error(error.message))}var headerSerialiser=serialisers.get(CommandHeader),errorSerialiser=serialisers.get(CommandError),conversations=internalSession.getConversationSet(),listeners={};this.send=sendMessage,this.addService=function(definition,service){if(void 0!==listeners[definition.id])throw new Error("Service already exists for "+definition);var requestSerialiser=serialisers.get(definition.request),responseSerialiser=serialisers.get(definition.response);listeners[definition.id]=function(header,input){var request=requestSerialiser.read(input),callback={respond:function(response){var rHeader=header.createResponseHeader();sendMessage(rHeader,response,responseSerialiser)},fail:function(error){var eHeader=header.createErrorHeader();sendMessage(eHeader,error,errorSerialiser)}};try{service.onRequest(internalSession,request,callback)}catch(e){throw new Error("Unable to handle request for "+definition.id,e)}}},this.onMessage=function(data){var header=headerSerialiser.read(data);switch(header.mode){case mode.REQUEST:handleRequest(header,data);break;case mode.RESPONSE:handleResponse(header,data);break;case mode.ERROR:handleError(header,data);break;default:throw new Error("Unknown Command Header mode"+header.mode)}}}var CommandHeader=_dereq_("services/command-header"),CommandError=_dereq_("services/command-error"),Message=_dereq_("v4-stack/message"),mode=CommandHeader.modes,type=CommandError.ErrorType,log=_dereq_("util/logger").create("Service Adapter");module.exports=ServiceAdapter},{"services/command-error":156,"services/command-header":158,"util/logger":264,"v4-stack/message":276}],63:[function(_dereq_,module){function ServiceLocator(internalSession,serialisers,serviceAdapter){var conversations=internalSession.getConversationSet();this.obtain=function(service){var pending=[],requestSerialiser=serialisers.get(service.request),responseSerialiser=serialisers.get(service.response),reference={send:function(req,callback){callback=callback||defaultCB;var handler={onOpen:function(cid){var header=new CommandHeader(mode.REQUEST,service.id,cid);serviceAdapter.send(header,req,requestSerialiser),pending.push(cid)},onResponse:function(cid,input){try{var response=responseSerialiser.read(input);return callback(null,response),remove(pending,cid),!0}catch(e){throw e.message=internalSession.getSessionId()+" failed to process response for service '"+service.name+"' cid=<"+cid+"> : "+e.message,e}},onDiscard:function(cid,err){remove(pending,cid),callback(err)}},cid=conversations["new"](handler,callback);return function(){conversations.discard(cid,"cancelled")}},close:function(){pending.forEach(conversations.discard),pending=[]}};return reference}}var CommandHeader=_dereq_("services/command-header"),mode=CommandHeader.prototype.mode,remove=(_dereq_("util/logger").create("Service Locator"),function(arr,e){var i=arr.indexOf(e);i>-1&&arr.splice(i,1)}),defaultCB=function(){};module.exports=ServiceLocator},{"services/command-header":158,"util/logger":264}],64:[function(_dereq_,module){function ServiceRegistry(){var services=new HashMap,listeners=[];this.get=function(definition){return services.get(definition)},this.add=function(definition,service){if(services.has(definition))throw new Error("Service already exists for "+definition);services.set(definition,service),listeners.forEach(function(listener){listener(definition,service)})},this.addListener=function(listener){listeners.push(listener),services.forEach(function(k,v){listener(v,k)})}}var HashMap=_dereq_("hashmap");module.exports=ServiceRegistry},{hashmap:7}],65:[function(_dereq_,module){var service={onRequest:function(internal,ping,callback){callback.respond(),internal.onSystemPing()}};module.exports=service},{}],66:[function(_dereq_,module){var service={onRequest:function(internal,request,callback){callback.respond(),internal.getRouting().subscribe(request.info)}};module.exports=service},{}],67:[function(_dereq_,module){var service={onRequest:function(internal,notification,callback){callback.respond(),internal.getRouting().unsubscribe(notification.id,notification.reason)}};module.exports=service},{}],68:[function(_dereq_,module){var service={onRequest:function(internal,ping,callback){callback.respond()}};module.exports=service},{}],69:[function(_dereq_,module){module.exports={RECORD_DELIMITER:1,FIELD_DELIMITER:2,EMPTY_FIELD:3,RECORD_MU:4,FIELD_MU:5}},{}],70:[function(_dereq_,module){var BufferInputStream=_dereq_("io/buffer-input-stream"),RecordContent=_dereq_("./record-content"),consts=_dereq_("content/consts");module.exports=function(buffer){var records=[];if(1===buffer.length&&buffer[0]===consts.RECORD_MU)records.push(new RecordContent.Record([]));else if(buffer.length>0){for(var bis=new BufferInputStream(buffer);bis.hasRemaining();){for(var rbis=new BufferInputStream(bis.readUntil(consts.RECORD_DELIMITER)),fields=[];rbis.hasRemaining();){var field=rbis.readUntil(consts.FIELD_DELIMITER);fields.push(0===field.length||1===field.length&&(0===fields.length&&field[0]===consts.FIELD_MU||field[0]===consts.EMPTY_FIELD)?void 0:field.toString())}var rbuffer=rbis.buffer;rbuffer[rbuffer.length-1]===consts.FIELD_DELIMITER&&fields.push(void 0),records.push(new RecordContent.Record(fields))}buffer[buffer.length-1]===consts.RECORD_DELIMITER&&records.push(new RecordContent.Record([]))}return new RecordContent(records)}},{"./record-content":71,"content/consts":69,"io/buffer-input-stream":113}],71:[function(_dereq_,module){var consts=_dereq_("content/consts"),RecordContent=function(records){this.length=records.length,this.get=function(i){return i=i||0,records[i]},this.records=function(){return records.concat([])},this.forEach=function(iterator){records.forEach(iterator)},this.toString=function(){return records.join(consts.RECORD_DELIMITER)}};RecordContent.Record=function(fields){this.length=fields.length,this.get=function(i){return i=i||0,fields[i]},this.fields=function(){return fields.concat([])},this.forEach=function(iterator){fields.forEach(iterator)},this.toString=function(){return fields.join(consts.FIELD_DELIMITER)}},module.exports=RecordContent},{"content/consts":69}],72:[function(_dereq_,module){var BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Codec=_dereq_("io/codec"),util=_dereq_("content/util"),Encoding={NONE:0,ENCRYPTED:1,COMPRESSED:2};module.exports={read:function(bis){var encoding=BEES.read(bis,Encoding),bytes=Codec.readBytes(bis);switch(encoding){case Encoding.NONE:return bytes;default:throw new Error("Unable to handle encoding type "+encoding)}},write:function(bos,content){BEES.write(bos,Encoding.NONE),Codec.writeBytes(bos,util.getBytes(content))}}},{"content/util":76,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],73:[function(_dereq_,module){function insertFields(record,fn,fields){if(fields)for(var field in fields){var value=fields[field];if(value instanceof Array)for(var i=0;i<value.length;++i)fn.call(record,field,value[i],i);else fn.call(record,field,value)}}var implements=_dereq_("util/interface")["implements"],api=_dereq_("../../../content/record-content"),RecordContent=_dereq_("content/structured-record-content/record-content"),RecordRecordBuilder=implements(api.Builder.Record,function(meta){var fields={};this.add=function(name,value){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name  '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),!(-1===mfield.occurs.max||fields[name].length<mfield.occurs.max))throw new Error("Field '"+name+"' can only occur up to "+mfield.occurs.max+" times");return fields[name].push(value),this},this.set=function(name,value,index){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),index=index||0,void 0===fields[name][index])throw new Error("Cannot set nonexistent field '"+name+'" ('+index+")");return fields[name][index]=value,this},this.build=function(){var $fields={};return meta.getFields().forEach(function(mfield){var field=mfield.name;$fields[field]=[],void 0===fields[field]&&(fields[field]=[]);for(var i=fields[field].length;i<mfield.occurs.min;++i)fields[field].push(mfield.type.value);$fields[field]=fields[field]}),new RecordContent.Record($fields)}}),RecordBuilder=implements(api.Builder,function(meta){var records={};this.add=function(name,fields){var mrecord=meta.getRecord(name);if(mrecord){if(void 0===records[name]&&(records[name]=[]),-1===mrecord.occurs.max||records[name].length<mrecord.occurs.max){var record=new RecordRecordBuilder(mrecord);return records[name].push(record),insertFields(record,record.add,fields),record}throw new Error("Record '"+name+"' can only occur up to "+mrecord.occurs.max+" times")}throw new Error("Invalid record name '"+name+"'")},this.set=function(name,fields,index){var mrecord=meta.getRecord(name);if(mrecord){if(void 0===records[name]&&(records[name]=[]),index=index||0,void 0!==records[name][index]){var record=records[name][index];return insertFields(record,record.set,fields),record}throw new Error("Cannot set nonexistent record "+name+'" ('+index+")")}throw new Error("Invalid record name '"+name+"'")},this.build=function(){var $records={};return meta.getRecords().forEach(function(mrecord){var record=mrecord.name;$records[record]=[],void 0===records[record]&&(records[record]=[]);for(var i=records[record].length;i<mrecord.occurs.min;++i)records[record].push(new RecordRecordBuilder(mrecord));for(var j=0;j<records[record].length;++j)$records[record].push(records[record][j].build())}),new RecordContent($records)},this.addAndBuild=function(name,value){return this.add(name,value),this.build()},this.setAndBuild=function(name,fields,index){return this.set(name,fields,index),this.build()}});module.exports=RecordBuilder},{"../../../content/record-content":29,"content/structured-record-content/record-content":75,"util/interface":263}],74:[function(_dereq_,module){function Reader(set){var pos=0;this.readUpTo=function(occurs,fn){var max=Math.min(pos+(-1===occurs.max?set.length:occurs.max),set.length);if(0===set.length)return;if(occurs.min>set.length-pos)throw new Error("Data exhaused while parsing");for(var i=pos;max>i;++i)fn(set[i]);pos=max}}function RecordContentMetadataParser(metadata){this.parse=function(buffer){var content=parseAsRecordContent(buffer),reader=new Reader(content.records()),$records={};return metadata.getRecords().forEach(function(mrecord){var records=[];reader.readUpTo(mrecord.occurs,function(record){var reader=new Reader(record.fields()),$fields={};mrecord.getFields().forEach(function(mfield){var fields=[];reader.readUpTo(mfield.occurs,function(field){fields.push(field?mfield.type.parse(field):field)}),$fields[mfield.name]=fields}),records.push(new RecordContent.Record($fields))}),$records[mrecord.name]=records}),new RecordContent($records)}}var parseAsRecordContent=_dereq_("content/record-content/parser"),RecordContent=_dereq_("content/structured-record-content/record-content");module.exports=RecordContentMetadataParser},{"content/record-content/parser":70,"content/structured-record-content/record-content":75}],75:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],api=_dereq_("../../../content/record-content"),StructuredRecordContent=implements(api,function(records){var inlined=[];for(var k in records)inlined=inlined.concat(records[k]);this.get=function(name,index){if(index=index||0,records[name])return records[name][index];return void 0},this.records=function(name){if(records[name])return records[name].concat([]);return inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}});StructuredRecordContent.Record=implements(api.Record,function(fields){var inlined=[];for(var k in fields)inlined=inlined.concat(fields[k]);this.get=function(name,index){if(index=index||0,fields[name])return fields[name][index];return void 0},this.fields=function(name){if(fields[name])return fields[name].concat([]);return inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}}),module.exports=StructuredRecordContent},{"../../../content/record-content":29,"util/interface":263}],76:[function(_dereq_,module){(function(Buffer){function getDefaultContentBytes(content){return new Buffer(content.toString())}function getRecordContentBytes(content){var bos=new BufferOutputStream,recordDelimiter=!1;return content.forEach(function(r){var fieldDelimiter=!1;recordDelimiter?bos.writeInt8(consts.RECORD_DELIMITER):recordDelimiter=!0,r.forEach(function(f){fieldDelimiter?bos.writeInt8(consts.FIELD_DELIMITER):fieldDelimiter=!0,bos.writeString(f.toString())})}),bos.getBuffer()}function isRecordContent(content){return RC.isPrototypeOf(content)||SRC.isPrototypeOf(content)}function getBytes(content){return content.$buffer?content.$buffer.slice(content.$offset,content.$length):isRecordContent(content)?getRecordContentBytes(content):getDefaultContentBytes(content)}var BufferOutputStream=(_dereq_("io/codec"),_dereq_("io/buffer-output-stream")),RC=_dereq_("content/record-content/record-content"),SRC=_dereq_("content/structured-record-content/record-content"),consts=_dereq_("content/consts");module.exports={getBytes:getBytes,isRecordContent:isRecordContent}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"content/consts":69,"content/record-content/record-content":71,"content/structured-record-content/record-content":75,"io/buffer-output-stream":114,"io/codec":115}],77:[function(_dereq_,module){var ControlGroup=_dereq_("control/control-group"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var name=Codec.readString(input);return new ControlGroup(name)},write:function(output,group){Codec.writeString(output,group.name)}};module.exports=serialiser},{"control/control-group":78,"io/codec":115}],78:[function(_dereq_,module){function ControlGroup(name){this.name=name}ControlGroup.DEFAULT=new ControlGroup("default"),module.exports=ControlGroup},{}],79:[function(_dereq_,module){function responseHandler(internal,adapter,deregistration){var close,state=ResponseHandlerState.REGISTERING;return{onDiscard:function(cid,err){adapter.close(err),state=ResponseHandlerState.CLOSED},onOpen:function(cid){close=function(){var emitter=new Emitter,result=new Result(emitter);return state!==ResponseHandlerState.CLOSED?deregistration(cid,function(err){err?(internal.getConversationSet().discard(cid,err),emitter.error(err)):(internal.getConversationSet().respond(cid,ResponseHandlerState.CLOSED),emitter.emit("complete"))}):emitter.error(new Error("Handler already closed")),result}},onResponse:function(cid,response){switch(response){case ResponseHandlerState.ACTIVE:return adapter.active(close),state=response,!1;case ResponseHandlerState.CLOSED:return adapter.close(),state=response,!0;default:return adapter.respond(response)}}}}function registrationCallback(conversationSet,cid,emitter){return function(err){err?(conversationSet.discard(cid,err),emitter.error(err)):(conversationSet.respond(cid,ResponseHandlerState.ACTIVE),emitter.emit("complete"))}}function registerHandler(internal,params,adapter,reg,dereg){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),registration=serviceLocator.obtain(reg),deregistration=serviceLocator.obtain(dereg),cid=conversationSet["new"](responseHandler(internal,adapter,function(cid,callback){deregistration.send(params,callback)})),emitter=new Emitter,result=new Result(emitter);return registration.send({params:params,cid:cid},registrationCallback(conversationSet,cid,emitter)),result}var Services=_dereq_("services/services"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),ResponseHandlerState={REGISTERING:0,ACTIVE:1,CLOSED:2};module.exports.responseHandler=responseHandler,module.exports.registrationCallback=registrationCallback,module.exports.registerMessageHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.MESSAGE_RECEIVER_CONTROL_REGISTRATION,Services.MESSAGE_RECEIVER_CONTROL_DEREGISTRATION)},module.exports.registerServerHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.SERVER_CONTROL_REGISTRATION,Services.SERVER_CONTROL_DEREGISTRATION)},module.exports.registerTopicHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.TOPIC_CONTROL_REGISTRATION,Services.TOPIC_CONTROL_DEREGISTRATION)},module.exports.ResponseHandlerState=ResponseHandlerState},{"events/emitter":95,"events/result":96,"services/services":204}],80:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ConversationId=_dereq_("conversation/conversation-id"),CIDSerialiser={read:function(input){return new ConversationId(Codec.readInt64(input))},write:function(out,cid){Codec.writeInt64(out,cid.val)}};module.exports=CIDSerialiser},{"conversation/conversation-id":81,"io/codec":115}],81:[function(_dereq_,module){function ConversationId(val){this.val=val}var Long=_dereq_("long");ConversationId.prototype.toString=function(){return this.val.toString(10)},ConversationId.prototype.toValue=function(){return this.toString()},ConversationId.fromString=function(val){return new ConversationId(Long.fromString(val,!1))},module.exports=ConversationId},{"long":10}],82:[function(_dereq_,module){function create(globalError){function discard(cid,err){var conversation=conversations.get(cid.toString());conversation&&(conversations.remove(cid.toString()),conversation.discard(cid,err))}var conversations=new HashMap,bulkhead=function(set,handler,error,cb){return function(cid){try{return fn.callWithArguments(cb,arguments)}catch(e){return discard(cid,e),void error(e)}}};return{"new":function(handler,error){var cid=nextCID(),set=this;error=error||globalError;var conversation=new Conversation({onOpen:bulkhead(set,handler,error,handler.onOpen),onResponse:bulkhead(set,handler,error,handler.onResponse),onDiscard:bulkhead(set,handler,error,handler.onDiscard)});return conversations.set(cid.toString(),conversation),conversation.open(cid),cid},respond:function(cid,r1,r2){var conversation=conversations.get(cid.toString()),response="NON_EXISTENT";switch(conversation&&(response=conversation.respond(cid,r1,r2)),response){case"NON_EXISTENT":globalError(cid,response);break;case"ALREADY_FINISHED":globalError(cid,response);break;case"HANDLED_AND_ACTIVE":break;case"HANDLED_AND_FINISHED":conversations.remove(cid.toString())}},discard:discard,discardAll:function(err){conversations.forEach(function(conversation,cid){discard(ConversationId.fromString(cid),err)}),conversations.clear()},size:function(){return conversations.count()}}}var HashMap=_dereq_("hashmap"),Long=_dereq_("long"),ConversationId=_dereq_("conversation/conversation-id"),Conversation=_dereq_("conversation/conversation"),fn=_dereq_("util/function"),nextCID=(_dereq_("util/logger").create("Conversation Set"),function(){var id=new Long(0);return function(){return id=id.add(1),new ConversationId(id)}}());module.exports=create},{"conversation/conversation":83,"conversation/conversation-id":81,hashmap:7,"long":10,"util/function":262,"util/logger":264}],83:[function(_dereq_,module){function Conversation(handler){this.handler=handler}Conversation.prototype.open=function(cid){this.handler.onOpen(cid)},Conversation.prototype.respond=function(cid,r1,r2){var close=void 0===r2?this.handler.onResponse(cid,r1):this.handler.onResponse(cid,r1,r2);return close?"HANDLED_AND_FINISHED":"HANDLED_AND_ACTIVE"},Conversation.prototype.discard=function(cid,err){this.handler.onDiscard(cid,err)},module.exports=Conversation},{}],84:[function(_dereq_,module){function assign(self,set){for(var m in set)self[m]=set[m]}var conversationSet=_dereq_("conversation/conversation-set");module.exports=function(globalErrorHandler){var current=conversationSet(globalErrorHandler),self=this;assign(self,current),this.replace=function(err){var old=current;current=conversationSet(globalErrorHandler),assign(self,current),old.discardAll(err)}}},{"conversation/conversation-set":82}],85:[function(_dereq_,module){(function(Buffer){var implements=_dereq_("util/interface")["implements"],BinaryDataType=_dereq_("../../../data/binary/binary-datatype"),BinaryDeltaSupportImpl=_dereq_("data/binary/binary-delta-support-impl"),BinaryDeltaImpl=_dereq_("data/binary/binary-delta-impl"),BinaryImpl=_dereq_("data/binary/binary-impl");module.exports=implements(BinaryDataType,function(){function internalValue(val){if(BinaryImpl.isPrototypeOf(val))return val;if(Buffer.isBuffer(val))return self.readValue(val);throw new Error("Unable to read Binary value from: "+val)}var self=this,binaryDeltaSupport=new BinaryDeltaSupportImpl(this,internalValue);this.name=function(){return"binary"},this.from=function(val){return internalValue(val)},this.readValue=function(buffer,offset,length){return new BinaryImpl(self,buffer,offset,length)},this.writeValue=function(binary){return binary=internalValue(binary),binary.$buffer.slice(binary.$offset,binary.$offset+binary.$length)},this.deltaType=function(context){if(!context)return binaryDeltaSupport;if("string"==typeof context)switch(context.toLowerCase()){case"binary":return binaryDeltaSupport}else if(BinaryDeltaImpl.isPrototypeOf(context))return binaryDeltaSupport;throw new Error("Unknown delta type: "+context)}})}).call(this,_dereq_("buffer").Buffer)},{"../../../data/binary/binary-datatype":30,buffer:2,"data/binary/binary-delta-impl":86,"data/binary/binary-delta-support-impl":87,"data/binary/binary-impl":88,"util/interface":263}],86:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],BinaryDelta=_dereq_("../../../data/binary/binary-delta"),util=_dereq_("data/util");module.exports=implements(BinaryDelta,function(buffer,offset,length){util.assignInternals(this,buffer,offset,length),this.hasChanges=function(){return 1!==length}})},{"../../../data/binary/binary-delta":31,"data/util":94,"util/interface":263}],87:[function(_dereq_,module){(function(Buffer){function replace(value){return encoder.encode(value.$buffer,value.$offset,value.$length),new BinaryDeltaImpl(encoder.flush())}function cborCost(i){if(24>i)return 1;if(255>i)return 2;if(65535>=i)return 3;return 5}var implements=_dereq_("util/interface")["implements"],DeltaType=_dereq_("../../../data/delta-type"),BufferOutputStream=_dereq_("io/buffer-output-stream"),BinaryDeltaImpl=_dereq_("data/binary/binary-delta-impl"),binaryDiff=_dereq_("data/diff/myers-binary-diff"),Decoder=_dereq_("cbor/decoder"),Encoder=_dereq_("cbor/encoder"),encoder=new Encoder,NO_CHANGE=new BinaryDeltaImpl(new Buffer([-10]),0,1);module.exports=implements(DeltaType,function(datatype,internalValue){var self=this;this.name=function(){return"binary"},this.diff=function(oldValue,newValue){function blowsBudget(cost){return(budget-=cost)<=0}oldValue=internalValue(oldValue),newValue=internalValue(newValue);var buffer=newValue.$buffer,offset=newValue.$offset,length=newValue.$length,budget=length,script={insert:function(bStart,length){if(blowsBudget(length+cborCost(length)))return binaryDiff.REPLACE;return encoder.encode(buffer,offset+bStart,length),binaryDiff.SUCCESS},match:function(aStart,length){if(blowsBudget(cborCost(aStart)+cborCost(length)))return binaryDiff.REPLACE;return encoder.encode(aStart),encoder.encode(length),binaryDiff.SUCCESS}},result=binaryDiff(oldValue.$buffer,oldValue.$offset,oldValue.$length,buffer,offset,length,script),delta=encoder.flush();switch(result){case binaryDiff.REPLACE:return replace(newValue);case binaryDiff.NO_CHANGE:return NO_CHANGE;default:return self.readDelta(delta)}},this.apply=function(oldValue,delta){if(oldValue=internalValue(oldValue),!delta||!delta.hasChanges())return oldValue;for(var decoder=new Decoder(delta.$buffer),bos=new BufferOutputStream;decoder.hasRemaining();){var start=decoder.nextValue();Buffer.isBuffer(start)?bos.writeMany(start):"number"==typeof start&&bos.writeMany(oldValue.$buffer,oldValue.$offset+start,decoder.nextValue())}return datatype.readValue(bos.getBuffer())},this.readDelta=function(buffer,offset,length){var delta=new BinaryDeltaImpl(buffer,offset,length);if(1===delta.$length&&buffer[delta.$offset]===NO_CHANGE.$buffer[0])return NO_CHANGE;return delta},this.writeDelta=function(delta){return delta.$buffer.slice(delta.$offset,delta.$offset+delta.$length)},this.noChange=function(){return NO_CHANGE},this.isValueCheaper=function(value,delta){return value.$length<=delta.$length}}),module.exports.NO_CHANGE=NO_CHANGE}).call(this,_dereq_("buffer").Buffer)},{"../../../data/delta-type":36,buffer:2,"cbor/decoder":57,"cbor/encoder":58,"data/binary/binary-delta-impl":86,"data/diff/myers-binary-diff":91,"io/buffer-output-stream":114,"util/interface":263}],88:[function(_dereq_,module){{var implements=_dereq_("util/interface")["implements"],BinaryType=_dereq_("../../../data/binary/binary"),BytesImpl=_dereq_("data/bytes-impl");_dereq_("data/util")}module.exports=implements(BinaryType,function(datatype,buffer,offset,length){BytesImpl.__constructor.call(this,buffer,offset,length);var self=this;this.get=function(){return buffer.slice(self.$offset,self.$offset+self.$length)},this.diff=function(original,type){return type=type||"binary",datatype.deltaType(type).diff(original,self)},this.apply=function(delta){return datatype.deltaType(delta).apply(self,delta)},this.toString=function(){return"Binary <"+self.$length+" bytes> "+self.get().toString()}})},{"../../../data/binary/binary":32,"data/bytes-impl":89,"data/util":94,"util/interface":263}],89:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],Bytes=_dereq_("../../data/bytes"),util=_dereq_("data/util");module.exports=implements(Bytes,function(buffer,offset,length){util.assignInternals(this,buffer,offset,length);var self=this;this.length=function(){return self.$length},this.asBuffer=function(){return buffer},this.copyTo=function(target,tOffset){tOffset=tOffset||0,buffer.copy(target,tOffset,self.$offset,self.$offset+self.$length)}})},{"../../data/bytes":33,"data/util":94,"util/interface":263}],90:[function(_dereq_,module){(function(Buffer){var implements=_dereq_("util/interface")["implements"],DataTypes=_dereq_("../../data/datatypes"),TopicType=_dereq_("../../topics/topics").TopicType,BinaryDataTypeImpl=_dereq_("data/binary/binary-datatype-impl"),BinaryImpl=_dereq_("data/binary/binary-impl"),JSONDataTypeImpl=_dereq_("data/json/json-datatype-impl"),JSONImpl=_dereq_("data/json/json-impl"),DataTypesImpl=implements(DataTypes,function(){var binary=new BinaryDataTypeImpl,json=new JSONDataTypeImpl,self=this;this.binary=function(){return binary},this.json=function(){return json},this.get=function(name){switch(typeof name){case"string":switch(name.toLowerCase()){case"json":return self.json();case"binary":return self.binary()}break;case"object":if(name===TopicType.BINARY||BinaryImpl.isPrototypeOf(name)||Buffer.isBuffer(name))return self.binary();if(name===TopicType.JSON||JSONImpl.isPrototypeOf(name)||name.constructor===Object)return self.json()
}return null}});module.exports=new DataTypesImpl}).call(this,_dereq_("buffer").Buffer)},{"../../data/datatypes":35,"../../topics/topics":281,buffer:2,"data/binary/binary-datatype-impl":85,"data/binary/binary-impl":88,"data/json/json-datatype-impl":92,"data/json/json-impl":93,"util/interface":263}],91:[function(_dereq_,module){function keyF(k){return 0>k?-4*k-1:4*k}function keyR(k){return keyF(k)+2}function getF(k){var i=storage[keyF(k)];return void 0===i?0:i}function getR(k){var i=storage[keyR(k)];return void 0===i?0:i}function setF(k,i){storage[keyF(k)]=i}function setR(k,i){storage[keyR(k)]=i}function nextF(k,d){if(k===d)return getF(k-1);if(k===-d)return getF(k+1)+1;var left=getF(k+1),right=getF(k-1);return right>left?right:left+1}function nextR(k,d){if(k===-d)return getR(k+1);if(k===d)return getR(k-1)-1;var left=getR(k+1),right=getR(k-1);return right>left?left:right-1}function exceedsStorage(d){return d>storageLimit}function calculateBailOutLimit(l1,l2,bailOutFactor){return bailOutFactor*approximateSquareRoot(l1+l2)}function checkBounds(buffer,offset,length){if(0>offset)throw new Error("offset "+offset+" < 0");if(0>length)throw new Error("length "+length+" < 0");if(offset+length>buffer.length||0>offset+length)throw new Error("offset "+offset+" + "+length+" > "+buffer.length)}function Execution(a,b,script,bailOutLimit){var self=this;this.diff=function(aOffset,aLength,bOffset,bLength){checkBounds(a,aOffset,aLength),checkBounds(b,bOffset,bLength);for(var x=0,y=0;aLength>x&&bLength>y&&a[aOffset+x]===b[bOffset+y];)++x,++y;for(var u=aLength,v=bLength;u>x&&v>y&&a[aOffset+u-1]===b[bOffset+v-1];)--u,--v;var r1=script.match(aOffset,x);if(r1!==SUCCESS)return r1;var r2;if(r2=x===u?script.insert(bOffset+y,v-y):y===v?script["delete"](aOffset+x,u-x):self.middleSnake(aOffset+x,u-x,bOffset+y,v-y),r2!==SUCCESS)return r2;return script.match(aOffset+u,aLength-u)},this.middleSnake=function(aOffset,aLength,bOffset,bLength){var delta=aLength-bLength,odd=1&delta;setF(-1,0),setR(1,aLength);for(var d=0;;){for(var k1=-d;d>=k1;k1+=2){for(var x1=nextF(k1,d),u1=x1;aLength>u1&&bLength>u1+k1&&a[aOffset+u1]===b[bOffset+u1+k1];)++u1;if(setF(k1,u1),odd&&d>1&&Math.abs(k1+delta)<=d-1&&u1>=getR(k1+delta))return self.recurse(aOffset,aLength,bOffset,bLength,x1,u1,k1)}for(var k2=-d;d>=k2;k2+=2){for(var u2=nextR(k2,d),x2=u2,kd=k2-delta;x2>0&&x2+kd>0&&a[aOffset+x2-1]===b[bOffset+x2+kd-1];)--x2;if(setR(k2,x2),!odd&&d>0&&Math.abs(kd)<=d&&x2<=getF(kd))return self.recurse(aOffset,aLength,bOffset,bLength,x2,u2,kd)}if(d>bailOutLimit)return REPLACE;if(++d,exceedsStorage(d))return REPLACE}},this.recurse=function(aOffset,aLength,bOffset,bLength,x,u,k){var r1=self.diff(aOffset,x,bOffset,x+k);if(r1!==SUCCESS)return r1;var r2=script.match(aOffset+x,u-x);if(r2!==SUCCESS)return r2;return self.diff(aOffset+u,aLength-u,bOffset+u+k,bLength-u-k)}}function coalesce(delegate,aOffset,bOffset){function flushPending(){return neverFlushed&=pending===NOOP,pending(delegate,pendingStart,pendingLength)}function process(op,start,length){if(length>0)if(pending!==op){var r=flushPending();if(r!==SUCCESS)return r;pending=op,pendingStart=start,pendingLength=length}else pendingLength+=length;return SUCCESS}var neverFlushed=!0,pendingLength=0,pendingStart=0,pending=NOOP;return{insert:function(bStart,length){return process(INSERT,bStart-bOffset,length)},match:function(aStart,length){return process(MATCH,aStart-aOffset,length)},"delete":function(){var r=flushPending();return pending=NOOP,r},close:function(aLength){if(neverFlushed){if(pending===INSERT)return REPLACE;if(0===pendingStart&&pendingLength===aLength)return NO_CHANGE}return flushPending()}}}var approximateSquareRoot=_dereq_("util/math").approximateSquareRoot,BAIL_OUT_FACTOR=10,SUCCESS=0,REPLACE=1,NO_CHANGE=2,storageLimit=536870911,storage=[],INSERT=function(script,start,length){return script.insert(start,length)},MATCH=function(script,start,length){return script.match(start,length)},NOOP=function(){return SUCCESS};module.exports=function(a,aOffset,aLength,b,bOffset,bLength,editScript,bailOutFactor){void 0===bailOutFactor&&(bailOutFactor=BAIL_OUT_FACTOR);var script=coalesce(editScript,aOffset,bOffset),execution=new Execution(a,b,script,calculateBailOutLimit(aLength,bLength,bailOutFactor)),result=execution.diff(aOffset,aLength,bOffset,bLength);if(result!==SUCCESS)return result;return script.close(aLength,bLength)},module.exports.SUCCESS=SUCCESS,module.exports.REPLACE=REPLACE,module.exports.NO_CHANGE=NO_CHANGE},{"util/math":265}],92:[function(_dereq_,module){(function(Buffer){var implements=_dereq_("util/interface")["implements"],JSONDataType=_dereq_("../../../data/json/json-datatype"),BinaryDeltaSupportImpl=_dereq_("data/binary/binary-delta-support-impl"),BinaryDeltaImpl=_dereq_("data/binary/binary-delta-impl"),JSONImpl=_dereq_("data/json/json-impl"),Encoder=_dereq_("cbor/encoder");module.exports=implements(JSONDataType,function(){function internalValue(val){return JSONImpl.isPrototypeOf(val)?val:self.readValue(Buffer.isBuffer(val)?val:encoder.encode(val).flush())}var encoder=new Encoder,self=this,binaryDeltaSupport=new BinaryDeltaSupportImpl(this,internalValue);this.name=function(){return"json"},this.from=function(val){return internalValue(val)},this.readValue=function(buffer,offset,length){return new JSONImpl(self,buffer,offset,length)},this.writeValue=function(json){return json=internalValue(json),json.$buffer.slice(json.$offset,json.$offset+json.$length)},this.deltaType=function(context){if(!context)return binaryDeltaSupport;if("string"==typeof context)switch(context.toLowerCase()){case"binary":return binaryDeltaSupport}else if(BinaryDeltaImpl.isPrototypeOf(context))return binaryDeltaSupport;throw new Error("Unknown delta type: "+context)}})}).call(this,_dereq_("buffer").Buffer)},{"../../../data/json/json-datatype":37,buffer:2,"cbor/encoder":58,"data/binary/binary-delta-impl":86,"data/binary/binary-delta-support-impl":87,"data/json/json-impl":93,"util/interface":263}],93:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],BytesImpl=_dereq_("data/bytes-impl"),Decoder=_dereq_("cbor/decoder"),JSONType=_dereq_("../../../data/json/json");module.exports=implements(JSONType,function(datatype,buffer,offset,length){BytesImpl.__constructor.call(this,buffer,offset,length);var self=this;this.get=function(){var decoder=new Decoder(buffer,offset,length);return decoder.nextValue()},this.diff=function(original,type){return type=type||"binary",datatype.deltaType(type).diff(original,self)},this.apply=function(delta){return datatype.deltaType(delta).apply(self,delta)},this.toString=function(){return JSON.stringify(self.get())}})},{"../../../data/json/json":38,"cbor/decoder":57,"data/bytes-impl":89,"util/interface":263}],94:[function(_dereq_,module){module.exports.assignInternals=function(self,buffer,offset,length){self.$buffer=buffer,self.$offset=offset||0,self.$length=void 0===length?buffer.length:length}},{}],95:[function(_dereq_,module){(function(process){function Emitter(e,fn,events){var listeners={},listener=function(){},closed=!1,emit=function(event,args){args=args||[];var dispatch=function(listener){functions.callWithArguments(listener,args)};process.nextTick(function(){listeners[event]&&listeners[event].forEach(dispatch)}),listener(event,args)},publicEmit=function(event){if(closed||!event)return;var args=array.argumentsToArray(arguments);args.shift(),emit(event,args)},error=function(reason){emit("error",[reason]),close()},close=function(reason){if(closed)return;closed=!0,emit("close",[reason])},stream=new Stream(listeners,error,close,events);void 0!==e&&stream.on(e,fn),this.listen=function(fn){listener=fn},this.get=function(){return stream},this.close=close,this.error=error,this.emit=publicEmit,this.assign=function(instance){for(var k in stream)instance[k]=stream[k]}}var functions=_dereq_("util/function"),array=_dereq_("util/array"),Stream=_dereq_("events/stream");Emitter.assign=function(instance){var emitter=new Emitter,s=emitter.get();for(var k in s)instance[k]=s[k];return emitter},module.exports=Emitter}).call(this,_dereq_("FWaASH"))},{FWaASH:6,"events/stream":97,"util/array":260,"util/function":262}],96:[function(_dereq_,module){function ResultImpl(emitter){var promise=when.promise(function(fulfilled,rejected){emitter.listen(function(e,args){"error"===e?rejected(args[0]):fulfilled(args[0])})});this.then=function(fulfillment,rejected,partial){return promise=promise.then(fulfillment,rejected,partial)}}var implements=_dereq_("util/interface")["implements"],when=(_dereq_("util/function"),_dereq_("when")),Result=_dereq_("../../events/result");module.exports=implements(Result,ResultImpl)},{"../../events/result":41,"util/function":262,"util/interface":263,when:28}],97:[function(_dereq_,module){function attach(object,key,value,allowedEvents){if("object"==typeof key)for(var k in key)attach(object,k,key[k],allowedEvents);else if(value){if(void 0===object[key]){if(allowedEvents&&-1===allowedEvents.indexOf(key))throw new Error("Event "+key+" not emitted on this stream, allowed events are "+allowedEvents);object[key]=[]}object[key].push(value)}return object}function remove(object,key,value){if("object"==typeof key)for(var k in key)remove(object,k,key[k]);else object[key]&&(object[key]=value?object[key].filter(function(e){return e!==value}):[]);return object}function StreamImpl(listeners,error,close,events){var allowedEvents;events&&(allowedEvents=["close","error","complete"].concat(events)),this.on=function(event,fn){return attach(listeners,event,fn,allowedEvents),this},this.off=function(event,fn){return remove(listeners,event,fn),this},this.close=function(reason){return close(reason),this},this.error=function(reason){return error(reason),this}}var implements=_dereq_("util/interface")["implements"],Stream=_dereq_("../../events/stream");module.exports=implements(Stream,StreamImpl)},{"../../events/stream":42,"util/interface":263}],98:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],Services=_dereq_("services/services"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),SessionID=_dereq_("session/session-id"),responseHandler=_dereq_("control/registration").responseHandler,registrationCallback=_dereq_("control/registration").registrationCallback,api=_dereq_("../../features/client-control"),SessionPropertiesEventType=(_dereq_("util/array"),_dereq_("services/control/client-control-options"),_dereq_("services/control/session-properties-event-type")),logger=_dereq_("util/logger").create("Session.Clients");module.exports=implements(api,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),getProperties=serviceLocator.obtain(Services.GET_SESSION_PROPERTIES),registration=serviceLocator.obtain(Services.SESSION_PROPERTIES_REGISTRATION_2);internal.getServiceRegistry().add(Services.SESSION_PROPERTIES_EVENT_2,{onRequest:function(internal,message,callback){conversationSet.respond(message.cid,message),callback.respond()}}),this.SessionEventType={UPDATED:0,RECONNECTED:1,FAILED_OVER:2,DISCONNECTED:3},this.getSessionProperties=function(sid,propertyKeys){var emitter=new Emitter,result=new Result(emitter);return"string"==typeof sid&&(sid=SessionID.fromString(sid)),internal.checkConnected(emitter)&&getProperties.send({sessionID:sid,propertyKeys:propertyKeys},function(err,result){err?emitter.error(err):null===result?emitter.error(new Error("Invalid session ID")):emitter.emit("complete",sid,result.properties)}),result},this.setSessionPropertiesListener=function(requiredProperties,handler){var emitter=new Emitter,result=new Result(emitter);if(handler||emitter.error(new Error("Session Properties listener is null or undefined")),internal.checkConnected(emitter)){logger.debug("Adding Session Properties Listener");var adapter={active:function(close){logger.debug("Session Properties Listener active"),handler.onActive(close)},respond:function(message){for(var i=0;i<message.events.length;++i){var event=message.events[i];switch(event.type){case SessionPropertiesEventType.OPEN:handler.onSessionOpen(event.sessionId,event.oldProperties);break;case SessionPropertiesEventType.UPDATE:handler.onSessionEvent(event.sessionId,event.updateType,event.newProperties,event.oldProperties);break;case SessionPropertiesEventType.CLOSE:handler.onSessionClose(event.sessionId,event.oldProperties,event.closeReason);break;default:logger.debug("Unknown event type received for session properties listener",event.type)}}},close:function(){logger.debug("Session Properties Listener closed"),handler.onClose()}},cid=conversationSet["new"](responseHandler(internal,adapter,function(cid,callback){registration.send({cid:cid},callback)}));registration.send({cid:cid,properties:requiredProperties},registrationCallback(conversationSet,cid,emitter))}return result}})},{"../../features/client-control":46,"control/registration":79,"events/emitter":95,"events/result":96,"services/control/client-control-options":159,"services/control/session-properties-event-type":174,"services/services":204,"session/session-id":238,"util/array":260,"util/interface":263,"util/logger":264}],99:[function(_dereq_,module){function createSendOptions(options){return options=options||{},options.headers=options.headers||[],options.priority=options.priority||0,options}function MessageStream(e,selector){this.selector=selector,e.assign(this)}function parseSessionId(str){try{var sid=SessionId.fromString(str);return sid}catch(err){return!1}}var topicSelectorParser=_dereq_("topics/topic-selector-parser"),implements=_dereq_("util/interface")["implements"],Services=_dereq_("services/services"),ConversationId=_dereq_("conversation/conversation-id"),SessionId=_dereq_("session/session-id"),ControlGroup=_dereq_("control/control-group"),registration=_dereq_("control/registration"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),api=_dereq_("../../features/messages"),arrays=_dereq_("util/array"),logger=_dereq_("util/logger").create("Session.Messages"),dummyCID=ConversationId.fromString("0");module.exports=implements(api,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),sender=serviceLocator.obtain(Services.SEND),sessionSender=serviceLocator.obtain(Services.SEND_TO_SESSION),filterSender=serviceLocator.obtain(Services.SEND_TO_FILTER),streams=[];internal.getServiceRegistry().add(Services.SEND,{onRequest:function(internal,message,callback){callback.respond(),streams.forEach(function(stream){stream.l.selector.selects(message.path)&&stream.e.emit("message",message)})}}),internal.getServiceRegistry().add(Services.SEND_RECEIVER_CLIENT,{onRequest:function(internal,message,callback){callback.respond(),conversationSet.respond(message.cid,message)}}),this.addHandler=function(path,handler,keys){var emitter=new Emitter,result=new Result(emitter);if(!path)return emitter.error(new Error("Message Handler path is null or undefined")),result;if(!handler)return emitter.error(new Error("Message Handler is null or undefined")),result;if(internal.checkConnected(emitter)){logger.debug("Adding message handler",path);var params={definition:Services.SEND_RECEIVER_CLIENT,group:ControlGroup.DEFAULT,path:path,keys:void 0!==keys?keys:{}},adapter={active:function(close){logger.debug("Message handler active",path),handler.onActive(close)},respond:function(response){logger.debug("Message handler response",path);var message={session:response.sender.toString(),content:response.message,options:response.options},properties=response.sessionProperties;return properties&&Object.keys(properties).length>0&&(message.properties=properties),handler.onMessage(message),!1},close:function(){logger.debug("Message handler closed",path),handler.onClose()}};return registration.registerMessageHandler(internal,params,adapter)}return result},this.listen=function(path,cb){var emitter=new Emitter(void 0,void 0,["message"]),selector=topicSelectorParser(path),stream=new MessageStream(emitter,selector),ref={l:stream,e:emitter};return stream.on("close",function(){arrays.remove(streams,ref)}),cb&&cb instanceof Function&&stream.on("message",cb),streams.push(ref),stream},this.send=function(path,message,options,recipient){var emitter=new Emitter,result=new Result(emitter),sendCallback=function(err){err?(logger.debug("Message send failed",path),emitter.error(err)):(logger.debug("Message send complete",path),emitter.emit("complete",{path:path,recipient:recipient}))};if(options&&"string"==typeof options?(recipient=options,options=createSendOptions()):options=createSendOptions(options),internal.checkConnected(emitter)){if(!path)return emitter.error(new Error("Message path is null or undefined")),result;if(void 0===message||null===message)return emitter.error(new Error("Message content is null or undefined")),result;var request;if(recipient){var session=parseSessionId(recipient);session?(request={path:path,content:message,session:session,options:options,cid:dummyCID},logger.debug("Sending message to session",request),sessionSender.send(request,sendCallback)):(request={path:path,content:message,filter:recipient,options:options,cid:dummyCID},logger.debug("Sending message to filter",request),filterSender.send(request,sendCallback))}else request={path:path,content:message,options:options},logger.debug("Sending message to server",request),sender.send(request,sendCallback)}return result}})},{"../../features/messages":47,"control/control-group":78,"control/registration":79,"conversation/conversation-id":81,"events/emitter":95,"events/result":96,"services/services":204,"session/session-id":238,"topics/topic-selector-parser":251,"util/array":260,"util/interface":263,"util/logger":264}],100:[function(_dereq_,module){var CHANGE_PRINCIPAL=_dereq_("services/services").CHANGE_PRINCIPAL,GET_SECURITY_CONFIGURATION=_dereq_("services/services").GET_SECURITY_CONFIGURATION,UPDATE_SECURITY_CONFIGURATION=_dereq_("services/services").UPDATE_SECURITY_CONFIGURATION,GET_SYSTEM_AUTHENTICATION=_dereq_("services/services").GET_SYSTEM_AUTHENTICATION,UPDATE_SYSTEM_AUTHENTICATION=_dereq_("services/services").UPDATE_SYSTEM_AUTHENTICATION,Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),SecurityCommandScript=_dereq_("services/authentication/security-command-script"),SecurityScriptBuilder=(_dereq_("services/authentication/security-command-script-result"),_dereq_("features/security/security-script-builder")),AuthenticationScriptBuilder=_dereq_("features/security/system-authentication-script-builder"),implements=_dereq_("util/interface")["implements"],api=_dereq_("../../features/security"),requireNonNull=_dereq_("util/require-non-null"),log=_dereq_("util/logger").create("Session.Security"),GlobalPermission={AUTHENTICATE:0,VIEW_SESSION:1,MODIFY_SESSION:2,REGISTER_HANDLER:3,VIEW_SERVER:4,CONTROL_SERVER:5,VIEW_SECURITY:6,MODIFY_SECURITY:7},TopicPermission={READ_TOPIC:0,UPDATE_TOPIC:1,MODIFY_TOPIC:2,SEND_TO_MESSAGE_HANDLER:3,SEND_TO_SESSION:4,SELECT_TOPIC:5},SecurityConfiguration=implements(api.SecurityConfiguration,{__constructor:function(anonymous,named,roles){this.anonymous=anonymous,this.named=named,this.roles=roles},toString:function(){return"SecurityConfiguration [anonymous="+this.anonymous+", named="+this.named+", roles="+this.roles+"]"}}),SystemAuthentication=implements(api.SystemAuthenticationConfiguration,{__constructor:function(principals,action,roles){this.principals=principals||[],this.anonymous={action:action,roles:roles||[]}},toString:function(){return"SystemAuthenticationConfiguration [principals="+this.principals+", anonymous="+this.anonymous+"]"}});SystemAuthentication.CONNECTION_ACTION={ALLOW:{id:0,value:"allow"},DENY:{id:1,value:"deny"},ABSTAIN:{id:2,value:"abstain"},fromString:function(val){return this[val.toUpperCase()]}};var SystemPrincipal=implements(api.SystemPrincipal,{__constructor:function(name,roles){this.name=requireNonNull(name),this.roles=roles||[]},toString:function(){return"SystemPrincipal ["+this.name+", "+this.roles+"]"}}),Security=implements(api,function(internal){var changePrincipal=internal.getServiceLocator().obtain(CHANGE_PRINCIPAL),getConfiguration=internal.getServiceLocator().obtain(GET_SECURITY_CONFIGURATION),getSystemAuthentication=internal.getServiceLocator().obtain(GET_SYSTEM_AUTHENTICATION),updateSystemAuthentication=internal.getServiceLocator().obtain(UPDATE_SYSTEM_AUTHENTICATION),updateSecurityConfiguration=internal.getServiceLocator().obtain(UPDATE_SECURITY_CONFIGURATION);this.getPrincipal=function(){return internal.getPrincipal()},this.changePrincipal=function(principal,credentials){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Changing principal",principal),changePrincipal.send({principal:principal,credentials:credentials},function(err,response){err?emitter.error(err):response?(internal.setPrincipal(principal),emitter.emit("complete")):emitter.error(new Error("Unable to change principal due to authentication failure"))})),result},this.getSecurityConfiguration=function(){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Getting security configuration"),getConfiguration.send(null,function(err,response){err?emitter.error(err):emitter.emit("complete",response)})),result},this.getSystemAuthenticationConfiguration=function(){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Getting system authentication"),getSystemAuthentication.send(null,function(err,response){err?emitter.error(err):emitter.emit("complete",response)})),result};var updateStoreCallback=function(err,result,emitter){err?emitter.error(err):result.errors.length>0?emitter.error(result.errors):emitter.emit("complete")},updateStore=function(updater,script){var emitter=new Emitter,result=new Result(emitter);return""===script?emitter.emit("complete"):script&&"string"==typeof script?internal.checkConnected(emitter)&&updater.send(new SecurityCommandScript(script),function(err,result){updateStoreCallback(err,result,emitter)}):emitter.error(new Error("Invalid argument for script:"+script)),result};this.updateSecurityStore=function(script){return log.debug("Updating security store"),updateStore(updateSecurityConfiguration,script)},this.updateAuthenticationStore=function(script){return log.debug("Updating authentication store"),updateStore(updateSystemAuthentication,script)},this.securityScriptBuilder=function(script){return new SecurityScriptBuilder(script)},this.authenticationScriptBuilder=function(script){return new AuthenticationScriptBuilder(script)}});module.exports.GlobalPermission=GlobalPermission,module.exports.TopicPermission=TopicPermission,module.exports.Security=Security,module.exports.SystemPrincipal=SystemPrincipal,module.exports.Configuration=SecurityConfiguration,module.exports.SystemAuthentication=SystemAuthentication},{"../../features/security":48,"events/emitter":95,"events/result":96,"features/security/security-script-builder":101,"features/security/system-authentication-script-builder":102,"services/authentication/security-command-script":150,"services/authentication/security-command-script-result":148,"services/services":204,"util/interface":263,"util/logger":264,"util/require-non-null":269}],101:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],util=_dereq_("features/security/util"),api=_dereq_("../../../features/security"),requireNonNull=_dereq_("util/require-non-null"),permissionsToString=util.permissionsToString,quoteAndEscape=util.quoteAndEscape,rolesToString=util.rolesToString,SecurityScriptBuilder=implements(api.SecurityScriptBuilder,function(commands){commands=commands||"";var withCommand=function(command){if(commands)return new SecurityScriptBuilder(commands+"\n"+command);return new SecurityScriptBuilder(command)};this.build=function(){return commands},this.toString=function(){return"ConfigurationScriptBuilder ["+commands+"]"},this.setRolesForAnonymousSessions=function(roles){return withCommand("set roles for anonymous sessions "+rolesToString(requireNonNull(roles,"roles")))},this.setRolesForNamedSessions=function(roles){return withCommand("set roles for named sessions "+rolesToString(requireNonNull(roles,"roles")))},this.setGlobalPermissions=function(role,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.setDefaultTopicPermissions=function(role,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" default topic permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.removeTopicPermissions=function(role,path){return withCommand("remove "+quoteAndEscape(requireNonNull(role,"role"))+" permissions for topic "+quoteAndEscape(requireNonNull(path,"path")))},this.setTopicPermissions=function(role,path,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" topic "+quoteAndEscape(requireNonNull(path,"path"))+" permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.setRoleIncludes=function(role,included){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" includes "+rolesToString(requireNonNull(included,"included roles")))}});module.exports=SecurityScriptBuilder},{"../../../features/security":48,"features/security/util":103,"util/interface":263,"util/require-non-null":269}],102:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],util=_dereq_("features/security/util"),api=_dereq_("../../../features/security"),requireNonNull=_dereq_("util/require-non-null"),quoteAndEscape=util.quoteAndEscape,rolesToString=util.rolesToString,SystemAuthenticationScriptBuilder=implements(api.SystemAuthenticationScriptBuilder,function(commands){commands=commands||"";var withCommand=function(command){if(commands)return new SystemAuthenticationScriptBuilder(commands+"\n"+command);return new SystemAuthenticationScriptBuilder(command)};this.build=function(){return commands},this.toString=function(){return"SystemAuthenticationScriptBuilder ["+commands+"]"},this.assignRoles=function(principal,roles){return withCommand("assign roles "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+rolesToString(requireNonNull(roles,"roles")))},this.addPrincipal=function(principal,password,roles){return roles=roles||[],withCommand("add principal "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password"))+(roles.length?" "+rolesToString(roles):""))},this.setPassword=function(principal,password){return withCommand("set password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.verifyPassword=function(principal,password){return withCommand("verify password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.removePrincipal=function(principal){return withCommand("remove principal "+quoteAndEscape(requireNonNull(principal,"principal")))},this.allowAnonymousConnections=function(roles){return roles=roles||[],withCommand("allow anonymous connections "+rolesToString(roles))},this.denyAnonymousConnections=function(){return withCommand("deny anonymous connections")},this.abstainAnonymousConnections=function(){return withCommand("abstain anonymous connections")}});module.exports=SystemAuthenticationScriptBuilder},{"../../../features/security":48,"features/security/util":103,"util/interface":263,"util/require-non-null":269}],103:[function(_dereq_,module){function quoteAndEscape(str){var escaped="'",i=0;if(str.indexOf("'")<0&&str.indexOf("\\")<0)escaped+=str;else for(;i<str.length;++i){var c=str[i];("'"===c||"\\"===c)&&(escaped+="\\"),escaped+=c}return escaped+="'"}function rolesToString(roles){return"["+roles.map(quoteAndEscape).join(" ")+"]"}function permissionsToString(permissions){return"["+permissions.join(" ")+"]"}module.exports.permissionsToString=permissionsToString,module.exports.quoteAndEscape=quoteAndEscape,module.exports.rolesToString=rolesToString},{}],104:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],Services=_dereq_("services/services"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),ControlGroup=_dereq_("control/control-group"),registerTopicHandler=_dereq_("control/registration").registerTopicHandler,updateResponseHandler=_dereq_("features/update-response-handler"),AddResult=_dereq_("services/add-topic/add-topic-failure-reason"),WillResult=_dereq_("services/wills/will-registration-result"),WillParams=_dereq_("services/wills/topic-will-parameters"),Update=(_dereq_("content/record-content/record-content"),_dereq_("update/update").Update),UniversalUpdater=_dereq_("features/topic-control/universal-updater"),deriveDetails=_dereq_("topics/details/topic-details").deriveDetails,util=_dereq_("metadata/util"),api=_dereq_("../../features/topic-control"),logger=_dereq_("util/logger").create("Session.Topics");module.exports=implements(api.TopicControl,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),ADD_SERVICE=serviceLocator.obtain(Services.ADD_TOPIC),REMOVE_SERVICE=serviceLocator.obtain(Services.REMOVE_TOPIC),UPDATE_SERVICE=serviceLocator.obtain(Services.UPDATE_TOPIC),TOPIC_WILL_REGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_REGISTRATION),TOPIC_WILL_DEREGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_DEREGISTRATION),UPDATE_SOURCE_REGISTRATION=serviceLocator.obtain(Services.UPDATE_SOURCE_REGISTRATION),valueCache={},universalUpdater=new UniversalUpdater(valueCache,internal);internal.getServiceRegistry().add(Services.UPDATE_SOURCE_STATE,{onRequest:function(internal,message,callback){callback.respond(),conversationSet.respond(message.cid,{old:message.old,current:message.current})}}),internal.getServiceRegistry().add(Services.MISSING_TOPIC,{onRequest:function(internal,request,callback){conversationSet.respond(request.cid,{request:request,callback:function(val){callback.respond(val)}})}}),this.add=function(){var path,details,content,emitter=new Emitter,result=new Result(emitter);switch(arguments.length){case 1:path=arguments[0],details=deriveDetails();break;case 2:path=arguments[0],details=deriveDetails(arguments[1]),content=details.content;break;case 3:path=arguments[0],details=deriveDetails(arguments[1]),content=arguments[2];break;default:return emitter.error({id:0,reason:"Incorrect number of parameters supplied to add() function"}),result}return internal.checkConnected(emitter)&&(logger.debug("Adding topic",path),ADD_SERVICE.send({path:path,details:details,content:content},function(err,result){if(err)emitter.error(err);else switch(result.status){case 0:case 1:logger.debug("Topic add complete",path),valueCache[path]=content,emitter.emit("complete",{topic:path,added:!0});break;case 2:result.reason===AddResult.EXISTS?(logger.debug("Topic add complete (already exists)",path),valueCache[path]=content,emitter.emit("complete",{topic:path,added:!1})):(logger.debug("Topic add failed",path),emitter.error(result.reason));break;case 3:emitter.error({id:0,reason:"Cache failure"})}})),result},this.remove=function(path){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(logger.debug("Removing topic",path),REMOVE_SERVICE.send({topic_name:path},function(error){error?(logger.debug("Topic removal failed",path),emitter.error(error)):(logger.debug("Topic removal complete",path),emitter.emit("complete"))})),result},this.removeWithSession=function(path){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Registering removeWithSession",path);var params=new WillParams(path,WillParams.Will.REMOVE_TOPICS);TOPIC_WILL_REGISTRATION.send(params,function(err,result){if(err)logger.debug("removeWithSession registration failed",path),emitter.error(err);
else if(result===WillResult.SUCCESS){logger.debug("removeWithSession registration complete",path);var registered=!0,dEmitter=new Emitter,dResult=new Result(dEmitter),deregister=function(){return registered&&internal.checkConnected(dEmitter)&&(logger.debug("Deregistering removeWithSession",path),TOPIC_WILL_DEREGISTRATION.send(params,function(err){err?dEmitter.error(err):(registered=!1,dEmitter.emit("complete",{topic:path}))})),dResult};emitter.emit("complete",{deregister:deregister})}else logger.debug("removeWithSession registration failed",path),emitter.error(new Error("REGISTRATION_CONFLICT"))})}return result},this.update=function(path,content){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Updating topic",path);var callback=function(error,result){error?(logger.debug("Update failed",path),emitter.error(error)):result.isError?(logger.debug("Update failed",path),emitter.error(result.reason)):(logger.debug("Update complete",path),emitter.emit("complete",path))};util.isMetadataValue(content)?UPDATE_SERVICE.send({path:path,update:new Update(content)},callback):universalUpdater.update(path,content,callback)}return result},this.registerUpdateSource=function(path,handler){var emitter=new Emitter,result=new Result(emitter),conversations=internal.getConversationSet(),cid=conversations["new"](updateResponseHandler(internal,valueCache,path,handler));return internal.checkConnected(emitter)&&UPDATE_SOURCE_REGISTRATION.send({cid:cid,path:path},function(err,state){err||"closed"===state?(conversations.discard(cid,err),emitter.error(err)):(conversations.respond(cid,{old:"init",current:state}),emitter.emit("complete"))}),result},this.addMissingTopicHandler=function(path,handler){var emitter=new Emitter,result=new Result(emitter);if(!handler)return emitter.error(new Error("Missing Topic handler is null or undefined")),result;if(internal.checkConnected(emitter)){var adapter={active:function(close){logger.debug("Missing Topic Handler registered for "+path),handler.onRegister(path,close)},respond:function(response){logger.debug("Missing Topic Handler notification for "+response.request.sessionID+" using "+response.request.selector),handler.onMissingTopic({path:response.request.selector.prefix,selector:response.request.selector,sessionID:response.request.sessionID,proceed:function(){response.callback(!0)},cancel:function(){response.callback(!1)}})},close:function(err){logger.debug("Missing Topic Handler closed for "+path),err?handler.onError(path,err):handler.onClose(path)}},params={definition:Services.MISSING_TOPIC,group:ControlGroup.DEFAULT,path:path};return registerTopicHandler(internal,params,adapter)}return result}})},{"../../features/topic-control":49,"content/record-content/record-content":71,"control/control-group":78,"control/registration":79,"events/emitter":95,"events/result":96,"features/topic-control/universal-updater":105,"features/update-response-handler":112,"metadata/util":124,"services/add-topic/add-topic-failure-reason":143,"services/services":204,"services/wills/topic-will-parameters":234,"services/wills/will-registration-result":236,"topics/details/topic-details":243,"update/update":259,"util/interface":263,"util/logger":264}],105:[function(_dereq_,module){var Services=_dereq_("services/services"),DataTypes=_dereq_("data/datatypes");module.exports=function(valueCache,internal){function dataToBytes(d){return d.$buffer.slice(d.$offset,d.$length)}var DELTA_SERVICE=internal.getServiceLocator().obtain(Services.UPDATE_TOPIC_DELTA),SET_SERVICE=internal.getServiceLocator().obtain(Services.UPDATE_TOPIC_SET);this.update=function(topic,content,callback){var datatype=DataTypes.get(content),value=datatype.from(content);if(valueCache[topic]){var deltaType=datatype.deltaType("binary"),delta=deltaType.diff(valueCache[topic],value);if(delta===deltaType.noChange())return void callback(null,{});DELTA_SERVICE.send({id:0,path:topic,bytes:dataToBytes(delta)},callback)}else SET_SERVICE.send({path:topic,bytes:dataToBytes(value)},callback);valueCache[topic]=value}}},{"data/datatypes":90,"services/services":204}],106:[function(_dereq_,module){var implements=(_dereq_("hashmap"),_dereq_("util/interface")["implements"]),View=(_dereq_("events/result"),_dereq_("features/topics/view")),Services=_dereq_("services/services"),parseSelector=_dereq_("topics/topic-selector-parser"),SubscriptionProxy=_dereq_("features/topics/subscription-proxy"),Topics=(_dereq_("services/serialisers"),_dereq_("../../features/topics")),logger=(_dereq_("util/array"),_dereq_("util/logger").create("Session"));module.exports=implements(Topics,function(internal){var unsubscribe=internal.getServiceLocator().obtain(Services.UNSUBSCRIBE),subscribe=internal.getServiceLocator().obtain(Services.SUBSCRIBE),streamRegistry=internal.getStreamRegistry();this.subscribe=function(topic,callback){logger.debug("Subscribing",topic);var selector=parseSelector(topic),proxy=new SubscriptionProxy(streamRegistry,selector,!1,callback);return internal.checkConnected(proxy.emitter)&&subscribe.send(selector),proxy.subscription},this.unsubscribe=function(topic){logger.debug("Unubscribing",topic),unsubscribe.send(parseSelector(topic))},this.stream=function(topic,callback){logger.debug("Establishing topic stream",topic);var fallback=!1,selector="";topic&&"function"!=typeof topic?selector=parseSelector(topic):(callback=topic,fallback=!0);var proxy=new SubscriptionProxy(streamRegistry,selector,fallback,callback);return proxy.subscription},this.view=function(selector,callback){var s=this.subscribe(selector);return new View(s,callback)}})},{"../../features/topics":50,"events/result":96,"features/topics/subscription-proxy":107,"features/topics/view":111,hashmap:7,"services/serialisers":203,"services/services":204,"topics/topic-selector-parser":251,"util/array":260,"util/interface":263,"util/logger":264}],107:[function(_dereq_,module){var SubscriptionImpl=_dereq_("features/topics/subscription"),Emitter=_dereq_("events/emitter");module.exports=function(registry,selector,fallback,callback){var emitter=new Emitter,stream=emitter.get(),self=this,subscription=new SubscriptionImpl(registry,stream,fallback,selector),pending=!0;stream.on("close",function(){registry.remove(self)}),this.subscription=subscription,this.emitter=emitter,this.selects=function(){return!0},this.onOpen=function(){emitter.emit("open",subscription)},this.onDelta=function(topic,details,value){emitter.emit("update",value,topic)},this.onValue=function(topic,details,value){emitter.emit("update",value,topic)},this.onSubscription=function(topic,details){emitter.emit("subscribe",details,topic)},this.onUnsubscription=function(topic,details,reason){emitter.emit("unsubscribe",reason,topic)},callback?(subscription.on("update",callback),fallback?registry.addFallback(self):registry.add(selector,self)):subscription.on=function(event,fn){return pending&&(fallback?registry.addFallback(self):registry.add(selector,self),pending=!1),stream.on.call(subscription,event,fn)}}},{"events/emitter":95,"features/topics/subscription":108}],108:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],Subscription=_dereq_("../../../events/subscription"),TypedSubscriptionProxy=_dereq_("features/topics/typed-subscription-proxy"),View=_dereq_("features/topics/view"),Emitter=_dereq_("events/emitter"),util=_dereq_("metadata/util");module.exports=implements(Subscription,function SubscriptionImpl(registry,stream,fallback,selector){for(var fn in stream)this[fn]=stream[fn];this.selector=selector;var self=this;this.view=function(){return new View(self)},this.asType=function(datatype,callback){var proxy=new TypedSubscriptionProxy(registry,selector,datatype,fallback,callback);return proxy.subscription},this.transform=function(fn){var e=new Emitter;return fn=util.isMetadata(fn)?fn.parse.bind(fn):fn,self.on("open",function(selector){e.emit("open",selector,self)}),self.on("close",function(){e.emit("close")}),self.on("update",function(update,topic){e.emit("update",fn(update),topic)}),self.on("subscribe",function(details){e.emit("subscribe",details)}),self.on("unsubscribe",function(reason,topic){e.emit("unsubscribe",reason,topic)}),new SubscriptionImpl(registry,e.get(),selector)}})},{"../../../events/subscription":43,"events/emitter":95,"features/topics/typed-subscription-proxy":109,"features/topics/view":111,"metadata/util":124,"util/interface":263}],109:[function(_dereq_,module){var TypedSubscriptionImpl=_dereq_("features/topics/typed-subscription"),TopicType=_dereq_("../../../topics/topics").TopicType,Emitter=_dereq_("events/emitter");module.exports=function(registry,selector,datatype,fallback,callback){var emitter=new Emitter,stream=emitter.get(),self=this,subscription=new TypedSubscriptionImpl(registry,stream,selector),pending=!0;stream.on("close",function(){registry.remove(self)}),this.subscription=subscription,this.emitter=emitter,this.selects=function(details){if(details)return details.type===TopicType[datatype.name().toUpperCase()];return!1},this.onOpen=function(){emitter.emit("open",subscription)},this.onDelta=function(topic,details,received,delta,oldValue,newValue){emitter.emit("value",topic,details,newValue,oldValue)},this.onValue=function(topic,details,received,oldValue,newValue){emitter.emit("value",topic,details,newValue,oldValue)},this.onSubscription=function(topic,details){emitter.emit("subscribe",topic,details)},this.onUnsubscription=function(topic,details,reason){emitter.emit("unsubscribe",topic,details,reason)},callback?(subscription.on("value",callback),fallback?registry.addFallback(self):registry.add(selector,self)):subscription.on=function(event,fn){return pending&&(fallback?registry.addFallback(self):registry.add(selector,self),pending=!1),stream.on.call(subscription,event,fn)}}},{"../../../topics/topics":281,"events/emitter":95,"features/topics/typed-subscription":110}],110:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],TypedSubscription=(_dereq_("features/topics/typed-subscription-proxy"),_dereq_("../../../events/typed-subscription"));module.exports=implements(TypedSubscription,function(registry,stream,selector){for(var fn in stream)this[fn]=stream[fn];this.selector=selector})},{"../../../events/typed-subscription":44,"features/topics/typed-subscription-proxy":109,"util/interface":263}],111:[function(_dereq_,module){function ViewImpl(subscription){var emitter=Emitter.assign(this),data={};subscription.on("update",function(value,topic){for(var parts=topic.split("/"),child=data,i=0;i<parts.length-1;i++)void 0===child[parts[i]]&&(child[parts[i]]={}),child=child[parts[i]];child[parts[i]]=value,emitter.emit("update",data)}),subscription.on("unsubscribe",function(reason,topic){if(2===reason.id){for(var parts=topic.split("/"),child=data,i=0;i<parts.length-1&&void 0!==child[parts[i]];i++)child=child[parts[i]];delete child[parts[i]],emitter.emit("update",data)}}),subscription.on("close",emitter.close),this.get=function(){return data}}var implements=_dereq_("util/interface")["implements"],Emitter=_dereq_("events/emitter"),View=_dereq_("../../../events/view");module.exports=implements(View,ViewImpl)},{"../../../events/view":45,"events/emitter":95,"util/interface":263}],112:[function(_dereq_,module){function dataToBytes(d){return d.$buffer.slice(d.$offset,d.$length)}function Updater(cid,dispatch){var self=this;this.isClosed=!1,this.update=function(topic,value){var emitter=new Emitter,result=new Result(emitter);return self.isClosed?emitter.error(new Error("Updater is closed")):topic?void 0===value||null===value?emitter.error(new Error("Update cannot be null")):dispatch(emitter,cid,topic,value):emitter.error(new Error("Topic can not be null or empty")),result}}var Services=_dereq_("services/services"),DataTypes=_dereq_("data/datatypes"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),Update=_dereq_("update/update"),util=_dereq_("metadata/util");module.exports=function(internal,valueCache,topic,handler){var close,updater,UPDATE_SOURCE_DEREGISTRATION=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_DEREGISTRATION),UPDATE_SOURCE_UPDATE=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_UPDATE),UPDATE_SOURCE_DELTA=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_DELTA),UPDATE_SOURCE_SET=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_SET),dispatch=function(emitter,cid,path,content){var callback=function(err,result){err?emitter.error(err):result.error?emitter.error(new Error("Topic update error for topic "+path+" : "+result.error)):emitter.emit("complete")};if(internal.checkConnected(emitter))if(util.isMetadataValue(content))UPDATE_SOURCE_UPDATE.send({cid:cid,path:path,update:new Update.Update(content)},callback);else{var datatype=DataTypes.get(content),value=datatype.from(content);if(valueCache[path]){var deltaType=datatype.deltaType("binary"),delta=deltaType.diff(valueCache[path],value);if(delta===deltaType.noChange())return void callback(null,{});UPDATE_SOURCE_DELTA.send({id:0,cid:cid,path:path,bytes:dataToBytes(delta)},callback)}else UPDATE_SOURCE_SET.send({cid:cid,path:path,bytes:dataToBytes(value)},callback);valueCache[path]=value}},state="init";return{onOpen:function(cid){close=function(){var emitter=new Emitter,result=new Result(emitter);return UPDATE_SOURCE_DEREGISTRATION.send({cid:cid},function(err){err?(internal.getConversationSet().discard(cid,err),emitter.error(err)):(internal.getConversationSet().respond(cid,{old:state,current:"closed"}),emitter.emit("complete"))}),result}},onResponse:function(cid,change){if(change.old!==state)throw new Error("Inconsistent server/client update source state");switch("init"===state&&"closed"!==change.current&&handler.onRegister(topic,close),updater&&(updater.isClosed=!0),state=change.current){case"active":return updater=new Updater(cid,dispatch),handler.onActive(topic,updater),!1;case"standby":return handler.onStandBy(topic),!1;default:return handler.onClose(topic),!0}},onDiscard:function(cid,reason){state="closed",updater&&(updater.isClosed=!0),handler.onClose(topic,reason)}}}},{"data/datatypes":90,"events/emitter":95,"events/result":96,"metadata/util":124,"services/services":204,"update/update":259}],113:[function(_dereq_,module){function BufferInputStream(buffer){if(null===buffer||void 0===buffer)throw new Error("Undefined buffer for InputStream");this.buffer=buffer,this.count=buffer.length,this.mark=0,this.pos=0}var Long=_dereq_("long");BufferInputStream.prototype.read=function(){return this.pos<this.count?255&this.buffer[this.pos++]:-1},BufferInputStream.prototype.readMany=function(length){if(length=Math.min(length,this.count-this.pos),0>length)throw new Error("Length out of bounds");var buffer=this.buffer.slice(this.pos,this.pos+length);return this.pos+=length,buffer},BufferInputStream.prototype.readUntil=function(delim){for(var found=this.count,i=this.pos;i<this.count;i++)if(this.buffer[i]===delim){found=i;break}var buffer=this.buffer.slice(this.pos,found);return this.pos=found===this.count?found:found+1,buffer},BufferInputStream.prototype.readInt8=function(){return this.buffer.readInt8(this.pos++)},BufferInputStream.prototype.readInt32=function(){var i=this.buffer.readInt32BE(this.pos);return this.pos+=4,i},BufferInputStream.prototype.readInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!1)},BufferInputStream.prototype.readUInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!0)},BufferInputStream.prototype.hasRemaining=function(){return this.pos<this.buffer.length},module.exports=BufferInputStream},{"long":10}],114:[function(_dereq_,module){(function(Buffer){function ensureCapacity(bos,min){min-bos.buffer.length>0&&grow(bos,min)}function grow(bos,minCapacity){var oldCapacity=bos.buffer.length,newCapacity=oldCapacity<<1;0>newCapacity-minCapacity&&(newCapacity=minCapacity);try{var replacement=new Buffer(newCapacity);bos.buffer.copy(replacement),bos.buffer=replacement}catch(e){throw new Error("Unable to resize BufferOutputStream to "+newCapacity)}}function BufferOutputStream(initial){Buffer.isBuffer(initial)?(this.buffer=initial,this.count=initial.length):(this.buffer=new Buffer(initial||32),this.count=0)}BufferOutputStream.prototype.write=function(val){ensureCapacity(this,this.count+1),this.buffer[this.count++]=val},BufferOutputStream.prototype.writeMany=function(buffer,offset,length){offset=offset||0,length=length||buffer.length,ensureCapacity(this,this.count+length),buffer.copy(this.buffer,this.count,offset,offset+length),this.count+=length},BufferOutputStream.prototype.writeString=function(val){var length=Buffer.byteLength(val);ensureCapacity(this,this.count+length),this.buffer.write(val,this.count,length),this.count+=length},BufferOutputStream.prototype.writeInt8=function(val){ensureCapacity(this,this.count+1),this.buffer.writeInt8(val,this.count++)},BufferOutputStream.prototype.writeInt32=function(val){ensureCapacity(this,this.count+4),this.buffer.writeInt32BE(val,this.count),this.count+=4},BufferOutputStream.prototype.writeInt64=function(val){ensureCapacity(this,this.count+8),this.buffer.writeInt32BE(val.getHighBits(),this.count),this.buffer.writeInt32BE(val.getLowBits(),this.count+4),this.count+=8},BufferOutputStream.prototype.getBuffer=function(){return this.buffer.slice(0,this.count)},BufferOutputStream.prototype.getBase64=function(){return this.getBuffer().toString("base64")},module.exports=BufferOutputStream}).call(this,_dereq_("buffer").Buffer)},{buffer:2}],115:[function(_dereq_,module){(function(Buffer){var Long=_dereq_("long"),x80=Long.fromNumber(128),x7F=Long.fromNumber(127),x7FInv=x7F.not(),readOneByte=function(input){var i=input.read();if(-1===i)throw new Error("End of stream");return i},codec={};codec.readInt64=function(input){for(var result=Long.fromNumber(0),shift=0;64>shift;){var i=readOneByte(input),l=Long.fromNumber(i);if(result=result.or(l.and(x7F).shiftLeft(shift)),l.and(x80).equals(0))return result;shift+=7}throw"Malformed int64"},codec.writeInt64=function(bos,value){for(var int64=value instanceof Long?value:Long.fromNumber(value,!1);;){if(int64.and(x7FInv).equals(0))return void bos.write(int64.toInt());bos.write(int64.and(x7F).or(x80).toInt()),int64=int64.shiftRightUnsigned(7)}},codec.readInt32=function(bis){for(var shift=0,result=0;32>shift;){var i=readOneByte(bis);if(result|=(127&i)<<shift,0===(128&i))return result;shift+=7}throw"Malformed int32"},codec.writeInt32=function(bos,value){for(;;){if(0===(-128&value))return void bos.write(value);bos.write(127&value|128),value>>>=7}},codec.writeByte=function(bos,value){bos.writeInt8(value),0!==(-128&value)&&bos.write(1)},codec.readByte=function(bis){var b1=bis.readInt8();if(0===(-128&b1))return b1;var b2=readOneByte(bis);if(1!==b2)throw"Malformed byte";return 128|b1},codec.readBytes=function(bis){var length=codec.readInt32(bis);return bis.readMany(length)},codec.writeBytes=function(bos,value){codec.writeInt32(bos,value.length),bos.writeMany(value)},codec.readString=function(bis){var buffer=codec.readBytes(bis);return buffer?buffer.toString("utf8"):""},codec.writeString=function(bos,value){codec.writeBytes(bos,new Buffer(value,"utf8"))},codec.writeCollection=function(bos,arr,write){codec.writeInt32(bos,arr.length);for(var i=0;i<arr.length;++i)write(bos,arr[i])},codec.readCollection=function(bis,read){for(var length=codec.readInt32(bis),arr=[],i=0;length>i;++i)arr.push(read(bis));return arr},codec.readDictionary=function(bis,read){for(var length=codec.readInt32(bis),dict={},i=0;length>i;++i){var k=codec.readString(bis);dict[k]=read(bis)}return dict},codec.writeDictionary=function(bos,dict,write){codec.writeInt32(bos,Object.keys(dict).length);for(var k in dict)codec.writeString(bos,k),write(bos,dict[k])},codec.readBoolean=function(bis){var b=bis.readInt8();if(0===b)return!1;return!0},codec.writeBoolean=function(bos,value){bos.writeInt8(value?1:0)},module.exports=codec}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"long":10}],116:[function(_dereq_,module){function roundTimeStamp(timestamp){return timestamp>>TIMESTAMP_ROUNDING}function mask(p,capacity){return p&capacity-1}var findNextPowerOfTwo=_dereq_("util/math").findNextPowerOfTwo,curryR=_dereq_("util/function").curryR,ofSize=_dereq_("util/array").ofSize,fill=_dereq_("util/array").fill,TIMESTAMP_ROUNDING=10;module.exports=function(minimumMessages,minimumTimeIndex){function removeElements(newElementsHead){var newSize,messagesHead=messagesMask(tail-size);newElementsHead>messagesHead?(fill(messages,null,messagesHead,newElementsHead),newSize=size-newElementsHead+messagesHead):messagesHead>newElementsHead?(fill(messages,null,messagesHead,messagesLength),fill(messages,null,0,newElementsHead),newSize=size-messagesHead+newElementsHead):(fill(messages,null),newSize=0),size=newSize}var messagesLength=findNextPowerOfTwo(minimumMessages),indexCapacity=findNextPowerOfTwo(minimumTimeIndex),messagesMask=curryR(mask,messagesLength),indexMask=curryR(mask,indexCapacity),messages=ofSize(messagesLength),indices=ofSize(indexCapacity,-1),times=ofSize(indexCapacity),timesHead=0,timesTail=0,tail=messagesMask(0),size=0;this.size=function(){return size},this.put=function(message){if(messages[tail]=message,tail=messagesMask(tail+1),messagesLength>size)size+=1;else for(;indices[timesHead]===tail;)indices[timesHead]=-1,timesHead=indexMask(timesHead+1)},this.recover=function(n,consumer){if(0>n||n>size)return!1;for(var i=n;i>=1;--i)consumer(messages[messagesMask(tail-i)]);return!0},this.clear=function(){fill(messages,null),fill(indices,-1),timesHead=0,timesTail=0,size=0},this.markTime=function(timestamp){if(size>0){var h=timesHead,t=timesTail,firstIndex=indices[h],roundedTimestamp=roundTimeStamp(timestamp);if(firstIndex>=0){var indexLast=indexMask(t-1);if(indices[indexLast]===tail)return;if(times[indexLast]===roundedTimestamp)return void(indices[indexLast]=tail)}timesTail=indexMask(t+1),times[t]=roundedTimestamp,indices[t]=tail,h===t&&firstIndex>=0&&(removeElements(firstIndex),timesHead=timesTail)}},this.flush=function(timestamp){if(0===size||indices[timesHead]<0)return;var i=timesTail,roundedTimestamp=roundTimeStamp(timestamp);do{var previousI=i;if(i=indexMask(i-1),times[i]<=roundedTimestamp)return removeElements(indices[i]),previousI>=timesHead?fill(indices,-1,timesHead,previousI):(fill(indices,-1,timesHead,indexCapacity),fill(indices,-1,0,previousI)),void(timesHead=previousI)}while(i!==timesHead)}}},{"util/array":260,"util/function":262,"util/math":265}],117:[function(_dereq_,module){module.exports=function(val,scale){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Decimal metadata must be given a numeric default value");if(void 0!==scale&&"number"!=typeof scale)throw new Error("Decimal metadata must be given a numeric scale");if(this.value=val||0,void 0===scale){var str=this.value+"",i=str.indexOf(".");this.scale=i>-1?str.length-(i+1):2}else this.scale=scale;this.getDetails=function(){return{type:"decimalString",name:"decimalString","default":self.value,scale:self.scale}},this.parse=function(buffer){var str=buffer.toString(),i=str.indexOf(".");return+str.substr(0,i+this.scale+1)}}},{}],118:[function(_dereq_,module){module.exports=function(val){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Integer metadata must be given a numeric default value");this.value=parseInt(val,10)||0,this.getDetails=function(){return{type:"integerString",name:"integerString","default":self.value}},this.parse=function(buffer){return parseInt(buffer.toString(),10)}}},{}],119:[function(_dereq_,module){var MRecordContent=(_dereq_("util/interface")["implements"],_dereq_("../../metadata/metadata"),_dereq_("./record-content")),MStateless=_dereq_("./stateless"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string");module.exports={RecordContent:MRecordContent,Stateless:MStateless,Decimal:MDecimal,Integer:MInteger,String:MString}},{"../../metadata/metadata":51,"./decimal":117,"./integer":118,"./record-content":120,"./stateless":121,"./string":122,"util/interface":263}],120:[function(_dereq_,module){function occurs(m,n){var min=1,max=1;if(void 0!==m){if("string"==typeof m){var i=m.indexOf(".");if(-1!==i){var j=m.lastIndexOf(".");min=m.substring(0,i),max=m.substring(j+1),"*"===max&&(max=-1)}else min=m,max=m}else"number"==typeof m?(min=m,max=void 0!==n&&"number"==typeof n?n:m):void 0!==m.min&&(min=m.min,max=m.max);void 0===max&&(max=min),min=parseInt(min,10),max=parseInt(max,10)}return{min:min,max:max,toString:function(){var min=this.min,max=this.max>-1?this.max:"*";return min===max?""+min:min+".."+max}}}var implements=_dereq_("util/interface")["implements"],Metadata=_dereq_("../../metadata/metadata"),RecordContentParser=_dereq_("content/structured-record-content/parser"),RecordContentBuilder=_dereq_("content/structured-record-content/builder"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string"),util=_dereq_("./util-single-value"),count=0,MFieldImpl=implements(Metadata.RecordContent.Field,function(name,type,occurs){if(this.name=name,this.occurs=occurs,type){var t=util.deriveMetadata(type);if(util.getType(t)!==util.Type.SINGLE_VALUE)throw new Error("Record fields can only have single values (string, integer or decimal)");this.type=t}else this.type=new MString;this.getDetails=function(){var details=this.type.getDetails();return details.name=name,details.multiplicity=occurs.toString(),details}}),MRecordImpl=implements(Metadata.RecordContent.Record,function(name,m){var fields={},order=[];this.name=name,this.occurs=m,this.getField=function(name){switch(typeof name){case"string":return fields[name];case"number":return fields[order[name]]}return void 0},this.getFields=function(){return order.map(function(name){return fields[name]})},this.addField=function(name,type,m){if(fields[name])throw new Error("Field metadata already exists for: "+name);var previous=fields[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Fields cannot be added after a repeating field");var field=new MFieldImpl(name,type,occurs(m));return fields[name]=field,order.push(name),field},this.getDetails=function(){return{name:name,multiplicity:m.toString()}}}),MRecordContentImpl=implements(Metadata.RecordContent,function(name){var parser=new RecordContentParser(this),self=this,records={},order=[];name=name||"MRecordData"+count++,this.addRecord=function(name,m,fields){if(records[name])throw new Error("Record metadata already exists for: "+name);var previous=records[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Records cannot be added after a repeating record");var record=new MRecordImpl(name,occurs(m));if(records[name]=record,order.push(name),void 0!==fields)for(var field in fields)record.addField(field,fields[field]);return record},this.getRecord=function(name){switch(typeof name){case"string":return records[name];case"number":return records[order[name]]}return void 0},this.getRecords=function(){return order.map(function(name){return records[name]})},this.occurs=occurs,this.name=name,this.string=function(val){return new MString(val)},this.integer=function(val){return new MInteger(val)},this.decimal=function(val,scale){return new MDecimal(val,scale)},this.getDetails=function(){return{name:name}},this.builder=function(){return new RecordContentBuilder(self)},this.parse=function(buffer){return parser.parse(buffer)}});module.exports=MRecordContentImpl},{"../../metadata/metadata":51,"./decimal":117,"./integer":118,"./string":122,"./util-single-value":123,"content/structured-record-content/builder":73,"content/structured-record-content/parser":74,"util/interface":263}],121:[function(_dereq_,module){var details={type:"stateless",name:"stateless"};module.exports=function(){this.getDetails=function(){return details},this.parse=function(buffer){return buffer}}},{}],122:[function(_dereq_,module){module.exports=function(val){var self=this;this.value=void 0===val?"":""+val,this.getDetails=function(){return{type:"string",name:"string","default":self.value}},this.parse=function(buffer){return buffer.toString()}}},{}],123:[function(_dereq_,module){function createFromSingleValue(value){switch(typeof value){case"string":return new MString(value);case"number":var str=""+value,i=str.indexOf(".");return i>-1?new MDecimal(value,str.length-(i+1)):new MInteger(value)}throw new Error("Invalid Single Value type",value)}function getType(metadata){if(metadata instanceof MDecimal||metadata instanceof MInteger||metadata instanceof MString)return Type.SINGLE_VALUE;if(metadata instanceof MStateless)return Type.STATELESS;throw new Error("Unknown metadata type")}function isMetadata(value){return value instanceof MStateless||value instanceof MDecimal||value instanceof MInteger||value instanceof MString}function isMetadataValue(value){return isMetadata(value)||"string"==typeof value||"number"==typeof value||"boolean"==typeof value||void 0===value}function deriveMetadata(value){if(void 0===value)return new MStateless;if(isMetadata(value))return value;return createFromSingleValue(value)}var MStateless=_dereq_("./stateless"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string"),Type=_dereq_("../../topics/topics").TopicType;module.exports={Type:Type,getType:getType,isMetadata:isMetadata,isMetadataValue:isMetadataValue,deriveMetadata:deriveMetadata}},{"../../topics/topics":281,"./decimal":117,"./integer":118,"./stateless":121,"./string":122}],124:[function(_dereq_,module){function getType(metadata){return MRecordContent.isPrototypeOf(metadata)?Type.RECORD:util.getType(metadata)}function isMetadata(value){return MRecordContent.isPrototypeOf(value)||util.isMetadata(value)}function isMetadataValue(value){return MRecordContent.isPrototypeOf(value)||util.isMetadataValue(value)||cutil.isRecordContent(value)}function deriveMetadata(value){if(isMetadata(value))return value;return util.deriveMetadata(value)}var Type=_dereq_("../../topics/topics").TopicType,util=_dereq_("./util-single-value"),cutil=_dereq_("content/util"),MRecordContent=_dereq_("./record-content");module.exports={Type:Type,getType:getType,isMetadata:isMetadata,isMetadataValue:isMetadataValue,deriveMetadata:deriveMetadata}},{"../../topics/topics":281,"./record-content":120,"./util-single-value":123,"content/util":76}],125:[function(_dereq_,module){function createConnectionRequest(){return{type:consts.TYPE,version:consts.CURRENT_VERSION,capabilities:consts.CAPABILITIES}}function createReconnectionRequest(token,availableClientSequence,lastServerSequence){var req=createConnectionRequest();return req.token=token,req.availableClientSequence=availableClientSequence,req.lastServerSequence=lastServerSequence,req}var consts=_dereq_("protocol/consts");module.exports={connect:createConnectionRequest,reconnect:createReconnectionRequest}},{"protocol/consts":127}],126:[function(_dereq_,module){function deserialise(buffer){var input=new BufferInputStream(buffer),protocol=input.read();if(protocol!==consts.PROTOCOL_BYTE)throw new Error("Unrecognised protocol byte: "+protocol);var version=input.read();if(version<consts.CURRENT_VERSION)throw new Error("Unrecognised protocol version: "+version);if(version>consts.CURRENT_VERSION)throw new Error("Unsupported protocol version: "+version);var responseCode=BEES.read(input,ResponseCode);if(ResponseCode.isSuccess(responseCode)){var sessionID=new SessionId(input.readUInt64(),input.readUInt64()),sessionToken=SessionTokenDeserialiser(input),systemPingPeriod=input.readInt64(),recoverySequence=0;return responseCode===ResponseCode.RECONNECTED&&(recoverySequence=input.readInt32()),{response:responseCode,identity:sessionID,token:sessionToken,systemPingPeriod:systemPingPeriod,version:version,success:!0,sequence:recoverySequence}}return{response:responseCode,version:version,identity:null,token:null,systemPingPeriod:null,success:!1,sequence:0}
}var BufferInputStream=_dereq_("io/buffer-input-stream"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),SessionId=_dereq_("session/session-id"),SessionTokenDeserialiser=_dereq_("session/session-token-deserialiser"),ResponseCode=_dereq_("protocol/response-code"),consts=_dereq_("protocol/consts");module.exports=deserialise},{"io/buffer-input-stream":113,"protocol/consts":127,"protocol/response-code":128,"serialisers/byte-encoded-enum-serialiser":141,"session/session-id":238,"session/session-token-deserialiser":240}],127:[function(_dereq_,module){module.exports={TYPE:"WB",CAPABILITIES:8,PROTOCOL_BYTE:35,CURRENT_VERSION:8}},{}],128:[function(_dereq_,module){function code(id,message){return{id:id,message:message}}var ResponseCode={OK:code(100,"Connected successfully"),DOWNGRADE:code(102,"Server does not support the requested protocol level"),RECONNECTED:code(105,"Reconnected successfully"),RECONNECTED_WITH_MESSAGE_LOSS:code(106,"Reconnected with message loss"),REJECTED:code(111,"Connection rejected"),CONNECTION_UNSUPPORTED:code(112,"Connection type not supported by connector"),LICENSE_EXCEEDED:code(113,"Connection rejected due to license limit"),RECONNECTION_UNSUPPORTED:code(114,"Reconnection not supported by connector"),CONNECTION_PROTOCOL_ERROR:code(115,"Connection failed - protocol error"),AUTHENTICATION_FAILED:code(116,"Connection failed - authentication failed"),UNKNOWN_SESSION:code(117,"Reconnection failed - the session is unknown"),RECONNECTION_FAILED_MESSAGE_LOSS:code(118,"Reconnection failed due to message loss"),ERROR:code(127,"Connection failed due to server error")};ResponseCode.isSuccess=function(code){switch(code){case ResponseCode.OK:case ResponseCode.RECONNECTED:case ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS:return!0;default:return!1}},module.exports=ResponseCode},{}],129:[function(_dereq_,module){var HashMap=_dereq_("hashmap"),Arrays=_dereq_("util/array");module.exports=function(topicCache){var streams=new HashMap,fallbacks=[],self=this;this.add=function(selector,stream){var existing=streams.get(selector);existing?existing.push(stream):streams.set(selector,[stream]),topicCache.newStream(selector,stream,self),stream.onOpen()},this.addFallback=function(stream){fallbacks.push(stream)},this.getFallbacks=function(){return fallbacks},this.remove=function(stream){Arrays.remove(fallbacks,stream),streams.forEach(function(existing,selector){Arrays.remove(existing,stream)&&topicCache.removeStream(stream),0===existing.length&&streams.remove(selector)})},this.streamsFor=function(topic,details){var combined=[];return streams.count()>0&&streams.forEach(function(existing,selector){selector.selects(topic)&&(combined=combined.concat(existing.filter(function(stream){return stream.selects(details)})))}),combined}}},{hashmap:7,"util/array":260}],130:[function(_dereq_,module){var TopicCacheEntry=_dereq_("routing/topic-cache-entry");module.exports=function(details,streams,datatype){TopicCacheEntry.call(this,details,streams);var value,deltaType=datatype.deltaType("binary");this.handleValue=function(path,received,registry){var oldValue=value;try{value=datatype.readValue(received),this.notifyValue(path,received,oldValue,value,registry)}catch(e){console.log(e)}},this.handleDelta=function(path,received,registry){var oldValue=value;try{var delta=deltaType.readDelta(received);value=deltaType.apply(oldValue,delta),this.notifyDelta(path,received,delta,oldValue,value,registry)}catch(e){console.log(e)}},this.notifyValueToNewStream=function(path,details,stream){value&&stream.onValue(path,details,value.$buffer,null,value)}}},{"routing/topic-cache-entry":131}],131:[function(_dereq_,module){var Arrays=_dereq_("util/array");module.exports=function(details,streams){function proxies(registry){var p=streams;return 0===p.length&&(p=registry.getFallbacks()),p}this.details=function(){return details},this.notifySubscription=function(path,registry){proxies(registry).forEach(function(proxy){proxy.onSubscription(path,details)})},this.notifyUnsubscription=function(path,reason,registry){proxies(registry).forEach(function(proxy){proxy.onUnsubscription(path,details,reason)})},this.notifyValue=function(path,content,oldValue,newValue,registry){proxies(registry).forEach(function(proxy){proxy.onValue(path,details,content,oldValue,newValue)})},this.notifyDelta=function(path,content,delta,oldValue,newValue,registry){proxies(registry).forEach(function(proxy){proxy.onDelta(path,details,content,delta,oldValue,newValue)})},this.addStream=function(path,stream,registry){streams.push(stream),stream.onSubscription(path,details),this.notifyValueToNewStream(path,details,stream,registry)},this.removeStream=function(stream){Arrays.remove(streams,stream)},this.removeAllStreams=function(){streams.length=0}}},{"util/array":260}],132:[function(_dereq_,module){var TopicCacheEntry=_dereq_("routing/topic-cache-entry");module.exports=function(details,streams){TopicCacheEntry.call(this,details,streams),this.handleValue=function(path,received,registry){this.notifyValue(path,received,null,received,registry)},this.handleDelta=function(path,received,registry){this.notifyDelta(path,received,null,null,received,registry)},this.notifyValueToNewStream=function(){}}},{"routing/topic-cache-entry":131}],133:[function(_dereq_,module){var TopicCacheEntry=_dereq_("routing/topic-cache-entry");module.exports=function(details,streams){TopicCacheEntry.call(this,details,streams);var value;this.handleValue=function(path,received,registry){this.notifyValue(path,received,value,received,registry),value=received},this.handleDelta=function(path,received,registry){this.notifyDelta(path,received,null,value,received,registry),value=received},this.notifyValueToNewStream=function(path,details,stream){value&&stream.onValue(path,details,value,null,value)}}},{"routing/topic-cache-entry":131}],134:[function(_dereq_,module){var NoValueEntry=_dereq_("routing/topic-cache-no-value-entry"),DatatypeEntry=_dereq_("routing/topic-cache-datatype-entry"),SingleEntry=_dereq_("routing/topic-cache-single-value-entry"),TopicType=_dereq_("../../topics/topics").TopicType;module.exports=function(datatypes){var idToPath={},cache={};this.handleSubscription=function(info,registry){var path=info.path;if(cache[path])return;var entry,details=info.details,streams=registry.streamsFor(path,details);switch(details.type){case TopicType.JSON:entry=new DatatypeEntry(details,streams,datatypes.json());break;case TopicType.BINARY:entry=new DatatypeEntry(details,streams,datatypes.binary());break;case TopicType.SINGLE_VALUE:entry=new SingleEntry(details,streams);break;default:entry=new NoValueEntry(details,streams)}idToPath[info.id]=path,cache[path]=entry,entry.notifySubscription(path,registry)},this.handleValue=function(path,content,registry){cache[path].handleValue(path,content,registry)},this.handleDelta=function(path,delta,registry){cache[path].handleDelta(path,delta,registry)},this.handleUnsubscription=function(id,reason,registry){var path=idToPath[id];if(delete idToPath[id],path){var entry=cache[path];delete cache[path],entry&&entry.notifyUnsubscription(path,reason,registry)}},this.newStream=function(selector,stream,registry){for(var path in cache){var entry=cache[path];selector.selects(path)&&stream.selects(entry.details())&&entry.addStream(path,stream,registry)}},this.removeStream=function(stream){for(var path in cache)cache[path].removeStream(stream)},this.removeAllStreams=function(){for(var path in cache)cache[path].removeAllStreams()},this.clear=function(){idToPath={},cache={}}}},{"../../topics/topics":281,"routing/topic-cache-datatype-entry":130,"routing/topic-cache-no-value-entry":132,"routing/topic-cache-single-value-entry":133}],135:[function(_dereq_,module){var log=_dereq_("util/logger").create("V4 Client Routing");module.exports=function(serviceAdapter,cache,registry){this.route=function(message){message.isTopicMessage()?"@"===message.topic?serviceAdapter.onMessage(message.getInputStream()):20===message.type?cache.handleValue(message.topic,message.data,registry):21===message.type&&cache.handleDelta(message.topic,message.data,registry):log.debug("Unhandled V4 message: "+message.type,message)},this.subscribe=function(info){cache.handleSubscription(info,registry)},this.unsubscribe=function(id,reason){cache.handleUnsubscription(id,reason,registry)}}},{"util/logger":264}],136:[function(_dereq_,module){module.exports={ATTR:"$",CHAR:"_"}},{}],137:[function(_dereq_,module){function createRecordSchema(metadata){if(0===metadata.getRecords().length)return null;var schema={message:{record:[]}};return schema.message[ATTR]={topicDataType:"record",name:metadata.name},metadata.getRecords().forEach(function(record){var rschema={field:[]};rschema[ATTR]=record.getDetails(),record.getFields().forEach(function(field){rschema.field.push(createSingleValueSchema(field).field)}),schema.message.record.push(rschema)}),schema}function createSingleValueSchema(metadata){var schema={field:{}};return schema.field[ATTR]=metadata.getDetails(),schema}function create(meta){switch(util.getType(meta)){case util.Type.RECORD:return createRecordSchema(meta);case util.Type.SINGLE_VALUE:return createSingleValueSchema(meta)}return null}var util=_dereq_("metadata/util"),ATTR=_dereq_("schema/consts").ATTR;module.exports=create},{"metadata/util":124,"schema/consts":136}],138:[function(_dereq_,module){var xmljson=_dereq_("./xmljson"),Codec=_dereq_("io/codec"),serialiser={read:function(input){return xmljson.xml2json(Codec.readString(input))},write:function(output,schema){schema&&(schema.field||schema.message)&&Codec.writeString(output,xmljson.json2xml(schema))}};module.exports=serialiser},{"./xmljson":139,"io/codec":115}],139:[function(_dereq_,module){function attrs_str2js(str){for(var js={},pairs=str.split(" "),i=0;i<pairs.length;i++){var pair=pairs[i].split("=");js[pair[0]]=pair[1].match(/"(.*)"/)[1]}return js}function escapeEntities(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function attrs_obj2arr(obj){var attrs=[];if("object"==typeof obj)for(var key in obj)attrs.push(""+key+'="'+escapeEntities(obj[key])+'"');return attrs}function xml2json(xml,pos){var js={};if(void 0===pos){pos={idx:0,isRoot:!0};var preamble=xml.match(/<\?.*?\?>/);preamble&&(xml=xml.substr(preamble[0].length))}for(var elem_match=null;;){if(elem_match=xml.substr(pos.idx).match(/<.*?>/),!elem_match)break;pos.idx+=elem_match[0].length;var elem=elem_match[0].trim();if("</"===elem.substr(0,2))return js;var name=elem.match(/\b(.+?)\b/)[0],attrs_match=elem.match(/<.+?\b(.*)\/?>/),attrs_str="";attrs_match&&(attrs_str=attrs_match[1].trim());var child_count,attrs=attrs_str2js(attrs_str);"/>"===elem.substr(-2)?pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push({}),js[name][child_count-1][ATTR]=attrs):pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push(xml2json(xml,pos)),js[name][child_count-1][ATTR]=attrs)}return js}function json2xml(obj,recur){var str="";recur||(str='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>');for(var key in obj){if(key===ATTR)continue;var val=obj[key];val instanceof Array||(val=Array(val));for(var i=0;i<val.length;i++){var attrs=attrs_obj2arr(val[i][ATTR]);str+="<"+key,attrs&&attrs.length>0&&(str+=" ",str+=attrs.join(" "));var child_str=json2xml(val[i],!0);child_str&&child_str.length>0?(str+=">",str+=child_str,str+="</"+key+">"):str+="/>"}}return str}var ATTR=(_dereq_("../metadata/metadata"),_dereq_("../schema/schema"),_dereq_("../schema/consts").ATTR);module.exports={xml2json:xml2json,json2xml:json2xml}},{"../metadata/metadata":119,"../schema/consts":136,"../schema/schema":137}],140:[function(_dereq_,module){var Codec=_dereq_("io/codec"),serialiser={read:function(input){return 1===Codec.readByte(input)},write:function(output,val){Codec.writeByte(output,val?1:0)}};module.exports=serialiser},{"io/codec":115}],141:[function(_dereq_,module){var serialiser={read:function(bis,enums){var k,i=bis.read();for(k in enums){var e=enums[k];if(e===i||void 0!==e.id&&e.id===i)return e}throw new Error("Unable to decode enum value "+i)},write:function(bos,val){bos.write(val.id?val.id:val)}};module.exports=serialiser},{}],142:[function(_dereq_,module){var Codec=_dereq_("io/codec"),serialiser={read:function(input,Enum){var i=Codec.readByte(input);for(var k in Enum)if(Enum[k]===i||void 0!==Enum[k].id&&Enum[k].id===i)return k;throw new Error("Unknown id ("+i+") for enum")},write:function(output,id){Codec.writeByte(output,id)}};module.exports=serialiser},{"io/codec":115}],143:[function(_dereq_,module){module.exports={EXISTS:{id:1,reason:"The topic already exists with the same details"},EXISTS_MISMATCH:{id:2,reason:"The topic already exists, with different details"},INVALID_PATH:{id:3,reason:"The topic path is invalid"},INVALID_DETAILS:{id:4,reason:"The topic details are invalid"},USER_CODE_ERROR:{id:5,reason:"A user supplied class could not be found or instantiated"},TOPIC_NOT_FOUND:{id:6,reason:"A referenced topic could not be found"},PERMISSIONS_FAILURE:{id:7,reason:"Invalid permissions to add a topic at the specified path"},INITIALISE_ERROR:{id:8,reason:"The topic could not be initialised, supplied value may be of the wrong format"},UNEXPECTED_ERROR:{id:9,reason:"An unexpected error occured while creating the topic"}}},{}],144:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ContentSerialiser=(_dereq_("io/buffer-output-stream"),_dereq_("content/util"),_dereq_("content/serialiser")),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),AddTopicFailureReason=_dereq_("services/add-topic/add-topic-failure-reason"),TopicDetailsSerialiser=_dereq_("topics/details/topic-details-serialiser"),Status={OK:0,OK_CACHED:1,FAILURE:2,CACHE_FAILURE:3},serialiser={read:function(input){var status=Codec.readByte(input),reason="";return status===Status.FAILURE&&(reason=BEES.read(input,AddTopicFailureReason)),{status:status,reason:reason}},write:function(output,req){Codec.writeString(output,req.path),Codec.writeInt32(output,0),TopicDetailsSerialiser.write(output,req.details),req.content?(Codec.writeBoolean(output,!0),ContentSerialiser.write(output,req.content)):Codec.writeBoolean(output,!1)}};module.exports=serialiser},{"content/serialiser":72,"content/util":76,"io/buffer-output-stream":114,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141,"services/add-topic/add-topic-failure-reason":143,"topics/details/topic-details-serialiser":242}],145:[function(_dereq_,module){function AddTopic(){}module.exports=AddTopic},{}],146:[function(_dereq_,module){var BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Codec=_dereq_("io/codec"),Type={NONE:0,PLAIN:1,CUSTOM:2},serialiser={read:function(input){var type=BEES.read(input,Type);switch(type){case Type.NONE:return null;case Type.PLAIN:return Codec.readString(input);case Type.CUSTOM:return Codec.readBytes(input)}},write:function(input,credentials){credentials?"string"==typeof credentials?(BEES.write(input,Type.PLAIN),Codec.writeString(input,credentials)):(BEES.write(input,Type.CUSTOM),Codec.writeBytes(input,credentials)):(BEES.write(input,Type.NONE),Codec.writeInt32(input,0))}};module.exports=serialiser},{"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],147:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ErrorReportSerialiser=_dereq_("../error-report-serialiser"),SecurityCommandScriptResult=_dereq_("./security-command-script-result"),serialiser={read:function(input){var errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new SecurityCommandScriptResult(errors)},write:function(output,value){Codec.writeCollection(output,value.errors,ErrorReportSerialiser.write)}};module.exports=serialiser},{"../error-report-serialiser":182,"./security-command-script-result":148,"io/codec":115}],148:[function(_dereq_,module){function SecurityCommandScriptResult(errors){this.errors=requireNonNull(errors)}var requireNonNull=_dereq_("util/require-non-null");SecurityCommandScriptResult.prototype.toString=function(){return"SecurityCommandScriptResult ["+this.errors+"]"},module.exports=SecurityCommandScriptResult},{"util/require-non-null":269}],149:[function(_dereq_,module){var SecurityCommandScript=_dereq_("./security-command-script"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var script=Codec.readString(input);return new SecurityCommandScript(script)},write:function(output,value){Codec.writeString(output,value.script)}};module.exports=serialiser},{"./security-command-script":150,"io/codec":115}],150:[function(_dereq_,module){function SecurityCommandScript(script){this.script=requireNonNull(script,"script")}var requireNonNull=_dereq_("util/require-non-null");SecurityCommandScript.prototype.toString=function(){return"SecurityCommandScript ["+this.script+"]"},module.exports=SecurityCommandScript},{"util/require-non-null":269}],151:[function(_dereq_,module){var Codec=_dereq_("io/codec"),Configuration=_dereq_("features/security").SystemAuthentication,ByteEncodedEnumSerialiser=_dereq_("serialisers/byte-encoded-enum-serialiser"),SystemPrincipalSerialiser=_dereq_("./system-principal-serialiser"),serialiser={read:function(input){var principals=Codec.readCollection(input,SystemPrincipalSerialiser.read),action=ByteEncodedEnumSerialiser.read(input,Configuration.CONNECTION_ACTION),roles=Codec.readCollection(input,Codec.readString);return new Configuration(principals,action.value,roles)},write:function(output,value){Codec.writeCollection(output,value.principals,SystemPrincipalSerialiser.write);var action=Configuration.CONNECTION_ACTION.fromString(value.anonymous.action);Codec.writeByte(output,action.id),Codec.writeCollection(output,value.anonymous.roles,Codec.writeString)}};module.exports=serialiser},{"./system-principal-serialiser":152,"features/security":100,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],152:[function(_dereq_,module){var Codec=_dereq_("io/codec"),SystemPrincipal=_dereq_("features/security").SystemPrincipal,serialiser={read:function(input){var name=Codec.readString(input),roles=Codec.readCollection(input,Codec.readString);return new SystemPrincipal(name,roles)},write:function(output,principal){Codec.writeString(output,principal.name),Codec.writeCollection(output,principal.roles,Codec.writeString)}};module.exports=serialiser},{"features/security":100,"io/codec":115}],153:[function(_dereq_,module){var CredentialsSerialiser=_dereq_("services/authentication/credentials-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){Codec.readString(input),CredentialsSerialiser.read(input)},write:function(output,req){Codec.writeString(output,req.principal),CredentialsSerialiser.write(output,req.credentials)}};module.exports=serialiser},{"io/codec":115,"services/authentication/credentials-serialiser":146}],154:[function(){},{}],155:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ByteEncodedEnumSerialiser=_dereq_("serialisers/byte-encoded-enum-serialiser"),CommandError=_dereq_("./command-error"),serialiser={read:function(input){var message=Codec.readString(input),type=ByteEncodedEnumSerialiser.read(input,CommandError.ErrorType);return new CommandError(type,message)},write:function(out,error){Codec.writeString(out,error.message),ByteEncodedEnumSerialiser.write(out,error.type)}};module.exports=serialiser},{"./command-error":156,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],156:[function(_dereq_,module){function ErrorType(reason){this.reason=reason,this.id=reason.id,this.asCommandError=function(){return new CommandError(this)}}function CommandError(type,message){this.type=type,this.message=message||type.reason.reason}var ErrorReasons=_dereq_("client/errors");CommandError.prototype.toString=function(){return this.message},CommandError.ErrorType={COMMUNICATION_FAILURE:new ErrorType(ErrorReasons.COMMUNICATION_FAILURE),ACCESS_DENIED:new ErrorType(ErrorReasons.ACCESS_DENIED),TOPIC_TREE_REGISTATION_CONFLICT:new ErrorType(ErrorReasons.TOPIC_TREE_REGISTRATION_CONFLICT)},module.exports=CommandError},{"client/errors":60}],157:[function(_dereq_,module){var ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),CommandHeader=_dereq_("./command-header"),Codec=_dereq_("io/codec"),CommandHeaderSerialiser={read:function(input){var service=Codec.readInt32(input),mode=Codec.readByte(input),cid=ConversationIDSerialiser.read(input);return new CommandHeader(mode,service,cid)},write:function(out,header){Codec.writeInt32(out,header.service),Codec.writeByte(out,header.mode),ConversationIDSerialiser.write(out,header.cid)}};module.exports=CommandHeaderSerialiser},{"./command-header":158,"conversation/conversation-id-serialiser":80,"io/codec":115}],158:[function(_dereq_,module){function CommandHeader(mode,service,cid){this.mode=mode,this.service=service,this.cid=cid}var modes={ERROR:0,REQUEST:1,RESPONSE:2};CommandHeader.prototype.toString=function(){var mode;switch(this.mode){case modes.ERROR:mode="Error";break;case modes.REQUEST:mode="Request";break;case modes.RESPONSE:mode="Response"}return mode+"<"+this.service+", "+this.cid.toString()+">"},CommandHeader.createRequestHeader=function(service,cid){return new CommandHeader(modes.REQUEST,service,cid)},CommandHeader.prototype.createResponseHeader=function(){return new CommandHeader(modes.RESPONSE,this.service,this.cid)},CommandHeader.prototype.createErrorHeader=function(){return new CommandHeader(modes.ERROR,this.service,this.cid)},CommandHeader.modes=modes,CommandHeader.prototype.mode=modes,module.exports=CommandHeader},{}],159:[function(_dereq_,module){var GetSessionPropertiesKeys={ALL_FIXED_PROPERTIES:["*F"],ALL_USER_PROPERTIES:["*U"]};module.exports={PropertyKeys:GetSessionPropertiesKeys}},{}],160:[function(_dereq_,module){var ControlGroupSerialiser=_dereq_("control/control-group-serialiser"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Services=_dereq_("services/services"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input);return{definition:definition,group:group}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group)}};module.exports=serialiser},{"control/control-group-serialiser":77,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141,"services/services":204}],161:[function(_dereq_,module){function ControlRegistrationParams(definition,group){this.definition=definition,this.group=group}module.exports=ControlRegistrationParams},{}],162:[function(_dereq_,module){var ControlRegistrationParamsSerialiser=_dereq_("services/control/control-registration-params-serialiser"),ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),serialiser={read:function(input){var params=ControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){ControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":80,"services/control/control-registration-params-serialiser":160}],163:[function(_dereq_,module){function ControlRegistrationRequest(params,cid){this.params=params,this.cid=cid}module.exports=ControlRegistrationRequest},{}],164:[function(_dereq_,module){var Codec=_dereq_("io/codec"),SessionSerialiser=_dereq_("session/session-id-serialiser"),serialiser={read:function(input){return Codec.readBoolean(input)?{properties:Codec.readDictionary(input,Codec.readString)}:null},write:function(output,request){if(void 0===request.sessionID||null===request.sessionID)throw new Error("session ID is null or undefined");SessionSerialiser.write(output,request.sessionID),void 0!==request.propertyKeys&&null!==request.propertyKeys?Codec.writeCollection(output,request.propertyKeys,Codec.writeString):Codec.writeCollection(output,[],Codec.writeString)}};module.exports=serialiser},{"io/codec":115,"session/session-id-serialiser":237}],165:[function(_dereq_,module){function GetSessionProperties(){}module.exports=GetSessionProperties},{}],166:[function(_dereq_,module){var ControlGroupSerialiser=_dereq_("control/control-group-serialiser"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Services=_dereq_("services/services"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input),path=Codec.readString(input),keys=Codec.readCollection(input,Codec.readString);return{definition:definition,group:group,path:path,keys:keys}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group),Codec.writeString(output,params.path),Codec.writeCollection(output,params.keys,Codec.writeString)}};module.exports=serialiser},{"control/control-group-serialiser":77,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141,"services/services":204}],167:[function(_dereq_,module){function MessageReceiverControlRegistrationParams(definition,group,path,keys){this.definition=definition,this.group=group,this.path=path,this.keys=keys}module.exports=MessageReceiverControlRegistrationParams},{}],168:[function(_dereq_,module){var MessageReceiverControlRegistrationParamsSerialiser=_dereq_("services/control/message-receiver-control-registration-params-serialiser"),ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),serialiser=(_dereq_("io/codec"),{read:function(input){var params=MessageReceiverControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){MessageReceiverControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}});module.exports=serialiser},{"conversation/conversation-id-serialiser":80,"io/codec":115,"services/control/message-receiver-control-registration-params-serialiser":166}],169:[function(_dereq_,module){function MessageReceiverControlRegistrationRequest(){}module.exports=MessageReceiverControlRegistrationRequest},{}],170:[function(_dereq_,module){var SessionCloseReason={CONNECTION_LOST:0,IO_EXCEPTION:1,CLIENT_UNRESPONSIVE:2,MESSAGE_QUEUE_LIMIT_REACHED:3,CLOSED_BY_CLIENT:4,MESSAGE_TOO_LARGE:5,INTERNAL_ERROR:6,INVALID_INBOUND_MESSAGE:7,ABORT:8,LOST_MESSAGES:9,SERVER_CLOSING:10,CLOSED_BY_CONTROLLER:11};module.exports=SessionCloseReason},{}],171:[function(_dereq_,module){var SessionPropertiesEventSerialiser=_dereq_("services/control/session-properties-event-serialiser"),ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(input){var cid=ConversationIDSerialiser.read(input),events=Codec.readCollection(input,SessionPropertiesEventSerialiser.read);return{cid:cid,events:events}},write:function(output,batch){ConversationIDSerialiser.write(output,batch.cid),Codec.writeCollection(output,batch.events)}}},{"conversation/conversation-id-serialiser":80,"io/codec":115,"services/control/session-properties-event-serialiser":173}],172:[function(_dereq_,module){module.exports=function(cid,events){this.cid=cid,this.events=events}},{}],173:[function(_dereq_,module){var SessionIdSerialiser=(_dereq_("services/control/client-control-options"),_dereq_("conversation/conversation-id-serialiser"),_dereq_("session/session-id-serialiser")),SessionPropertiesEventType=_dereq_("services/control/session-properties-event-type"),SessionCloseReason=_dereq_("services/control/session-close-reason"),Codec=_dereq_("io/codec"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),serialiser={read:function(input){var result={sessionId:SessionIdSerialiser.read(input),type:BEES.read(input,SessionPropertiesEventType)};switch(result.type){case SessionPropertiesEventType.OPEN:result.oldProperties=Codec.readDictionary(input,Codec.readString);break;case SessionPropertiesEventType.UPDATE:result.updateType=Codec.readByte(input),result.oldProperties=Codec.readDictionary(input,Codec.readString),result.newProperties=Codec.readDictionary(input,Codec.readString);break;case SessionPropertiesEventType.CLOSE:result.closeReason=BEES.read(input,SessionCloseReason),result.oldProperties=Codec.readDictionary(input,Codec.readString);break;default:throw new Error("Unknown session properties event type: "+result.type)}return result},write:function(){}};module.exports=serialiser},{"conversation/conversation-id-serialiser":80,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141,"services/control/client-control-options":159,"services/control/session-close-reason":170,"services/control/session-properties-event-type":174,"session/session-id-serialiser":237}],174:[function(_dereq_,module){var SessionPropertiesEventType={OPEN:0,UPDATE:1,CLOSE:2};module.exports=SessionPropertiesEventType},{}],175:[function(_dereq_,module){function SessionPropertiesEvent(){}module.exports=SessionPropertiesEvent},{}],176:[function(_dereq_,module){var ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(){},write:function(output,request){request.properties?(Codec.writeInt32(output,0),Codec.writeCollection(output,request.properties,Codec.writeString)):Codec.writeInt32(output,1),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":80,"io/codec":115}],177:[function(_dereq_,module){function SetSessionPropertiesListener(){}module.exports=SetSessionPropertiesListener},{}],178:[function(_dereq_,module){var ControlGroupSerialiser=_dereq_("control/control-group-serialiser"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Services=_dereq_("services/services"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input),path=Codec.readString(input);return{definition:definition,group:group,path:path}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group),Codec.writeString(output,params.path)}};module.exports=serialiser},{"control/control-group-serialiser":77,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141,"services/services":204}],179:[function(_dereq_,module){function TopicControlRegistrationParams(definition,group,path){this.definition=definition,this.group=group,this.path=path}module.exports=TopicControlRegistrationParams},{}],180:[function(_dereq_,module){var TopicControlRegistrationParamsSerialiser=_dereq_("services/control/topic-control-registration-params-serialiser"),ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),serialiser={read:function(input){var params=TopicControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){TopicControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":80,"services/control/topic-control-registration-params-serialiser":178}],181:[function(_dereq_,module){function TopicControlRegistrationRequest(){}module.exports=TopicControlRegistrationRequest},{}],182:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ErrorReport=_dereq_("services/error-report"),serialiser={read:function(input){var message=Codec.readString(input),line=Codec.readInt32(input),column=Codec.readInt32(input);return new ErrorReport(message,line,column)},write:function(output,value){Codec.writeString(output,value.message),Codec.writeInt32(output,value.line),Codec.writeInt32(output,value.column)}};module.exports=serialiser},{"io/codec":115,"services/error-report":183}],183:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],requireNonNull=_dereq_("util/require-non-null"),ErrorReport=_dereq_("../../error-report");
module.exports=implements(ErrorReport,function(message,line,column){this.message=requireNonNull(message),this.line=line||0,this.column=column||0,this.toString=function(){return"ErrorReport ["+this.message+" at ["+this.line+":"+this.column+"]]"}})},{"../../error-report":40,"util/interface":263,"util/require-non-null":269}],184:[function(_dereq_,module){var Codec=_dereq_("io/codec"),TopicDetailsSerialiser=(_dereq_("./get-topic-details"),_dereq_("topics/details/topic-details-serialiser")),serialiser={read:function(input){return TopicDetailsSerialiser.read(input)},write:function(output,request){Codec.writeString(output,request.topic_name),Codec.writeByte(output,request.level)}};module.exports=serialiser},{"./get-topic-details":185,"io/codec":115,"topics/details/topic-details-serialiser":242}],185:[function(_dereq_,module){function GetTopicDetails(){}module.exports=GetTopicDetails},{}],186:[function(_dereq_,module){var TopicSelectorSerialiser=_dereq_("topics/topic-selector-serialiser"),CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),SessionSerialiser=_dereq_("session/session-id-serialiser");module.exports={read:function(input){var sessionID=SessionSerialiser.read(input),selector=TopicSelectorSerialiser.read(input),cid=CIDSerialiser.read(input);return{sessionID:sessionID,selector:selector,cid:cid}},write:function(output,req){SessionSerialiser.write(output,req.sessionID),TopicSelectorSerialiser.write(output,req.selector),CIDSerialiser.write(output,req.cid)}}},{"conversation/conversation-id-serialiser":80,"session/session-id-serialiser":237,"topics/topic-selector-serialiser":252}],187:[function(_dereq_,module){module.exports=function(sessionID,selector){this.sessionID=sessionID,this.selector=selector}},{}],188:[function(_dereq_,module){var Codec=(_dereq_("./remove-topic"),_dereq_("io/codec")),serialiser={read:function(){},write:function(output,req){Codec.writeString(output,req.topic_name)}};module.exports=serialiser},{"./remove-topic":189,"io/codec":115}],189:[function(_dereq_,module){function RemoveTopic(){}module.exports=RemoveTopic},{}],190:[function(_dereq_,module){var TopicPermission=_dereq_("features/security").TopicPermission,GlobalPermission=_dereq_("features/security").GlobalPermission,Converter=_dereq_("serialisers/enum-converter"),curryR=_dereq_("util/function").curryR,Codec=_dereq_("io/codec"),writeGlobalPerm=curryR(Converter.write,GlobalPermission),writeTopicPerm=curryR(Converter.write,TopicPermission),readGlobalPerm=curryR(Converter.read,GlobalPermission),readTopicPerm=curryR(Converter.read,TopicPermission),writeTopicPerms=curryR(Codec.writeCollection,writeTopicPerm),readTopicPerms=curryR(Codec.readCollection,readTopicPerm),serialiser={read:function(input){return{name:Codec.readString(input),global:Codec.readCollection(input,readGlobalPerm),"default":Codec.readCollection(input,readTopicPerm),topic:Codec.readDictionary(input,readTopicPerms),roles:Codec.readCollection(input,Codec.readString)}},write:function(output,role){Codec.writeString(output,role.name),Codec.writeCollection(output,role.global,writeGlobalPerm),Codec.writeCollection(output,role["default"],writeTopicPerm),Codec.writeDictionary(output,role.topic,writeTopicPerms),Codec.writeCollection(output,role.roles,Codec.writeString)}};module.exports=serialiser},{"features/security":100,"io/codec":115,"serialisers/enum-converter":142,"util/function":262}],191:[function(_dereq_,module){var Configuration=_dereq_("features/security").Configuration,RoleSerialiser=_dereq_("services/security/role-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var anonymous=Codec.readCollection(input,Codec.readString),named=Codec.readCollection(input,Codec.readString),roles=Codec.readCollection(input,RoleSerialiser.read);return new Configuration(anonymous,named,roles)},write:function(output,config){Codec.writeCollection(output,config.anonymous,Codec.writeString),Codec.writeCollection(output,config.named,Codec.writeString),Codec.writeCollection(output,config.roles,RoleSerialiser.write)}};module.exports=serialiser},{"features/security":100,"io/codec":115,"services/security/role-serialiser":190}],192:[function(_dereq_,module){var OptionsSerialiser=(_dereq_("./filter-send-request"),_dereq_("./send-options-serialiser")),ContentSerialiser=_dereq_("content/serialiser"),CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var filter=Codec.readString(input),path=Codec.readString(input),content=ContentSerialiser.read(input),options=OptionsSerialiser.read(input),cid=CIDSerialiser.read(input);return{cid:cid,path:path,filter:filter,message:content,options:options}},write:function(output,req){Codec.writeString(output,req.filter),Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),OptionsSerialiser.write(output,req.options),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./filter-send-request":193,"./send-options-serialiser":196,"content/serialiser":72,"conversation/conversation-id-serialiser":80,"io/codec":115}],193:[function(_dereq_,module){function FilterSendRequest(path,message,filter){this.path=path,this.message=message,this.filter=filter}module.exports=FilterSendRequest},{}],194:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ErrorReportSerialiser=_dereq_("../error-report-serialiser"),FilterSendResult=_dereq_("./filter-send-result"),serialiser={read:function(input){var sent=Codec.readInt32(input),errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new FilterSendResult(sent,errors)},write:function(output,req){Codec.writeInt32(output,req.sent),Codec.writeCollection(output,req.errors,ErrorReportSerialiser.write)}};module.exports=serialiser},{"../error-report-serialiser":182,"./filter-send-result":195,"io/codec":115}],195:[function(_dereq_,module){function FilterSendResult(sent,errors){this.sent=requireNonNull(sent),this.errors=requireNonNull(errors)}var requireNonNull=_dereq_("util/require-non-null");FilterSendResult.prototype.toString=function(){return"FilterSendResult ["+this.sent+" sent, errors="+this.errors+"]"},module.exports=FilterSendResult},{"util/require-non-null":269}],196:[function(_dereq_,module){var BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),Codec=_dereq_("io/codec"),Priority=_dereq_("../../../features/messages").Priority,serialiser={read:function(input){var priority=BEES.read(input,Priority),headers=Codec.readCollection(input,Codec.readString);return{priority:priority,headers:headers}},write:function(output,req){BEES.write(output,req.priority),Codec.writeCollection(output,req.headers,Codec.writeString)}};module.exports=serialiser},{"../../../features/messages":47,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],197:[function(_dereq_,module){var OptionsSerialiser=(_dereq_("./send-request"),_dereq_("./send-options-serialiser")),ContentSerialiser=_dereq_("content/serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),options=OptionsSerialiser.read(input);return{path:path,content:content,options:options}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),OptionsSerialiser.write(output,req.options)}};module.exports=serialiser},{"./send-options-serialiser":196,"./send-request":198,"content/serialiser":72,"io/codec":115}],198:[function(_dereq_,module){function SendRequest(path,message){this.path=path,this.message=message}module.exports=SendRequest},{}],199:[function(_dereq_,module){var OptionsSerialiser=(_dereq_("./session-forward-send-request"),_dereq_("./send-options-serialiser")),ContentSerialiser=_dereq_("content/serialiser"),SessionSerialiser=_dereq_("session/session-id-serialiser"),CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),sender=SessionSerialiser.read(input),options=OptionsSerialiser.read(input),sessionProperties=Codec.readDictionary(input,Codec.readString),cid=CIDSerialiser.read(input);return{cid:cid,path:path,sender:sender,message:content,options:options,sessionProperties:sessionProperties}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),SessionSerialiser.write(output,req.session),OptionsSerialiser.write(output,req.options),Codec.writeDictionary(output,req.sessionProperties,Codec.writeString),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./send-options-serialiser":196,"./session-forward-send-request":200,"content/serialiser":72,"conversation/conversation-id-serialiser":80,"io/codec":115,"session/session-id-serialiser":237}],200:[function(_dereq_,module){function SessionForwardSendRequest(path,message,recipient,sessionProperties){this.path=path,this.message=message,this.recipient=recipient,this.sessionProperties=sessionProperties}module.exports=SessionForwardSendRequest},{}],201:[function(_dereq_,module){var OptionsSerialiser=(_dereq_("./session-send-request"),_dereq_("./send-options-serialiser")),ContentSerialiser=_dereq_("content/serialiser"),SessionSerialiser=_dereq_("session/session-id-serialiser"),CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),sender=SessionSerialiser.read(input),options=OptionsSerialiser.read(input),cid=CIDSerialiser.read(input);return{cid:cid,path:path,sender:sender,message:content,options:options}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),SessionSerialiser.write(output,req.session),OptionsSerialiser.write(output,req.options),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./send-options-serialiser":196,"./session-send-request":202,"content/serialiser":72,"conversation/conversation-id-serialiser":80,"io/codec":115,"session/session-id-serialiser":237}],202:[function(_dereq_,module){function SessionSendRequest(path,message,recipient){this.path=path,this.message=message,this.recipient=recipient}module.exports=SessionSendRequest},{}],203:[function(_dereq_,module){var HashMap=_dereq_("hashmap"),CommandHeader=_dereq_("services/command-header"),CommandHeaderSerialiser=_dereq_("services/command-header-serialiser"),CommandError=_dereq_("services/command-error"),CommandErrorSerialiser=_dereq_("services/command-error-serialiser"),TopicSelector=_dereq_("../../selectors/topic-selector"),TopicSelectorSerialiser=_dereq_("topics/topic-selector-serialiser"),ErrorReport=_dereq_("services/error-report"),ErrorReportSerialiser=_dereq_("services/error-report-serialiser.js"),serialisers=new HashMap;serialisers.set(CommandError,CommandErrorSerialiser),serialisers.set(CommandHeader,CommandHeaderSerialiser),serialisers.set(TopicSelector,TopicSelectorSerialiser),serialisers.set(ErrorReport,ErrorReportSerialiser),serialisers.set(null,{read:function(){return null},write:function(){}}),serialisers.set(Boolean,_dereq_("serialisers/boolean-serialiser")),serialisers.set(_dereq_("./subscription-notification/subscription-notification"),_dereq_("./subscription-notification/subscription-notification-serialiser")),serialisers.set(_dereq_("./unsubscription-notification/unsubscription-notification"),_dereq_("./unsubscription-notification/unsubscription-notification-serialiser")),serialisers.set(_dereq_("./get-topic-details/get-topic-details"),_dereq_("./get-topic-details/get-topic-details-serialiser")),serialisers.set(_dereq_("./add-topic/add-topic"),_dereq_("./add-topic/add-topic-serialiser")),serialisers.set(_dereq_("./remove-topic/remove-topic"),_dereq_("./remove-topic/remove-topic-serialiser")),serialisers.set(_dereq_("./update-topic/update-topic-request"),_dereq_("./update-topic/update-topic-request-serialiser")),serialisers.set(_dereq_("./update-topic/update-topic-response"),_dereq_("./update-topic/update-topic-response-serialiser")),serialisers.set(_dereq_("./wills/topic-will-parameters"),_dereq_("./wills/topic-will-parameters-serialiser")),serialisers.set(_dereq_("./wills/will-registration-result"),_dereq_("./wills/will-registration-result-serialiser")),serialisers.set(_dereq_("./send/send-request"),_dereq_("./send/send-request-serialiser")),serialisers.set(_dereq_("./send/session-send-request"),_dereq_("./send/session-send-request-serialiser"));var security=_dereq_("../../features/security");serialisers.set(security.SystemAuthenticationConfiguration,_dereq_("./authentication/system-authentication-configuration-serialiser")),serialisers.set(security.SecurityConfiguration,_dereq_("./security/security-configuration-serialiser")),serialisers.set(security.SystemPrincipal,_dereq_("./authentication/system-principal-serialiser")),serialisers.set(_dereq_("./authentication/security-command-script"),_dereq_("./authentication/security-command-script-serialiser")),serialisers.set(_dereq_("./authentication/security-command-script-result"),_dereq_("./authentication/security-command-script-result-serialiser")),serialisers.set(_dereq_("session/session-id"),_dereq_("session/session-id-serialiser")),serialisers.set(_dereq_("services/control/topic-control-registration-request"),_dereq_("services/control/topic-control-registration-request-serialiser")),serialisers.set(_dereq_("services/control/topic-control-registration-params"),_dereq_("services/control/topic-control-registration-params-serialiser")),serialisers.set(_dereq_("services/control/control-registration-request"),_dereq_("services/control/control-registration-request-serialiser")),serialisers.set(_dereq_("services/control/control-registration-request"),_dereq_("services/control/control-registration-request-serialiser")),serialisers.set(_dereq_("services/change-principal/change-principal-request"),_dereq_("services/change-principal/change-principal-request-serialiser")),serialisers.set(_dereq_("./send/session-forward-send-request"),_dereq_("./send/session-forward-send-request-serialiser")),serialisers.set(_dereq_("services/control/message-receiver-control-registration-request"),_dereq_("services/control/message-receiver-control-registration-request-serialiser")),serialisers.set(_dereq_("services/control/message-receiver-control-registration-params"),_dereq_("services/control/message-receiver-control-registration-params-serialiser")),serialisers.set(_dereq_("./send/filter-send-request"),_dereq_("./send/filter-send-request-serialiser")),serialisers.set(_dereq_("./send/filter-send-result"),_dereq_("./send/filter-send-result-serialiser")),serialisers.set(_dereq_("services/control/get-session-properties"),_dereq_("services/control/get-session-properties-serialiser")),serialisers.set(_dereq_("services/control/set-session-properties-listener"),_dereq_("services/control/set-session-properties-listener-serialiser")),serialisers.set(_dereq_("services/control/session-properties-event"),_dereq_("services/control/session-properties-event-serialiser")),serialisers.set(_dereq_("services/control/session-properties-event-batch"),_dereq_("services/control/session-properties-event-batch-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-registration-request"),_dereq_("services/topic-update/update-source-registration-request-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-deregistration-request"),_dereq_("services/topic-update/update-source-deregistration-request-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-state-request"),_dereq_("services/topic-update/update-source-state-request-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-state"),_dereq_("services/topic-update/update-source-state-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-update"),_dereq_("services/topic-update/update-source-update-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-update-response"),_dereq_("services/topic-update/update-source-update-response-serialiser")),serialisers.set(_dereq_("services/update-topic/update-topic-set-request"),_dereq_("services/update-topic/update-topic-set-request-serialiser")),serialisers.set(_dereq_("services/update-topic/update-topic-delta-request"),_dereq_("services/update-topic/update-topic-delta-request-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-set-request"),_dereq_("services/topic-update/update-source-set-request-serialiser")),serialisers.set(_dereq_("services/topic-update/update-source-delta-request"),_dereq_("services/topic-update/update-source-delta-request-serialiser")),serialisers.set(_dereq_("services/missing-topic/missing-topic-request"),_dereq_("services/missing-topic/missing-topic-request-serialiser")),module.exports=serialisers},{"../../features/security":48,"../../selectors/topic-selector":278,"./add-topic/add-topic":145,"./add-topic/add-topic-serialiser":144,"./authentication/security-command-script":150,"./authentication/security-command-script-result":148,"./authentication/security-command-script-result-serialiser":147,"./authentication/security-command-script-serialiser":149,"./authentication/system-authentication-configuration-serialiser":151,"./authentication/system-principal-serialiser":152,"./get-topic-details/get-topic-details":185,"./get-topic-details/get-topic-details-serialiser":184,"./remove-topic/remove-topic":189,"./remove-topic/remove-topic-serialiser":188,"./security/security-configuration-serialiser":191,"./send/filter-send-request":193,"./send/filter-send-request-serialiser":192,"./send/filter-send-result":195,"./send/filter-send-result-serialiser":194,"./send/send-request":198,"./send/send-request-serialiser":197,"./send/session-forward-send-request":200,"./send/session-forward-send-request-serialiser":199,"./send/session-send-request":202,"./send/session-send-request-serialiser":201,"./subscription-notification/subscription-notification":206,"./subscription-notification/subscription-notification-serialiser":205,"./unsubscription-notification/unsubscription-notification":224,"./unsubscription-notification/unsubscription-notification-serialiser":223,"./update-topic/update-topic-request":228,"./update-topic/update-topic-request-serialiser":227,"./update-topic/update-topic-response":230,"./update-topic/update-topic-response-serialiser":229,"./wills/topic-will-parameters":234,"./wills/topic-will-parameters-serialiser":233,"./wills/will-registration-result":236,"./wills/will-registration-result-serialiser":235,hashmap:7,"serialisers/boolean-serialiser":140,"services/change-principal/change-principal-request":154,"services/change-principal/change-principal-request-serialiser":153,"services/command-error":156,"services/command-error-serialiser":155,"services/command-header":158,"services/command-header-serialiser":157,"services/control/control-registration-request":163,"services/control/control-registration-request-serialiser":162,"services/control/get-session-properties":165,"services/control/get-session-properties-serialiser":164,"services/control/message-receiver-control-registration-params":167,"services/control/message-receiver-control-registration-params-serialiser":166,"services/control/message-receiver-control-registration-request":169,"services/control/message-receiver-control-registration-request-serialiser":168,"services/control/session-properties-event":175,"services/control/session-properties-event-batch":172,"services/control/session-properties-event-batch-serialiser":171,"services/control/session-properties-event-serialiser":173,"services/control/set-session-properties-listener":177,"services/control/set-session-properties-listener-serialiser":176,"services/control/topic-control-registration-params":179,"services/control/topic-control-registration-params-serialiser":178,"services/control/topic-control-registration-request":181,"services/control/topic-control-registration-request-serialiser":180,"services/error-report":183,"services/error-report-serialiser.js":182,"services/missing-topic/missing-topic-request":187,"services/missing-topic/missing-topic-request-serialiser":186,"services/topic-update/update-source-delta-request":208,"services/topic-update/update-source-delta-request-serialiser":207,"services/topic-update/update-source-deregistration-request":210,"services/topic-update/update-source-deregistration-request-serialiser":209,"services/topic-update/update-source-registration-request":212,"services/topic-update/update-source-registration-request-serialiser":211,"services/topic-update/update-source-set-request":214,"services/topic-update/update-source-set-request-serialiser":213,"services/topic-update/update-source-state":218,"services/topic-update/update-source-state-request":216,"services/topic-update/update-source-state-request-serialiser":215,"services/topic-update/update-source-state-serialiser":217,"services/topic-update/update-source-update":222,"services/topic-update/update-source-update-response":220,"services/topic-update/update-source-update-response-serialiser":219,"services/topic-update/update-source-update-serialiser":221,"services/update-topic/update-topic-delta-request":226,"services/update-topic/update-topic-delta-request-serialiser":225,"services/update-topic/update-topic-set-request":232,"services/update-topic/update-topic-set-request-serialiser":231,"session/session-id":238,"session/session-id-serialiser":237,"topics/topic-selector-serialiser":252}],204:[function(_dereq_,module){var TopicSelector=_dereq_("../../selectors/topic-selector"),SubscriptionNotification=_dereq_("services/subscription-notification/subscription-notification"),UnsubscriptionNotification=_dereq_("services/unsubscription-notification/unsubscription-notification"),GetTopicDetails=_dereq_("services/get-topic-details/get-topic-details"),AddTopic=_dereq_("services/add-topic/add-topic"),RemoveTopic=_dereq_("services/remove-topic/remove-topic"),UpdateTopicRequest=_dereq_("services/update-topic/update-topic-request"),UpdateTopicSetRequest=_dereq_("services/update-topic/update-topic-set-request"),UpdateTopicDeltaRequest=_dereq_("services/update-topic/update-topic-delta-request"),UpdateTopicResponse=_dereq_("services/update-topic/update-topic-response"),SecurityCommandScript=_dereq_("services/authentication/security-command-script"),SecurityCommandScriptResult=_dereq_("services/authentication/security-command-script-result"),SecurityConfiguration=_dereq_("../../features/security").SecurityConfiguration,SystemAuthenticationConfiguration=_dereq_("../../features/security").SystemAuthenticationConfiguration,TopicWillParameters=_dereq_("services/wills/topic-will-parameters"),WillRegistrationResult=_dereq_("services/wills/will-registration-result"),SendRequest=_dereq_("services/send/send-request"),SessionSendRequest=_dereq_("services/send/session-send-request"),TopicControlRegistrationRequest=_dereq_("services/control/topic-control-registration-request"),TopicControlRegistrationParams=_dereq_("services/control/topic-control-registration-params"),UpdateSourceRegistrationRequest=_dereq_("services/topic-update/update-source-registration-request"),UpdateSourceDeregistrationRequest=_dereq_("services/topic-update/update-source-deregistration-request"),UpdateSourceUpdate=_dereq_("services/topic-update/update-source-update"),UpdateSourceSetRequest=_dereq_("services/topic-update/update-source-set-request"),UpdateSourceDeltaRequest=_dereq_("services/topic-update/update-source-delta-request"),UpdateSourceUpdateResponse=_dereq_("services/topic-update/update-source-update-response"),UpdateSourceStateRequest=_dereq_("services/topic-update/update-source-state-request"),UpdateSourceState=_dereq_("services/topic-update/update-source-state"),ControlRegistrationRequest=_dereq_("services/control/control-registration-request"),ControlRegistrationParams=_dereq_("services/control/control-registration-params"),ChangePrincipalRequest=_dereq_("services/change-principal/change-principal-request"),SessionForwardSendRequest=_dereq_("services/send/session-forward-send-request"),MessageReceiverControlRegistrationRequest=_dereq_("services/control/message-receiver-control-registration-request"),MessageReceiverControlRegistrationParams=_dereq_("services/control/message-receiver-control-registration-params"),FilterSendRequest=_dereq_("services/send/filter-send-request"),FilterSendResult=_dereq_("services/send/filter-send-result"),GetSessionProperties=_dereq_("services/control/get-session-properties"),SetSessionPropertiesListener=_dereq_("services/control/set-session-properties-listener"),SessionPropertiesEvent=_dereq_("services/control/session-properties-event"),SessionPropertiesEventBatch=_dereq_("services/control/session-properties-event-batch"),MissingTopicRequest=_dereq_("services/missing-topic/missing-topic-request");module.exports={SUBSCRIBE:{id:3,name:"Subscribe",request:TopicSelector,response:null},UNSUBSCRIBE:{id:4,name:"Unsubscribe",request:TopicSelector,response:null},SEND:{id:6,name:"Send",request:SendRequest,response:null},SEND_TO_SESSION:{id:28,name:"Send to session",request:SessionSendRequest,response:null},SUBSCRIPTION_NOTIFICATION:{id:40,name:"Subscription Notification",request:SubscriptionNotification,response:null},GET_TOPIC_DETAILS:{id:41,name:"Get Topic Details",request:GetTopicDetails,response:GetTopicDetails},UNSUBSCRIPTION_NOTIFICATION:{id:42,name:"Unsubscription Notification",request:UnsubscriptionNotification,response:null},ADD_TOPIC:{id:46,name:"Add Topic",request:AddTopic,response:AddTopic},REMOVE_TOPIC:{id:47,name:"Remove Topic",request:RemoveTopic,response:RemoveTopic},MISSING_TOPIC:{id:50,name:"Missing topic",request:MissingTopicRequest,response:Boolean},TOPIC_SCOPED_WILL_REGISTRATION:{id:53,name:"Topic Will Registration",request:TopicWillParameters,response:WillRegistrationResult},TOPIC_SCOPED_WILL_DEREGISTRATION:{id:54,name:"Topic Will Deregistration",request:TopicWillParameters,response:null},SYSTEM_PING:{id:55,name:"System Ping",request:null,response:null},USER_PING:{id:56,name:"User Ping",request:null,response:null},CHANGE_PRINCIPAL:{id:5,name:"Change Principal",request:ChangePrincipalRequest,response:Boolean},GET_SYSTEM_AUTHENTICATION:{id:57,name:"Get System Authentication",request:null,response:SystemAuthenticationConfiguration},UPDATE_SYSTEM_AUTHENTICATION:{id:58,name:"Update System Authentication",request:SecurityCommandScript,response:SecurityCommandScriptResult},GET_SECURITY_CONFIGURATION:{id:59,name:"Get Security Configuration",request:null,response:SecurityConfiguration},UPDATE_SECURITY_CONFIGURATION:{id:60,name:"Update Security Configuration",request:SecurityCommandScript,response:SecurityCommandScriptResult},UPDATE_TOPIC:{id:61,name:"Update Topic",request:UpdateTopicRequest,response:UpdateTopicResponse},SERVER_CONTROL_REGISTRATION:{id:18,name:"Server Control Registration",request:ControlRegistrationRequest,response:null},SERVER_CONTROL_DEREGISTRATION:{id:19,name:"Server Control Deregistration",request:ControlRegistrationParams,response:null},TOPIC_CONTROL_REGISTRATION:{id:20,name:"Topic Control Registration",request:TopicControlRegistrationRequest,response:null},TOPIC_CONTROL_DEREGISTRATION:{id:21,name:"Topic Control Deregistration",request:TopicControlRegistrationParams,response:null},UPDATE_SOURCE_REGISTRATION:{id:30,name:"Update Source Registration",request:UpdateSourceRegistrationRequest,response:UpdateSourceState},UPDATE_SOURCE_DEREGISTRATION:{id:31,name:"Update Source Deregistration",request:UpdateSourceDeregistrationRequest,response:null},UPDATE_SOURCE_STATE:{id:32,name:"Update Source State",request:UpdateSourceStateRequest,response:null},UPDATE_SOURCE_UPDATE:{id:35,name:"Update Source Update",request:UpdateSourceUpdate,response:UpdateSourceUpdateResponse},SEND_RECEIVER_CLIENT:{id:62,name:"Control Client Send Service",request:SessionForwardSendRequest,response:null},MESSAGE_RECEIVER_CONTROL_REGISTRATION:{id:63,name:"Message Receiver Control Registration",request:MessageReceiverControlRegistrationRequest,response:null},MESSAGE_RECEIVER_CONTROL_DEREGISTRATION:{id:64,name:"Message Receiver Control Deregistration",request:MessageReceiverControlRegistrationParams,response:null},SEND_TO_FILTER:{id:29,name:"Send to filter",request:FilterSendRequest,response:FilterSendResult},GET_SESSION_PROPERTIES:{id:67,name:"Get session properties",request:GetSessionProperties,response:GetSessionProperties},SESSION_PROPERTIES_REGISTRATION:{id:69,name:"Set session properties listener - legacy, see SESSION_PROPERTIES_REGISTRATION_2",request:SetSessionPropertiesListener,response:null},SESSION_PROPERTIES_EVENT:{id:70,name:"Session properties event - legacy, see SESSION_PROPERTIES_EVENT_2",request:SessionPropertiesEvent,response:null},UPDATE_SOURCE_SET:{id:77,name:"Update source set",request:UpdateSourceSetRequest,response:UpdateSourceUpdateResponse},UPDATE_SOURCE_DELTA:{id:78,name:"Update source delta",request:UpdateSourceDeltaRequest,response:UpdateSourceUpdateResponse},UPDATE_TOPIC_SET:{id:79,name:"Update topic set",request:UpdateTopicSetRequest,response:UpdateTopicResponse},UPDATE_TOPIC_DELTA:{id:80,name:"Update topic delta",request:UpdateTopicDeltaRequest,response:UpdateTopicResponse},SESSION_PROPERTIES_REGISTRATION_2:{id:81,name:"Session Properties registration 2",request:SetSessionPropertiesListener,response:null},SESSION_PROPERTIES_EVENT_2:{id:82,name:"Session Properties event 2",request:SessionPropertiesEventBatch,response:null}}},{"../../features/security":48,"../../selectors/topic-selector":278,"services/add-topic/add-topic":145,"services/authentication/security-command-script":150,"services/authentication/security-command-script-result":148,"services/change-principal/change-principal-request":154,"services/control/control-registration-params":161,"services/control/control-registration-request":163,"services/control/get-session-properties":165,"services/control/message-receiver-control-registration-params":167,"services/control/message-receiver-control-registration-request":169,"services/control/session-properties-event":175,"services/control/session-properties-event-batch":172,"services/control/set-session-properties-listener":177,"services/control/topic-control-registration-params":179,"services/control/topic-control-registration-request":181,"services/get-topic-details/get-topic-details":185,"services/missing-topic/missing-topic-request":187,"services/remove-topic/remove-topic":189,"services/send/filter-send-request":193,"services/send/filter-send-result":195,"services/send/send-request":198,"services/send/session-forward-send-request":200,"services/send/session-send-request":202,"services/subscription-notification/subscription-notification":206,"services/topic-update/update-source-delta-request":208,"services/topic-update/update-source-deregistration-request":210,"services/topic-update/update-source-registration-request":212,"services/topic-update/update-source-set-request":214,"services/topic-update/update-source-state":218,"services/topic-update/update-source-state-request":216,"services/topic-update/update-source-update":222,"services/topic-update/update-source-update-response":220,"services/unsubscription-notification/unsubscription-notification":224,"services/update-topic/update-topic-delta-request":226,"services/update-topic/update-topic-request":228,"services/update-topic/update-topic-response":230,"services/update-topic/update-topic-set-request":232,"services/wills/topic-will-parameters":234,"services/wills/will-registration-result":236}],205:[function(_dereq_,module){var TopicInfoSerialiser=_dereq_("topics/details/topic-info-serialiser"),SubscriptionNotification=_dereq_("./subscription-notification");module.exports={read:function(input){var info=TopicInfoSerialiser.read(input);return new SubscriptionNotification(info)},write:function(out,notification){TopicInfoSerialiser.write(out,notification.info)
}}},{"./subscription-notification":206,"topics/details/topic-info-serialiser":245}],206:[function(_dereq_,module){function SubscriptionNotification(info){this.info=info}module.exports=SubscriptionNotification},{}],207:[function(_dereq_,module){var CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(bis){return{cid:CIDSerialiser.read(bis),path:bis.readString(),id:bis.readInt32(),bytes:bis.readBytes()}},write:function(bos,req){CIDSerialiser.write(bos,req.cid),Codec.writeString(bos,req.path),Codec.writeInt32(bos,req.id),Codec.writeBytes(bos,req.bytes)}}},{"conversation/conversation-id-serialiser":80,"io/codec":115}],208:[function(_dereq_,module){module.exports=function(cid,path,id,bytes){this.cid=cid,this.path=path,this.id=id,this.bytes=bytes}},{}],209:[function(_dereq_,module){var CIDSerialiser=_dereq_("conversation/conversation-id-serialiser");module.exports={read:function(input){var cid=CIDSerialiser.read(input);return{cid:cid}},write:function(output,req){CIDSerialiser.write(output,req.cid)}}},{"conversation/conversation-id-serialiser":80}],210:[function(_dereq_,module){module.exports=function(cid){this.cid=cid}},{}],211:[function(_dereq_,module){var CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(input){var cid=CIDSerialiser.read(input),path=Codec.readString(input);return{cid:cid,path:path}},write:function(output,req){CIDSerialiser.write(output,req.cid),Codec.writeString(output,req.path)}}},{"conversation/conversation-id-serialiser":80,"io/codec":115}],212:[function(_dereq_,module){module.exports=function(cid,path){this.cid=cid,this.path=path}},{}],213:[function(_dereq_,module){var CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(bis){return{cid:CIDSerialiser.read(bis),path:bis.readString(),bytes:bis.readBytes()}},write:function(bos,req){CIDSerialiser.write(bos,req.cid),Codec.writeString(bos,req.path),Codec.writeBytes(bos,req.bytes)}}},{"conversation/conversation-id-serialiser":80,"io/codec":115}],214:[function(_dereq_,module){module.exports=function(cid,path,bytes){this.cid=cid,this.path=path,this.bytes=bytes}},{}],215:[function(_dereq_,module){var UpdateStateSerialiser=_dereq_("services/topic-update/update-source-state-serialiser"),CIDSerialiser=_dereq_("conversation/conversation-id-serialiser");module.exports={read:function(input){var cid=CIDSerialiser.read(input),old=UpdateStateSerialiser.read(input),current=UpdateStateSerialiser.read(input);return{cid:cid,old:old,current:current}},write:function(output,req){CIDSerialiser.write(output,req.cid),UpdateStateSerialiser.write(output,req.old),UpdateStateSerialiser.write(output,req.current)}}},{"conversation/conversation-id-serialiser":80,"services/topic-update/update-source-state-serialiser":217}],216:[function(_dereq_,module){module.exports=function(cid,old,current){this.cid=cid,this.old=old,this.current=current}},{}],217:[function(_dereq_,module){var EnumSerialiser=_dereq_("serialisers/enum-converter"),State={init:0,active:1,closed:2,standby:3};module.exports={read:function(input){return EnumSerialiser.read(input,State)},write:function(output,req){EnumSerialiser.write(output,req,State)}}},{"serialisers/enum-converter":142}],218:[function(_dereq_,module){module.exports=function(state){this.state=state}},{}],219:[function(_dereq_,module){var UpdateSourceUpdateResponse=_dereq_("services/topic-update/update-source-update-response"),EnumSerialiser=_dereq_("serialisers/enum-converter"),Codec=_dereq_("io/codec"),ResponseCodes={SUCCESS:0,INCOMPATIBLE_UPDATE:1,UPDATE_FAILED:2,INVALID_UPDATER:3,MISSING_TOPIC:4,INVALID_ADDRESS:5,DUPLICATES:6,EXCLUSIVE_UPDATER_CONFLICT:7};module.exports={read:function(input){if(0===Codec.readByte(input))return new UpdateSourceUpdateResponse;var error=EnumSerialiser.read(input,ResponseCodes);return new UpdateSourceUpdateResponse(error)},write:function(output,req){req.error?(Codec.writeByte(output,1),EnumSerialiser.write(output,req.error,ResponseCodes)):Codec.writeByte(output,0)}}},{"io/codec":115,"serialisers/enum-converter":142,"services/topic-update/update-source-update-response":220}],220:[function(_dereq_,module){module.exports=function(error){this.error=error}},{}],221:[function(_dereq_,module){var CIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),UpdateSerialiser=_dereq_("update/serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(input){var cid=CIDSerialiser.read(input),path=Codec.readString(input),val=UpdateSerialiser.read(input);return{cid:cid,path:path,update:val}},write:function(output,req){CIDSerialiser.write(output,req.cid),Codec.writeString(output,req.path),UpdateSerialiser.write(output,req.update)}}},{"conversation/conversation-id-serialiser":80,"io/codec":115,"update/serialiser":258}],222:[function(_dereq_,module){module.exports=function(cid,path,update){this.cid=cid,this.path=path,this.update=update}},{}],223:[function(_dereq_,module){var UnsubscribeReason=_dereq_("../../../topics/topics").UnsubscribeReason,TopicIdSerialiser=_dereq_("topics/details/topic-id-serialiser"),UnsubscriptionNotification=_dereq_("./unsubscription-notification"),ByteEncodedEnumSerialiser=_dereq_("serialisers/byte-encoded-enum-serialiser");module.exports={read:function(input){var id=TopicIdSerialiser.read(input),reason=ByteEncodedEnumSerialiser.read(input,UnsubscribeReason);return new UnsubscriptionNotification(id,reason)},write:function(out,notification){TopicIdSerialiser.write(out,notification.id),ByteEncodedEnumSerialiser.write(out,notification.reason)}}},{"../../../topics/topics":281,"./unsubscription-notification":224,"serialisers/byte-encoded-enum-serialiser":141,"topics/details/topic-id-serialiser":244}],224:[function(_dereq_,module){function UnsubscriptionNotification(id,reason){this.id=id,this.reason=reason}module.exports=UnsubscriptionNotification},{}],225:[function(_dereq_,module){var Codec=_dereq_("io/codec");module.exports={read:function(bis){return{path:bis.readString(),id:bis.readInt32(),bytes:bis.readBytes()}},write:function(bos,req){Codec.writeString(bos,req.path),Codec.writeInt32(bos,req.id),Codec.writeBytes(bos,req.bytes)}}},{"io/codec":115}],226:[function(_dereq_,module){module.exports=function(path,id,bytes){this.path=path,this.id=id,this.bytes=bytes}},{}],227:[function(_dereq_,module){var UpdateSerialiser=_dereq_("../../update/serialiser"),Codec=_dereq_("io/codec");module.exports={read:function(input){return{path:Codec.readString(input),update:UpdateSerialiser.read(input)}},write:function(output,request){Codec.writeString(output,request.path),UpdateSerialiser.write(output,request.update)}}},{"../../update/serialiser":258,"io/codec":115}],228:[function(_dereq_,module){module.exports=function(path,update){this.path=path,this.update=update}},{}],229:[function(_dereq_,module){var BEES=(_dereq_("io/codec"),_dereq_("serialisers/byte-encoded-enum-serialiser")),UpdateTopicResponse=_dereq_("./update-topic-response");module.exports={read:function(input){var reason=BEES.read(input,UpdateTopicResponse);return{reason:reason,isError:reason!==UpdateTopicResponse.SUCCESS}},write:function(output,request){BEES.write(output,request.reason)}}},{"./update-topic-response":230,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],230:[function(_dereq_,module){module.exports={SUCCESS:{id:0,reason:"The update was succesful"},INCOMPATIBLE_UPDATE:{id:1,reason:"The update value was incompatible with the topic type"},UPDATE_FAILED:{id:2,reason:"The update could not be applied"},INVALID_UPDATER:{id:3,reason:"The updater was invalid for updating this topic"},MISSING_TOPIC:{id:4,reason:"The specified topic does not exist"},INVALID_ADDRESS:{id:5,reason:"The update for a Paged Topic contained an invalid index"},DUPLICATES:{id:6,reason:"The update for a Paged Topic contained invalid duplicate items"},EXCLUSIVE_UPDATER_CONFLICT:{id:7,reason:"An exclusive update source is already registered for the topic branch"},DELTA_WITHOUT_VALUE:{id:8,reason:"A delta was applied to a topic that does not yet have a value"}}},{}],231:[function(_dereq_,module){var Codec=_dereq_("io/codec");module.exports={read:function(bis){return{path:bis.readString(),bytes:bis.readBytes()}},write:function(bos,req){Codec.writeString(bos,req.path),Codec.writeBytes(bos,req.bytes)}}},{"io/codec":115}],232:[function(_dereq_,module){module.exports=function(path,bytes){this.path=path,this.bytes=bytes}},{}],233:[function(_dereq_,module){var BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),TopicWillParameters=_dereq_("./topic-will-parameters"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),will=BEES.read(input,TopicWillParameters.Will);return new TopicWillParameters(path,will)},write:function(out,params){Codec.writeString(out,params.path),BEES.write(out,params.will)}};module.exports=serialiser},{"./topic-will-parameters":234,"io/codec":115,"serialisers/byte-encoded-enum-serialiser":141}],234:[function(_dereq_,module){function TopicWillParameters(path,will){this.path=path,this.will=will}var Will={REMOVE_TOPICS:0};TopicWillParameters.prototype.toString=function(){return"TopicWillParams ["+this.will+", "+this.path+"]"},TopicWillParameters.Will=Will,module.exports=TopicWillParameters},{}],235:[function(_dereq_,module){var BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),WillRegistrationResult=_dereq_("./will-registration-result"),serialiser={read:function(input){return BEES.read(input,WillRegistrationResult)},write:function(output,result){BEES.write(output,result)}};module.exports=serialiser},{"./will-registration-result":236,"serialisers/byte-encoded-enum-serialiser":141}],236:[function(_dereq_,module){var WillRegistrationResult={SUCCESS:0,GROUP_CONFLICT:1,TOPIC_TREE_CONFLICT:2};WillRegistrationResult.toString=function(){return"WillRegistrationResult"},module.exports=WillRegistrationResult},{}],237:[function(_dereq_,module){var SessionID=_dereq_("session/session-id"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var server=Codec.readInt64(input),value=Codec.readInt64(input);return new SessionID(server,value)},write:function(output,sessionID){Codec.writeInt64(output,sessionID.server),Codec.writeInt64(output,sessionID.value)}};module.exports=serialiser},{"io/codec":115,"session/session-id":238}],238:[function(_dereq_,module){function SessionId(server,value){this.server=server,this.value=value}var Long=_dereq_("long"),padding="0000000000000000";SessionId.prototype.toString=function(){var server=padding+this.server.toUnsigned().toString(16),client=padding+this.value.toUnsigned().toString(16);return(server.substr(server.length-16)+"-"+client.substr(client.length-16)).toUpperCase()},SessionId.prototype.toValue=function(){return this.toString()},SessionId.fromString=function(str){if(-1===str.indexOf("-"))throw new Error("SessionId must consist of two hexadecimal parts, joined with a '-'");var parts=(""+str).split("-"),server=Long.fromString(parts[0],!1,16),value=Long.fromString(parts[1],!1,16);return new SessionId(server,value)},module.exports=SessionId},{"long":10}],239:[function(_dereq_,module){function SessionImpl(options){var emitter=new Emitter(void 0,void 0,["connect","reconnect","disconnect"]),serviceRegistry=new ServiceRegistry,conversationSet=new DelegatingConversationSet(function(cid,err){emitter.error(err)});options=new Options("string"==typeof options?{host:options}:options),serviceRegistry.add(Services.USER_PING,PingService),serviceRegistry.add(Services.SYSTEM_PING,MonitoredPingService),serviceRegistry.add(Services.SUBSCRIPTION_NOTIFICATION,NotifySubscriptionService),serviceRegistry.add(Services.UNSUBSCRIPTION_NOTIFICATION,NotifyUnsubscriptionService);var internalSession=new InternalSession(conversationSet,serviceRegistry,ConnectionFactory,options),session=new Session(internalSession,emitter,options["with"]({credentials:void 0}));session.on("error",internalSession.close),internalSession.on({connect:function(sessionID){session.sessionID=sessionID.toString(),emitter.emit("connect",session)},reconnect:function(){emitter.emit("reconnect")},disconnect:function(reason){emitter.emit("disconnect",reason)},error:function(err){emitter.emit("error",err)},close:function(reason){emitter.emit("close",reason)}}),this.connect=function(){internalSession.connect()},this.get=function(){return session}}var Emitter=_dereq_("events/emitter"),InternalSession=_dereq_("client/internal-session"),ServiceRegistry=_dereq_("client/service-registry"),ConnectionFactory=_dereq_("v4-stack/connection-factory"),DelegatingConversationSet=_dereq_("conversation/delegating-conversation-set"),Services=_dereq_("services/services"),MonitoredPingService=_dereq_("client/services/monitored-ping-service"),PingService=_dereq_("client/services/ping-service"),NotifySubscriptionService=_dereq_("client/services/notify-subscription-service"),NotifyUnsubscriptionService=_dereq_("client/services/notify-unsubscription-service"),Options=_dereq_("../../options"),Session=_dereq_("../../session");module.exports=SessionImpl},{"../../options":277,"../../session":280,"client/internal-session":61,"client/service-registry":64,"client/services/monitored-ping-service":65,"client/services/notify-subscription-service":66,"client/services/notify-unsubscription-service":67,"client/services/ping-service":68,"conversation/delegating-conversation-set":84,"events/emitter":95,"services/services":204,"v4-stack/connection-factory":273}],240:[function(_dereq_,module){function readToken(input){return new SessionToken(input.readMany(SessionToken.TOKEN_LENGTH))}var SessionToken=_dereq_("session/session-token");module.exports=readToken},{"session/session-token":241}],241:[function(_dereq_,module){(function(Buffer){function SessionToken(external){this.put=function(destination){destination.writeBytes(external)},this.toString=function(){return external.toString("ascii")}}var TOKEN_LENGTH=24;SessionToken.fromExternalString=function(external){return new SessionToken(new Buffer(external,"ascii"))},SessionToken.TOKEN_LENGTH=TOKEN_LENGTH,module.exports=SessionToken}).call(this,_dereq_("buffer").Buffer)},{buffer:2}],242:[function(_dereq_,module){var Codec=_dereq_("io/codec"),serialiser=_dereq_("schema/serialiser"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),TopicType=_dereq_("../../../topics/topics").TopicType;module.exports={read:function(input){var details={};return Codec.readBoolean(input)&&(details.type=BEES.read(input,TopicType),Codec.readBoolean(input)&&(details.schema=serialiser.read(input))),details},write:function(output,details){details?(Codec.writeBoolean(output,!0),BEES.write(output,details.type),details.schema&&(Codec.writeBoolean(output,!0),serialiser.write(output,details.schema)),Codec.writeBoolean(output,!1)):Codec.writeBoolean(output,!1)}}},{"../../../topics/topics":281,"io/codec":115,"schema/serialiser":138,"serialisers/byte-encoded-enum-serialiser":141}],243:[function(_dereq_,module){var TopicType=_dereq_("../../../topics/topics").TopicType,DataTypes=_dereq_("data/datatypes"),schema=_dereq_("schema/schema"),util=_dereq_("metadata/util");module.exports.deriveDetails=function(value){var details={};for(var t in TopicType)if(TopicType[t]===value)return{type:value};if(util.isMetadataValue(value)){var meta=util.deriveMetadata(value);details.type=util.getType(meta),details.schema=schema(meta)}else{var datatype=DataTypes.get(value);details.type=TopicType[datatype.name().toUpperCase()],details.schema={},details.content=datatype.from(value)}return details}},{"../../../topics/topics":281,"data/datatypes":90,"metadata/util":124,"schema/schema":137}],244:[function(_dereq_,module){var Codec=_dereq_("io/codec"),serialiser={read:function(bis){return Codec.readInt32(bis)},write:function(bos,id){Codec.writeInt32(bos,id)}};module.exports=serialiser},{"io/codec":115}],245:[function(_dereq_,module){var Codec=_dereq_("io/codec"),TopicIdSerialiser=_dereq_("./topic-id-serialiser"),TopicDetailsSerialiser=_dereq_("./topic-details-serialiser"),serialiser={read:function(input){return{id:TopicIdSerialiser.read(input),path:Codec.readString(input),details:TopicDetailsSerialiser.read(input)}},write:function(out,info){TopicIdSerialiser.write(out,info.id),Codec.writeString(out,info.path),TopicDetailsSerialiser.write(out,info.details)}};module.exports=serialiser},{"./topic-details-serialiser":242,"./topic-id-serialiser":244,"io/codec":115}],246:[function(_dereq_,module){function FullPathSelector(components){switch(components.qualifier){case DQ.MATCH:this.regex=regex(components.base);break;case DQ.DESCENDANTS_OF_MATCH:this.regex=regex(components.base+"/.+");break;case DQ.MATCH_AND_DESCENDANTS:this.regex=regex(components.base+"(?:$|/.+)")}TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),regex=_dereq_("util/regex"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(FullPathSelector,TopicSelector),FullPathSelector.prototype.doSelects=function(topicPath){return this.regex(topicPath)},module.exports=FullPathSelector},{"../../selectors/topic-selector":278,inherits:8,"topics/topic-path-utils":250,"util/regex":268}],247:[function(_dereq_,module){function TopicPathSelector(components){var remainder=components.remainder;if(components.type===TopicSelector.Type.PATH){if(components.qualifier.includesDescendants)throw new Error("Topic path cannot select descendants: "+remainder);if(""===components.prefix)throw new Error("Topic path must have at least one part: "+remainder);if(components.prefix.indexOf("//")>-1)throw new Error("Topic path contains empty part: "+remainder)}this.qualifier=components.qualifier,this.path=components.prefix,TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(TopicPathSelector,TopicSelector),TopicPathSelector.prototype.doSelects=function(topicPath){var match=this.path===topicPath,descendants=0===topicPath.indexOf(this.path+"/");switch(this.qualifier){case DQ.MATCH:return match;case DQ.DESCENDANTS_OF_MATCH:return descendants;case DQ.MATCH_AND_DESCENDANTS:return match||descendants;default:return!1}},module.exports=TopicPathSelector},{"../../selectors/topic-selector":278,inherits:8,"topics/topic-path-utils":250}],248:[function(_dereq_,module){function extractCommonPrefix(selectors){if(0===selectors.length)return"";var minimum=2147483647,prefixes=[],i=0;selectors.forEach(function(selector){var part=utils.split(selector.prefix);minimum=Math.min(minimum,part.length),prefixes[i++]=part});var composite=[];assembly:for(var j=0;minimum>j;++j){for(var part=prefixes[0][j],k=0;k<prefixes.length;++k)if(part!==prefixes[k][j])break assembly;composite.push(part),composite.push(utils.PATH_SEPARATOR)}return utils.canonicalise(composite.join(""))}function SelectorSet(selectors){var expanded=[];selectors.forEach(function(selector){selector instanceof SelectorSet?selector.selectors.forEach(function(nested){expanded.push(nested)}):expanded.push(selector)}),this.selectors=expanded;var remainder=expanded.join(DELIMITER),prefix=extractCommonPrefix(expanded);TopicSelector.call(this,TopicSelector.Type.SELECTOR_SET,prefix,TopicSelector.Prefix.SELECTOR_SET+remainder)}var inherits=_dereq_("inherits"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../selectors/topic-selector"),DELIMITER="////";SelectorSet.DELIMITER=DELIMITER,inherits(SelectorSet,TopicSelector),SelectorSet.prototype.selects=function(topicPath){for(var i=0;i<this.selectors.length;++i)if(this.selectors[i].selects(topicPath))return!0;return!1},module.exports=SelectorSet},{"../../selectors/topic-selector":278,inherits:8,"topics/topic-path-utils":250}],249:[function(_dereq_,module){function SplitPathSelector(components){this.qualifier=components.qualifier,this.patterns=[];var parts=utils.split(components.base);parts.forEach(function(p){this.patterns.push(regex(p))}.bind(this)),TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),regex=_dereq_("util/regex"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(SplitPathSelector,TopicSelector),SplitPathSelector.prototype.doSelects=function(topicPath){var length=this.patterns.length,parts=topicPath.split(utils.PATH_SEPARATOR);switch(this.qualifier){case DQ.MATCH:if(parts.length!==length)return!1;break;case DQ.DESCENDANTS_OF_MATCH:if(parts.length<=length)return!1;break;case DQ.MATCH_AND_DESCENDANTS:if(parts.length<length)return!1}for(var i=0;length>i;++i)if(!this.patterns[i](parts[i]))return!1;return!0},module.exports=SplitPathSelector},{"../../selectors/topic-selector":278,inherits:8,"topics/topic-path-utils":250,"util/regex":268}],250:[function(_dereq_,module){function split(path){return path.split(PATH_SEPARATOR)}function canonicalise(path){if(!path)return"";var l=path.length,s=l>0&&path.charAt(0)===PATH_SEPARATOR?1:0,e=l>1&&path.charAt(l-1)===PATH_SEPARATOR?1:0;return path.substring(s,l-e)}function DQ(descendants){this.includesDescendants=descendants}var PATH_SEPARATOR="/",qualifiers={MATCH:new DQ(!1),DESCENDANTS_OF_MATCH:new DQ(!0),MATCH_AND_DESCENDANTS:new DQ(!0)};module.exports={split:split,canonicalise:canonicalise,PATH_SEPARATOR:PATH_SEPARATOR,DescendantQualifier:qualifiers}},{}],251:[function(_dereq_,module){function parse(expression){if(!expression)throw new Error("Empty topic selector expression");if(arguments.length>1&&(expression=arr.argumentsToArray(arguments)),expression instanceof Array){var actual=[];return expression.forEach(function(s){actual.push(s instanceof TopicSelector?s:parse(s))}),new SelectorSet(actual)}if("string"==typeof expression){var components=getComponents(expression);if(isTopicPath(components))return new PathSelector(components);switch(components.type){case T.SPLIT_PATH_PATTERN:return new SplitPathSelector(components);case T.FULL_PATH_PATTERN:return new FullPathSelector(components);case T.SELECTOR_SET:var parts=split(components.remainder,SelectorSet.DELIMITER),selectors=[];return parts.forEach(function(e){selectors.push(parse(e))}),new SelectorSet(selectors)}}throw new Error("Topic selector expression must be a string or array")}function getComponents(expression){var type=getType(expression);if(null===type){if(!isAlphaNumeric(expression[0]))throw new Error("Invalid expression type: "+expression);expression=P.PATH+expression,type=T.PATH}var qualifier,prefix,base,remainder=expression.substring(1);return type===T.PATH?(base=remainder,qualifier=DQ.MATCH):"/"===remainder[remainder.length-1]?"/"===remainder[remainder.length-2]?(qualifier=DQ.MATCH_AND_DESCENDANTS,base=remainder.substring(0,remainder.length-2)):(qualifier=DQ.DESCENDANTS_OF_MATCH,base=remainder.substring(0,remainder.length-1)):(base=remainder,qualifier=DQ.MATCH),prefix=type===T.PATH?utils.canonicalise(remainder):extractPrefixFromRegex(base),{type:type,base:base,prefix:prefix,remainder:remainder,qualifier:qualifier,expression:type+remainder}}function isTopicPath(c){if(c.type===T.PATH)return!0;if(c.type===T.SELECTOR_SET||""===c.prefix)return!1;return c.prefix===c.base}function isAlphaNumeric(c){return!isNaN(parseInt(c,10))||c>="a"&&"z">=c||c>="A"&&"Z">=c}function getType(expression){switch(expression[0]){case P.PATH:return T.PATH;case P.SPLIT_PATH_PATTERN:return T.SPLIT_PATH_PATTERN;case P.FULL_PATH_PATTERN:return T.FULL_PATH_PATTERN;case P.SELECTOR_SET:return T.SELECTOR_SET;default:return null}}function extractPrefixFromRegex(remainder){for(var buffer=[],composite=[],validator=normal,i=0,l=remainder.length;l>i;++i){var char=remainder[i];if("\\"===char&&l-1>i){var next=remainder[i+1];if(validator===normal&&"Q"===next)validator=quoted;else if(validator===quoted&&"E"===next)validator=normal;else{if(!("a">next||next>"z")||!("A">next||next>"Z")){buffer.length=0;break}buffer.push(next)}i++}else{if(!validator(char)){buffer.length=0;break}char===utils.PATH_SEPARATOR&&(composite.push(buffer.join("")),buffer.length=0),buffer.push(char)}}return composite.push(buffer.join("")),utils.canonicalise(composite.join(""))}var split=_dereq_("util/string").split,cache=_dereq_("util/memoize"),arr=_dereq_("util/array"),TopicSelector=_dereq_("../../selectors/topic-selector"),utils=_dereq_("topics/topic-path-utils"),PathSelector=_dereq_("topics/path-selector"),SplitPathSelector=_dereq_("topics/split-path-selector"),FullPathSelector=_dereq_("topics/full-path-selector"),SelectorSet=_dereq_("topics/selector-set"),T=TopicSelector.Type,P=TopicSelector.Prefix,DQ=utils.DescendantQualifier,metaChars=["*",".","+","?","^","$","{","}","(",")","[","]","\\"],normal=function(c){return-1===metaChars.indexOf(c)},quoted=function(){return!0};module.exports=cache(parse)},{"../../selectors/topic-selector":278,"topics/full-path-selector":246,"topics/path-selector":247,"topics/selector-set":248,"topics/split-path-selector":249,"topics/topic-path-utils":250,"util/array":260,"util/memoize":266,"util/string":270}],252:[function(_dereq_,module){var Codec=_dereq_("io/codec"),parser=_dereq_("./topic-selector-parser"),topicSelectorSerialiser={read:function(input){return parser(Codec.readString(input))},write:function(out,selector){Codec.writeString(out,selector.expression)}};module.exports=topicSelectorSerialiser},{"./topic-selector-parser":251,"io/codec":115}],253:[function(_dereq_,module){function parseResponse(onHandshakeSuccess,onHandshakeError,message){logger.trace("Received connection handshake response");var response;try{response=connectionResponseDeserialiser(message)}catch(e){return onHandshakeError(e),null}return onHandshakeSuccess(response)}var connectionResponseDeserialiser=_dereq_("protocol/connection-response-deserialiser"),logger=_dereq_("util/logger").create("Parsing");module.exports={connectionResponse:parseResponse}},{"protocol/connection-response-deserialiser":126,"util/logger":264}],254:[function(_dereq_,module){function websocketSubTransportFactoryProvider(){return"undefined"!=typeof window&&window.WebSocket?(log.debug("Using native websocket"),{constructor:window.WebSocket,enabled:!0}):"function"==typeof NodeWebSocket?(log.debug("Using Node WS library"),{constructor:NodeWebSocket,enabled:!0}):(log.debug("Websocket transport not available"),{enabled:!1})}function xhrSubTransportFactoryProvider(){return"undefined"!=typeof window&&window.XMLHttpRequest?(log.debug("Using native XHR"),{constructor:window.XMLHttpRequest,enabled:!0}):(log.debug("XHR transport not available"),{enabled:!1})}var NodeWebSocket=_dereq_("ws"),log=_dereq_("util/logger").create("Transports");module.exports={WS:websocketSubTransportFactoryProvider(),XHR:xhrSubTransportFactoryProvider(),WEBSOCKET:websocketSubTransportFactoryProvider(),HTTP_POLLING:xhrSubTransportFactoryProvider()}},{"util/logger":264,ws:1}],255:[function(_dereq_,module){function filterTransports(requestedTransports,subtransports){return requestedTransports.filter(function(name){return name&&knownTransports.hasOwnProperty(name)}).filter(function(name){return subtransports[name].enabled})}function isCascadableResponse(response){return response===ResponseCode.ERROR}function createTransport(subtransports,options,name){var transport=knownTransports[name],subtransport=subtransports[name];if(transport&&subtransport&&subtransport.enabled)return new transport(options,subtransport.constructor);throw new Error("Unknown transport name: "+name)}function CascadeDriver(subtransports,opts,transports,cascadeNotifications){function onData(data){emitter.emit("data",data)}function onClose(reason){if(!responseReceived&&cascade(!0))return;emitter.emit("close",reason)}function onError(error){emitter.emit("error",error)}function onConnectionResponse(response){if(responseReceived=!0,isCascadableResponse(response.response)&&cascade())return;return onHandshakeSuccess(response)}function onParsingError(error){if(responseReceived=!0,!cascade())return onHandshakeError(error)}function closeQuietly(){transport&&(transport.off("data",onData),transport.off("close",onClose),transport.off("error",onError),transport.close(),transport=null)}function selectTransport(suppressClose){if(0===transports.length)return self.name=null,transport=null,logger.debug("Transports exhausted"),cascadeNotifications.emit("transports-exhausted"),suppressClose||emitter.emit("close"),null;return self.name=transports.shift(),transport=transportFactory(self.name),logger.debug("Selecting transport",self.name),cascadeNotifications.emit("transport-selected",self.name),transport}function internalConnect(){responseReceived=!1,logger.debug("Attempting to connect"),cascadeNotifications.emit("cascading-connect"),transport.on("data",onData),transport.on("close",onClose),transport.on("error",onError);try{transport.connect(req,parsing.connectionResponse.bind(null,onConnectionResponse,onParsingError))}catch(e){if(!cascade())throw e}return!0}function cascade(suppressClose){if(closeQuietly(),!selectTransport(suppressClose))return!1;return cascadeNotifications.emit("cascade"),internalConnect()}var emitter=Emitter.assign(this),self=this;this.name=null;var req=null,onHandshakeSuccess=null,onHandshakeError=null,responseReceived=!1,transportFactory=createTransport.bind(null,subtransports,opts),transport=selectTransport();this.connect=function(request,handshake,handshakeError){req=request,onHandshakeSuccess=handshake,onHandshakeError=handshakeError,internalConnect()},this.dispatch=function(message){if(null===transport)throw new Error("Unable to send message when no transport is set");transport.dispatch(message)},this.close=function(){null!==transport&&(responseReceived=!0,transport.close(),transport=null)}}function Transports(subtransports){var emitter=Emitter.assign(this);this.get=function(options){var validTransports=filterTransports(options.transports,subtransports);if(0===validTransports.length)return null;return new CascadeDriver(subtransports,options,validTransports,emitter)}}var WSTransport=_dereq_("transports/ws"),XHRTransport=_dereq_("transports/xhr"),Emitter=(_dereq_("v4-stack/credential-tunnel").encodeAsString,_dereq_("events/emitter")),ResponseCode=(_dereq_("util/queue"),_dereq_("protocol/response-code")),standardSubtransports=(_dereq_("io/buffer-input-stream"),_dereq_("io/buffer-output-stream"),_dereq_("transports/subtransports")),parsing=_dereq_("transports/parsing"),logger=_dereq_("util/logger").create("Cascading"),knownTransports={WS:WSTransport,XHR:XHRTransport,WEBSOCKET:WSTransport,HTTP_POLLING:XHRTransport};Transports.create=function(subtransports){return new Transports(subtransports?subtransports:standardSubtransports)},module.exports=Transports},{"events/emitter":95,"io/buffer-input-stream":113,"io/buffer-output-stream":114,"protocol/response-code":128,"transports/parsing":253,"transports/subtransports":254,"transports/ws":256,"transports/xhr":257,"util/logger":264,"util/queue":267,"v4-stack/credential-tunnel":275}],256:[function(_dereq_,module){(function(Buffer){function constructURI(req,opts){var scheme=opts.secure?"wss":"ws",uri=scheme+"://"+opts.host+":"+opts.port+"/diffusion";return uri+="?ty="+req.type,uri+="&v="+req.version,uri+="&ca="+req.capabilities,uri+="&r="+opts.reconnect.timeout,req.token&&(uri+="&c="+encodeURIComponent(req.token),uri+="&cs="+req.availableClientSequence,uri+="&ss="+req.lastServerSequence),opts.principal&&(uri+="&username="+encodeURIComponent(opts.principal),uri+="&password="+encodeURIComponent(encodeAsString(opts.credentials))),uri}function WSTransport(opts,ws){var constructor=ws;if(!constructor||!constructor instanceof Function)throw log.warn("No WebSocket available"),new Error("No available WebSocket constructor");var socket,emitter=Emitter.assign(this),handler=function(message){emitter.emit("data",new Buffer(new Uint8Array(message.data)))
};this.connect=function(req,handshake){try{var uri=constructURI(req,opts);socket=new constructor(uri),log.debug("Created websocket",uri)}catch(error){throw new Error("Unable to construct WebSocket",error)}socket.binaryType="arraybuffer",socket.onmessage=function(msg){socket.onmessage=handler,handshake(new Buffer(new Uint8Array(msg.data)))},socket.onclose=emitter.close,socket.onerror=emitter.error},this.dispatch=function(message){log.trace("Sending websocket message");try{return socket.send(message),!0}catch(err){return log.error("Websocket send error",err),!1}},this.close=function(){log.debug("Closing websocket"),socket.close()}}{var encodeAsString=_dereq_("v4-stack/credential-tunnel").encodeAsString,Emitter=_dereq_("events/emitter"),log=_dereq_("util/logger").create("Websocket transport");_dereq_("util/logger").curry}module.exports=WSTransport}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"events/emitter":95,"util/logger":264,"v4-stack/credential-tunnel":275}],257:[function(_dereq_,module){(function(Buffer){function constructURI(req,opts){var scheme=opts.secure?"https":"http",uri=scheme+"://"+opts.host+":"+opts.port+"/diffusion",headers={m:"0",ty:"B",ca:"8",r:opts.reconnect.timeout,v:req.version};return req.token&&(headers.c=encodeURIComponent(req.token),headers.cs=req.availableClientSequence,headers.ss=req.lastServerSequence),opts.principal&&(headers.username=encodeURIComponent(opts.principal),headers.password=encodeURIComponent(encodeAsString(opts.credentials))),{uri:uri,headers:headers}}function XHRTransport(opts,xhr){var clientId,URI,emitter=Emitter.assign(this),pollSequence=0,pingSequence=0,pollRequest=null,aborted=!1,isSending=!1,self=this,queue=Queue.create(),constructor=xhr;this.connect=function(req,handshake){try{var url=constructURI(req,opts);URI=url.uri;var request=this.createRequest(url.headers,url.uri);log.debug("Created XHR",url.uri),request.onreadystatechange=function(){if(4===request.readyState)if(200===request.status){var handShakeData=request.responseText,serverResponse=handshake(new Buffer(handShakeData,"binary"));if(!serverResponse)return;clientId=serverResponse.identity;var responseCode=serverResponse.response,isSuccesss=ResponseCode.isSuccess(responseCode);isSuccesss?self.poll():(log.debug(responseCode.id+" - "+responseCode.message),emitter.close())}else emitter.close()},request.send(null)}catch(error){throw new Error("Unable to create polling transport",error)}},this.close=function(){log.trace("Closing XHR transport"),pollRequest&&(aborted=!0,pollRequest.abort()),queue=Queue.create(),emitter.close()},this.createRequest=function(headers,uri){var request=new constructor;request.open("POST",uri,!0),request.overrideMimeType("text/plain; charset=x-user-defined");for(var header in headers)try{request.setRequestHeader(header,headers[header])}catch(e){log.warn("Can't set header "+header+":"+headers.join(":"))}return request},this.poll=function(){var request=this.createRequest({m:"1",c:clientId,s:pollSequence++},URI);request.onreadystatechange=function(){if(4===request.readyState)if(200===request.status){for(var data=request.responseText,decoded=new Buffer(data,"base64").toString("ascii"),bis=new BufferInputStream(new Buffer(decoded,"ascii"));bis.pos!==bis.count;){var type=bis.read(),length=bis.readInt32(),body=bis.readMany(length),payload=new Buffer(body.length+1);payload.writeInt8(type),body.copy(payload,1),emitter.emit("data",payload)}self.poll()}else emitter.close()},pollRequest=request,request.send(null)},this.dispatch=function(message){if(aborted)return!1;if(queue.add(message),isSending)return!0;self.flush()},this.flush=function(){if(queue.isEmpty())return;var buffer=drainToBuffer(queue.drain()),request=this.createRequest({m:2,c:clientId,s:pingSequence++},URI);request.onreadystatechange=function(){4===request.readyState&&(200===request.status?(isSending=!1,self.flush()):emitter.close())},isSending=!0,request.send(buffer)}}function drainToBuffer(messages){for(var messagesBOS=new BufferOutputStream,i=0;i<messages.length;i++){var msg=messages[i];messagesBOS.writeInt32(msg.length),messagesBOS.writeMany(msg,0,msg.length)}return messagesBOS.getBuffer()}var encodeAsString=_dereq_("v4-stack/credential-tunnel").encodeAsString,Emitter=_dereq_("events/emitter"),Queue=_dereq_("util/queue"),ResponseCode=_dereq_("protocol/response-code"),BufferInputStream=_dereq_("io/buffer-input-stream"),BufferOutputStream=_dereq_("io/buffer-output-stream"),log=_dereq_("util/logger").create("XHR transport");module.exports=XHRTransport}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"events/emitter":95,"io/buffer-input-stream":113,"io/buffer-output-stream":114,"protocol/response-code":128,"util/logger":264,"util/queue":267,"v4-stack/credential-tunnel":275}],258:[function(_dereq_,module){var Update=_dereq_("./update"),BEES=_dereq_("serialisers/byte-encoded-enum-serialiser"),ContentSerialiser=_dereq_("../content/serialiser");module.exports={read:function(input){var type=BEES.read(Update.Type,input);switch(type){case Update.Type.CONTENT:var data=ContentSerialiser.read(input);return new Update(data);default:throw new Error("Received unimplemented update type "+type)}},write:function(output,update){switch(output.write(update.type),update.type){case Update.Type.CONTENT:output.write(output,update.action),ContentSerialiser.write(output,update.data);break;default:throw new Error("Trying to write unimplemented update type "+update.type)}}}},{"../content/serialiser":72,"./update":259,"serialisers/byte-encoded-enum-serialiser":141}],259:[function(_dereq_,module){var UpdateType={CONTENT:0,PAGED_RECORD_ORDERED:1,PAGED_STRING_ORDERED:2,PAGED_RECORD_UNORDERED:3,PAGED_STRING_UNORDERED:4},UpdateAction={UPDATE:0,REPLACE:1},Update=function(data,type,action){this.data=data,this.type=void 0!==type?type:UpdateType.CONTENT,this.action=void 0!==action?action:UpdateAction.UPDATE};module.exports={Type:UpdateType,Update:Update}},{}],260:[function(_dereq_,module){function remove(arr,e){var i=arr.indexOf(e);if(i>-1)return arr.splice(i,1),!0;return!1}function fill(array,value,start,end){start=start||0,end=end||array.length;for(var i=start;end>i;++i)array[i]=value}function ofSize(size,initialValue){var a=[];return a.length=size,void 0!==initialValue&&fill(a,initialValue),a}function argumentsToArray(args){return s.call(args,0)}var s=Array.prototype.slice;module.exports={fill:fill,ofSize:ofSize,remove:remove,argumentsToArray:argumentsToArray}},{}],261:[function(_dereq_,module){function FSM(initial,states){var emitter=Emitter.assign(this),current=states[initial];this.state=initial,this.change=function(state){if(this.state===state)return!0;if(states[state]&&("*"===current||current.indexOf(state)>-1))return emitter.emit("change",this.state,state),current=states[state],this.state=state,!0;return!1}}var Emitter=_dereq_("events/emitter");module.exports={create:function(initial,states){return new FSM(initial,states)}}},{"events/emitter":95}],262:[function(_dereq_,module){function curry(){var args=a2a(arguments),fn=args.shift();return function(){return callWithArguments(fn,args.concat(a2a(arguments)))}}function curryR(){var args=a2a(arguments),fn=args.shift();return function(){return callWithArguments(fn,a2a(arguments).concat(args))}}function callWithArguments(f,args,count){switch(count=void 0===count?args.length:count){case 0:return f();case 1:return f(args[0]);case 2:return f(args[0],args[1]);case 3:return f(args[0],args[1],args[2]);case 4:return f(args[0],args[1],args[2],args[3]);case 5:return f(args[0],args[1],args[2],args[3],args[4]);case 6:return f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return f.apply(f,args)}function newWithArguments(f,args,count){function Proxy(){f.apply(this,args)}switch(count=void 0===count?args.length:count){case 0:return new f;case 1:return new f(args[0]);case 2:return new f(args[0],args[1]);case 3:return new f(args[0],args[1],args[2]);case 4:return new f(args[0],args[1],args[2],args[3]);case 5:return new f(args[0],args[1],args[2],args[3],args[4]);case 6:return new f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return Proxy.prototype=f.prototype,new Proxy}var a2a=_dereq_("util/array").argumentsToArray;module.exports={curry:curry,curryR:curryR,callWithArguments:callWithArguments,newWithArguments:newWithArguments}},{"util/array":260}],263:[function(_dereq_,module){function interface(){var args=array.argumentsToArray(arguments),name=args.shift(),members=args.pop()||[];args.forEach(function(ex){members=members.concat(ex.members)});var boundMembers=members.map(function(member){return{name:member,check:function(impl){return void 0===impl[member]},"throw":function(){throw new Error(name+"#"+member+'" must be implemented')}}}),filter=function(implementation){return boundMembers.filter(function(member){return member.check(implementation)})};return filter.toString=function(){return name},filter.members=members,filter}function implements(){var constructor,args=Array.prototype.slice.call(arguments,0),impl=args.pop(),unsatisfied=[];if(impl instanceof Function)constructor=impl,impl=constructor.prototype;else{constructor=impl.__constructor||function(){};for(var m in constructor.prototype)impl[m]=constructor.prototype[m]}if(args.forEach(function(interface){unsatisfied=unsatisfied.concat(interface(impl))}),constructor.prototype=impl,0===unsatisfied.length)return constructor;var proxy=function(){var instance=functions.newWithArguments(constructor,arguments);return unsatisfied.forEach(function(m){m.check(instance)&&m["throw"]()}),instance};return proxy.toString=function(){return constructor.toString()},proxy.isPrototypeOf=function(c){return c instanceof constructor},proxy.__constructor=constructor,proxy}var functions=_dereq_("util/function"),array=_dereq_("util/array");module.exports={"interface":interface,"implements":implements}},{"util/array":260,"util/function":262}],264:[function(_dereq_,module){function d(){return new Date}function log(level,prefix){var c="|"+level.toUpperCase()+"|"+prefix+"|";return function(msg,arg){arg?logger[level](d()+c+msg,arg):logger[level](d()+c+msg)}}function create(classname){var l={};return methods.forEach(function(m){l[m]=log(m,classname)}),l}var logger=_dereq_("loglevel"),methods=["trace","debug","info","warn","error"];module.exports={create:create,setLevel:logger.setLevel}},{loglevel:9}],265:[function(_dereq_,module){module.exports.approximateSquareRoot=function(value){if(0>value)throw new Error("Value must be greater or equal to 0");if(0===value)return 0;for(var result=1,i=value;i>0;i>>=2)result*=2;return result},module.exports.findNextPowerOfTwo=function(value){if(0>value||value>1<<30)throw new Error("Illegal argument: "+value);return value--,value|=value>>1,value|=value>>2,value|=value>>4,value|=value>>8,value|=value>>16,value++,value}},{}],266:[function(_dereq_,module){function defaultCacheKey(args){return args}function memoize(f,cache,matcher){matcher=matcher||defaultCacheKey,cache=cache||{};var c=function(){var args=a2a(arguments),a=matcher(args),r=cache[a];if(r)return r;return r=f.apply(f,args),cache[a]=r,r};return c._uncached=f,c}var a2a=_dereq_("./array").argumentsToArray;module.exports=memoize},{"./array":260}],267:[function(_dereq_,module){function Queue(){var messages=[];this.length=function(){return messages.length},this.add=function(message){messages.push(message)},this.drain=function(){return messages.splice(0,messages.length)},this.isEmpty=function(){return 0===messages.length}}module.exports={create:function(){return new Queue}}},{}],268:[function(_dereq_,module){function regex(s,context){if(context=context||"",""===s)throw new Error("Empty regular expression ["+context+"]");try{var r=new RegExp(s);return function(test){var m=r.exec(test);return m&&m[0]===test}}catch(e){throw new Error("Bad regular expression ["+e.message+", "+context+"]")}}module.exports=regex},{}],269:[function(_dereq_,module){function requireNonNull(value,what){if("undefined"==typeof value||null===value)throw new Error(what+" is null");return value}module.exports=requireNonNull},{}],270:[function(_dereq_,module){function split(str,delim){if(""===str)return[];for(var parts=[],l=delim.length,i=str.lastIndexOf(delim);i>-1;)parts.push(str.substring(i+l,str.length)),str=str.substring(0,i),i=str.lastIndexOf(delim);return parts.push(str),parts.reverse()}module.exports={split:split}},{}],271:[function(_dereq_,module){function AliasMap(){var aliases={};this.establish=function(topic){var bang=topic.indexOf("!");if(-1!==bang){if(0===bang)return aliases[topic.substring(1)];var alias=topic.substring(bang+1);return topic=topic.substring(0,bang),aliases[alias]=topic,topic}return topic}}AliasMap.create=function(){return new AliasMap},module.exports=AliasMap},{}],272:[function(_dereq_,module){function reason(id,message,canReconnect){return{id:id,message:message,canReconnect:canReconnect}}var CloseReason={CLOSED_BY_CLIENT:reason(0,"The session was closed by the client",!1),CLOSED_BY_SERVER:reason(1,"The session was closed by the server",!1),RECONNECT_ABORTED:reason(2,"Client aborted a reconnect attempt",!1),CONNECTION_TIMEOUT:reason(3,"The connection attempt timed out",!1),HANDSHAKE_REJECTED:reason(4,"The connection handshake was rejected by the server",!1),HANDSHAKE_ERROR:reason(5,"There was an error parsing the handshake response",!1),TRANSPORT_ERROR:reason(6,"There was an unexpected error with the connection",!0),CONNECTION_ERROR:reason(7,"A connection to the server was unable to be established",!0),IDLE_CONNECTION:reason(8,"The activity monitor detected the connection was idle",!0),LOST_MESSAGES:reason(16,"Loss of messages has been detected",!1)};module.exports=CloseReason},{}],273:[function(_dereq_,module){var Connection=_dereq_("v4-stack/connection");module.exports.create=function(aliases,transports){return new Connection(aliases,transports)}},{"v4-stack/connection":274}],274:[function(_dereq_,module){(function(global){function Connection(aliases,transports,reconnectTimeout,recoveryBufferSize){function onData(data){logger.trace("Received message from transport",data);try{var message=Message.parse(data);message.topic&&(message.topic=aliases.establish(message.topic)),self.lastReceivedSequence++,emitter.emit("data",message)}catch(e){logger.warn("Unable to parse message",e),fsm.change("closed")&&(closeReason=CloseReason.CONNECTION_ERROR,transport.close())}}function onClose(){fsm.change("disconnected")||fsm.change("closed")?(clearInterval(scheduledRecoveryBufferTrim),clearTimeout(scheduledClose),logger.trace("Transport closed: ",closeReason),"disconnected"===fsm.state?emitter.emit("disconnect",closeReason):emitter.close(closeReason)):logger.debug("Unable to disconnect, current state: ",fsm.state)}function onHandshakeSuccess(response){if(response.response===ResponseCode.RECONNECTED){var messageDelta=lastSentSequence-response.sequence+1;if(!recoveryBuffer.recover(messageDelta,dispatch)){var outboundLoss=lastSentSequence-recoveryBuffer.size()-response.sequence+1;return logger.warn("Unable to reconnect due to lost messages ("+outboundLoss+")"),fsm.change("disconnected")&&(closeReason=CloseReason.LOST_MESSAGES,transport.close()),response}recoveryBuffer.clear(),lastSentSequence=response.sequence}return response.success&&fsm.change("connected")?(logger.trace("Connection response: ",response.response),closeReason=CloseReason.TRANSPORT_ERROR,emitter.emit("connect",response)):(logger.debug("Connection response: ",response.response),closeReason=CloseReason.HANDSHAKE_REJECTED,transport.close()),clearTimeout(scheduledClose),response}function onHandshakeError(error){return closeReason=CloseReason.HANDSHAKE_ERROR,clearTimeout(scheduledClose),void logger.trace("Unable to deserialise handshake response",error)}function dispatch(message){var bos=new BufferOutputStream;Message.writeToBuffer(message,bos),lastSentSequence+=1,recoveryBuffer.put(message),recoveryBuffer.markTime(Date.now()),transport.dispatch(bos.getBuffer())}var emitter=Emitter.assign(this),fsm=FSM.create("disconnected",{connecting:["connected","disconnected","closed"],connected:["disconnecting","disconnected","closed"],disconnecting:["disconnected"],disconnected:["connecting","closed"],closed:[]}),lastSentSequence=0;this.lastReceivedSequence=0;var scheduledRecoveryBufferTrim,scheduledClose,closeReason,recoveryBuffer=new RecoveryBuffer(recoveryBufferSize,RECOVERY_BUFFER_INDEX_SIZE),transport=null,self=this;fsm.on("change",function(previous,current){logger.debug("State changed: "+previous+" -> "+current)}),this.connect=function(request,opts,timeout){if("disconnected"!==fsm.state)return void logger.warn("Cannot connect, current state: ",fsm.state);fsm.change("connecting")&&(timeout=void 0===timeout?CONNECT_TIMEOUT:timeout,closeReason=CloseReason.CONNECTION_ERROR,transport=transports.get(opts),transport.on("data",onData),transport.on("close",onClose),transport.connect(request,onHandshakeSuccess,onHandshakeError),scheduledClose=setTimeout(function(){logger.debug("Timed out connection attempt after "+timeout),closeReason=CloseReason.CONNECTION_TIMEOUT,transport.close()},timeout),scheduledRecoveryBufferTrim=setInterval(function(){"connected"===fsm.state&&recoveryBuffer.flush(Date.now()-reconnectTimeout)},reconnectTimeout))},this.resetSequences=function(){recoveryBuffer.clear(),lastSentSequence=0,this.lastReceivedSequence=0},this.getAvailableSequence=function(){return lastSentSequence+1-recoveryBuffer.size()},this.send=function(message){if("connected"===fsm.state)return dispatch(message);return!1},this.close=function(reason){closeReason=reason,fsm.change("disconnecting")&&(dispatch(Message.create(Message.types.CLOSE_REQUEST)),scheduledClose=setTimeout(transport.close,CLOSE_TIMEOUT))},this.closeIdleConnection=function(){fsm.change("disconnecting")&&(logger.debug("Connection detected as idle"),closeReason=CloseReason.IDLE_CONNECTION,transport.close())},this.getState=function(){return fsm.state}}var RecoveryBuffer=_dereq_("message-queue/recovery-buffer"),BufferOutputStream=_dereq_("io/buffer-output-stream"),ResponseCode=_dereq_("protocol/response-code"),CloseReason=_dereq_("v4-stack/close-reason"),Message=_dereq_("v4-stack/message"),Emitter=_dereq_("events/emitter"),logger=_dereq_("util/logger").create("Connection"),FSM=(_dereq_("util/function").curry,_dereq_("util/fsm")),CLOSE_TIMEOUT=global.DIFFUSION_CLOSE_TIMEOUT||1e3,CONNECT_TIMEOUT=global.DIFFUSION_CONNECT_TIMEOUT||1e4,RECOVERY_BUFFER_INDEX_SIZE=global.DIFFUSION_RECOVERY_BUFFER_INDEX_SIZE||8;module.exports=Connection}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"events/emitter":95,"io/buffer-output-stream":114,"message-queue/recovery-buffer":116,"protocol/response-code":128,"util/fsm":261,"util/function":262,"util/logger":264,"v4-stack/close-reason":272,"v4-stack/message":276}],275:[function(_dereq_,module){(function(Buffer){function encodeAsString(password){var bos=new BufferOutputStream;return serialiser.write(bos,password),bos.getBase64()}function decodeAsString(s){if(s){var bis=new BufferInputStream(new Buffer(s,"base64"));return serialiser.read(bis)}return null}var BufferOutputStream=_dereq_("io/buffer-output-stream"),BufferInputStream=_dereq_("io/buffer-input-stream"),serialiser=_dereq_("services/authentication/credentials-serialiser");module.exports={encodeAsString:encodeAsString,decodeAsString:decodeAsString}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"io/buffer-input-stream":113,"io/buffer-output-stream":114,"services/authentication/credentials-serialiser":146}],276:[function(_dereq_,module){(function(Buffer){function writeToBuffer(message,bos){bos.write(message.type),bos.writeString(getHeaderString(message)),bos.writeMany(message.getBuffer())}function WriteableMessage(fields){Message.call(this,fields.type,fields.encoding,fields,fields.buffer),BufferOutputStream.call(this,fields.buffer)}function Message(type,encoding,fields,data){this.type=type,this.encoding=encoding;for(var f in fields)this[f]=fields[f];this.data=data}var inherits=_dereq_("inherits"),BufferOutputStream=_dereq_("io/buffer-output-stream"),BufferInputStream=_dereq_("io/buffer-input-stream"),systemHeaders={20:["topic"],21:["topic"],22:["topic_set"],23:["topic_set"],24:["timestamp","queue_size"],25:["timestamp"],26:["username","password"],27:["username","password"],28:[],29:[],30:["topic","ack_id"],31:["topic","ack_id"],32:["ack_id"],33:["topic"],34:["topic"],35:["topic","topic_status"],36:["topic","command"],40:["topic","command_topic_category","command_topic_type"],41:["topic","notification_type"]},types={TOPIC_LOAD:20,DELTA:21,SUBSCRIBE:22,UNSUBSCRIBE:23,PING_SERVER:24,PING_CLIENT:25,CREDENTIALS:26,CREDENTIALS_REJECTED:27,ABORT_NOTIFICATION:28,CLOSE_REQUEST:29,TOPIC_LOAD_ACK_REQUIRED:30,DELTA_ACK_REQUIRED:31,ACK:32,FETCH:33,FETCH_REPLY:34,TOPIC_STATUS_NOTIFICATION:35,COMMAND_MESSAGE:36,COMMAND_TOPIC_LOAD:40,COMMAND_TOPIC_NOTIFICATION:41},encoding={NONE:0,ENCRYPTION_REQUESTED:1,COMPRESSION_REQUESTED:2,BASE64_REQUESTED:3,ENCRYPTED:17,COMPRESSED:18,BASE64:19},parse=function(buffer){var bis=new BufferInputStream(buffer),type=bis.read();if(void 0===systemHeaders[type])throw new Error("Invalid message type: "+type);var headers=bis.readUntil(1).toString().split(""),body=bis.readMany(bis.count),fields={};return systemHeaders[type]&&systemHeaders[type].forEach(function(key){fields[key]=headers.shift()}),new Message(type,encoding.NONE,fields,body)},create=function(type){var fields;if(void 0===type||"number"==typeof type&&void 0===systemHeaders[type])throw"Invalid message type: "+type;return fields=type instanceof Object?type:{type:type},fields.encoding=fields.encoding||0,fields.buffer=fields.buffer||new Buffer(0),new WriteableMessage(fields)},getHeaderString=function(message){var sh=[],headers="";if(systemHeaders[message.type].forEach(function(h){sh.push(message[h])}),0===systemHeaders[message.type].length)return headers;return sh.length>0&&(headers=sh.join(""),headers+=""),headers};inherits(WriteableMessage,BufferOutputStream),Message.prototype.isTopicMessage=function(){return void 0!==this.topic},Message.prototype.getInputStream=function(){return new BufferInputStream(this.data)},module.exports={types:types,parse:parse,create:create,encoding:encoding,getHeaderString:getHeaderString,writeToBuffer:writeToBuffer}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,inherits:8,"io/buffer-input-stream":113,"io/buffer-output-stream":114}],277:[function(_dereq_,module){function Options(options){if(options=options||{},void 0===options.host)options.host=DEFAULT_HOST;else if(options.host.indexOf(":")>-1){var parts=options.host.split(":");void 0===options.port&&(options.port=parseInt(parts[1])),options.host=parts[0]}void 0===options.secure&&(options.secure=void 0===options.port?DEFAULT_SECURE:options.port===DEFAULT_SECURE_PORT?!0:!1),void 0===options.port&&(options.port=options.secure?DEFAULT_SECURE_PORT:DEFAULT_PORT),this.host=options.host,this.port=options.port,this.secure=options.secure,this.reconnect=void 0===options.reconnect||"boolean"==typeof options.reconnect&&options.reconnect?{timeout:DEFAULT_RECONNECT_TIMEOUT,strategy:DEFAULT_RECONNECT_STRATEGY}:"number"==typeof options.reconnect?{timeout:options.reconnect,strategy:DEFAULT_RECONNECT_STRATEGY}:"function"==typeof options.reconnect?{timeout:DEFAULT_RECONNECT_TIMEOUT,strategy:options.reconnect}:"object"==typeof options.reconnect?{timeout:options.reconnect.timeout||DEFAULT_RECONNECT_TIMEOUT,strategy:options.reconnect.strategy||DEFAULT_RECONNECT_STRATEGY}:{timeout:0,strategy:DEFAULT_ABORT_STRATEGY},void 0!==options.principal&&(this.principal=options.principal||DEFAULT_PRINCIPAL,this.credentials=options.credentials||DEFAULT_PASSWORD),this.transports="string"==typeof options.transports?[options.transports]:"object"==typeof options.transports&&options.transports instanceof Array&&options.transports.length>0?options.transports.slice():DEFAULT_TRANSPORTS.slice(),this.transports=this.transports.slice().map(function(t){return t.toUpperCase()}),this.activityMonitor=void 0!==options.activityMonitor?options.activityMonitor:DEFAULT_ACTIVITY_MONITOR}var DEFAULT_HOST="localhost",DEFAULT_PORT=80,DEFAULT_SECURE_PORT=443,DEFAULT_SECURE=!0;"undefined"!=typeof window&&(window.location.hostname&&(DEFAULT_HOST=window.location.hostname),"http:"===window.location.protocol&&(DEFAULT_SECURE=!1,window.location.port&&(DEFAULT_PORT=parseInt(window.location.port))),"https:"===window.location.protocol&&(DEFAULT_SECURE=!0,window.location.port&&(DEFAULT_SECURE_PORT=parseInt(window.location.port))));var DEFAULT_RECONNECT_TIMEOUT=6e4,DEFAULT_RECONNECT_STRATEGY=function(start){setTimeout(start,5e3)},DEFAULT_ABORT_STRATEGY=function(start,abort){abort()},DEFAULT_PRINCIPAL="",DEFAULT_PASSWORD="",DEFAULT_ACTIVITY_MONITOR=!0,DEFAULT_TRANSPORTS=["WEBSOCKET"];Options.prototype["with"]=function(options){var k,o={};for(k in this)o[k]=this[k];for(k in options)o[k]=options[k];return new Options(o)},module.exports=Options},{}],278:[function(_dereq_,module){function TopicSelector(type,prefix,expression){this.type=type,this.prefix=prefix,this.expression=expression}var util=_dereq_("topics/topic-path-utils");TopicSelector.Prefix={PATH:">",SPLIT_PATH_PATTERN:"?",FULL_PATH_PATTERN:"*",SELECTOR_SET:"#"},TopicSelector.Type={PATH:TopicSelector.Prefix.PATH,SPLIT_PATH_PATTERN:TopicSelector.Prefix.SPLIT_PATH_PATTERN,FULL_PATH_PATTERN:TopicSelector.Prefix.FULL_PATH_PATTERN,SELECTOR_SET:TopicSelector.Prefix.SELECTOR_SET},TopicSelector.prototype.selects=function(topicPath){var canonical=util.canonicalise(topicPath);return 0===canonical.indexOf(this.prefix)&&this.doSelects(canonical)},TopicSelector.prototype.toString=function(){return this.expression},module.exports=TopicSelector},{"topics/topic-path-utils":250}],279:[function(_dereq_,module){var parser=_dereq_("topics/topic-selector-parser"),topicSelectors={parse:function(expression){return parser(expression)}};module.exports=topicSelectors},{"topics/topic-selector-parser":251}],280:[function(_dereq_,module){function Session(internalSession,emitter,options){this.sessionID=void 0,this.options=options;var self=this;emitter.assign(self),features.forEach(function(feature){var instance=new feature(internalSession);for(var k in instance)self[k]=instance[k]}),this.close=function(){return internalSession.close(),self},this.isConnected=function(){return internalSession.isConnected()},this.isClosed=function(){var state=internalSession.getState();return"closing"===state||"closed"===state},this.security=new Security(internalSession,this),this.topics=new TopicControl(internalSession,this),this.messages=new Messages(internalSession,this),this.clients=new ClientControl(internalSession,this),this.toString=function(){return"Session<"+self.sessionID+" "+internalSession.getState()+">"}}var Messages=_dereq_("features/messages"),Security=_dereq_("features/security").Security,TopicControl=_dereq_("features/topic-control"),ClientControl=_dereq_("features/client-control"),features=[_dereq_("features/topics")];module.exports=Session},{"features/client-control":98,"features/messages":99,"features/security":100,"features/topic-control":104,"features/topics":106}],281:[function(_dereq_,module){function type(id,stateful,functional){return{id:id,stateful:stateful,functional:functional}}function reason(id,message){return{id:id,message:message}}module.exports.TopicType={STATELESS:type(1,!1,!1),SINGLE_VALUE:type(3,!0,!1),RECORD:type(4,!0,!1),PROTOCOL_BUFFER:type(5,!0,!1),CUSTOM:type(6,!0,!1),SLAVE:type(7,!0,!1),SERVICE:type(8,!1,!0),PAGED_STRING:type(9,!1,!0),PAGED_RECORD:type(10,!1,!0),TOPIC_NOTIFY:type(11,!1,!0),ROUTING:type(12,!1,!0),CHILD_LIST:type(13,!1,!0),BINARY:type(14,!0,!1),JSON:type(15,!0,!1)},module.exports.UnsubscribeReason={REQUESTED:reason(0,"The unsubscription was requested by this client"),CONTROL:reason(1,"The server or another client unsubscribed this client"),REMOVED:reason(2,"The topic was removed")}},{}]},{},[39])(39)});