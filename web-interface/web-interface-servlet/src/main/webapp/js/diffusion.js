!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.diffusion=f()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){},{}],2:[function(require,module,exports){(function(global){"use strict";function typedArraySupport(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length)throw new RangeError("Invalid typed array length");return Buffer.TYPED_ARRAY_SUPPORT?(that=new Uint8Array(length),that.__proto__=Buffer.prototype):(null===that&&(that=new Buffer(length)),that.length=length),that}function Buffer(arg,encodingOrOffset,length){if(!(Buffer.TYPED_ARRAY_SUPPORT||this instanceof Buffer))return new Buffer(arg,encodingOrOffset,length);if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}function from(that,value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');if("undefined"!=typeof ArrayBuffer&&value instanceof ArrayBuffer)return fromArrayBuffer(that,value,encodingOrOffset,length);if("string"==typeof value)return fromString(that,value,encodingOrOffset);return fromObject(that,value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be a number');if(size<0)throw new RangeError('"size" argument must not be negative')}function alloc(that,size,fill,encoding){if(assertSize(size),size<=0)return createBuffer(that,size);if(void 0!==fill)return"string"==typeof encoding?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill);return createBuffer(that,size)}function allocUnsafe(that,size){if(assertSize(size),that=createBuffer(that,size<0?0:0|checked(size)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;i<size;++i)that[i]=0;return that}function fromString(that,string,encoding){if("string"==typeof encoding&&""!==encoding||(encoding="utf8"),!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');var length=0|byteLength(string,encoding);that=createBuffer(that,length);var actual=that.write(string,encoding);return actual!==length&&(that=that.slice(0,actual)),that}function fromArrayLike(that,array){var length=array.length<0?0:0|checked(array.length);that=createBuffer(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function fromArrayBuffer(that,array,byteOffset,length){if(array.byteLength,byteOffset<0||array.byteLength<byteOffset)throw new RangeError("'offset' is out of bounds");if(array.byteLength<byteOffset+(length||0))throw new RangeError("'length' is out of bounds");return array=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length),Buffer.TYPED_ARRAY_SUPPORT?(that=array,that.__proto__=Buffer.prototype):that=fromArrayLike(that,array),that}function fromObject(that,obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length);if(that=createBuffer(that,len),0===that.length)return that;return obj.copy(that,0,0,len),that}if(obj){if("undefined"!=typeof ArrayBuffer&&obj.buffer instanceof ArrayBuffer||"length"in obj){if("number"!=typeof obj.length||isnan(obj.length))return createBuffer(that,0);return fromArrayLike(that,obj)}if("Buffer"===obj.type&&isArray(obj.data))return fromArrayLike(that,obj.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function SlowBuffer(length){return+length!=length&&(length=0),Buffer.alloc(+length)}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if(end>>>=0,start>>>=0,end<=start)return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset=+byteOffset,isNaN(byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val)){if(0===val.length)return-1;return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}if("number"==typeof val){if(val=255&val,Buffer.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf)return dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset);return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}var indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&(encoding=String(encoding).toLowerCase(),"ucs2"===encoding||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else foundIndex!==-1&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new TypeError("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:secondByte=buf[i+1],128===(192&secondByte)&&(tempCodePoint=(31&firstByte)<<6|63&secondByte,tempCodePoint>127&&(codePoint=tempCodePoint));break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128===(192&secondByte)&&128===(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte,tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint));break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128===(192&secondByte)&&128===(192&thirdByte)&&128===(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte,tempCodePoint>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint))}}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return decodeCodePointsArray(res)}function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);for(var res="",i=0;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){value<0&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){value<0&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){if(str=stringtrim(str).replace(INVALID_BASE64_RE,""),str.length<2)return"";for(;str.length%4!==0;)str+="=";return str}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||1/0;for(var codePoint,length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if(codePoint=string.charCodeAt(i),codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}function isnan(val){return val!==val}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),exports.kMaxLength=kMaxLength(),Buffer.poolSize=8192,Buffer._augment=function(arr){return arr.__proto__=Buffer.prototype,arr},Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)},Buffer.TYPED_ARRAY_SUPPORT&&(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0})),Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)},Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}if(x<y)return-1;if(y<x)return 1;return 0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=0|this.length;if(0===length)return"";if(0===arguments.length)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return!0;return 0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(start>>>=0,end>>>=0,thisStart>>>=0,thisEnd>>>=0,this===target)return 0;for(var x=thisEnd-thisStart,y=end-start,len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}if(x<y)return-1;if(y<x)return 1;return 0},Buffer.prototype.includes=function(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset=0|offset,isFinite(length)?(length=0|length,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(start,end){var len=this.length;start=~~start,end=void 0===end?len:~~end,start<0?(start+=len,start<0&&(start=0)):start>len&&(start=len),end<0?(end+=len,end<0&&(end=0)):end>len&&(end=len),end<start&&(end=start);var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT)newBuf=this.subarray(start,end),newBuf.__proto__=Buffer.prototype;else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,(void 0));for(var i=0;i<sliceLen;++i)newBuf[i]=this[i+start]}return newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){if(noAssert||checkOffset(offset,1,this.length),!(128&this[offset]))return this[offset];return(255-this[offset]+1)*-1},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,byteLength=0|byteLength,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,byteLength=0|byteLength,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&start<targetStart&&targetStart<end)for(i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;i<len;++i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),1===val.length){var code=val.charCodeAt(0);code<256&&(val=code)}if(void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding)}else"number"==typeof val&&(val=255&val);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0);var i;if("number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString()),len=bytes.length;for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":3,ieee754:4,isarray:5}],3:[function(require,module,exports){"use strict";function placeHoldersCount(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===b64[len-2]?2:"="===b64[len-1]?1:0}function byteLength(b64){return 3*b64.length/4-placeHoldersCount(b64)}function toByteArray(b64){var i,j,l,tmp,placeHolders,arr,len=b64.length;placeHolders=placeHoldersCount(b64),arr=new Arr(3*len/4-placeHolders),l=placeHolders>0?len-4:len;var L=0;for(i=0,j=0;i<l;i+=4,j+=3)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[L++]=tmp>>16&255,arr[L++]=tmp>>8&255,arr[L++]=255&tmp;return 2===placeHolders?(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[L++]=255&tmp):1===placeHolders&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[L++]=tmp>>8&255,arr[L++]=255&tmp),arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]}function encodeChunk(uint8,start,end){for(var tmp,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output.push(tripletToBase64(tmp));return output.join("")}function fromByteArray(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,output="",parts=[],maxChunkLength=16383,i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength)parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength));return 1===extraBytes?(tmp=uint8[len-1],output+=lookup[tmp>>2],output+=lookup[tmp<<4&63],output+="=="):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],output+=lookup[tmp>>10],output+=lookup[tmp>>4&63],output+=lookup[tmp<<2&63],output+="="),parts.push(output),parts.join("")}exports.byteLength=byteLength,exports.toByteArray=toByteArray,exports.fromByteArray=fromByteArray;for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},{}],4:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:(s?-1:1)*(1/0);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],5:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},{}],6:[function(require,module,exports){function isBuffer(obj){return!!obj.constructor&&"function"==typeof obj.constructor.isBuffer&&obj.constructor.isBuffer(obj)}function isSlowBuffer(obj){return"function"==typeof obj.readFloatLE&&"function"==typeof obj.slice&&isBuffer(obj.slice(0,0))}module.exports=function(obj){return null!=obj&&(isBuffer(obj)||isSlowBuffer(obj)||!!obj._isBuffer)}},{}],7:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){if(!draining||!currentQueue)return;draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue()}function drainQueue(){if(draining)return;var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],8:[function(require,module,exports){!function(factory){if("function"==typeof define&&define.amd)define([],factory);else if("object"==typeof module){var HashMap=module.exports=factory();HashMap.HashMap=HashMap}else this.HashMap=factory()}(function(){function HashMap(other){switch(this.clear(),arguments.length){case 0:break;case 1:this.copy(other);break;default:multi(this,arguments)}}function multi(map,args){for(var i=0;i<args.length;i+=2)map.set(args[i],args[i+1])}function chain(fn){return function(){return fn.apply(this,arguments),this}}function hide(obj,prop){Object.defineProperty&&Object.defineProperty(obj,prop,{enumerable:!1})}var proto=HashMap.prototype={constructor:HashMap,get:function(key){var data=this._data[this.hash(key)];return data&&data[1]},set:function(key,value){this._data[this.hash(key)]=[key,value]},multi:function(){multi(this,arguments)},copy:function(other){for(var key in other._data)this._data[key]=other._data[key]},has:function(key){return this.hash(key)in this._data},search:function(value){for(var key in this._data)if(this._data[key][1]===value)return this._data[key][0];return null},remove:function(key){delete this._data[this.hash(key)]},type:function(key){var str=Object.prototype.toString.call(key),type=str.slice(8,-1).toLowerCase();if("domwindow"===type&&!key)return key+"";return type},keys:function(){var keys=[];return this.forEach(function(value,key){keys.push(key)}),keys},values:function(){var values=[];return this.forEach(function(value){values.push(value)}),values},count:function(){return this.keys().length},clear:function(){this._data={}},clone:function(){return new HashMap(this)},hash:function(key){switch(this.type(key)){case"undefined":case"null":case"boolean":case"number":case"regexp":return key+"";case"date":return"♣"+key.getTime();case"string":return"♠"+key;case"array":for(var hashes=[],i=0;i<key.length;i++)hashes[i]=this.hash(key[i]);return"♥"+hashes.join("⁞");default:return key._hmuid_||(key._hmuid_=++HashMap.uid,hide(key,"_hmuid_")),"♦"+key._hmuid_}},forEach:function(func,ctx){for(var key in this._data){var data=this._data[key];func.call(ctx||this,data[1],data[0])}}};HashMap.uid=0;for(var method in proto){if("constructor"===method||!proto.hasOwnProperty(method))continue;var fn=proto[method];fn.toString().indexOf("return ")===-1&&(proto[method]=chain(fn))}return HashMap})},{}],9:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],10:[function(require,module,exports){!function(root,definition){"use strict";"object"==typeof module&&module.exports&&"function"==typeof require?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):root.log=definition()}(this,function(){"use strict";function realMethod(methodName){return typeof console!==undefinedType&&(void 0!==console[methodName]?bindMethod(console,methodName):void 0!==console.log?bindMethod(console,"log"):noop)}function bindMethod(obj,methodName){var method=obj[methodName];if("function"==typeof method.bind)return method.bind(obj);try{return Function.prototype.bind.call(method,obj)}catch(e){return function(){return Function.prototype.apply.apply(method,[obj,arguments])}}}function enableLoggingWhenConsoleArrives(methodName,level,loggerName){return function(){typeof console!==undefinedType&&(replaceLoggingMethods.call(this,level,loggerName),this[methodName].apply(this,arguments))}}function replaceLoggingMethods(level,loggerName){for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];this[methodName]=i<level?noop:this.methodFactory(methodName,level,loggerName)}}function defaultMethodFactory(methodName,level,loggerName){return realMethod(methodName)||enableLoggingWhenConsoleArrives.apply(this,arguments)}function Logger(name,defaultLevel,factory){function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||"silent").toUpperCase();try{return void(window.localStorage[storageKey]=levelName)}catch(ignore){}try{window.document.cookie=encodeURIComponent(storageKey)+"="+levelName+";"}catch(ignore){}}function getPersistedLevel(){var storedLevel;try{storedLevel=window.localStorage[storageKey]}catch(ignore){}if(typeof storedLevel===undefinedType)try{var cookie=window.document.cookie,location=cookie.indexOf(encodeURIComponent(storageKey)+"=");location&&(storedLevel=/^([^;]+)/.exec(cookie.slice(location))[1])}catch(ignore){}return void 0===self.levels[storedLevel]&&(storedLevel=void 0),storedLevel}var currentLevel,self=this,storageKey="loglevel";name&&(storageKey+=":"+name),self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.methodFactory=factory||defaultMethodFactory,self.getLevel=function(){return currentLevel},self.setLevel=function(level,persist){if("string"==typeof level&&void 0!==self.levels[level.toUpperCase()]&&(level=self.levels[level.toUpperCase()]),!("number"==typeof level&&level>=0&&level<=self.levels.SILENT))throw"log.setLevel() called with invalid level: "+level;if(currentLevel=level,persist!==!1&&persistLevelIfPossible(level),replaceLoggingMethods.call(self,level,name),typeof console===undefinedType&&level<self.levels.SILENT)return"No console available for logging"},self.setDefaultLevel=function(level){getPersistedLevel()||self.setLevel(level,!1)},self.enableAll=function(persist){self.setLevel(self.levels.TRACE,persist)},self.disableAll=function(persist){self.setLevel(self.levels.SILENT,persist)};var initialLevel=getPersistedLevel();null==initialLevel&&(initialLevel=null==defaultLevel?"WARN":defaultLevel),self.setLevel(initialLevel,!1)}var noop=function(){},undefinedType="undefined",logMethods=["trace","debug","info","warn","error"],defaultLogger=new Logger,_loggersByName={};defaultLogger.getLogger=function(name){if("string"!=typeof name||""===name)throw new TypeError("You must supply a name when creating a logger.");var logger=_loggersByName[name];return logger||(logger=_loggersByName[name]=new Logger(name,defaultLogger.getLevel(),defaultLogger.methodFactory)),logger};var _log=typeof window!==undefinedType?window.log:void 0;return defaultLogger.noConflict=function(){return typeof window!==undefinedType&&window.log===defaultLogger&&(window.log=_log),defaultLogger},defaultLogger})},{}],11:[function(require,module,exports){!function(global){"use strict";var Long=function(low,high,unsigned){this.low=0|low,this.high=0|high,this.unsigned=!!unsigned};Long.isLong=function(obj){return(obj&&obj instanceof Long)===!0};var INT_CACHE={},UINT_CACHE={};Long.fromInt=function(value,unsigned){var obj,cachedObj;if(unsigned){if(value>>>=0,0<=value&&value<256&&(cachedObj=UINT_CACHE[value]))return cachedObj;return obj=new Long(value,(0|value)<0?-1:0,(!0)),0<=value&&value<256&&(UINT_CACHE[value]=obj),obj}if(value=0|value,-128<=value&&value<128&&(cachedObj=INT_CACHE[value]))return cachedObj;return obj=new Long(value,value<0?-1:0,(!1)),-128<=value&&value<128&&(INT_CACHE[value]=obj),obj},Long.fromNumber=function(value,unsigned){if(unsigned=!!unsigned,isNaN(value)||!isFinite(value))return Long.ZERO;if(!unsigned&&value<=-TWO_PWR_63_DBL)return Long.MIN_VALUE;if(!unsigned&&value+1>=TWO_PWR_63_DBL)return Long.MAX_VALUE;if(unsigned&&value>=TWO_PWR_64_DBL)return Long.MAX_UNSIGNED_VALUE;if(value<0)return Long.fromNumber(-value,unsigned).negate();return new Long(value%TWO_PWR_32_DBL|0,value/TWO_PWR_32_DBL|0,unsigned)},Long.fromBits=function(lowBits,highBits,unsigned){return new Long(lowBits,highBits,unsigned)},Long.fromString=function(str,unsigned,radix){if(0===str.length)throw Error("number format error: empty string");if("NaN"===str||"Infinity"===str||"+Infinity"===str||"-Infinity"===str)return Long.ZERO;if("number"==typeof unsigned&&(radix=unsigned,unsigned=!1),radix=radix||10,radix<2||36<radix)throw Error("radix out of range: "+radix);var p;if((p=str.indexOf("-"))>0)throw Error('number format error: interior "-" character: '+str);if(0===p)return Long.fromString(str.substring(1),unsigned,radix).negate();for(var radixToPower=Long.fromNumber(Math.pow(radix,8)),result=Long.ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(size<8){var power=Long.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Long.fromNumber(value))}else result=result.multiply(radixToPower),result=result.add(Long.fromNumber(value))}return result.unsigned=unsigned,result},Long.fromValue=function(val){if("number"==typeof val)return Long.fromNumber(val);if("string"==typeof val)return Long.fromString(val);if(Long.isLong(val))return val;return new Long(val.low,val.high,val.unsigned)};var TWO_PWR_24_DBL=1<<24,TWO_PWR_32_DBL=4294967296,TWO_PWR_64_DBL=0x10000000000000000,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=Long.fromInt(TWO_PWR_24_DBL);Long.ZERO=Long.fromInt(0),Long.UZERO=Long.fromInt(0,!0),Long.ONE=Long.fromInt(1),Long.UONE=Long.fromInt(1,!0),Long.NEG_ONE=Long.fromInt(-1),Long.MAX_VALUE=Long.fromBits(-1,2147483647,!1),Long.MAX_UNSIGNED_VALUE=Long.fromBits(-1,-1,!0),Long.MIN_VALUE=Long.fromBits(0,-2147483648,!1),Long.prototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},Long.prototype.toNumber=function(){if(this.unsigned)return(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0);return this.high*TWO_PWR_32_DBL+(this.low>>>0)},Long.prototype.toString=function(radix){if(radix=radix||10,radix<2||36<radix)throw RangeError("radix out of range: "+radix);if(this.isZero())return"0";var rem;if(this.isNegative()){if(this.equals(Long.MIN_VALUE)){var radixLong=Long.fromNumber(radix),div=this.div(radixLong);return rem=div.multiply(radixLong).subtract(this),div.toString(radix)+rem.toInt().toString(radix)}return"-"+this.negate().toString(radix)}var radixToPower=Long.fromNumber(Math.pow(radix,6),this.unsigned);rem=this;for(var result="";;){var remDiv=rem.div(radixToPower),intval=rem.subtract(remDiv.multiply(radixToPower)).toInt()>>>0,digits=intval.toString(radix);if(rem=remDiv,rem.isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},Long.prototype.getHighBits=function(){return this.high},Long.prototype.getHighBitsUnsigned=function(){return this.high>>>0},Long.prototype.getLowBits=function(){return this.low},Long.prototype.getLowBitsUnsigned=function(){return this.low>>>0},Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var val=0!=this.high?this.high:this.low,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high?bit+33:bit+1},Long.prototype.isZero=function(){return 0===this.high&&0===this.low},Long.prototype.isNegative=function(){return!this.unsigned&&this.high<0},Long.prototype.isPositive=function(){return this.unsigned||this.high>=0},Long.prototype.isOdd=function(){return 1===(1&this.low)},Long.prototype.isEven=function(){return 0===(1&this.low)},Long.prototype.equals=function(other){if(Long.isLong(other)||(other=Long.fromValue(other)),this.unsigned!==other.unsigned&&this.high>>>31===1&&other.high>>>31===1)return!1;return this.high===other.high&&this.low===other.low},Long.prototype.notEquals=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),!this.equals(other)},Long.prototype.lessThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<0},Long.prototype.lessThanOrEqual=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<=0},Long.prototype.greaterThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)>0},Long.prototype.greaterThanOrEqual=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)>=0},Long.prototype.compare=function(other){if(this.equals(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();if(thisNeg&&!otherNeg)return-1;if(!thisNeg&&otherNeg)return 1;if(!this.unsigned)return this.subtract(other).isNegative()?-1:1;return other.high>>>0>this.high>>>0||other.high===this.high&&other.low>>>0>this.low>>>0?-1:1},Long.prototype.negate=function(){if(!this.unsigned&&this.equals(Long.MIN_VALUE))return Long.MIN_VALUE;return this.not().add(Long.ONE)},Long.prototype.add=function(addend){Long.isLong(addend)||(addend=Long.fromValue(addend));var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=addend.high>>>16,b32=65535&addend.high,b16=addend.low>>>16,b00=65535&addend.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00+b00,c16+=c00>>>16,c00&=65535,c16+=a16+b16,c32+=c16>>>16,c16&=65535,c32+=a32+b32,c48+=c32>>>16,c32&=65535,c48+=a48+b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.subtract=function(subtrahend){return Long.isLong(subtrahend)||(subtrahend=Long.fromValue(subtrahend)),this.add(subtrahend.negate())},Long.prototype.multiply=function(multiplier){if(this.isZero())return Long.ZERO;if(Long.isLong(multiplier)||(multiplier=Long.fromValue(multiplier)),multiplier.isZero())return Long.ZERO;if(this.equals(Long.MIN_VALUE))return multiplier.isOdd()?Long.MIN_VALUE:Long.ZERO;if(multiplier.equals(Long.MIN_VALUE))return this.isOdd()?Long.MIN_VALUE:Long.ZERO;if(this.isNegative())return multiplier.isNegative()?this.negate().multiply(multiplier.negate()):this.negate().multiply(multiplier).negate();if(multiplier.isNegative())return this.multiply(multiplier.negate()).negate();if(this.lessThan(TWO_PWR_24)&&multiplier.lessThan(TWO_PWR_24))return Long.fromNumber(this.toNumber()*multiplier.toNumber(),this.unsigned);var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=multiplier.high>>>16,b32=65535&multiplier.high,b16=multiplier.low>>>16,b00=65535&multiplier.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00*b00,c16+=c00>>>16,c00&=65535,c16+=a16*b00,c32+=c16>>>16,c16&=65535,c16+=a00*b16,c32+=c16>>>16,c16&=65535,c32+=a32*b00,c48+=c32>>>16,c32&=65535,c32+=a16*b16,c48+=c32>>>16,c32&=65535,c32+=a00*b32,c48+=c32>>>16,c32&=65535,c48+=a48*b00+a32*b16+a16*b32+a00*b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.div=function(divisor){if(Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),divisor.isZero())throw new Error("division by zero");if(this.isZero())return this.unsigned?Long.UZERO:Long.ZERO;var approx,rem,res;if(this.equals(Long.MIN_VALUE)){if(divisor.equals(Long.ONE)||divisor.equals(Long.NEG_ONE))return Long.MIN_VALUE;if(divisor.equals(Long.MIN_VALUE))return Long.ONE;var halfThis=this.shiftRight(1);return approx=halfThis.div(divisor).shiftLeft(1),approx.equals(Long.ZERO)?divisor.isNegative()?Long.ONE:Long.NEG_ONE:(rem=this.subtract(divisor.multiply(approx)),res=approx.add(rem.div(divisor)))}if(divisor.equals(Long.MIN_VALUE))return this.unsigned?Long.UZERO:Long.ZERO;if(this.isNegative()){if(divisor.isNegative())return this.negate().div(divisor.negate());return this.negate().div(divisor).negate()}if(divisor.isNegative())return this.div(divisor.negate()).negate();for(res=Long.ZERO,rem=this;rem.greaterThanOrEqual(divisor);){approx=Math.max(1,Math.floor(rem.toNumber()/divisor.toNumber()));for(var log2=Math.ceil(Math.log(approx)/Math.LN2),delta=log2<=48?1:Math.pow(2,log2-48),approxRes=Long.fromNumber(approx),approxRem=approxRes.multiply(divisor);approxRem.isNegative()||approxRem.greaterThan(rem);)approx-=delta,approxRes=Long.fromNumber(approx,this.unsigned),approxRem=approxRes.multiply(divisor);approxRes.isZero()&&(approxRes=Long.ONE),res=res.add(approxRes),rem=rem.subtract(approxRem)}return res},Long.prototype.modulo=function(divisor){return Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),this.subtract(this.div(divisor).multiply(divisor))},Long.prototype.not=function(){return Long.fromBits(~this.low,~this.high,this.unsigned)},Long.prototype.and=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low&other.low,this.high&other.high,this.unsigned)},Long.prototype.or=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low|other.low,this.high|other.high,this.unsigned)},Long.prototype.xor=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low^other.low,this.high^other.high,this.unsigned)},Long.prototype.shiftLeft=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:numBits<32?Long.fromBits(this.low<<numBits,this.high<<numBits|this.low>>>32-numBits,this.unsigned):Long.fromBits(0,this.low<<numBits-32,this.unsigned)},Long.prototype.shiftRight=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:numBits<32?Long.fromBits(this.low>>>numBits|this.high<<32-numBits,this.high>>numBits,this.unsigned):Long.fromBits(this.high>>numBits-32,this.high>=0?0:-1,this.unsigned)},Long.prototype.shiftRightUnsigned=function(numBits){if(Long.isLong(numBits)&&(numBits=numBits.toInt()),numBits&=63,0===numBits)return this;var high=this.high;if(numBits<32){var low=this.low;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits,this.unsigned)}return 32===numBits?Long.fromBits(high,0,this.unsigned):Long.fromBits(high>>>numBits-32,0,this.unsigned)},Long.prototype.toSigned=function(){if(!this.unsigned)return this;return new Long(this.low,this.high,(!1))},Long.prototype.toUnsigned=function(){if(this.unsigned)return this;return new Long(this.low,this.high,(!0))},"function"==typeof require&&"object"==typeof module&&module&&"object"==typeof exports&&exports?module.exports=Long:"function"==typeof define&&define.amd?define(function(){return Long}):(global.dcodeIO=global.dcodeIO||{}).Long=Long}(this)},{}],12:[function(require,module,exports){!function(define){"use strict";define(function(require){var makePromise=require("./makePromise"),Scheduler=require("./Scheduler"),async=require("./env").asap;return makePromise({scheduler:new Scheduler(async)})})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"./Scheduler":13,"./env":25,"./makePromise":27}],13:[function(require,module,exports){!function(define){"use strict";define(function(){function Scheduler(async){this._async=async,this._running=!1,this._queue=this,this._queueLen=0,this._afterQueue={},this._afterQueueLen=0;var self=this;this.drain=function(){self._drain()}}return Scheduler.prototype.enqueue=function(task){this._queue[this._queueLen++]=task,this.run()},Scheduler.prototype.afterQueue=function(task){this._afterQueue[this._afterQueueLen++]=task,this.run()},Scheduler.prototype.run=function(){this._running||(this._running=!0,this._async(this.drain))},Scheduler.prototype._drain=function(){for(var i=0;i<this._queueLen;++i)this._queue[i].run(),this._queue[i]=void 0;for(this._queueLen=0,this._running=!1,i=0;i<this._afterQueueLen;++i)this._afterQueue[i].run(),this._afterQueue[i]=void 0;this._afterQueueLen=0},Scheduler})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],14:[function(require,module,exports){!function(define){"use strict";define(function(){function TimeoutError(message){Error.call(this),this.message=message,this.name=TimeoutError.name,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,TimeoutError)}return TimeoutError.prototype=Object.create(Error.prototype),TimeoutError.prototype.constructor=TimeoutError,TimeoutError})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],15:[function(require,module,exports){!function(define){"use strict";define(function(){function makeApply(Promise,call){function apply(f,thisArg,args){var p=Promise._defer(),l=args.length,params=new Array(l);return callAndResolve({f:f,thisArg:thisArg,args:args,params:params,i:l-1,call:call},p._handler),p}function callAndResolve(c,h){if(c.i<0)return call(c.f,c.thisArg,c.params,h);var handler=Promise._handler(c.args[c.i]);handler.fold(callAndResolveNext,c,void 0,h)}function callAndResolveNext(c,x,h){c.params[c.i]=x,c.i-=1,callAndResolve(c,h)}return arguments.length<2&&(call=tryCatchResolve),apply}function tryCatchResolve(f,thisArg,args,resolver){try{resolver.resolve(f.apply(thisArg,args))}catch(e){resolver.reject(e)}}return makeApply.tryCatchResolve=tryCatchResolve,makeApply})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],16:[function(require,module,exports){!function(define){"use strict";define(function(require){var state=require("../state"),applier=require("../apply");return function(Promise){function any(promises){function handleFulfill(x){errors=null,this.resolve(x)}function handleReject(e){if(this.resolved)return;errors.push(e),0===--pending&&this.reject(errors)}for(var h,x,p=Promise._defer(),resolver=p._handler,l=promises.length>>>0,pending=l,errors=[],i=0;i<l;++i){if(x=promises[i],void 0===x&&!(i in promises)){--pending;continue}if(h=Promise._handler(x),h.state()>0){resolver.become(h),Promise._visitRemaining(promises,i,h);break}h.visit(resolver,handleFulfill,handleReject)}return 0===pending&&resolver.reject(new RangeError("any(): array must not be empty")),p}function some(promises,n){function fulfill(x){if(this.resolved)return;results.push(x),0===--nFulfill&&(errors=null,this.resolve(results))}function reject(e){if(this.resolved)return;errors.push(e),0===--nReject&&(results=null,this.reject(errors))}var nReject,x,i,p=Promise._defer(),resolver=p._handler,results=[],errors=[],l=promises.length>>>0,nFulfill=0;for(i=0;i<l;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;++nFulfill}for(n=Math.max(n,0),nReject=nFulfill-n+1,nFulfill=Math.min(n,nFulfill),n>nFulfill?resolver.reject(new RangeError("some(): array must contain at least "+n+" item(s), but had "+nFulfill)):0===nFulfill&&resolver.resolve(results),i=0;i<l;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;Promise._handler(x).visit(resolver,fulfill,reject,resolver.notify)}return p}function map(promises,f){return Promise._traverse(f,promises)}function filter(promises,predicate){var a=slice.call(promises);return Promise._traverse(predicate,a).then(function(keep){return filterSync(a,keep)})}function filterSync(promises,keep){for(var l=keep.length,filtered=new Array(l),i=0,j=0;i<l;++i)keep[i]&&(filtered[j++]=Promise._handler(promises[i]).value);return filtered.length=j,filtered}function settle(promises){return all(promises.map(settleOne))}function settleOne(p){var h=Promise._handler(p);if(0===h.state())return toPromise(p).then(state.fulfilled,state.rejected);return h._unreport(),state.inspect(h)}function reduce(promises,f){return arguments.length>2?ar.call(promises,liftCombine(f),arguments[2]):ar.call(promises,liftCombine(f))}function reduceRight(promises,f){return arguments.length>2?arr.call(promises,liftCombine(f),arguments[2]):arr.call(promises,liftCombine(f))}function liftCombine(f){return function(z,x,i){return applyFold(f,void 0,[z,x,i])}}var applyFold=applier(Promise),toPromise=Promise.resolve,all=Promise.all,ar=Array.prototype.reduce,arr=Array.prototype.reduceRight,slice=Array.prototype.slice;return Promise.any=any,Promise.some=some,Promise.settle=settle,Promise.map=map,Promise.filter=filter,Promise.reduce=reduce,Promise.reduceRight=reduceRight,Promise.prototype.spread=function(onFulfilled){return this.then(all).then(function(array){return onFulfilled.apply(this,array)})},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"../apply":15,"../state":28}],17:[function(require,module,exports){!function(define){"use strict";define(function(){function rejectInvalidPredicate(){throw new TypeError("catch predicate must be a function")}function evaluatePredicate(e,predicate){return isError(predicate)?e instanceof predicate:predicate(e)}function isError(predicate){return predicate===Error||null!=predicate&&predicate.prototype instanceof Error}function maybeThenable(x){return("object"==typeof x||"function"==typeof x)&&null!==x}function identity(x){return x}return function(Promise){function createCatchFilter(handler,predicate){return function(e){return evaluatePredicate(e,predicate)?handler.call(this,e):reject(e)}}function runSideEffect(handler,thisArg,propagate,value){var result=handler.call(thisArg);return maybeThenable(result)?propagateValue(result,propagate,value):propagate(value)}function propagateValue(result,propagate,x){return resolve(result).then(function(){return propagate(x)})}var resolve=Promise.resolve,reject=Promise.reject,origCatch=Promise.prototype.catch;return Promise.prototype.done=function(onResult,onError){this._handler.visit(this._handler.receiver,onResult,onError)},Promise.prototype.catch=Promise.prototype.otherwise=function(onRejected){if(arguments.length<2)return origCatch.call(this,onRejected);if("function"!=typeof onRejected)return this.ensure(rejectInvalidPredicate);return origCatch.call(this,createCatchFilter(arguments[1],onRejected))},Promise.prototype.finally=Promise.prototype.ensure=function(handler){if("function"!=typeof handler)return this;return this.then(function(x){return runSideEffect(handler,this,identity,x)},function(e){return runSideEffect(handler,this,reject,e)})},Promise.prototype.else=Promise.prototype.orElse=function(defaultValue){return this.then(void 0,function(){return defaultValue})},Promise.prototype.yield=function(value){return this.then(function(){return value})},Promise.prototype.tap=function(onFulfilledSideEffect){return this.then(onFulfilledSideEffect).yield(this);
},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],18:[function(require,module,exports){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype.fold=function(f,z){var promise=this._beget();return this._handler.fold(function(z,x,to){Promise._handler(z).fold(function(x,z,to){to.resolve(f.call(this,z,x))},x,this,to)},z,promise._handler.receiver,promise._handler),promise},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],19:[function(require,module,exports){!function(define){"use strict";define(function(require){var inspect=require("../state").inspect;return function(Promise){return Promise.prototype.inspect=function(){return inspect(Promise._handler(this))},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"../state":28}],20:[function(require,module,exports){!function(define){"use strict";define(function(){return function(Promise){function iterate(f,condition,handler,x){return unfold(function(x){return[x,f(x)]},condition,handler,x)}function unfold(unspool,condition,handler,x){function next(item,newSeed){return resolve(handler(item)).then(function(){return unfold(unspool,condition,handler,newSeed)})}return resolve(x).then(function(seed){return resolve(condition(seed)).then(function(done){return done?seed:resolve(unspool(seed)).spread(next)})})}var resolve=Promise.resolve;return Promise.iterate=iterate,Promise.unfold=unfold,Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],21:[function(require,module,exports){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype.progress=function(onProgress){return this.then(void 0,void 0,onProgress)},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],22:[function(require,module,exports){!function(define){"use strict";define(function(require){function setTimeout(f,ms,x,y){return env.setTimer(function(){f(x,y,ms)},ms)}var env=require("../env"),TimeoutError=require("../TimeoutError");return function(Promise){function handleDelay(ms,x,h){setTimeout(resolveDelay,ms,x,h)}function resolveDelay(x,h){h.resolve(x)}function onTimeout(reason,h,ms){var e="undefined"==typeof reason?new TimeoutError("timed out after "+ms+"ms"):reason;h.reject(e)}return Promise.prototype.delay=function(ms){var p=this._beget();return this._handler.fold(handleDelay,ms,void 0,p._handler),p},Promise.prototype.timeout=function(ms,reason){var p=this._beget(),h=p._handler,t=setTimeout(onTimeout,ms,reason,p._handler);return this._handler.visit(h,function(x){env.clearTimer(t),this.resolve(x)},function(x){env.clearTimer(t),this.reject(x)},h.notify),p},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"../TimeoutError":14,"../env":25}],23:[function(require,module,exports){!function(define){"use strict";define(function(require){function throwit(e){throw e}function noop(){}var setTimer=require("../env").setTimer,format=require("../format");return function(Promise){function report(r){r.handled||(reported.push(r),logError("Potentially unhandled rejection ["+r.id+"] "+format.formatError(r.value)))}function unreport(r){var i=reported.indexOf(r);i>=0&&(reported.splice(i,1),logInfo("Handled previous rejection ["+r.id+"] "+format.formatObject(r.value)))}function enqueue(f,x){tasks.push(f,x),null===running&&(running=setTimer(flush,0))}function flush(){for(running=null;tasks.length>0;)tasks.shift()(tasks.shift())}var localConsole,logError=noop,logInfo=noop;"undefined"!=typeof console&&(localConsole=console,logError="undefined"!=typeof localConsole.error?function(e){localConsole.error(e)}:function(e){localConsole.log(e)},logInfo="undefined"!=typeof localConsole.info?function(e){localConsole.info(e)}:function(e){localConsole.log(e)}),Promise.onPotentiallyUnhandledRejection=function(rejection){enqueue(report,rejection)},Promise.onPotentiallyUnhandledRejectionHandled=function(rejection){enqueue(unreport,rejection)},Promise.onFatalRejection=function(rejection){enqueue(throwit,rejection.value)};var tasks=[],reported=[],running=null;return Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"../env":25,"../format":26}],24:[function(require,module,exports){!function(define){"use strict";define(function(){return function(Promise){return Promise.prototype.with=Promise.prototype.withThis=function(receiver){var p=this._beget(),child=p._handler;return child.receiver=receiver,this._handler.chain(child,receiver),p},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],25:[function(require,module,exports){(function(process){!function(define){"use strict";define(function(require){function isNode(){return"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process)}function hasMutationObserver(){return"function"==typeof MutationObserver&&MutationObserver||"function"==typeof WebKitMutationObserver&&WebKitMutationObserver}function initMutationObserver(MutationObserver){function run(){var f=scheduled;scheduled=void 0,f()}var scheduled,node=document.createTextNode(""),o=new MutationObserver(run);o.observe(node,{characterData:!0});var i=0;return function(f){scheduled=f,node.data=i^=1}}var MutationObs,capturedSetTimeout="undefined"!=typeof setTimeout&&setTimeout,setTimer=function(f,ms){return setTimeout(f,ms)},clearTimer=function(t){return clearTimeout(t)},asap=function(f){return capturedSetTimeout(f,0)};if(isNode())asap=function(f){return process.nextTick(f)};else if(MutationObs=hasMutationObserver())asap=initMutationObserver(MutationObs);else if(!capturedSetTimeout){var vertxRequire=require,vertx=vertxRequire("vertx");setTimer=function(f,ms){return vertx.setTimer(ms,f)},clearTimer=vertx.cancelTimer,asap=vertx.runOnLoop||vertx.runOnContext}return{setTimer:setTimer,clearTimer:clearTimer,asap:asap}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})}).call(this,require("_process"))},{_process:7}],26:[function(require,module,exports){!function(define){"use strict";define(function(){function formatError(e){var s="object"==typeof e&&null!==e&&e.stack?e.stack:formatObject(e);return e instanceof Error?s:s+" (WARNING: non-Error used)"}function formatObject(o){var s=String(o);return"[object Object]"===s&&"undefined"!=typeof JSON&&(s=tryStringify(o,s)),s}function tryStringify(x,defaultValue){try{return JSON.stringify(x)}catch(e){return defaultValue}}return{formatError:formatError,formatObject:formatObject,tryStringify:tryStringify}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],27:[function(require,module,exports){(function(process){!function(define){"use strict";define(function(){return function(environment){function Promise(resolver,handler){this._handler=resolver===Handler?handler:init(resolver)}function init(resolver){function promiseResolve(x){handler.resolve(x)}function promiseReject(reason){handler.reject(reason)}function promiseNotify(x){handler.notify(x)}var handler=new Pending;try{resolver(promiseResolve,promiseReject,promiseNotify)}catch(e){promiseReject(e)}return handler}function resolve(x){return isPromise(x)?x:new Promise(Handler,new Async(getHandler(x)))}function reject(x){return new Promise(Handler,new Async(new Rejected(x)))}function never(){return foreverPendingPromise}function defer(){return new Promise(Handler,new Pending)}function begetFrom(parent,Promise){var child=new Pending(parent.receiver,parent.join().context);return new Promise(Handler,child)}function all(promises){return traverseWith(snd,null,promises)}function traverse(f,promises){return traverseWith(tryCatch2,f,promises)}function traverseWith(tryMap,f,promises){function mapAt(i,x,resolver){resolver.resolved||traverseAt(promises,settleAt,i,tryMap(f,x,i),resolver)}function settleAt(i,x,resolver){results[i]=x,0===--pending&&resolver.become(new Fulfilled(results))}for(var x,handler="function"==typeof f?mapAt:settleAt,resolver=new Pending,pending=promises.length>>>0,results=new Array(pending),i=0;i<promises.length&&!resolver.resolved;++i){if(x=promises[i],void 0===x&&!(i in promises)){--pending;continue}traverseAt(promises,handler,i,x,resolver)}return 0===pending&&resolver.become(new Fulfilled(results)),new Promise(Handler,resolver)}function traverseAt(promises,handler,i,x,resolver){if(maybeThenable(x)){var h=getHandlerMaybeThenable(x),s=h.state();0===s?h.fold(handler,i,void 0,resolver):s>0?handler(i,h.value,resolver):(resolver.become(h),visitRemaining(promises,i+1,h))}else handler(i,x,resolver)}function visitRemaining(promises,start,handler){for(var i=start;i<promises.length;++i)markAsHandled(getHandler(promises[i]),handler)}function markAsHandled(h,handler){if(h===handler)return;var s=h.state();0===s?h.visit(h,void 0,h._unreport):s<0&&h._unreport()}function race(promises){if("object"!=typeof promises||null===promises)return reject(new TypeError("non-iterable passed to race()"));return 0===promises.length?never():1===promises.length?resolve(promises[0]):runRace(promises)}function runRace(promises){var i,x,h,resolver=new Pending;for(i=0;i<promises.length;++i){if(x=promises[i],void 0===x&&!(i in promises))continue;if(h=getHandler(x),0!==h.state()){resolver.become(h),visitRemaining(promises,i+1,h);break}h.visit(resolver,resolver.resolve,resolver.reject)}return new Promise(Handler,resolver)}function getHandler(x){if(isPromise(x))return x._handler.join();return maybeThenable(x)?getHandlerUntrusted(x):new Fulfilled(x)}function getHandlerMaybeThenable(x){return isPromise(x)?x._handler.join():getHandlerUntrusted(x)}function getHandlerUntrusted(x){try{var untrustedThen=x.then;return"function"==typeof untrustedThen?new Thenable(untrustedThen,x):new Fulfilled(x)}catch(e){return new Rejected(e)}}function Handler(){}function FailIfRejected(){}function Pending(receiver,inheritedContext){Promise.createContext(this,inheritedContext),this.consumers=void 0,this.receiver=receiver,this.handler=void 0,this.resolved=!1}function Async(handler){this.handler=handler}function Thenable(then,thenable){Pending.call(this),tasks.enqueue(new AssimilateTask(then,thenable,this))}function Fulfilled(x){Promise.createContext(this),this.value=x}function Rejected(x){Promise.createContext(this),this.id=++errorId,this.value=x,this.handled=!1,this.reported=!1,this._report()}function ReportTask(rejection,context){this.rejection=rejection,this.context=context}function UnreportTask(rejection){this.rejection=rejection}function cycle(){return new Rejected(new TypeError("Promise cycle"))}function ContinuationTask(continuation,handler){this.continuation=continuation,this.handler=handler}function ProgressTask(value,handler){this.handler=handler,this.value=value}function AssimilateTask(then,thenable,resolver){this._then=then,this.thenable=thenable,this.resolver=resolver}function tryAssimilate(then,thenable,resolve,reject,notify){try{then.call(thenable,resolve,reject,notify)}catch(e){reject(e)}}function Fold(f,z,c,to){this.f=f,this.z=z,this.c=c,this.to=to,this.resolver=failIfRejected,this.receiver=this}function isPromise(x){return x instanceof Promise}function maybeThenable(x){return("object"==typeof x||"function"==typeof x)&&null!==x}function runContinuation1(f,h,receiver,next){if("function"!=typeof f)return next.become(h);Promise.enterContext(h),tryCatchReject(f,h.value,receiver,next),Promise.exitContext()}function runContinuation3(f,x,h,receiver,next){if("function"!=typeof f)return next.become(h);Promise.enterContext(h),tryCatchReject3(f,x,h.value,receiver,next),Promise.exitContext()}function runNotify(f,x,h,receiver,next){if("function"!=typeof f)return next.notify(x);Promise.enterContext(h),tryCatchReturn(f,x,receiver,next),Promise.exitContext()}function tryCatch2(f,a,b){try{return f(a,b)}catch(e){return reject(e)}}function tryCatchReject(f,x,thisArg,next){try{next.become(getHandler(f.call(thisArg,x)))}catch(e){next.become(new Rejected(e))}}function tryCatchReject3(f,x,y,thisArg,next){try{f.call(thisArg,x,y,next)}catch(e){next.become(new Rejected(e))}}function tryCatchReturn(f,x,thisArg,next){try{next.notify(f.call(thisArg,x))}catch(e){next.notify(e)}}function inherit(Parent,Child){Child.prototype=objectCreate(Parent.prototype),Child.prototype.constructor=Child}function snd(x,y){return y}function noop(){}function initEmitRejection(){if("undefined"!=typeof process&&null!==process&&"function"==typeof process.emit)return function(type,rejection){return"unhandledRejection"===type?process.emit(type,rejection.value,rejection):process.emit(type,rejection)};if("undefined"!=typeof self&&"function"==typeof CustomEvent)return function(noop,self,CustomEvent){var hasCustomEvent=!1;try{var ev=new CustomEvent("unhandledRejection");hasCustomEvent=ev instanceof CustomEvent}catch(e){}return hasCustomEvent?function(type,rejection){var ev=new CustomEvent(type,{detail:{reason:rejection.value,key:rejection},bubbles:!1,cancelable:!0});return!self.dispatchEvent(ev)}:noop}(noop,self,CustomEvent);return noop}var tasks=environment.scheduler,emitRejection=initEmitRejection(),objectCreate=Object.create||function(proto){function Child(){}return Child.prototype=proto,new Child};Promise.resolve=resolve,Promise.reject=reject,Promise.never=never,Promise._defer=defer,Promise._handler=getHandler,Promise.prototype.then=function(onFulfilled,onRejected,onProgress){var parent=this._handler,state=parent.join().state();if("function"!=typeof onFulfilled&&state>0||"function"!=typeof onRejected&&state<0)return new this.constructor(Handler,parent);var p=this._beget(),child=p._handler;return parent.chain(child,parent.receiver,onFulfilled,onRejected,onProgress),p},Promise.prototype.catch=function(onRejected){return this.then(void 0,onRejected)},Promise.prototype._beget=function(){return begetFrom(this._handler,this.constructor)},Promise.all=all,Promise.race=race,Promise._traverse=traverse,Promise._visitRemaining=visitRemaining,Handler.prototype.when=Handler.prototype.become=Handler.prototype.notify=Handler.prototype.fail=Handler.prototype._unreport=Handler.prototype._report=noop,Handler.prototype._state=0,Handler.prototype.state=function(){return this._state},Handler.prototype.join=function(){for(var h=this;void 0!==h.handler;)h=h.handler;return h},Handler.prototype.chain=function(to,receiver,fulfilled,rejected,progress){this.when({resolver:to,receiver:receiver,fulfilled:fulfilled,rejected:rejected,progress:progress})},Handler.prototype.visit=function(receiver,fulfilled,rejected,progress){this.chain(failIfRejected,receiver,fulfilled,rejected,progress)},Handler.prototype.fold=function(f,z,c,to){this.when(new Fold(f,z,c,to))},inherit(Handler,FailIfRejected),FailIfRejected.prototype.become=function(h){h.fail()};var failIfRejected=new FailIfRejected;inherit(Handler,Pending),Pending.prototype._state=0,Pending.prototype.resolve=function(x){this.become(getHandler(x))},Pending.prototype.reject=function(x){if(this.resolved)return;this.become(new Rejected(x))},Pending.prototype.join=function(){if(!this.resolved)return this;for(var h=this;void 0!==h.handler;)if(h=h.handler,h===this)return this.handler=cycle();return h},Pending.prototype.run=function(){var q=this.consumers,handler=this.handler;this.handler=this.handler.join(),this.consumers=void 0;for(var i=0;i<q.length;++i)handler.when(q[i])},Pending.prototype.become=function(handler){if(this.resolved)return;this.resolved=!0,this.handler=handler,void 0!==this.consumers&&tasks.enqueue(this),void 0!==this.context&&handler._report(this.context)},Pending.prototype.when=function(continuation){this.resolved?tasks.enqueue(new ContinuationTask(continuation,this.handler)):void 0===this.consumers?this.consumers=[continuation]:this.consumers.push(continuation)},Pending.prototype.notify=function(x){this.resolved||tasks.enqueue(new ProgressTask(x,this))},Pending.prototype.fail=function(context){var c="undefined"==typeof context?this.context:context;this.resolved&&this.handler.join().fail(c)},Pending.prototype._report=function(context){this.resolved&&this.handler.join()._report(context)},Pending.prototype._unreport=function(){this.resolved&&this.handler.join()._unreport()},inherit(Handler,Async),Async.prototype.when=function(continuation){tasks.enqueue(new ContinuationTask(continuation,this))},Async.prototype._report=function(context){this.join()._report(context)},Async.prototype._unreport=function(){this.join()._unreport()},inherit(Pending,Thenable),inherit(Handler,Fulfilled),Fulfilled.prototype._state=1,Fulfilled.prototype.fold=function(f,z,c,to){runContinuation3(f,z,this,c,to)},Fulfilled.prototype.when=function(cont){runContinuation1(cont.fulfilled,this,cont.receiver,cont.resolver)};var errorId=0;inherit(Handler,Rejected),Rejected.prototype._state=-1,Rejected.prototype.fold=function(f,z,c,to){to.become(this)},Rejected.prototype.when=function(cont){"function"==typeof cont.rejected&&this._unreport(),runContinuation1(cont.rejected,this,cont.receiver,cont.resolver)},Rejected.prototype._report=function(context){tasks.afterQueue(new ReportTask(this,context))},Rejected.prototype._unreport=function(){if(this.handled)return;this.handled=!0,tasks.afterQueue(new UnreportTask(this))},Rejected.prototype.fail=function(context){this.reported=!0,emitRejection("unhandledRejection",this),Promise.onFatalRejection(this,void 0===context?this.context:context)},ReportTask.prototype.run=function(){this.rejection.handled||this.rejection.reported||(this.rejection.reported=!0,emitRejection("unhandledRejection",this.rejection)||Promise.onPotentiallyUnhandledRejection(this.rejection,this.context))},UnreportTask.prototype.run=function(){this.rejection.reported&&(emitRejection("rejectionHandled",this.rejection)||Promise.onPotentiallyUnhandledRejectionHandled(this.rejection))},Promise.createContext=Promise.enterContext=Promise.exitContext=Promise.onPotentiallyUnhandledRejection=Promise.onPotentiallyUnhandledRejectionHandled=Promise.onFatalRejection=noop;var foreverPendingHandler=new Handler,foreverPendingPromise=new Promise(Handler,foreverPendingHandler);return ContinuationTask.prototype.run=function(){this.handler.join().when(this.continuation)},ProgressTask.prototype.run=function(){var q=this.handler.consumers;if(void 0===q)return;for(var c,i=0;i<q.length;++i)c=q[i],runNotify(c.progress,this.value,this.handler,c.receiver,c.resolver)},AssimilateTask.prototype.run=function(){function _resolve(x){h.resolve(x)}function _reject(x){h.reject(x)}function _notify(x){h.notify(x)}var h=this.resolver;tryAssimilate(this._then,this.thenable,_resolve,_reject,_notify)},Fold.prototype.fulfilled=function(x){this.f.call(this.c,this.z,x,this.to)},Fold.prototype.rejected=function(x){this.to.reject(x)},Fold.prototype.progress=function(x){this.to.notify(x)},Promise}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})}).call(this,require("_process"))},{_process:7}],28:[function(require,module,exports){!function(define){"use strict";define(function(){function toPendingState(){return{state:"pending"}}function toRejectedState(e){return{state:"rejected",reason:e}}function toFulfilledState(x){return{state:"fulfilled",value:x}}function inspect(handler){var state=handler.state();return 0===state?toPendingState():state>0?toFulfilledState(handler.value):toRejectedState(handler.value)}return{pending:toPendingState,fulfilled:toFulfilledState,rejected:toRejectedState,inspect:inspect}})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory()})},{}],29:[function(require,module,exports){!function(define){"use strict";define(function(require){function when(x,onFulfilled,onRejected,onProgress){var p=Promise.resolve(x);if(arguments.length<2)return p;return p.then(onFulfilled,onRejected,onProgress)}function promise(resolver){return new Promise(resolver)}function lift(f){return function(){for(var i=0,l=arguments.length,a=new Array(l);i<l;++i)a[i]=arguments[i];return apply(f,this,a)}}function attempt(f){for(var i=0,l=arguments.length-1,a=new Array(l);i<l;++i)a[i]=arguments[i+1];return apply(f,this,a)}function defer(){return new Deferred}function Deferred(){function resolve(x){p._handler.resolve(x)}function reject(x){p._handler.reject(x)}function notify(x){p._handler.notify(x)}var p=Promise._defer();this.promise=p,this.resolve=resolve,this.reject=reject,this.notify=notify,this.resolver={resolve:resolve,reject:reject,notify:notify}}function isPromiseLike(x){return x&&"function"==typeof x.then}function join(){return Promise.all(arguments)}function all(promises){return when(promises,Promise.all)}function settle(promises){return when(promises,Promise.settle)}function map(promises,mapFunc){return when(promises,function(promises){return Promise.map(promises,mapFunc)})}function filter(promises,predicate){return when(promises,function(promises){return Promise.filter(promises,predicate)})}var timed=require("./lib/decorators/timed"),array=require("./lib/decorators/array"),flow=require("./lib/decorators/flow"),fold=require("./lib/decorators/fold"),inspect=require("./lib/decorators/inspect"),generate=require("./lib/decorators/iterate"),progress=require("./lib/decorators/progress"),withThis=require("./lib/decorators/with"),unhandledRejection=require("./lib/decorators/unhandledRejection"),TimeoutError=require("./lib/TimeoutError"),Promise=[array,flow,fold,generate,progress,inspect,withThis,timed,unhandledRejection].reduce(function(Promise,feature){return feature(Promise)},require("./lib/Promise")),apply=require("./lib/apply")(Promise);return when.promise=promise,when.resolve=Promise.resolve,when.reject=Promise.reject,when.lift=lift,when.try=attempt,when.attempt=attempt,when.iterate=Promise.iterate,when.unfold=Promise.unfold,when.join=join,when.all=all,when.settle=settle,when.any=lift(Promise.any),when.some=lift(Promise.some),when.race=lift(Promise.race),when.map=map,when.filter=filter,when.reduce=lift(Promise.reduce),when.reduceRight=lift(Promise.reduceRight),when.isPromiseLike=isPromiseLike,when.Promise=Promise,when.defer=defer,when.TimeoutError=TimeoutError,when})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)})},{"./lib/Promise":12,"./lib/TimeoutError":14,"./lib/apply":15,"./lib/decorators/array":16,"./lib/decorators/flow":17,"./lib/decorators/fold":18,"./lib/decorators/inspect":19,"./lib/decorators/iterate":20,"./lib/decorators/progress":21,"./lib/decorators/timed":22,"./lib/decorators/unhandledRejection":23,"./lib/decorators/with":24}],30:[function(require,module,exports){var _interface=require("util/interface").interface,RecordContent=_interface("RecordContent",["get","records","forEach"]);RecordContent.Record=_interface("Record",["get","fields","forEach"]),RecordContent.Builder=_interface("RecordContentBuilder",["add","set","build","addAndBuild","setAndBuild"]),RecordContent.Builder.Record=_interface("RecordContentRecordBuilder",["add","set"]),module.exports=RecordContent},{"util/interface":280}],31:[function(require,module,exports){var _interface=require("util/interface").interface,DataType=require("../datatype");module.exports=_interface("BinaryDataType",DataType,["from"])},{"../datatype":35,"util/interface":280}],32:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("BinaryDelta",["hasChanges"])},{"util/interface":280}],33:[function(require,module,exports){var _interface=require("util/interface").interface,Bytes=require("../bytes");module.exports=_interface("Binary",Bytes,["get","diff","apply"])},{"../bytes":34,"util/interface":280}],34:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("Bytes",["length","asBuffer","copyTo"])},{"util/interface":280}],35:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("DataType",["name","readValue","writeValue","deltaType"])},{"util/interface":280}],36:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("DataTypes",["binary","json","get"])},{"util/interface":280}],37:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("DeltaType",["name","diff","apply","readDelta","writeDelta","noChange","isValueCheaper"])},{"util/interface":280}],38:[function(require,module,exports){var _interface=require("util/interface").interface,DataType=require("../datatype");module.exports=_interface("JSONDataType",DataType,["from","fromJsonString"])},{"../datatype":35,"util/interface":280}],39:[function(require,module,exports){var _interface=require("util/interface").interface,Bytes=require("../bytes");module.exports=_interface("JSON",Bytes,["get","diff","jsonDiff","apply"])},{"../bytes":34,"util/interface":280}],40:[function(require,module,exports){var SessionImpl=require("session/session-impl"),DataTypes=require("data/datatypes"),Metadata=require("metadata/metadata"),Topics=require("./topics/topics"),TopicSelectors=require("./selectors/topic-selectors"),ErrorReport=require("services/error-report"),ClientControlOptions=require("./features/client-control-options"),Emitter=require("events/emitter"),Result=require("events/result"),log=require("util/logger");log.setLevel("SILENT");var logger=log.create("Diffusion"),diffusion={version:"5.9.1",build:"1_01#42183",log:function(level){log.setLevel(level)},connect:function(options){function onClose(reason){logger.debug("Session closed",reason),session.off({connect:onConnect,close:onClose}),emitter.error(reason)}function onConnect(session){logger.info("Session connected",session.toString()),session.off({connect:onConnect,close:onClose}),emitter.emit("connect",session)}var sessionImpl=new SessionImpl(options),session=sessionImpl.get(),emitter=new Emitter,r=new Result(emitter);return session.on({connect:onConnect,close:onClose}),sessionImpl.connect(),r},datatypes:DataTypes,selectors:TopicSelectors,metadata:Metadata,topics:Topics,errorReport:ErrorReport,clients:ClientControlOptions};module.exports=diffusion},{"./features/client-control-options":48,"./selectors/topic-selectors":297,"./topics/topics":299,"data/datatypes":94,"events/emitter":103,"events/result":104,"metadata/metadata":129,"services/error-report":198,"session/session-impl":256,"util/logger":281}],41:[function(require,module,exports){var _interface=require("util/interface").interface,ErrorReport=_interface("ErrorReport",["message","line","column"]);module.exports=ErrorReport},{"util/interface":280}],42:[function(require,module,exports){var _interface=require("util/interface").interface,Stream=require("./stream");module.exports=_interface("FetchStream",Stream,[])},{"./stream":44,"util/interface":280}],43:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("Result",["then"])},{"util/interface":280}],44:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports=_interface("Stream",["on","off","close"])},{"util/interface":280}],45:[function(require,module,exports){var _interface=require("util/interface").interface,Stream=require("./stream");module.exports=_interface("Subscription",Stream,["selector","asType","view","transform","close"])},{"./stream":44,"util/interface":280}],46:[function(require,module,exports){var _interface=require("util/interface").interface,Stream=require("./stream");module.exports=_interface("TypedSubscription",Stream,["selector","close"])},{"./stream":44,"util/interface":280}],47:[function(require,module,exports){var _interface=require("util/interface").interface,Stream=require("./stream");module.exports=_interface("View",Stream,["get"])},{"./stream":44,"util/interface":280}],48:[function(require,module,exports){var GetSessionPropertiesKeys={ALL_FIXED_PROPERTIES:["*F"],ALL_USER_PROPERTIES:["*U"],ALL_PROPERTIES:["*F","*U"]};module.exports={PropertyKeys:GetSessionPropertiesKeys}},{}],49:[function(require,module,exports){var _interface=require("util/interface").interface,ClientControl=_interface("ClientControl",["subscribe","unsubscribe","getSessionProperties","setSessionPropertiesListener"]);ClientControl.SessionPropertiesListener=_interface("SessionPropertiesListener",["onActive","onClose","onError","onSessionOpen","onSessionEvent","onSessionClose"]),ClientControl.SessionEventType={UPDATED:0,RECONNECTED:1,FAILED_OVER:2,DISCONNECTED:3},module.exports=ClientControl},{"util/interface":280}],50:[function(require,module,exports){var _interface=require("util/interface").interface,Messages=_interface("Messaging",["send","listen","addHandler"]);Messages.MessageStream=_interface("MessageStream",[]),Messages.MessageHandler=_interface("MessageHandler",["onMessage","onActive","onClose"]),Messages.Priority={NORMAL:0,HIGH:1,LOW:2},Messages.Message={},Messages.SessionMessage={},module.exports=Messages},{"util/interface":280}],51:[function(require,module,exports){var _interface=require("util/interface").interface,SystemPrincipal=_interface("SystemPrincipal",["name","roles"]),Role=_interface("Role",["name","global","default","topic","inherits"]),SecurityConfiguration=_interface("SecurityConfiguration",["named","anonymous","roles"]),SystemAuthenticationConfiguration=_interface("SystemAuthenticationConfiguration",["principals","anonymous"]),SecurityScriptBuilder=_interface("SecurityScriptBuilder",["build","setRolesForAnonymousSessions","setRolesForNamedSessions","setGlobalPermissions","setDefaultTopicPermissions","removeTopicPermissions","setTopicPermissions","setRoleIncludes"]),SystemAuthenticationScriptBuilder=_interface("SystemAuthenticationScriptBuilder",["build","assignRoles","addPrincipal","setPassword","verifyPassword","removePrincipal","allowAnonymousConnections","denyAnonymousConnections","abstainAnonymousConnections"]),Security=_interface("Security",["getPrincipal","changePrincipal","getSecurityConfiguration","getSystemAuthenticationConfiguration","updateSecurityStore","updateAuthenticationStore","securityScriptBuilder","authenticationScriptBuilder"]);Security.SecurityScriptBuilder=SecurityScriptBuilder,Security.SystemAuthenticationScriptBuilder=SystemAuthenticationScriptBuilder,Security.SecurityConfiguration=SecurityConfiguration,Security.SystemAuthenticationConfiguration=SystemAuthenticationConfiguration,Security.Role=Role,Security.SystemPrincipal=SystemPrincipal,module.exports=Security},{"util/interface":280}],52:[function(require,module,exports){var _interface=require("util/interface").interface;module.exports.TopicControl=_interface("TopicControl",["add","remove","removeSelector","removeWithSession","update","registerUpdateSource","addMissingTopicHandler"]),module.exports.MissingTopicHandler=_interface("MissingTopicHandler",["onMissingTopic","onRegister","onClose","onError"]),module.exports.MissingTopicNotification=_interface("MissingTopicNotification",["path","selector","sessionID","proceed","cancel"]),module.exports.TopicUpdateHandler=_interface("TopicUpdateHandler",["onRegister","onActive","onStandBy","onClose"]),module.exports.Updater=_interface("Updater",["update"]),module.exports.TopicAddFailReason={EXISTS:{id:1,reason:"The topic already exists with the same details"},EXISTS_MISMATCH:{id:2,reason:"The topic already exists, with different details"},INVALID_PATH:{id:3,reason:"The topic path is invalid"},INVALID_DETAILS:{id:4,reason:"The topic details are invalid"},USER_CODE_ERROR:{id:5,reason:"A user supplied class could not be found or instantiated"},TOPIC_NOT_FOUND:{id:6,reason:"A referenced topic could not be found"},PERMISSIONS_FAILURE:{id:7,reason:"Invalid permissions to add a topic at the specified path"},INITIALISE_ERROR:{id:8,reason:"The topic could not be initialised, supplied value may be of the wrong format"},UNEXPECTED_ERROR:{id:9,reason:"An unexpected error occured while creating the topic"}},module.exports.UpdateFailReason={SUCCESS:0,INCOMPATIBLE_UPDATE:1,UPDATE_FAILED:2,INVALID_UPDATER:3,MISSING_TOPIC:4,INVALID_ADDRESS:5,DUPLICATES:6,EXCLUSIVE_UPDATER_CONFLICT:7}},{"util/interface":280}],53:[function(require,module,exports){var _interface=require("util/interface").interface,Topics=_interface("Topics",["subscribe","unsubscribe","stream","view","fetch"]);module.exports=Topics},{"util/interface":280}],54:[function(require,module,exports){var _interface=require("util/interface").interface,Metadata=_interface("Metadata",["String","Integer","Decimal","Stateless","RecordContent"]);Metadata.Stateless=_interface("Stateless",[]),Metadata.String=_interface("String",["value"]),Metadata.Integer=_interface("Integer",["value"]),Metadata.Decimal=_interface("Decimal",["value","scale"]),Metadata.RecordContent=_interface("RecordContent",["occurs","addRecord","getRecord","getRecords","string","integer","decimal","builder","parse"]),Metadata.RecordContent.Record=_interface("Record",["name","occurs","addField","getField","getFields"]),Metadata.RecordContent.Field=_interface("MField",["name","type","occurs"]),module.exports=Metadata},{"util/interface":280}],55:[function(require,module,exports){function connectionActivityMonitorFactory(connection,response){var pingTimeout=response.systemPingPeriod*pingTimeoutFactor;return new ConnectionActivityMonitor(pingTimeout,connection)}var ConnectionActivityMonitor=require("./connection-activity-monitor"),pingTimeoutFactor=2;module.exports=connectionActivityMonitorFactory},{"./connection-activity-monitor":56}],56:[function(require,module,exports){function ConnectionActivityMonitor(pingTimeout,connection){var currentTimeout=null;this.onSystemPing=function(){null!==currentTimeout&&(clearTimeout(currentTimeout),currentTimeout=setTimeout(connection.closeIdleConnection.bind(connection),pingTimeout))},this.shutdown=function(){null!==currentTimeout&&(clearTimeout(currentTimeout),currentTimeout=null)},currentTimeout=setTimeout(connection.closeIdleConnection.bind(connection),pingTimeout)}module.exports=ConnectionActivityMonitor},{}],57:[function(require,module,exports){function SessionActivityMonitor(connectionActivityMonitorFactory){var currentConnectionMonitor=null;this.onNewConnection=function(connection,response){currentConnectionMonitor=connectionActivityMonitorFactory(connection,response)},this.onConnectionClosed=function(){null!==currentConnectionMonitor&&(currentConnectionMonitor.shutdown(),currentConnectionMonitor=null)},this.onSystemPing=function(){null!==currentConnectionMonitor&&currentConnectionMonitor.onSystemPing()}}module.exports={NOOP:{onNewConnection:function(){},onConnectionClosed:function(){},onSystemPing:function(){}},create:function(connectionActivityMonitorFactory){return new SessionActivityMonitor(connectionActivityMonitorFactory)}}},{}],58:[function(require,module,exports){module.exports.types={UINT:0,INT:1,BYTES:2,STRING:3,ARRAY:4,MAP:5,SEMANTIC:6,SIMPLE:7,FLOAT:7},module.exports.additional={FALSE:20,TRUE:21,NULL:22,UNDEFINED:23,SIMPLE:24,HALF_PRECISION:25,SINGLE_PRECISION:26,DOUBLE_PRECISION:27,BREAK:31},module.exports.tokens={ARRAY_START:0,ARRAY_END:1,MAP_START:2,MAP_END:3,STRING_START:4,STRING_END:5,VALUE:6},module.exports.isStructStart=function(token){switch(token){case module.exports.tokens.ARRAY_START:case module.exports.tokens.MAP_START:case module.exports.tokens.STRING_START:return!0;default:return!1}},module.exports.isStructEnd=function(token){switch(token){case module.exports.tokens.ARRAY_END:case module.exports.tokens.MAP_END:case module.exports.tokens.STRING_END:return!0;default:return!1}}},{}],59:[function(require,module,exports){function Context(){var stack=[],tail=ROOT;this.type=function(){return tail.type},this.read=function(){return tail.read},this.expected=function(){return tail.length},this.push=function(type,length){length=void 0===length?-1:length,tail={length:length,type:type,read:0},stack.push(tail)},this.pop=function(){var prev=stack.pop();return tail=stack.length?stack[stack.length-1]:ROOT,prev},this.next=function(){if(!this.hasRemaining())throw new Error("Exceeded expected collection limit");tail.read++},this.break=function(){this.acceptsBreakMarker()&&(tail.length=0,tail.read=0)},this.hasRemaining=function(){return tail.length===-1||tail.length>tail.read},this.acceptsBreakMarker=function(){return tail!==ROOT&&tail.length===-1}}var ROOT={length:-1,type:"root",read:0};module.exports=Context},{}],60:[function(require,module,exports){(function(Buffer){function decode(token,tokeniser){switch(token.type){case tokens.VALUE:return token.value;case tokens.MAP_START:for(var obj={};;){var field=tokeniser.nextToken();if(null===field)throw new Error("Unexpected EOF (reading: map key)");if(field.type===tokens.MAP_END)break;var value=tokeniser.nextToken();if(null===value||value.type===tokens.MAP_END)throw new Error("Unexpected EOF (reading: map value)");obj[decode(field,tokeniser)]=decode(value,tokeniser)}return obj;case tokens.ARRAY_START:for(var arr=[];;){var element=tokeniser.nextToken();if(null===element)throw new Error("Unexpected EOF (reading: array value)");if(element.type===tokens.ARRAY_END)break;arr.push(decode(element,tokeniser))}return arr;case tokens.STRING_START:for(var chunks=[];;){var chunk=tokeniser.nextToken();if(null===chunk)throw new Error("Unexpected EOF (reading: indefinite-length string");if(chunk.type===tokens.STRING_END)break;if(chunk.header.type!==token.header.type)throw new Error("Unexpected chunk type ("+chunk.header.type+") within string");chunks.push(chunk.value)}var joined;return token.header.type===types.BYTES&&(joined=Buffer.concat(chunks)),token.header.type===types.STRING&&(joined=chunks.join("")),joined;default:throw new Error("Unexpected token: "+JSON.stringify(token))}}var Tokeniser=require("cbor/tokeniser"),consts=require("cbor/consts"),tokens=consts.tokens,types=consts.types;module.exports=function(initial,offset,length){var tokeniser=Buffer.isBuffer(initial)?new Tokeniser(initial,offset,length):initial;this.hasRemaining=tokeniser.hasRemaining,this.nextValue=function(){if(tokeniser.hasRemaining())return decode(tokeniser.nextToken(),tokeniser);throw new Error("Token stream exhausted")}}}).call(this,require("buffer").Buffer)},{buffer:2,"cbor/consts":58,"cbor/tokeniser":62}],61:[function(require,module,exports){(function(Buffer){function Encoder(initial){function writeByte(b){bos.write(b)}function writeBuffer(buf,offset,length){offset=offset||0,length=void 0===length?buf.length:length,bos.writeMany(buf,offset,length)}function writeUint16(v){writeByte(v>>8&255),writeByte(255&v)}function writeUint32(v){writeUint16(v>>16&65535),writeUint16(65535&v)}function writeUint64(v){writeUint32(Math.floor(v/4294967296)),writeUint32(v%4294967296)}function writeBreakHeader(type){writeByte(type<<5|additional.BREAK)}function writeToken(type,val){var first=type<<5;val<24?writeByte(first|val):val<256?(writeByte(24|first),writeByte(val)):val<65536?(writeByte(25|first),writeUint16(val)):val<4294967296?(writeByte(26|first),writeUint32(val)):(writeByte(27|first),writeUint64(val))}function writeNumber(val){if(val.toString().indexOf(".")>-1){var buf=new Buffer(8);buf.writeDoubleBE(val,0),writeByte(types.SIMPLE<<5|additional.DOUBLE_PRECISION),writeBuffer(buf)}else val<0?writeToken(types.INT,-1-val):writeToken(types.UINT,val)}function writeString(val){var buf=new Buffer(val,"utf-8");writeToken(types.STRING,buf.length),writeBuffer(buf)}function writeBinary(val,offset,length){length=void 0===length?val.length:length,writeToken(types.BYTES,length),writeBuffer(val,offset,length)}function writeBoolean(val){val?writeToken(types.SIMPLE,additional.TRUE):writeToken(types.SIMPLE,additional.FALSE)}function writeUndefined(){writeToken(types.SIMPLE,additional.UNDEFINED)}function writeNull(){writeToken(types.SIMPLE,additional.NULL)}function writeObject(val){var keys=Object.keys(val);self.startObject(keys.length);for(var i=0;i<keys.length;++i)self.encode(keys[i]),self.encode(val[keys[i]])}function writeArray(val){self.startArray(val.length);for(var i=0;i<val.length;++i)self.encode(val[i])}var bos=initial||new BufferOutputStream,self=this;this.break=function(){return writeBreakHeader(types.SIMPLE),self},this.startArray=function(length){return void 0===length?writeBreakHeader(types.ARRAY):writeToken(types.ARRAY,length),self},this.startObject=function(length){return void 0===length?writeBreakHeader(types.MAP):writeToken(types.MAP,length),self},this.encode=function(value,offset,length){if(null===value)writeNull();else if(void 0===value)writeUndefined();else if(value===!0)writeBoolean(!0);else if(value===!1)writeBoolean(!1);else switch(typeof value){case"string":writeString(value);break;case"number":writeNumber(value);break;case"object":Buffer.isBuffer(value)?writeBinary(value,offset,length):Array.isArray(value)?writeArray(value):writeObject(value)}return self},this.flush=function(){var res=bos.getBuffer();return bos=new BufferOutputStream,res}}var BufferOutputStream=require("io/buffer-output-stream"),consts=require("cbor/consts"),additional=consts.additional,types=consts.types;module.exports=Encoder}).call(this,require("buffer").Buffer)},{buffer:2,"cbor/consts":58,"io/buffer-output-stream":124}],62:[function(require,module,exports){(function(Buffer){function Tokeniser(data,offset,length){function readValue(header){switch(header.type){case types.UINT:return readHeaderValue(header);case types.INT:return-1-readHeaderValue(header);case types.BYTES:return readBuffer(readHeaderValue(header));case types.STRING:return readBuffer(readHeaderValue(header)).toString("utf-8");case types.SIMPLE:return readSimpleValue(header.raw)}}function readSimpleValue(type){switch(type){case additional.TRUE:return!0;case additional.FALSE:return!1;case additional.NULL:return null;case additional.BREAK:return BREAK_FLAG;case additional.HALF_PRECISION:return readFloat16();case additional.SINGLE_PRECISION:return readFloat32();case additional.DOUBLE_PRECISION:return readFloat64()}}function readByte(){if(pos<data.length)return data[pos++];throw new Error("Exhausted token stream")}function readBuffer(len){return data.slice(pos,pos+=len)}function readUint16(){var res=data.readUInt16BE(pos);return pos+=2,res}function readUint32(){var res=data.readUInt32BE(pos);return pos+=4,res}function readUint64(){return 4294967296*readUint32()+readUint32()}function readFloat16(){var h=readUint16(),f=1023&h,s=(32768&h)>>15,e=(31744&h)>>10,sign=s?-1:1;if(0===e)return sign*Math.pow(2,-14)*(f/Math.pow(2,10));if(31===e)return f?NaN:sign*(1/0);return sign*Math.pow(2,e-15)*(1+f/Math.pow(2,10))}function readFloat32(){var res=data.readFloatBE(pos);return pos+=4,res}function readFloat64(){var res=data.readDoubleBE(pos);return pos+=8,res}function readHeader(){var header=readByte();return{type:header>>5,raw:31&header}}function readHeaderValue(header){var low=header.raw;if(low<24)return low;if(low===additional.SIMPLE)return readByte();if(low===additional.HALF_PRECISION)return readUint16();if(low===additional.SINGLE_PRECISION)return readUint32();if(low===additional.DOUBLE_PRECISION)return readUint64();if(low===additional.BREAK)return BREAK_FLAG}function readCollectionLength(header){var l=readHeaderValue(header);if(l===BREAK_FLAG)return-1;return l}length=void 0===length?data.length:length,offset=offset||0;var token,type,context=new Context,self=this,pos=offset;this.reset=function(){context=new Context,token=void 0,type=void 0,pos=offset},this.hasRemaining=function(){var ctx=context.type(),len="root"===ctx?length:length+1;return pos<offset+len},this.offset=function(){return pos},this.getContext=function(){return context},this.getToken=function(){return token},this.nextToken=function(){if(!self.hasRemaining())return null;var ctx=context.type(),previousPos=pos;if("root"!==ctx&&!context.hasRemaining()){switch(ctx){case"object":type=tokens.MAP_END;break;case"array":type=tokens.ARRAY_END;break;case"string":type=tokens.STRING_END}return context.pop(),{pos:pos,type:type,getBuffer:function(){return EMPTY_BUFFER}}}context.next();var value,header=readHeader();switch(header.type){case types.INT:case types.UINT:case types.FLOAT:case types.SIMPLE:type=tokens.VALUE,value=readValue(header);break;case types.BYTES:case types.STRING:header.raw===additional.BREAK?(context.push("string",-1),type=tokens.STRING_START):(type=tokens.VALUE,value=readValue(header));break;case types.ARRAY:context.push("array",readCollectionLength(header)),type=tokens.ARRAY_START;break;case types.MAP:var len=readCollectionLength(header);len>=0&&(len=2*len),context.push("object",len),type=tokens.MAP_START;break;default:throw new Error("Unkown CBOR header type: "+header.type)}if(value===BREAK_FLAG){if(context.acceptsBreakMarker())return context.break(),self.nextToken();throw new Error("Unexpected break flag outside of indefinite-length context")}return token={pos:previousPos,type:type,value:value,header:header,length:pos,getBuffer:function(){return data.slice(this.pos,this.length)}}}}var Context=require("./context"),consts=require("./consts"),additional=consts.additional,tokens=consts.tokens,types=consts.types,BREAK_FLAG=new Error,EMPTY_BUFFER=new Buffer([]);module.exports=Tokeniser}).call(this,require("buffer").Buffer)},{"./consts":58,"./context":59,buffer:2}],63:[function(require,module,exports){module.exports={COMMUNICATION_FAILURE:{id:100,reason:"Communication with server failed"},SESSION_CLOSED:{id:101,reason:"Session is closed"},REQUEST_TIME_OUT:{id:102,reason:"Request time out"},ACCESS_DENIED:{id:103,reason:"Access denied"},TOPIC_TREE_REGISTRATION_CONFLICT:{id:200,reason:"A conflicting, pre-existing registration exists on the same branch of the topic tree"}}},{}],64:[function(require,module,exports){function InternalSession(conversationSet,serviceRegistry,connectionFactory,opts){function close(reason){fsm.change("closed")?(conversationSet.discardAll(reason),emitter.close(reason)):log.debug("Unable to handle session close, session state: ",fsm.state)}function replaceConversationSet(err){conversationSet.replace(err)}var sessionID,token,sessionActivityMonitor,emitter=Emitter.assign(this),principal="",fsm=FSM.create("initialising",{initialising:["connecting"],connecting:["connected","closing"],connected:["disconnected","closing"],disconnected:["reconnecting","closing"],reconnecting:["connected","closing"],closing:["closed"],closed:[]});fsm.on("change",function(previous,current){log.info("State changed: "+previous+" -> "+current)});var self=this;this.getState=function(){return fsm.state},this.getConversationSet=function(){return conversationSet},this.isConnected=function(){return"connected"===fsm.state},this.getServiceRegistry=function(){return serviceRegistry},this.getSessionId=function(){return sessionID},this.setPrincipal=function(newPrincipal){principal=newPrincipal},this.checkConnected=function(emitter){return!!self.isConnected()||(emitter.error(new Error("The session is not connected. Operations are not possible at this time.")),!1)};var transports=Transports.create();transports.on({"transport-selected":function(name){emitter.emit("transport-selected",name)},cascade:function(){emitter.emit("cascade")}});var connection=connectionFactory.create(Aliases.create(),transports,opts.reconnect.timeout,256),serviceAdapter=new ServiceAdapter(this,serialisers,connection.send),serviceLocator=new ServiceLocator(this,serialisers,serviceAdapter),topicCache=new TopicCache(DataTypes),topicStreamRegistry=new StreamRegistry(topicCache),topicRouting=new TopicRouting(this,serviceAdapter,conversationSet,topicCache,topicStreamRegistry);serviceRegistry.addListener(serviceAdapter.addService);var attempts=0,reconnect=function(opts){if(fsm.change("reconnecting")){log.info("Reconnect attempt ("+ ++attempts+")");var request=ConnectionRequest.reconnect(token,connection.getAvailableSequence(),connection.lastReceivedSequence);connection.connect(request,opts,opts.reconnect.timeout)}else log.debug("Unable to attempt reconnect, session state: ",fsm.state)},abort=function(reason){fsm.change("closing")?(log.debug("Aborting reconnect"),close(reason||CloseReason.RECONNECT_ABORTED)):log.debug("Unable to abort reconnect, session state: ",fsm.state)};this.connect=function(){if(fsm.change("connecting")){var reconnectTimeout,request=ConnectionRequest.connect();connection.on("data",topicRouting.route),connection.on("close",close),sessionActivityMonitor=opts.activityMonitor?sessionActivityMonitorModule.create(connectionActivityMonitorFactory):sessionActivityMonitorModule.NOOP,connection.on("disconnect",function(reason){log.debug("Connection disconnected, reason: ",reason),fsm.change("disconnected")||"reconnecting"===fsm.state?(sessionActivityMonitor.onConnectionClosed(),opts.reconnect.timeout>0&&reason.canReconnect?(opts.token=token,"disconnected"===fsm.state&&(emitter.emit("disconnect",reason),reconnectTimeout=setTimeout(function(){"connected"!==fsm.state&&abort(CloseReason.CONNECTION_TIMEOUT)},opts.reconnect.timeout)),opts.reconnect.strategy(curry(reconnect,opts),abort,reason)):abort(reason)):fsm.change("closing")?close(reason):(sessionActivityMonitor.onConnectionClosed(),log.debug("Unable to handle session disconnect, session state: ",fsm.state))}),connection.on("connect",function(response){fsm.change("connected")?(token=response.token,response.response===ResponseCode.OK?(sessionID=response.identity,sessionActivityMonitor.onNewConnection(connection,response),emitter.emit("connect",response.identity)):response.response!==ResponseCode.RECONNECTED&&response.response!==ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS||(attempts=0,clearTimeout(reconnectTimeout),response.response===ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS?(connection.resetSequences(),replaceConversationSet(new Error("Peer is disconnected")),log.info("Reconnected session, but messages may have been lost")):log.info("Reconnected session"),sessionActivityMonitor.onNewConnection(connection,response),emitter.emit("reconnect"))):log.trace("Unknown connection response: ",response)}),log.debug("Connecting with options:",opts),log.trace("Connecting with request:",request);try{connection.connect(request,opts)}catch(e){log.warn("Connection error",e),emitter.emit("error",e),fsm.change("closing")&&close(CloseReason.CONNECTION_ERROR)}opts.principal&&(principal=opts.principal)}else log.warn("Unable to connect, session state: ",fsm.state),emitter.emit("error",new Error("Unable to connect, session state: "+fsm.state))},this.close=function(){fsm.change("closing")?(sessionActivityMonitor.onConnectionClosed(),connection.close(CloseReason.CLOSED_BY_CLIENT)):log.debug("Unable to close, session state: ",fsm.state)},this.getErrorHandler=function(){return function(error){log.error("Session error:",error.message)}},this.getServiceLocator=function(){return serviceLocator},this.getServiceAdapter=function(){return serviceAdapter},this.getPrincipal=function(){return principal},this.getStreamRegistry=function(){return topicStreamRegistry},this.getRouting=function(){return topicRouting},this.onSystemPing=function(){sessionActivityMonitor.onSystemPing()}}var Emitter=require("events/emitter"),sessionActivityMonitorModule=require("activity/session-activity-monitor"),ServiceAdapter=require("client/service-adapter"),ServiceLocator=require("client/service-locator"),StreamRegistry=require("routing/stream-registry"),TopicRouting=require("routing/topic-routing"),TopicCache=require("routing/topic-cache"),DataTypes=require("data/datatypes"),serialisers=require("services/serialisers"),ConnectionRequest=require("protocol/connection-request"),ResponseCode=require("protocol/response-code"),CloseReason=require("v4-stack/close-reason"),Transports=require("transports/transports"),Aliases=require("v4-stack/aliases"),log=require("util/logger").create("Internal Session"),curry=(require("../../options"),require("util/function").curry),FSM=require("util/fsm"),connectionActivityMonitorFactory=require("activity/connection-activity-monitor-factory");module.exports=InternalSession},{"../../options":295,"activity/connection-activity-monitor-factory":55,"activity/session-activity-monitor":57,"client/service-adapter":65,"client/service-locator":66,"data/datatypes":94,"events/emitter":103,"protocol/connection-request":135,"protocol/response-code":138,"routing/stream-registry":139,"routing/topic-cache":144,"routing/topic-routing":145,"services/serialisers":220,"transports/transports":272,"util/fsm":278,"util/function":279,"util/logger":281,"v4-stack/aliases":288,"v4-stack/close-reason":289}],65:[function(require,module,exports){function ServiceAdapter(internalSession,serialisers,sender){function sendRequest(header,command,serialiser){var msg=Message.create({type:Message.types.SERVICE_REQUEST});headerSerialiser.write(msg,header),serialiser.write(msg,command),log.trace("Sending command request: "+header,command),sender(msg)}function sendResponse(header,command,serialiser){var msg=Message.create({type:Message.types.SERVICE_RESPONSE});headerSerialiser.write(msg,header),serialiser.write(msg,command),log.trace("Sending command response: "+header,command),sender(msg)}function sendError(header,command,serialiser){var msg=Message.create({type:Message.types.SERVICE_ERROR});headerSerialiser.write(msg,header),serialiser.write(msg,command),log.trace("Sending error: "+header,command),sender(msg)}function handleRequest(header,input){var listener=listeners[header.service];if(listener)log.trace("Received command request for service: "+header),listener(header,input);else{log.error("Received command request for unknown service: "+header);var error=new CommandError(type.COMMUNICATION_FAILURE,"Unknown client service: "+header.service);sendError(header.createErrorHeader(),error,errorSerialiser)}}function handleResponse(header,input){log.trace("Received command response: "+header),conversations.respond(header.cid,input)}function handleError(header,input){var error=errorSerialiser.read(input);log.warn("Command Error received",error.message),conversations.discard(header.cid,new Error(error.message))}var headerSerialiser=serialisers.get(CommandHeader),errorSerialiser=serialisers.get(CommandError),conversations=internalSession.getConversationSet(),listeners={};this.sendRequest=sendRequest,this.sendResponse=sendResponse,this.sendError=sendError,this.addService=function(definition,service){if(void 0!==listeners[definition.id])throw new Error("Service already exists for "+definition);var requestSerialiser=serialisers.get(definition.request),responseSerialiser=serialisers.get(definition.response);listeners[definition.id]=function(header,input){var request=requestSerialiser.read(input),callback={respond:function(response){var rHeader=header.createResponseHeader();sendResponse(rHeader,response,responseSerialiser)},fail:function(error){var eHeader=header.createErrorHeader();sendError(eHeader,error,errorSerialiser)}};try{service.onRequest(internalSession,request,callback)}catch(e){throw new Error("Unable to handle request for "+definition.id,e)}}},this.onMessage=function(modes,data){var header=headerSerialiser.read(data);switch(modes){case Message.types.SERVICE_REQUEST:handleRequest(header,data);break;case Message.types.SERVICE_RESPONSE:handleResponse(header,data);break;case Message.types.SERVICE_ERROR:handleError(header,data);break;default:throw new Error("Unknown Command Service message "+modes)}}}var CommandHeader=require("services/command-header"),CommandError=require("services/command-error"),Message=require("v4-stack/message"),type=CommandError.ErrorType,log=require("util/logger").create("Service Adapter");module.exports=ServiceAdapter},{"services/command-error":166,"services/command-header":168,"util/logger":281,"v4-stack/message":294}],66:[function(require,module,exports){function ServiceLocator(internalSession,serialisers,serviceAdapter){var conversations=internalSession.getConversationSet();this.obtain=function(service){var pending=[],requestSerialiser=serialisers.get(service.request),responseSerialiser=serialisers.get(service.response),reference={send:function(req,callback){callback=callback||defaultCB;var handler={onOpen:function(cid){var header=new CommandHeader(service.id,cid);serviceAdapter.sendRequest(header,req,requestSerialiser),pending.push(cid)},onResponse:function(cid,input){try{var response=responseSerialiser.read(input);return callback(null,response),remove(pending,cid),!0}catch(e){throw e.message=internalSession.getSessionId()+" failed to process response for service '"+service.name+"' cid=<"+cid+"> : "+e.message,e}},onDiscard:function(cid,err){remove(pending,cid),callback(err)}},cid=conversations.new(handler,callback);return function(){conversations.discard(cid,"cancelled")}},close:function(){pending.forEach(conversations.discard),pending=[]}};return reference}}var CommandHeader=require("services/command-header"),remove=(require("v4-stack/message"),require("util/logger").create("Service Locator"),function(arr,e){var i=arr.indexOf(e);i>-1&&arr.splice(i,1)}),defaultCB=function(){};module.exports=ServiceLocator},{"services/command-header":168,"util/logger":281,"v4-stack/message":294}],67:[function(require,module,exports){function ServiceRegistry(){var services=new HashMap,listeners=[];this.get=function(definition){return services.get(definition)},this.add=function(definition,service){if(services.has(definition))throw new Error("Service already exists for "+definition);services.set(definition,service),listeners.forEach(function(listener){listener(definition,service)})},this.addListener=function(listener){listeners.push(listener),services.forEach(function(k,v){listener(v,k)})}}var HashMap=require("hashmap");module.exports=ServiceRegistry},{hashmap:8}],68:[function(require,module,exports){var service={onRequest:function(internal,ping,callback){callback.respond(),internal.onSystemPing()}};module.exports=service},{}],69:[function(require,module,exports){var service={onRequest:function(internal,request,callback){callback.respond(),internal.getRouting().subscribe(request.info)}};module.exports=service},{}],70:[function(require,module,exports){var service={onRequest:function(internal,notification,callback){callback.respond(),internal.getRouting().unsubscribe(notification.id,notification.reason)}};module.exports=service},{}],71:[function(require,module,exports){var service={onRequest:function(internal,ping,callback){callback.respond()}};module.exports=service},{}],72:[function(require,module,exports){module.exports={RECORD_DELIMITER:1,FIELD_DELIMITER:2,EMPTY_FIELD:3,RECORD_MU:4,FIELD_MU:5}},{}],73:[function(require,module,exports){var BufferInputStream=require("io/buffer-input-stream"),RecordContent=require("./record-content"),consts=require("content/consts");module.exports=function(buffer){var records=[];if(1===buffer.length&&buffer[0]===consts.RECORD_MU)records.push(new RecordContent.Record([]));else if(buffer.length>0){for(var bis=new BufferInputStream(buffer);bis.hasRemaining();){for(var rbis=new BufferInputStream(bis.readUntil(consts.RECORD_DELIMITER)),fields=[];rbis.hasRemaining();){var field=rbis.readUntil(consts.FIELD_DELIMITER);0===field.length||1===field.length&&(0===fields.length&&field[0]===consts.FIELD_MU||field[0]===consts.EMPTY_FIELD)?fields.push(void 0):fields.push(field.toString())}var rbuffer=rbis.buffer;rbuffer[rbuffer.length-1]===consts.FIELD_DELIMITER&&fields.push(void 0),records.push(new RecordContent.Record(fields))}buffer[buffer.length-1]===consts.RECORD_DELIMITER&&records.push(new RecordContent.Record([]))}return new RecordContent(records)}},{"./record-content":74,"content/consts":72,"io/buffer-input-stream":123}],74:[function(require,module,exports){var consts=require("content/consts"),RecordContent=function(records){this.length=records.length,this.get=function(i){return i=i||0,records[i]},this.records=function(){return records.concat([])},this.forEach=function(iterator){records.forEach(iterator)},this.toString=function(){return records.join(consts.RECORD_DELIMITER)}};RecordContent.Record=function(fields){this.length=fields.length,this.get=function(i){return i=i||0,fields[i]},this.fields=function(){return fields.concat([])},this.forEach=function(iterator){fields.forEach(iterator)},this.toString=function(){return fields.join(consts.FIELD_DELIMITER)}},module.exports=RecordContent},{"content/consts":72}],75:[function(require,module,exports){var BEES=require("serialisers/byte-encoded-enum-serialiser"),Codec=require("io/codec"),util=require("content/util"),Encoding={NONE:0,ENCRYPTED:1,COMPRESSED:2};module.exports={read:function(bis){var encoding=BEES.read(bis,Encoding),bytes=Codec.readBytes(bis);switch(encoding){case Encoding.NONE:return bytes;default:throw new Error("Unable to handle encoding type "+encoding)}},write:function(bos,content){BEES.write(bos,Encoding.NONE),Codec.writeBytes(bos,util.getBytes(content))}}},{"content/util":79,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],76:[function(require,module,exports){function insertFields(record,fn,fields){if(fields)for(var field in fields){var value=fields[field];if(value instanceof Array)for(var i=0;i<value.length;++i)fn.call(record,field,value[i],i);else fn.call(record,field,value)}}var implements=require("util/interface").implements,api=require("../../../content/record-content"),RecordContent=require("content/structured-record-content/record-content"),RecordRecordBuilder=implements(api.Builder.Record,function(meta){var fields={};this.add=function(name,value){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name  '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),!(mfield.occurs.max===-1||fields[name].length<mfield.occurs.max))throw new Error("Field '"+name+"' can only occur up to "+mfield.occurs.max+" times");return fields[name].push(value),this},this.set=function(name,value,index){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),index=index||0,void 0===fields[name][index])throw new Error("Cannot set nonexistent field '"+name+'" ('+index+")");return fields[name][index]=value,this},this.build=function(){var $fields={};return meta.getFields().forEach(function(mfield){var field=mfield.name;$fields[field]=[],void 0===fields[field]&&(fields[field]=[]);for(var i=fields[field].length;i<mfield.occurs.min;++i)fields[field].push(mfield.type.value);$fields[field]=fields[field]}),new RecordContent.Record($fields)}}),RecordBuilder=implements(api.Builder,function(meta){var records={};this.add=function(name,fields){var mrecord=meta.getRecord(name);if(mrecord){if(void 0===records[name]&&(records[name]=[]),mrecord.occurs.max===-1||records[name].length<mrecord.occurs.max){var record=new RecordRecordBuilder(mrecord);return records[name].push(record),insertFields(record,record.add,fields),record}throw new Error("Record '"+name+"' can only occur up to "+mrecord.occurs.max+" times")}throw new Error("Invalid record name '"+name+"'")},this.set=function(name,fields,index){var mrecord=meta.getRecord(name);if(mrecord){if(void 0===records[name]&&(records[name]=[]),index=index||0,void 0!==records[name][index]){var record=records[name][index];return insertFields(record,record.set,fields),record}throw new Error("Cannot set nonexistent record "+name+'" ('+index+")")}throw new Error("Invalid record name '"+name+"'")},this.build=function(){var $records={};return meta.getRecords().forEach(function(mrecord){var record=mrecord.name;$records[record]=[],void 0===records[record]&&(records[record]=[]);for(var i=records[record].length;i<mrecord.occurs.min;++i)records[record].push(new RecordRecordBuilder(mrecord));for(var j=0;j<records[record].length;++j)$records[record].push(records[record][j].build())}),new RecordContent($records)},this.addAndBuild=function(name,value){return this.add(name,value),this.build()},this.setAndBuild=function(name,fields,index){return this.set(name,fields,index),this.build()}});module.exports=RecordBuilder},{"../../../content/record-content":30,"content/structured-record-content/record-content":78,"util/interface":280}],77:[function(require,module,exports){function Reader(set){var pos=0;this.readUpTo=function(occurs,fn){var max=Math.min(pos+(occurs.max===-1?set.length:occurs.max),set.length);if(0===set.length)return;if(occurs.min>set.length-pos)throw new Error("Data exhaused while parsing");for(var i=pos;i<max;++i)fn(set[i]);pos=max}}function RecordContentMetadataParser(metadata){this.parse=function(buffer){var content=parseAsRecordContent(buffer),reader=new Reader(content.records()),$records={};return metadata.getRecords().forEach(function(mrecord){var records=[];reader.readUpTo(mrecord.occurs,function(record){var reader=new Reader(record.fields()),$fields={};mrecord.getFields().forEach(function(mfield){var fields=[];reader.readUpTo(mfield.occurs,function(field){field?fields.push(mfield.type.parse(field)):fields.push(field)}),$fields[mfield.name]=fields}),records.push(new RecordContent.Record($fields))}),$records[mrecord.name]=records}),new RecordContent($records)}}var parseAsRecordContent=require("content/record-content/parser"),RecordContent=require("content/structured-record-content/record-content");module.exports=RecordContentMetadataParser},{"content/record-content/parser":73,"content/structured-record-content/record-content":78}],78:[function(require,module,exports){var implements=require("util/interface").implements,api=require("../../../content/record-content"),StructuredRecordContent=implements(api,function(records){var inlined=[];for(var k in records)inlined=inlined.concat(records[k]);this.get=function(name,index){if(index=index||0,records[name])return records[name][index];return},this.records=function(name){if(records[name])return records[name].concat([]);return inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}});StructuredRecordContent.Record=implements(api.Record,function(fields){var inlined=[];for(var k in fields)inlined=inlined.concat(fields[k]);this.get=function(name,index){if(index=index||0,fields[name])return fields[name][index];return},this.fields=function(name){if(fields[name])return fields[name].concat([]);return inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}}),module.exports=StructuredRecordContent},{"../../../content/record-content":30,"util/interface":280}],79:[function(require,module,exports){(function(Buffer){function getDefaultContentBytes(content){return new Buffer(content.toString())}function getRecordContentBytes(content){var bos=new BufferOutputStream,recordDelimiter=!1;return content.forEach(function(r){var fieldDelimiter=!1;recordDelimiter?bos.writeInt8(consts.RECORD_DELIMITER):recordDelimiter=!0,r.forEach(function(f){fieldDelimiter?bos.writeInt8(consts.FIELD_DELIMITER):fieldDelimiter=!0,bos.writeString(f.toString())})}),bos.getBuffer()}function isRecordContent(content){return RC.isPrototypeOf(content)||SRC.isPrototypeOf(content)}function getBytes(content){return content.$buffer?content.$buffer.slice(content.$offset,content.$length):isRecordContent(content)?getRecordContentBytes(content):getDefaultContentBytes(content)}var BufferOutputStream=(require("io/codec"),require("io/buffer-output-stream")),RC=require("content/record-content/record-content"),SRC=require("content/structured-record-content/record-content"),consts=require("content/consts");module.exports={getBytes:getBytes,isRecordContent:isRecordContent}}).call(this,require("buffer").Buffer)},{buffer:2,"content/consts":72,"content/record-content/record-content":74,"content/structured-record-content/record-content":78,"io/buffer-output-stream":124,"io/codec":125}],80:[function(require,module,exports){var ControlGroup=require("control/control-group"),Codec=require("io/codec"),serialiser={read:function(input){var name=Codec.readString(input);return new ControlGroup(name)},write:function(output,group){Codec.writeString(output,group.name)}};module.exports=serialiser},{"control/control-group":81,"io/codec":125}],81:[function(require,module,exports){function ControlGroup(name){this.name=name}ControlGroup.DEFAULT=new ControlGroup("default"),module.exports=ControlGroup},{}],82:[function(require,module,exports){function responseHandler(internal,adapter,deregistration){var close,state=ResponseHandlerState.REGISTERING;return{onDiscard:function(cid,err){adapter.close(err),state=ResponseHandlerState.CLOSED},onOpen:function(cid){close=function(){var emitter=new Emitter,result=new Result(emitter);return state!==ResponseHandlerState.CLOSED?deregistration(cid,function(err){err?(internal.getConversationSet().discard(cid,err),emitter.error(err)):(internal.getConversationSet().respond(cid,ResponseHandlerState.CLOSED),emitter.emit("complete"))}):emitter.error(new Error("Handler already closed")),result}},onResponse:function(cid,response){switch(response){case ResponseHandlerState.ACTIVE:return adapter.active(close),state=response,!1;case ResponseHandlerState.CLOSED:return adapter.close(),state=response,!0;default:return adapter.respond(response)}}}}function registrationCallback(conversationSet,cid,emitter){return function(err){err?(conversationSet.discard(cid,err),emitter.error(err)):(conversationSet.respond(cid,ResponseHandlerState.ACTIVE),emitter.emit("complete"))}}function registerHandler(internal,params,adapter,reg,dereg){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),registration=serviceLocator.obtain(reg),deregistration=serviceLocator.obtain(dereg),cid=conversationSet.new(responseHandler(internal,adapter,function(cid,callback){deregistration.send(params,callback)})),emitter=new Emitter,result=new Result(emitter);return registration.send({params:params,cid:cid},registrationCallback(conversationSet,cid,emitter)),result}var Services=require("services/services"),Emitter=require("events/emitter"),Result=require("events/result"),ResponseHandlerState={REGISTERING:0,ACTIVE:1,CLOSED:2};module.exports.responseHandler=responseHandler,module.exports.registrationCallback=registrationCallback,module.exports.registerMessageHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.MESSAGE_RECEIVER_CONTROL_REGISTRATION,Services.MESSAGE_RECEIVER_CONTROL_DEREGISTRATION)},module.exports.registerServerHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.SERVER_CONTROL_REGISTRATION,Services.SERVER_CONTROL_DEREGISTRATION)},module.exports.registerTopicHandler=function(internal,params,adapter){return registerHandler(internal,params,adapter,Services.TOPIC_CONTROL_REGISTRATION,Services.TOPIC_CONTROL_DEREGISTRATION)},module.exports.ResponseHandlerState=ResponseHandlerState},{"events/emitter":103,"events/result":104,"services/services":221}],83:[function(require,module,exports){var Codec=require("io/codec"),ConversationId=require("conversation/conversation-id"),CIDSerialiser={read:function(input){return new ConversationId(Codec.readInt64(input))},write:function(out,cid){Codec.writeInt64(out,cid.val)}};module.exports=CIDSerialiser},{"conversation/conversation-id":84,"io/codec":125}],84:[function(require,module,exports){function ConversationId(val){this.val=val}var Long=require("long");ConversationId.prototype.toString=function(){return this.val.toString(10)},ConversationId.prototype.toValue=function(){return this.toString()},ConversationId.fromString=function(val){return new ConversationId(Long.fromString(val,!1))},module.exports=ConversationId},{long:11}],85:[function(require,module,exports){function create(errorHandler){function discard(cid,err){var conversation=conversations.get(cid.toString());conversation&&(conversations.remove(cid.toString()),conversation.discard(cid,err))}var conversations=new HashMap,bulkhead=function(set,handler,cb){return function(cid){try{return fn.callWithArguments(cb,arguments)}catch(e){return errorHandler.handlerException(cid,e,arguments[1],arguments[2]),discard(cid,e),!1}}};return{new:function(handler){var cid=nextCID(),set=this,conversation=new Conversation({onOpen:bulkhead(set,handler,handler.onOpen),onResponse:bulkhead(set,handler,handler.onResponse),onDiscard:bulkhead(set,handler,handler.onDiscard)});return conversations.set(cid.toString(),conversation),conversation.open(cid),cid},respond:function(cid,r1,r2){var conversation=conversations.get(cid.toString());if(conversation){var response=conversation.respond(cid,r1,r2);switch(response){case"ALREADY_FINISHED":errorHandler.unknownConversation(cid,r1,r2);break;case"HANDLED_AND_ACTIVE":break;case"HANDLED_AND_FINISHED":conversations.remove(cid.toString())}}else errorHandler.unknownConversation(cid,r1,r2)},discard:discard,discardAll:function(err){conversations.forEach(function(conversation,cid){discard(ConversationId.fromString(cid),err)}),conversations.clear()},size:function(){return conversations.count()}}}var HashMap=require("hashmap"),Long=require("long"),ConversationId=require("conversation/conversation-id"),Conversation=require("conversation/conversation"),fn=require("util/function"),nextCID=(require("util/logger").create("Conversation Set"),function(){var id=new Long(0);return function(){return id=id.add(1),new ConversationId(id)}}());module.exports=create},{"conversation/conversation":86,"conversation/conversation-id":84,hashmap:8,long:11,"util/function":279,"util/logger":281}],86:[function(require,module,exports){function Conversation(handler){this.handler=handler}Conversation.prototype.open=function(cid){this.handler.onOpen(cid)},Conversation.prototype.respond=function(cid,r1,r2){var close=void 0===r2?this.handler.onResponse(cid,r1):this.handler.onResponse(cid,r1,r2);return close?"HANDLED_AND_FINISHED":"HANDLED_AND_ACTIVE"},Conversation.prototype.discard=function(cid,err){this.handler.onDiscard(cid,err)},module.exports=Conversation},{}],87:[function(require,module,exports){function assign(self,set){for(var m in set)self[m]=set[m]}var conversationSet=require("conversation/conversation-set");module.exports=function(globalErrorHandler){var current=conversationSet(globalErrorHandler),self=this;assign(self,current),this.replace=function(err){var old=current;current=conversationSet(globalErrorHandler),assign(self,current),old.discardAll(err)}}},{"conversation/conversation-set":85}],88:[function(require,module,exports){var log=require("util/logger").create("Conversation Error Handler");module.exports={handlerException:function(cid,e,r1,r2){log.error("Application handler threw an exception when called with a response[cid="+cid+" response="+r1+", "+r2+"] ",e)},unknownConversation:function(cid,r1,r2){log.debug("A response was received from a peer for a finished conversation and ignored[cid="+cid+" response="+r1+", "+r2+"]")}}},{"util/logger":281}],89:[function(require,module,exports){(function(Buffer){var implements=require("util/interface").implements,BinaryDataType=require("../../../data/binary/binary-datatype"),BinaryDeltaSupportImpl=require("data/binary/binary-delta-support-impl"),BinaryDeltaImpl=require("data/binary/binary-delta-impl"),BinaryImpl=require("data/binary/binary-impl");module.exports=implements(BinaryDataType,function(){function internalValue(val){if(BinaryImpl.isPrototypeOf(val))return val;if(Buffer.isBuffer(val))return self.readValue(val);throw new Error("Unable to read Binary value from: "+val)}var self=this,binaryDeltaSupport=new BinaryDeltaSupportImpl(this,internalValue);this.name=function(){return"binary"},this.from=function(val){return internalValue(val)},this.readValue=function(buffer,offset,length){return new BinaryImpl(self,buffer,offset,length)},this.writeValue=function(binary){return binary=internalValue(binary),binary.$buffer.slice(binary.$offset,binary.$offset+binary.$length)},this.deltaType=function(context){if(!context)return binaryDeltaSupport;if("string"==typeof context)switch(context.toLowerCase()){case"binary":return binaryDeltaSupport}else if(BinaryDeltaImpl.isPrototypeOf(context))return binaryDeltaSupport;throw new Error("Unknown delta type: "+context)}})}).call(this,{isBuffer:require("../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js")})},{"../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js":6,"../../../data/binary/binary-datatype":31,"data/binary/binary-delta-impl":90,"data/binary/binary-delta-support-impl":91,"data/binary/binary-impl":92,"util/interface":280}],90:[function(require,module,exports){(function(Buffer){var implements=require("util/interface").implements,Tokeniser=require("cbor/tokeniser"),BinaryDelta=require("../../../data/binary/binary-delta"),util=require("data/util");module.exports=implements(BinaryDelta,function(buffer,offset,length){util.assignInternals(this,buffer,offset,length),this.visit=function(visitor){if(this.hasChanges()){for(var tokeniser=new Tokeniser(buffer,offset,length);tokeniser.hasRemaining();){var token=tokeniser.nextToken(),isEnd=!1;if(Buffer.isBuffer(token.value))isEnd=!visitor.insert(token.value);else{var start=token.value,end=tokeniser.nextToken().value;isEnd=!visitor.match(start,end)}if(isEnd)return void visitor.end()}visitor.end()}else visitor.noChange()},this.hasChanges=function(){return 1!==length}})}).call(this,{isBuffer:require("../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js")})},{"../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js":6,"../../../data/binary/binary-delta":32,"cbor/tokeniser":62,"data/util":102,"util/interface":280}],91:[function(require,module,exports){(function(Buffer){function replace(value){return encoder.encode(value.$buffer,value.$offset,value.$length),new BinaryDeltaImpl(encoder.flush())}function cborCost(i){if(i<24)return 1;if(i<255)return 2;if(i<=65535)return 3;return 5}function conflatableMatch(matchStart,matchLength,insertLength){var matchCost=cborCost(matchStart)+1,insertCost=cborCost(matchLength+insertLength)-cborCost(insertLength)+matchLength;return insertCost<=matchCost}function Script(encoder,buffer,offset,blowsBudget){function flush(){return pendingStart===-1?binaryDiff.SUCCESS:pendingInsert?writeInsert(pendingStart,pendingLength):writeMatch(pendingStart,pendingLength)}function process(insert,start,length){var r=flush();if(r!==binaryDiff.SUCCESS)return r;return pendingInsert=insert,pendingStart=start,pendingLength=length,binaryDiff.SUCCESS}function writeInsert(start,length){if(blowsBudget(length+cborCost(length)))return binaryDiff.REPLACE;return encoder.encode(buffer,offset+start,length),pendingStart=-1,binaryDiff.SUCCESS}function writeMatch(start,length){if(blowsBudget(cborCost(start)+cborCost(length)))return binaryDiff.REPLACE;return encoder.encode(start),encoder.encode(length),pendingStart=-1,binaryDiff.SUCCESS}var pendingInsert,pendingLength,pendingStart=-1;this.insert=function(bStart,length){if(!pendingInsert&&pendingStart!==-1&&conflatableMatch(pendingStart,pendingLength,length))return pendingStart=bStart-pendingLength,pendingLength+=length,pendingInsert=!0,binaryDiff.SUCCESS;return process(!0,bStart,length)},this.match=function(aStart,length){if(pendingInsert&&pendingStart!==-1&&conflatableMatch(aStart,length,pendingLength))return pendingLength+=length,binaryDiff.SUCCESS;return process(!1,aStart,length)},this.close=function(){return flush()}}var implements=require("util/interface").implements,DeltaType=require("../../../data/delta-type"),BufferOutputStream=require("io/buffer-output-stream"),BinaryDeltaImpl=require("data/binary/binary-delta-impl"),binaryDiff=require("data/diff/myers-binary-diff"),Decoder=require("cbor/decoder"),Encoder=require("cbor/encoder"),encoder=new Encoder,NO_CHANGE=new BinaryDeltaImpl(new Buffer([-10]),0,1);module.exports=implements(DeltaType,function(datatype,internalValue){var self=this;this.name=function(){return"binary"},this.diff=function(oldValue,newValue){oldValue=internalValue(oldValue),newValue=internalValue(newValue);var buffer=newValue.$buffer,offset=newValue.$offset,length=newValue.$length,budget=length,script=new Script(encoder,buffer,offset,function(cost){return(budget-=cost)<=0}),result=binaryDiff(oldValue.$buffer,oldValue.$offset,oldValue.$length,buffer,offset,length,script),delta=encoder.flush();switch(result){case binaryDiff.REPLACE:return replace(newValue);case binaryDiff.NO_CHANGE:return NO_CHANGE;default:return self.readDelta(delta)}},this.apply=function(oldValue,delta){if(oldValue=internalValue(oldValue),!delta||!delta.hasChanges())return oldValue;for(var decoder=new Decoder(delta.$buffer),bos=new BufferOutputStream;decoder.hasRemaining();){var start=decoder.nextValue();Buffer.isBuffer(start)?bos.writeMany(start):"number"==typeof start&&bos.writeMany(oldValue.$buffer,oldValue.$offset+start,decoder.nextValue())}return datatype.readValue(bos.getBuffer())},this.readDelta=function(buffer,offset,length){var delta=new BinaryDeltaImpl(buffer,offset,length);if(1===delta.$length&&buffer[delta.$offset]===NO_CHANGE.$buffer[0])return NO_CHANGE;return delta},this.writeDelta=function(delta){return delta.$buffer.slice(delta.$offset,delta.$offset+delta.$length)},this.noChange=function(){return NO_CHANGE},this.isValueCheaper=function(value,delta){return value.$length<=delta.$length}}),module.exports.NO_CHANGE=NO_CHANGE}).call(this,require("buffer").Buffer)},{"../../../data/delta-type":37,buffer:2,"cbor/decoder":60,"cbor/encoder":61,"data/binary/binary-delta-impl":90,"data/diff/myers-binary-diff":95,"io/buffer-output-stream":124,"util/interface":280}],92:[function(require,module,exports){var implements=require("util/interface").implements,BinaryType=require("../../../data/binary/binary"),BytesImpl=require("data/bytes-impl");require("data/util");module.exports=implements(BinaryType,function(datatype,buffer,offset,length){BytesImpl.__constructor.call(this,buffer,offset,length);var self=this;this.get=function(){return buffer.slice(self.$offset,self.$offset+self.$length)},this.diff=function(original,type){return type=type||"binary",datatype.deltaType(type).diff(original,self)},this.apply=function(delta){return datatype.deltaType(delta).apply(self,delta)},this.toString=function(){return"Binary <"+self.$length+" bytes> "+self.get().toString()}})},{"../../../data/binary/binary":33,"data/bytes-impl":93,"data/util":102,"util/interface":280}],93:[function(require,module,exports){var implements=require("util/interface").implements,Bytes=require("../../data/bytes"),util=require("data/util");module.exports=implements(Bytes,function(buffer,offset,length){util.assignInternals(this,buffer,offset,length);var self=this;this.length=function(){return self.$length},this.asBuffer=function(){return buffer},this.copyTo=function(target,tOffset){tOffset=tOffset||0,buffer.copy(target,tOffset,self.$offset,self.$offset+self.$length)},this.equalBytes=function(buffer,offset,length){if(this.$length!==length)return!1;var $buffer=this.$buffer,$offset=this.$offset;if($buffer===buffer&&$offset===offset)return!0;for(var i=0;i<length;++i)if($buffer[$offset+i]!==buffer[offset+i])return!1;return!0}})},{"../../data/bytes":34,"data/util":102,"util/interface":280}],94:[function(require,module,exports){(function(Buffer){var implements=require("util/interface").implements,DataTypes=require("../../data/datatypes"),TopicType=require("../../topics/topics").TopicType,BinaryDataTypeImpl=require("data/binary/binary-datatype-impl"),BinaryImpl=require("data/binary/binary-impl"),JSONDataTypeImpl=require("data/json/json-datatype-impl"),JSONImpl=require("data/json/json-impl"),DataTypesImpl=implements(DataTypes,function(){var binary=new BinaryDataTypeImpl,json=new JSONDataTypeImpl,self=this;this.binary=function(){return binary},this.json=function(){return json},this.get=function(name){switch(typeof name){case"string":switch(name.toLowerCase()){case"json":return self.json();case"binary":return self.binary()}break;case"object":if(name===TopicType.BINARY||BinaryImpl.isPrototypeOf(name)||Buffer.isBuffer(name))return self.binary();if(name===TopicType.JSON||JSONImpl.isPrototypeOf(name)||name.constructor===Object)return self.json()}return null}});module.exports=new DataTypesImpl}).call(this,{isBuffer:require("../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js")})},{"../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js":6,"../../data/datatypes":36,"../../topics/topics":299,"data/binary/binary-datatype-impl":89,"data/binary/binary-impl":92,"data/json/json-datatype-impl":96,"data/json/json-impl":98,"util/interface":280}],95:[function(require,module,exports){function keyF(k){return k<0?-4*k-1:4*k}function keyR(k){return keyF(k)+2}function getF(k){var i=storage[keyF(k)];return void 0===i?0:i}function getR(k){var i=storage[keyR(k)];return void 0===i?0:i}function setF(k,i){storage[keyF(k)]=i}function setR(k,i){storage[keyR(k)]=i}function nextF(k,d){if(k===d)return getF(k-1);if(k===-d)return getF(k+1)+1;var left=getF(k+1),right=getF(k-1);return left<right?right:left+1}function nextR(k,d){if(k===-d)return getR(k+1);if(k===d)return getR(k-1)-1;var left=getR(k+1),right=getR(k-1);return left<right?left:right-1}function exceedsStorage(d){return d>storageLimit}function calculateBailOutLimit(l1,l2,bailOutFactor){return bailOutFactor*approximateSquareRoot(l1+l2)}function checkBounds(buffer,offset,length){if(offset<0)throw new Error("offset "+offset+" < 0");if(length<0)throw new Error("length "+length+" < 0");if(offset+length>buffer.length||offset+length<0)throw new Error("offset "+offset+" + "+length+" > "+buffer.length)}function Execution(a,b,script,bailOutLimit){var self=this;this.diff=function(aOffset,aLength,bOffset,bLength){checkBounds(a,aOffset,aLength),checkBounds(b,bOffset,bLength);for(var x=0,y=0;x<aLength&&y<bLength&&a[aOffset+x]===b[bOffset+y];)++x,++y;for(var u=aLength,v=bLength;u>x&&v>y&&a[aOffset+u-1]===b[bOffset+v-1];)--u,--v;var r1=script.match(aOffset,x);if(r1!==SUCCESS)return r1;var r2;if(r2=x===u?script.insert(bOffset+y,v-y):y===v?script.delete(aOffset+x,u-x):self.middleSnake(aOffset+x,u-x,bOffset+y,v-y),r2!==SUCCESS)return r2;return script.match(aOffset+u,aLength-u)},this.middleSnake=function(aOffset,aLength,bOffset,bLength){var delta=aLength-bLength,odd=1&delta;setF(-1,0),setR(1,aLength);for(var d=0;;){for(var k1=-d;k1<=d;k1+=2){for(var x1=nextF(k1,d),u1=x1;u1<aLength&&u1+k1<bLength&&a[aOffset+u1]===b[bOffset+u1+k1];)++u1;if(setF(k1,u1),odd&&d>1&&Math.abs(k1+delta)<=d-1&&u1>=getR(k1+delta))return self.recurse(aOffset,aLength,bOffset,bLength,x1,u1,k1)}for(var k2=-d;k2<=d;k2+=2){for(var u2=nextR(k2,d),x2=u2,kd=k2-delta;x2>0&&x2+kd>0&&a[aOffset+x2-1]===b[bOffset+x2+kd-1];)--x2;if(setR(k2,x2),!odd&&d>0&&Math.abs(kd)<=d&&x2<=getF(kd))return self.recurse(aOffset,aLength,bOffset,bLength,x2,u2,kd)}if(d>bailOutLimit)return REPLACE;if(++d,exceedsStorage(d))return REPLACE}},this.recurse=function(aOffset,aLength,bOffset,bLength,x,u,k){var r1=self.diff(aOffset,x,bOffset,x+k);if(r1!==SUCCESS)return r1;var r2=script.match(aOffset+x,u-x);if(r2!==SUCCESS)return r2;return self.diff(aOffset+u,aLength-u,bOffset+u+k,bLength-u-k)}}function coalesce(delegate,aOffset,bOffset){function flushPending(){return neverFlushed&=pending===NOOP,pending(delegate,pendingStart,pendingLength)}function process(op,start,length){if(length>0)if(pending!==op){var r=flushPending();if(r!==SUCCESS)return r;pending=op,pendingStart=start,pendingLength=length}else pendingLength+=length;return SUCCESS}var neverFlushed=!0,pendingLength=0,pendingStart=0,pending=NOOP;return{insert:function(bStart,length){return process(INSERT,bStart-bOffset,length)},match:function(aStart,length){return process(MATCH,aStart-aOffset,length)},delete:function(aStart,length){var r=flushPending();return pending=NOOP,r},close:function(aLength,bLength){if(neverFlushed){if(pending===INSERT)return REPLACE;if(0===pendingStart&&pendingLength===aLength)return NO_CHANGE}var r=flushPending();if(r!==SUCCESS)return r;return delegate.close()}}}var approximateSquareRoot=require("util/math").approximateSquareRoot,BAIL_OUT_FACTOR=10,SUCCESS=0,REPLACE=1,NO_CHANGE=2,storageLimit=536870911,storage=[],INSERT=function(script,start,length){return script.insert(start,length)},MATCH=function(script,start,length){return script.match(start,length)},NOOP=function(){return SUCCESS};module.exports=function(a,aOffset,aLength,b,bOffset,bLength,editScript,bailOutFactor){void 0===bailOutFactor&&(bailOutFactor=BAIL_OUT_FACTOR);var script=coalesce(editScript,aOffset,bOffset),execution=new Execution(a,b,script,calculateBailOutLimit(aLength,bLength,bailOutFactor)),result=execution.diff(aOffset,aLength,bOffset,bLength);if(result!==SUCCESS)return result;return script.close(aLength,bLength)},module.exports.SUCCESS=SUCCESS,module.exports.REPLACE=REPLACE,module.exports.NO_CHANGE=NO_CHANGE},{"util/math":282}],96:[function(require,module,exports){(function(Buffer){var implements=require("util/interface").implements,JSONDataType=require("../../../data/json/json-datatype"),BinaryDeltaSupportImpl=require("data/binary/binary-delta-support-impl"),BinaryDeltaImpl=require("data/binary/binary-delta-impl"),JSONImpl=require("data/json/json-impl"),Encoder=require("cbor/encoder");module.exports=implements(JSONDataType,function(){function internalValue(val){return JSONImpl.isPrototypeOf(val)?val:Buffer.isBuffer(val)?self.readValue(val):self.readValue(encoder.encode(val).flush())}var encoder=new Encoder,self=this,binaryDeltaSupport=new BinaryDeltaSupportImpl(this,internalValue);this.name=function(){return"json"},this.from=function(val){return internalValue(val)},this.fromJsonString=function(val){return internalValue(JSON.parse(val))},this.readValue=function(buffer,offset,length){return new JSONImpl(self,buffer,offset,length)},this.writeValue=function(json){return json=internalValue(json),json.$buffer.slice(json.$offset,json.$offset+json.$length)},this.deltaType=function(context){if(!context)return binaryDeltaSupport;if("string"==typeof context)switch(context.toLowerCase()){case"binary":return binaryDeltaSupport}else if(BinaryDeltaImpl.isPrototypeOf(context))return binaryDeltaSupport;throw new Error("Unknown delta type: "+context)}})}).call(this,{isBuffer:require("../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js")})},{"../../../../node_modules/browserify/node_modules/insert-module-globals/node_modules/is-buffer/index.js":6,"../../../data/json/json-datatype":38,"cbor/encoder":61,"data/binary/binary-delta-impl":90,"data/binary/binary-delta-support-impl":91,"data/json/json-impl":98,"util/interface":280}],97:[function(require,module,exports){(function(Buffer){function isPartOf(original,other,start,length){return original.equalBytes(other.$buffer,other.$offset+start,length)}function DeltaVisitor(oldValue,newValue,inserted,removed,partOf,copyPartOf){function handleDelete(start,length){checkInvariants();var end=start+length;oldParser.nextByte()<end&&(0!==oldParser.spanTo(end,remover)||oldParser.nextByte()>end)&&newParser.spanToNext(newOffset+1,inserter)}function handleMatch(start,length){checkInvariants();var newStart=newOffset,end=start+length;newOffset+=length,oldOffset=end;var oldNextByte=oldParser.nextByte(),newNextByte=newParser.nextByte();newNextByte>newStart&&oldNextByte===start?oldParser.spanToNext(start+1,remover):oldNextByte>start&&newNextByte===newStart&&newParser.spanToNext(newStart+1,inserter);var lastOld=new LastResult(removedSplitStructures),lastNew=new LastResult(insertedSplitStructures);oldParser.spanTo(end,lastOld),newParser.spanTo(newOffset,lastNew);var oldSplit=lastOld.foundLast()&&oldParser.nextByte()>end,newSplit=lastNew.foundLast()&&newParser.nextByte()>newOffset;oldSplit&&newSplit&&(lastOld.consumeLast(remover),lastNew.consumeLast(inserter))}function addInsert(nextPointer,nextValue){null!==pendingInsert&&inserted.put(pendingInsert,pendingInsertValue),pendingInsert=nextPointer,pendingInsertValue=nextValue}function addRemove(nextPointer,nextValue){null!==pendingRemove&&removed.put(pendingRemove,pendingRemoveValue),pendingRemove=nextPointer,pendingRemoveValue=nextValue}function checkInvariants(){if(oldParser.nextByte()<oldOffset||newParser.nextByte()<newOffset)throw new Error("Invalid binary delta")}function replaceFullRemovedStructures(){for(var i=removedSplitStructures.postOrder();i.hasNext();){var s=i.next(),split=s.value,entry=removed.getEntry(s.pointer);null!==entry&&entry.numberOfChildren()===split.elements&&(entry.setValue(copyPartOf(oldValue,split.start,split.length)),entry.removeDescendants())}}function replaceFullInsertedStructures(){for(var i=insertedSplitStructures.postOrder();i.hasNext();){var s=i.next(),split=s.value,entry=inserted.getEntry(s.pointer);null!==entry&&entry.numberOfChildren()===split.elements&&(entry.setValue(partOf(newValue,split.start,split.length)),entry.removeDescendants())}}var pendingRemoveValue,pendingInsertValue,removedSplitStructures=new JSONPointerMap,insertedSplitStructures=new JSONPointerMap,oldParser=new SpanParser(oldValue),newParser=new SpanParser(newValue),oldOffset=0,newOffset=0,pendingRemove=null,pendingInsert=null;this.match=function(start,length){return handleDelete(oldOffset,start-oldOffset),handleMatch(start,length),!0},this.insert=function(bytes){return checkInvariants(),newOffset+=bytes.length,newParser.nextByte()<newOffset&&(0!==newParser.spanTo(newOffset,inserter)||newParser.nextByte()>newOffset)&&oldParser.spanToNext(oldOffset+1,remover),!0},this.end=function(){handleDelete(oldOffset,oldValue.$length-oldOffset),addInsert(null,null),addRemove(null,null),replaceFullRemovedStructures(),replaceFullInsertedStructures()},this.noChange=function(){};var inserter={accept:function(pointer,start,length){null!==pendingRemove&&pendingRemove.equalIgnoringIndexes(pointer)&&isPartOf(pendingRemoveValue,newValue,start,length)?(pendingRemove=null,pendingRemoveValue=null):(addInsert(pointer,partOf(newValue,start,length)),addRemove(null,null))},splitStructureEnd:function(pointer,count,start,length){insertedSplitStructures.put(pointer,{start:start,length:length,elements:count})}},remover={accept:function(pointer,start,length){null!==pendingInsert&&pendingInsert.equalIgnoringIndexes(pointer)&&isPartOf(pendingInsertValue,oldValue,start,length)?(pendingInsert=null,pendingInsertValue=null):(addRemove(pointer,copyPartOf(oldValue,start,length)),addInsert(null,null))},splitStructureEnd:function(pointer,count,start,length){removedSplitStructures.put(pointer,{start:start,length:length,elements:count})}}}function LastResult(splitStructures){var last,lastStart,lastLength;this.accept=function(pointer,start,length){last=pointer,lastStart=start,lastLength=length},this.foundLast=function(){return!!last},this.consumeLast=function(delegate){delegate.accept(last,lastStart,lastLength)},this.splitStructureEnd=function(pointer,count,start,length){splitStructures.put(pointer,{start:start,length:length,elements:count})}}function ChangeMapImpl(parts){for(var entrySet=[],i=parts.iterator();i.hasNext();){var n=i.next();entrySet.push({key:n.pointer.toString(),value:n.value.get()})}this.length=entrySet.length,this.get=function(key){return parts.get(JSONPointer.parse(key)).get()},this.entrySet=function(){return entrySet},this.containsKey=function(key){return parts.contains(JSONPointer.parse(key))},this.descendants=function(pointer){return new ChangeMapImpl(parts.descendants(JSONPointer.parse(pointer)))},this.intersection=function(pointer){return new ChangeMapImpl(parts.intersection(JSONPointer.parse(pointer)))}}var JSONPointerMap=require("data/json/json-pointer-map"),JSONPointer=require("data/json/json-pointer"),SpanParser=require("data/json/span-parser");module.exports=function(jsonDataType,original,newValue,binaryDelta){function partOf(value,start,length){return jsonDataType.readValue(value.$buffer,value.$offset+start,length)}function copyPartOf(value,start,length){var offsetStart=value.$offset+start,buffer=new Buffer(length);return value.$buffer.copy(buffer,0,offsetStart,offsetStart+length),jsonDataType.readValue(buffer,0,length)}var inserted=new JSONPointerMap,removed=new JSONPointerMap;void 0!==binaryDelta?binaryDelta.visit(new DeltaVisitor(original,newValue,inserted,removed,partOf,copyPartOf)):(inserted.put(JSONPointer.ROOT,original),removed.put(JSONPointer.ROOT,newValue)),this.removed=function(){return new ChangeMapImpl(removed)},this.inserted=function(){return new ChangeMapImpl(inserted)},this.hasChanges=function(){return 0!==removed.size||0!==inserted.size},this.toString=function(){return["REMOVE ",removed," INSERT ",inserted].join("")}}}).call(this,require("buffer").Buffer)},{buffer:2,"data/json/json-pointer":100,"data/json/json-pointer-map":99,"data/json/span-parser":101}],98:[function(require,module,exports){var implements=require("util/interface").implements,BytesImpl=require("data/bytes-impl"),Decoder=require("cbor/decoder"),JSONDeltaImpl=require("data/json/json-delta-impl"),JSONType=require("../../../data/json/json");module.exports=implements(JSONType,function(datatype,buffer,offset,length){BytesImpl.__constructor.call(this,buffer,offset,length);var self=this;this.get=function(){var decoder=new Decoder(buffer,offset,length);return decoder.nextValue()},this.diff=function(original,type){var binaryDiff=datatype.deltaType("binary").diff(original,self);return"json"===type?new JSONDeltaImpl(datatype,original,self,binaryDiff):binaryDiff},this.jsonDiff=function(original){return self.diff(original,"json")},this.apply=function(delta){return datatype.deltaType(delta).apply(self,delta)},this.toString=function(){return JSON.stringify(self.get())}})},{"../../../data/json/json":39,"cbor/decoder":60,"data/bytes-impl":93,"data/json/json-delta-impl":97,"util/interface":280}],99:[function(require,module,exports){function JSONPointerMap(){function Entry(segment,pointer){this.segment=segment,this.pointer=pointer,this.children=[],this.value=null,this.count=function(){for(var result=this.value?1:0,i=0;i<this.children.length;++i)result+=this.children[i].count();return result},this.addChild=function(s){var c=new Entry(s,pointer.withSegment(s));return this.children.push(c),c},this.findChild=function(s){for(var i=0;i<this.children.length;++i)if(s.equals(this.children[i].segment))return this.children[i];return null},this.setValue=function(newValue){var previous=this.value;return null===previous&&self.size++,this.value=newValue,previous},this.removeDescendants=function(){for(var removed=0,i=0;i<this.children.length;++i)removed+=this.children[i].count();return this.children=[],self.size-=removed,removed},this.numberOfChildren=function(){for(var result=0,i=0;i<this.children.length;++i)result+=this.children[i].value?1:0;return result},this.toString=function(){return pointer+"="+this.value}}this.root=new Entry(null,JSONPointer.ROOT),this.size=0;var self=this;this.put=function(pointer,value){requireNonNull(value,"value");for(var node=self.root,i=0;i<pointer.segments.length;){var s=pointer.segments[i++],c=node.findChild(s);if(null===c){node=node.addChild(s);break}node=c}for(;i<pointer.segments.length;i++)node=node.addChild(pointer.segments[i]);return node.setValue(value)},this.contains=function(pointer){return null!==self.get(pointer)},this.get=function(pointer){var entry=self.getEntry(pointer);if(entry)return entry.value;return null},this.getEntry=function(pointer){for(var result=self.root,i=0;i<pointer.segments.length;++i)if(result=result.findChild(pointer.segments[i]),null===result)return null;return result},this.descendants=function(pointer){var result=new JSONPointerMap,thisNode=self.root,resultNode=result.root,segments=pointer.segments,length=segments.length;if(0===length)return this;for(var i=0;i<length-1;++i){var s=segments[i];if(thisNode=thisNode.findChild(s),null===thisNode)return EMPTY;resultNode=resultNode.addChild(s)}var last=thisNode.findChild(segments[length-1]);if(null===last)return EMPTY;return resultNode.children.push(last),result.size=last.count(),result},this.intersection=function(pointer){var result=new JSONPointerMap,thisNode=self.root,resultNode=result.root,segments=pointer.segments,length=segments.length;if(0===length)return this;null!==thisNode.value&&resultNode.setValue(thisNode.value);for(var i=0;i<length-1;++i){var s=segments[i];if(thisNode=thisNode.findChild(s),null===thisNode)return result;resultNode=resultNode.addChild(s),null!==thisNode.value&&resultNode.setValue(thisNode.value)}var last=thisNode.findChild(segments[length-1]);if(null===last)return result;return resultNode.children.push(last),result.size+=last.count(),result},this.iterator=function(){var stack=[self.root];return new EntryIterator(function(){for(;;){var r=stack.shift();if(void 0===r)return null;for(var n=r.children.length;n>0;--n)stack.unshift(r.children[n-1]);if(null!==r.value)return r}})},this.postOrder=function(){var stack=[new PostOrderState(self.root)];return new EntryIterator(function(){for(;;){var r=stack[0];if(void 0===r)return null;var c=r.nextChild();if(null===c){if(stack.shift(),null!==r.node.value)return r.node}else{if(0===c.children.length)return c;stack.unshift(new PostOrderState(c))}}})},this.toString=function(){for(var parts=["{"],iter=self.iterator();iter.hasNext();)parts.length>1&&parts.push(", "),parts.push(iter.next());return parts.push("}"),parts.join("")}}function PostOrderState(node){this.node=node;var nextChild=0;this.nextChild=function(){var children=node.children;if(nextChild>=children.length)return null;return children[nextChild++]}}function EntryIterator(nextWithValue){var next=nextWithValue();this.hasNext=function(){return null!==next},this.next=function(){if(null===next)throw new Error("No such element");var result=next;return next=nextWithValue(),result}}var requireNonNull=require("util/require-non-null"),JSONPointer=require("data/json/json-pointer"),EMPTY=new JSONPointerMap;module.exports=JSONPointerMap},{"data/json/json-pointer":100,"util/require-non-null":286}],100:[function(require,module,exports){function JSONPointer(nodes){this.segments=nodes}function escape(key){for(var i=0;i<key.length;++i){var c=key.charAt(i);if("/"===c||"~"===c){var length=key.length,parts=[];parts.push(key.substring(0,i));for(var j=i;j<length;++j){var c1=key.charAt(j);"/"===c1?parts.push("~1"):"~"===c1?parts.push("~0"):parts.push(c1)}return parts.join("")}}return key}function IndexSegment(index){this.index=index}function KeySegment(key){this.expression="/"+escape(key)}function Parser(expression){function nextSegmentString(){for(var start=p;p<expression.length;++p){var c=expression[p];if("/"===c)break;if("~"===c){for(var parts=[expression.substring(start,p)],length=expression.length;p<length;++p){var c1=expression.charAt(p);if("/"===c1)break;if("~"===c1&&p!==length-1){++p;var c2=expression.charAt(p);"0"===c2?parts.push("~"):"1"===c2?parts.push("/"):(parts.push("~"),parts.push(c2))}else parts.push(c1)}return parts.join("")}}return expression.substring(start,p)}function maybeIndex(s){var digits=s.length;if(0===digits||digits>10)return null;for(var i=0;i<digits;++i){var c=s.charAt(i);if(c<"0"||c>"9")return null;if("0"===c&&0===i)return 1===digits?INDEX0:null}var index=parseInt(s,10);if(index>2147483647)return null;return new IndexSegment(index)}var p=0;if(""!==expression&&"/"!==expression.charAt(0))throw new Error("JSON Pointer expression must be empty or start with '/' : "+expression);this.next=function(){if(p===expression.length)return null;++p;var s=nextSegmentString(),is=maybeIndex(s);if(null!==is)return is;return new KeySegment(s)}}JSONPointer.prototype.withKey=function(key){return this.withSegment(new KeySegment(key))},JSONPointer.prototype.withIndex=function(index){return this.withSegment(new IndexSegment(index))},JSONPointer.prototype.withSegment=function(newNode){var newNodes=this.segments.concat(newNode);return new JSONPointer(newNodes)},JSONPointer.prototype.equalIgnoringIndexes=function(other){if(other===this)return!0;var length=this.segments.length;if(length!==other.segments.length)return!1;for(var i=0;i<length;++i){var s=this.segments[i],o=other.segments[i];if(s instanceof IndexSegment){if(o instanceof KeySegment)return!1}else if(!s.equals(o))return!1}return!0},JSONPointer.prototype.toString=function(){for(var parts=[],i=0;i<this.segments.length;++i)parts.push(this.segments[i].toString());return parts.join("")},JSONPointer.prototype.equals=function(other){if(other===this)return!0;if(!(other&&other instanceof JSONPointer))return!1;if(this.segments.length!==other.segments.length)return!1;for(var length=this.segments.length,i=0;i<length;++i){var s1=this.segments[i],s2=other.segments[i];if(!s1.equals(s2))return!1}return!0},JSONPointer.ROOT=new JSONPointer([]),JSONPointer.parse=function(expression){if(expression instanceof JSONPointer)return expression;for(var result=JSONPointer.ROOT,segmentParser=new Parser(expression);;){var s=segmentParser.next();if(null===s)return result;result=result.withSegment(s)}},module.exports=JSONPointer;var INDEX0=new IndexSegment(0);IndexSegment.prototype.equals=function(other){if(other===this)return!0;if(!(other&&other instanceof IndexSegment))return!1;return other.index===this.index},IndexSegment.prototype.toString=function(){return"/"+this.index},KeySegment.prototype.equals=function(other){if(other===this)return!0;if(!(other&&other instanceof KeySegment))return!1;return other.expression===this.expression},KeySegment.prototype.toString=function(){return this.expression}},{}],101:[function(require,module,exports){function ArrayAccumulator(tokeniser,base,start,next){AbstractAccumulator.call(this,tokeniser,base,start,next),this.take=function(consumer,base,firstAccumulatedIndex,index,start,length){consumer.accept(base.withIndex(index),start,length)},this.currentPointer=function(base,total){return base.withIndex(total)}}function ObjectAccumulator(tokeniser,base,start,next){AbstractAccumulator.call(this,tokeniser,base,start,next);var _add=this.add,pendingKeyName="",pendingKey=!0,keys=[];this.add=function(tokenEnd){return pendingKey?(this.setNextStart(tokenEnd),pendingKeyName=tokeniser.getToken().value,pendingKey=!1):(keys[this.accumulated()]=pendingKeyName,pendingKey=!0,_add(tokenEnd)),!pendingKey},this.take=function(consumer,base,firstAccumulatedIndex,index,start,length){consumer.accept(base.withKey(keys[index-firstAccumulatedIndex]),start,length)},this.currentPointer=function(base,total){return base.withKey(pendingKeyName)}}function RootAccumulator(tokeniser){AbstractAccumulator.call(this,tokeniser,JSONPointer.ROOT,-1,0),this.take=function(consumer,base,firstAccumulatedIndex,index,start,length){if(this.total()>1)throw new Error("Invalid JSON: multiple values found");consumer.accept(base,start,length)},this.currentPointer=function(base,total){return base}}function AbstractAccumulator(tokeniser,base,start,next){var tokenRange=[],accumulated=0,total=0,startOffset=start,nextOffset=next,self=this;this.total=function(){return total},this.accumulated=function(){return accumulated},this.newArray=function(start,next){return new ArrayAccumulator(tokeniser,self.currentPointer(base,total),start,next)},this.newObject=function(start,next){return new ObjectAccumulator(tokeniser,self.currentPointer(base,total),start,next)},this.notEmptyAndSplitBy=function(offset){return startOffset<offset&&0!==total},this.add=function(next){return tokenRange[accumulated]=[nextOffset,next],nextOffset=next,++accumulated,++total,!1},this.setNextStart=function(offset){nextOffset=offset},this.skip=function(){++total,accumulated=0},this.takeAll=function(consumer){for(var next=total,begin=next-accumulated,i=0;i<accumulated;++i){var range=tokenRange[i],start=range[0],end=range[1];self.take(consumer,base,begin,begin+i,start,end-start)}accumulated=0},this.splitStructureEnd=function(consumer){consumer.splitStructureEnd(base,total,startOffset,nextOffset+1-startOffset)},this.toString=function(){return base.toString()}}function SpanParser(json){var tokeniser=new Tokeniser(json.$buffer,json.$offset,json.$length),structure=new RootAccumulator(tokeniser),parentStack=[],startOffset=tokeniser.offset(),self=this;this.spanToNext=function(offset,result){return self.spanTo(offset,result,!0)},this.spanTo=function(offset,result,atLeastOne){var start=self.nextByte();if(start>=offset)return 0;var t,lastHeight=parentStack.length,consumeFirstValue=atLeastOne,next=start;do{t=tokeniser.nextToken();var tokenStart=next;if(next=self.nextByte(),null===t){if(0!==parentStack.length)throw new Error("Invalid structure");break}if(t.type===consts.tokens.VALUE)consumeFirstValue=structure.add(next);else if(t.type===consts.tokens.ARRAY_START)parentStack.push(structure),structure=structure.newArray(tokenStart,next);else if(t.type===consts.tokens.MAP_START)parentStack.push(structure),structure=structure.newObject(tokenStart,next);else if(consts.isStructEnd(t.type)){var parent=parentStack.pop();structure.notEmptyAndSplitBy(start)?(structure.takeAll(result),structure.splitStructureEnd(result),parent.skip(),parent.setNextStart(next)):parent.add(next),structure=parent,consumeFirstValue=!1}}while(consumeFirstValue||next<offset||self.nextTokenIsStructEnd(t,next));for(var i=0;i<parentStack.length;++i)parentStack[i].takeAll(result);return structure.takeAll(result),parentStack.length-lastHeight},this.nextTokenIsStructEnd=function(t,next){var context=tokeniser.getContext();if(consts.isStructStart(t.type))return 0===context.expected();return context.acceptsBreakMarker()&&next<json.$length&&(31&json.$buffer[json.$offset+next])===consts.additional.BREAK||!context.hasRemaining()},this.nextByte=function(){return tokeniser.offset()-startOffset},this.toString=function(){var parts=["SpanParser"," next=",self.nextByte()," ["];return parentStack.forEach(function(x){parts.push(x),parts.push(", ")}),parts.push(structure),parts.push("]"),parts.join("")}}var JSONPointer=require("data/json/json-pointer"),Tokeniser=require("cbor/tokeniser"),consts=require("cbor/consts");require("long");module.exports=SpanParser},{"cbor/consts":58,"cbor/tokeniser":62,"data/json/json-pointer":100,long:11}],102:[function(require,module,exports){module.exports.assignInternals=function(self,buffer,offset,length){self.$buffer=buffer,self.$offset=offset||0,self.$length=void 0===length?buffer.length:length}},{}],103:[function(require,module,exports){(function(process){function Emitter(e,fn,events){var listeners={},listener=function(){},closed=!1,emit=function(event,args){args=args||[];var dispatch=function(listener){functions.callWithArguments(listener,args)};process.nextTick(function(){listeners[event]&&listeners[event].forEach(dispatch)}),listener(event,args)},publicEmit=function(event){if(closed||!event)return;var args=array.argumentsToArray(arguments);args.shift(),emit(event,args)},error=function(reason){emit("error",[reason]),close()},close=function(reason){if(closed)return;closed=!0,emit("close",[reason])},stream=new Stream(listeners,error,close,events);void 0!==e&&stream.on(e,fn),this.listen=function(fn){listener=fn},this.get=function(){return stream},this.close=close,this.error=error,this.emit=publicEmit,this.assign=function(instance){for(var k in stream)instance[k]=stream[k]}}var functions=require("util/function"),array=require("util/array"),Stream=require("events/stream");Emitter.assign=function(instance){var emitter=new Emitter,s=emitter.get();for(var k in s)instance[k]=s[k];return emitter},module.exports=Emitter}).call(this,require("_process"))},{_process:7,"events/stream":105,"util/array":277,"util/function":279}],104:[function(require,module,exports){function ResultImpl(emitter){var promise=when.promise(function(fulfilled,rejected){emitter.listen(function(e,args){"error"===e?rejected(args[0]):fulfilled(args[0])})});this.then=function(fulfillment,rejected,partial){return promise=promise.then(fulfillment,rejected,partial)}}var implements=require("util/interface").implements,Result=require("../../events/result"),when=require("when");module.exports=implements(Result,ResultImpl)},{"../../events/result":43,"util/interface":280,when:29}],105:[function(require,module,exports){function attach(object,key,value,allowedEvents){if("object"==typeof key)for(var k in key)attach(object,k,key[k],allowedEvents);else if(value){if(void 0===object[key]){if(allowedEvents&&allowedEvents.indexOf(key)===-1)throw new Error("Event "+key+" not emitted on this stream, allowed events are "+allowedEvents);object[key]=[]}object[key].push(value)}return object}function remove(object,key,value){if("object"==typeof key)for(var k in key)remove(object,k,key[k]);else object[key]&&(value?object[key]=object[key].filter(function(e){return e!==value}):object[key]=[]);return object}function StreamImpl(listeners,error,close,events){var allowedEvents;events&&(allowedEvents=["close","error","complete"].concat(events)),this.on=function(event,fn){return attach(listeners,event,fn,allowedEvents),this},this.off=function(event,fn){return remove(listeners,event,fn),this},this.close=function(reason){return close(reason),this},this.error=function(reason){return error(reason),this}}var implements=require("util/interface").implements,Stream=require("../../events/stream");module.exports=implements(Stream,StreamImpl)},{"../../events/stream":44,"util/interface":280}],106:[function(require,module,exports){var implements=require("util/interface").implements,Services=require("services/services"),Emitter=require("events/emitter"),Result=require("events/result"),SessionID=require("session/session-id"),parseSelector=require("topics/topic-selector-parser"),responseHandler=require("control/registration").responseHandler,registrationCallback=require("control/registration").registrationCallback,api=require("../../features/client-control"),SessionPropertiesEventType=(require("util/array"),require("../../features/client-control-options"),require("services/control/session-properties-event-type")),requireNotNull=require("util/require-non-null"),logger=require("util/logger").create("Session.Clients");module.exports=implements(api,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),getProperties=serviceLocator.obtain(Services.GET_SESSION_PROPERTIES),registration=serviceLocator.obtain(Services.SESSION_PROPERTIES_REGISTRATION_2);internal.getServiceRegistry().add(Services.SESSION_PROPERTIES_EVENT_2,{onRequest:function(internal,message,callback){conversationSet.respond(message.cid,message),callback.respond()}}),this.subscribe=function(session,path){var emitter=new Emitter,result=new Result(emitter);try{requireNotNull(session,"SessionID or Session Filter"),requireNotNull(path,"Topic Selector")}catch(e){return emitter.error(e),result}if(internal.checkConnected(emitter)){var selector;try{selector=parseSelector(path)}catch(e){return emitter.error(e),result}var sessionID=SessionID.validate(session);sessionID?serviceLocator.obtain(Services.SUBSCRIBE_CLIENT).send({sessionID:sessionID,selector:selector},function(err,result){err?emitter.error(err):emitter.emit("complete")}):serviceLocator.obtain(Services.FILTER_SUBSCRIBE).send({filter:session,selector:selector},function(err,result){err?emitter.error(err):result.isSuccess()?emitter.emit("complete",result.selected):emitter.error(result.errors)})}return result},this.unsubscribe=function(session,path){var emitter=new Emitter,result=new Result(emitter);try{requireNotNull(session,"SessionID or Session Filter"),requireNotNull(path,"Topic Selector")}catch(e){return emitter.error(e),result}if(internal.checkConnected(emitter)){var selector;try{selector=parseSelector(path)}catch(e){return emitter.error(e),result}var sessionID=SessionID.validate(session);sessionID?serviceLocator.obtain(Services.UNSUBSCRIBE_CLIENT).send({sessionID:sessionID,selector:selector},function(err,result){err?emitter.error(err):emitter.emit("complete")}):serviceLocator.obtain(Services.FILTER_UNSUBSCRIBE).send({filter:session,selector:selector},function(err,result){err?emitter.error(err):result.isSuccess()?emitter.emit("complete",result.selected):emitter.error(result.errors)})}return result},this.getSessionProperties=function(sid,propertyKeys){var emitter=new Emitter,result=new Result(emitter);return"string"==typeof sid&&(sid=SessionID.fromString(sid)),internal.checkConnected(emitter)&&getProperties.send({sessionID:sid,propertyKeys:propertyKeys},function(err,result){err?emitter.error(err):null===result?emitter.error(new Error("Invalid session ID")):emitter.emit("complete",sid,result.properties)}),result},this.setSessionPropertiesListener=function(requiredProperties,handler){var emitter=new Emitter,result=new Result(emitter);if(handler||emitter.error(new Error("Session Properties listener is null or undefined")),internal.checkConnected(emitter)){logger.debug("Adding Session Properties Listener");var adapter={active:function(close){logger.debug("Session Properties Listener active"),handler.onActive(close)},respond:function(message){for(var i=0;i<message.events.length;++i){var event=message.events[i];switch(event.type){case SessionPropertiesEventType.OPEN:handler.onSessionOpen(event.sessionId,event.oldProperties);break;case SessionPropertiesEventType.UPDATE:handler.onSessionEvent(event.sessionId,event.updateType,event.newProperties,event.oldProperties);break;case SessionPropertiesEventType.CLOSE:handler.onSessionClose(event.sessionId,event.oldProperties,event.closeReason);break;default:logger.debug("Unknown event type received for session properties listener",event.type)}}},close:function(err){logger.debug("Session Properties Listener closed"),err?handler.onError(err):handler.onClose()}},cid=conversationSet.new(responseHandler(internal,adapter,function(cid,callback){registration.send({cid:cid},callback)}));registration.send({cid:cid,properties:requiredProperties},registrationCallback(conversationSet,cid,emitter))}return result}})},{"../../features/client-control":49,"../../features/client-control-options":48,"control/registration":82,"events/emitter":103,"events/result":104,"services/control/session-properties-event-type":189,"services/services":221,"session/session-id":255,"topics/topic-selector-parser":268,"util/array":277,"util/interface":280,"util/logger":281,"util/require-non-null":286}],107:[function(require,module,exports){function createSendOptions(options){return options=options||{},options.headers=options.headers||[],options.priority=options.priority||0,options}function MessageStream(e,selector){this.selector=selector,e.assign(this)}function parseSessionId(str){try{var sid=SessionId.fromString(str);return sid}catch(err){return!1}}var topicSelectorParser=require("topics/topic-selector-parser"),implements=require("util/interface").implements,CommandError=require("services/command-error"),Services=require("services/services"),ConversationId=require("conversation/conversation-id"),SessionId=require("session/session-id"),ControlGroup=require("control/control-group"),registration=require("control/registration"),Emitter=require("events/emitter"),Result=require("events/result"),api=require("../../features/messages"),arrays=require("util/array"),logger=require("util/logger").create("Session.Messages"),dummyCID=ConversationId.fromString("0");module.exports=implements(api,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),sender=serviceLocator.obtain(Services.SEND),sessionSender=serviceLocator.obtain(Services.SEND_TO_SESSION),filterSender=serviceLocator.obtain(Services.SEND_TO_FILTER),streams=[];internal.getServiceRegistry().add(Services.SEND,{onRequest:function(internal,message,callback){var received=!1;streams.forEach(function(stream){stream.l.selector.selects(message.path)&&(stream.e.emit("message",message),received=!0)}),received?callback.respond():(logger.info("No messaging streams registered for message on path: "+message.path),callback.fail(new CommandError(CommandError.ErrorType.COMMUNICATION_FAILURE,"Session "+internal.getSessionId()+"has no registered streams for message sent to: "+message.path)))}}),internal.getServiceRegistry().add(Services.SEND_RECEIVER_CLIENT,{onRequest:function(internal,message,callback){callback.respond(),conversationSet.respond(message.cid,message)}}),this.addHandler=function(path,handler,keys){var emitter=new Emitter,result=new Result(emitter);if(!path)return emitter.error(new Error("Message Handler path is null or undefined")),result;if(!handler)return emitter.error(new Error("Message Handler is null or undefined")),result;if(internal.checkConnected(emitter)){logger.debug("Adding message handler",path);var params={definition:Services.SEND_RECEIVER_CLIENT,group:ControlGroup.DEFAULT,path:path,keys:void 0!==keys?keys:{}},adapter={active:function(close){logger.debug("Message handler active",path),handler.onActive(close)},respond:function(response){logger.debug("Message handler response",path);var message={session:response.sender.toString(),content:response.message,options:response.options,path:response.path},properties=response.sessionProperties;return properties&&Object.keys(properties).length>0&&(message.properties=properties),handler.onMessage(message),!1},close:function(){logger.debug("Message handler closed",path),handler.onClose()}};return registration.registerMessageHandler(internal,params,adapter)}return result},this.listen=function(path,cb){var emitter=new Emitter((void 0),(void 0),["message"]),selector=topicSelectorParser(path),stream=new MessageStream(emitter,selector),ref={l:stream,e:emitter};return stream.on("close",function(){arrays.remove(streams,ref)}),cb&&cb instanceof Function&&stream.on("message",cb),streams.push(ref),stream},this.send=function(path,message,options,recipient){var emitter=new Emitter,result=new Result(emitter),sendCallback=function(err,result){err?(logger.debug("Message send failed",path),emitter.error(err)):(logger.debug("Message send complete",path),result?emitter.emit("complete",{path:path,recipient:recipient,sent:result.sent,errors:result.errors}):emitter.emit("complete",{path:path,recipient:recipient}))};if(options&&("string"==typeof options||options instanceof SessionId)?(recipient=options,options=createSendOptions()):options=createSendOptions(options),internal.checkConnected(emitter)){if(!path)return emitter.error(new Error("Message path is null or undefined")),result;if(void 0===message||null===message)return emitter.error(new Error("Message content is null or undefined")),result;var request;if(recipient){var session="string"==typeof recipient?parseSessionId(recipient):recipient;session?(request={path:path,content:message,session:session,options:options,cid:dummyCID},logger.debug("Sending message to session",request),sessionSender.send(request,sendCallback)):(request={path:path,content:message,filter:recipient,options:options,cid:dummyCID},logger.debug("Sending message to filter",request),filterSender.send(request,sendCallback))}else request={path:path,content:message,options:options},logger.debug("Sending message to server",request),sender.send(request,sendCallback)}return result}})},{"../../features/messages":50,"control/control-group":81,"control/registration":82,"conversation/conversation-id":84,"events/emitter":103,"events/result":104,"services/command-error":166,"services/services":221,"session/session-id":255,"topics/topic-selector-parser":268,"util/array":277,"util/interface":280,"util/logger":281}],108:[function(require,module,exports){var CHANGE_PRINCIPAL=require("services/services").CHANGE_PRINCIPAL,GET_SECURITY_CONFIGURATION=require("services/services").GET_SECURITY_CONFIGURATION,UPDATE_SECURITY_CONFIGURATION=require("services/services").UPDATE_SECURITY_CONFIGURATION,GET_SYSTEM_AUTHENTICATION=require("services/services").GET_SYSTEM_AUTHENTICATION,UPDATE_SYSTEM_AUTHENTICATION=require("services/services").UPDATE_SYSTEM_AUTHENTICATION,Emitter=require("events/emitter"),Result=require("events/result"),SecurityCommandScript=require("services/authentication/security-command-script"),SecurityScriptBuilder=(require("services/authentication/security-command-script-result"),require("features/security/security-script-builder")),AuthenticationScriptBuilder=require("features/security/system-authentication-script-builder"),implements=require("util/interface").implements,api=require("../../features/security"),requireNonNull=require("util/require-non-null"),log=require("util/logger").create("Session.Security"),GlobalPermission={AUTHENTICATE:0,VIEW_SESSION:1,MODIFY_SESSION:2,REGISTER_HANDLER:3,VIEW_SERVER:4,CONTROL_SERVER:5,VIEW_SECURITY:6,MODIFY_SECURITY:7},TopicPermission={READ_TOPIC:0,UPDATE_TOPIC:1,MODIFY_TOPIC:2,SEND_TO_MESSAGE_HANDLER:3,SEND_TO_SESSION:4,SELECT_TOPIC:5},SecurityConfiguration=implements(api.SecurityConfiguration,{__constructor:function(anonymous,named,roles){this.anonymous=anonymous,this.named=named,this.roles=roles},toString:function(){return"SecurityConfiguration [anonymous="+this.anonymous+", named="+this.named+", roles="+this.roles+"]"}}),SystemAuthentication=implements(api.SystemAuthenticationConfiguration,{__constructor:function(principals,action,roles){this.principals=principals||[],this.anonymous={action:action,roles:roles||[]}},toString:function(){return"SystemAuthenticationConfiguration [principals="+this.principals+", anonymous="+this.anonymous+"]"}});SystemAuthentication.CONNECTION_ACTION={ALLOW:{id:0,value:"allow"},DENY:{id:1,value:"deny"},ABSTAIN:{id:2,value:"abstain"},fromString:function(val){return this[val.toUpperCase()]}};var SystemPrincipal=implements(api.SystemPrincipal,{__constructor:function(name,roles){this.name=requireNonNull(name),this.roles=roles||[]},toString:function(){return"SystemPrincipal ["+this.name+", "+this.roles+"]"}}),Security=implements(api,function(internal){var changePrincipal=internal.getServiceLocator().obtain(CHANGE_PRINCIPAL),getConfiguration=internal.getServiceLocator().obtain(GET_SECURITY_CONFIGURATION),getSystemAuthentication=internal.getServiceLocator().obtain(GET_SYSTEM_AUTHENTICATION),updateSystemAuthentication=internal.getServiceLocator().obtain(UPDATE_SYSTEM_AUTHENTICATION),updateSecurityConfiguration=internal.getServiceLocator().obtain(UPDATE_SECURITY_CONFIGURATION);this.getPrincipal=function(){return internal.getPrincipal()},this.changePrincipal=function(principal,credentials){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Changing principal",principal),changePrincipal.send({principal:principal,credentials:credentials},function(err,response){err?emitter.error(err):response?(internal.setPrincipal(principal),emitter.emit("complete")):emitter.error(new Error("Unable to change principal due to authentication failure"))})),result},this.getSecurityConfiguration=function(){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Getting security configuration"),getConfiguration.send(null,function(err,response){err?emitter.error(err):emitter.emit("complete",response)})),result},this.getSystemAuthenticationConfiguration=function(){var emitter=new Emitter,result=new Result(emitter);return internal.checkConnected(emitter)&&(log.debug("Getting system authentication"),getSystemAuthentication.send(null,function(err,response){err?emitter.error(err):emitter.emit("complete",response)})),result};var updateStoreCallback=function(err,result,emitter){err?emitter.error(err):result.errors.length>0?emitter.error(result.errors):emitter.emit("complete")},updateStore=function(updater,script){var emitter=new Emitter,result=new Result(emitter);return""===script?emitter.emit("complete"):script&&"string"==typeof script?internal.checkConnected(emitter)&&updater.send(new SecurityCommandScript(script),function(err,result){updateStoreCallback(err,result,emitter)}):emitter.error(new Error("Invalid argument for script:"+script)),result};this.updateSecurityStore=function(script){return log.debug("Updating security store"),updateStore(updateSecurityConfiguration,script)},this.updateAuthenticationStore=function(script){return log.debug("Updating authentication store"),updateStore(updateSystemAuthentication,script)},this.securityScriptBuilder=function(script){return new SecurityScriptBuilder(script)},this.authenticationScriptBuilder=function(script){return new AuthenticationScriptBuilder(script)}});module.exports.GlobalPermission=GlobalPermission,module.exports.TopicPermission=TopicPermission,module.exports.Security=Security,module.exports.SystemPrincipal=SystemPrincipal,module.exports.Configuration=SecurityConfiguration,module.exports.SystemAuthentication=SystemAuthentication},{"../../features/security":51,"events/emitter":103,"events/result":104,"features/security/security-script-builder":109,"features/security/system-authentication-script-builder":110,"services/authentication/security-command-script":160,"services/authentication/security-command-script-result":158,"services/services":221,"util/interface":280,"util/logger":281,"util/require-non-null":286}],109:[function(require,module,exports){var implements=require("util/interface").implements,util=require("features/security/util"),api=require("../../../features/security"),requireNonNull=require("util/require-non-null"),permissionsToString=util.permissionsToString,quoteAndEscape=util.quoteAndEscape,rolesToString=util.rolesToString,SecurityScriptBuilder=implements(api.SecurityScriptBuilder,function(commands){commands=commands||"";var withCommand=function(command){if(commands)return new SecurityScriptBuilder(commands+"\n"+command);return new SecurityScriptBuilder(command)};this.build=function(){return commands},this.toString=function(){return"ConfigurationScriptBuilder ["+commands+"]"},this.setRolesForAnonymousSessions=function(roles){return withCommand("set roles for anonymous sessions "+rolesToString(requireNonNull(roles,"roles")))},this.setRolesForNamedSessions=function(roles){return withCommand("set roles for named sessions "+rolesToString(requireNonNull(roles,"roles")))},this.setGlobalPermissions=function(role,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.setDefaultTopicPermissions=function(role,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" default topic permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.removeTopicPermissions=function(role,path){return withCommand("remove "+quoteAndEscape(requireNonNull(role,"role"))+" permissions for topic "+quoteAndEscape(requireNonNull(path,"path")))},this.setTopicPermissions=function(role,path,permissions){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" topic "+quoteAndEscape(requireNonNull(path,"path"))+" permissions "+permissionsToString(requireNonNull(permissions,"permissions")))},this.setRoleIncludes=function(role,included){return withCommand("set "+quoteAndEscape(requireNonNull(role,"role"))+" includes "+rolesToString(requireNonNull(included,"included roles")))}});module.exports=SecurityScriptBuilder},{"../../../features/security":51,"features/security/util":111,"util/interface":280,"util/require-non-null":286}],110:[function(require,module,exports){var implements=require("util/interface").implements,util=require("features/security/util"),api=require("../../../features/security"),requireNonNull=require("util/require-non-null"),quoteAndEscape=util.quoteAndEscape,rolesToString=util.rolesToString,SystemAuthenticationScriptBuilder=implements(api.SystemAuthenticationScriptBuilder,function(commands){commands=commands||"";var withCommand=function(command){if(commands)return new SystemAuthenticationScriptBuilder(commands+"\n"+command);return new SystemAuthenticationScriptBuilder(command)};this.build=function(){return commands},this.toString=function(){return"SystemAuthenticationScriptBuilder ["+commands+"]"},this.assignRoles=function(principal,roles){return withCommand("assign roles "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+rolesToString(requireNonNull(roles,"roles")))},this.addPrincipal=function(principal,password,roles){return roles=roles||[],withCommand("add principal "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password"))+(roles.length?" "+rolesToString(roles):""))},this.setPassword=function(principal,password){return withCommand("set password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.verifyPassword=function(principal,password){return withCommand("verify password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.removePrincipal=function(principal){return withCommand("remove principal "+quoteAndEscape(requireNonNull(principal,"principal")))},this.allowAnonymousConnections=function(roles){return roles=roles||[],withCommand("allow anonymous connections "+rolesToString(roles))},this.denyAnonymousConnections=function(){return withCommand("deny anonymous connections")},this.abstainAnonymousConnections=function(){return withCommand("abstain anonymous connections")}});module.exports=SystemAuthenticationScriptBuilder},{"../../../features/security":51,"features/security/util":111,"util/interface":280,"util/require-non-null":286}],111:[function(require,module,exports){function quoteAndEscape(str){var escaped="'",i=0;if(str.indexOf("'")<0&&str.indexOf("\\")<0)escaped+=str;else for(;i<str.length;++i){var c=str[i];"'"!==c&&"\\"!==c||(escaped+="\\"),escaped+=c}return escaped+="'"}function rolesToString(roles){return"["+roles.map(quoteAndEscape).join(" ")+"]"}function permissionsToString(permissions){return"["+permissions.join(" ")+"]"}module.exports.permissionsToString=permissionsToString,module.exports.quoteAndEscape=quoteAndEscape,module.exports.rolesToString=rolesToString},{}],112:[function(require,module,exports){var implements=require("util/interface").implements,Services=require("services/services"),Emitter=require("events/emitter"),Result=require("events/result"),ControlGroup=require("control/control-group"),registerTopicHandler=require("control/registration").registerTopicHandler,updateResponseHandler=require("features/update-response-handler"),AddResult=require("services/add-topic/add-topic-failure-reason"),WillResult=require("services/wills/will-registration-result"),WillParams=require("services/wills/topic-will-parameters"),Update=(require("content/record-content/record-content"),require("update/update").Update),UniversalUpdater=require("features/topic-control/universal-updater"),ValueCache=require("features/topic-control/value-cache"),parseSelector=require("topics/topic-selector-parser"),deriveDetails=require("topics/details/topic-details").deriveDetails,util=require("metadata/util"),api=require("../../features/topic-control"),logger=require("util/logger").create("Session.Topics");module.exports=implements(api.TopicControl,function(internal){var conversationSet=internal.getConversationSet(),serviceLocator=internal.getServiceLocator(),ADD_SERVICE=serviceLocator.obtain(Services.ADD_TOPIC),REMOVE_SERVICE=serviceLocator.obtain(Services.REMOVE_TOPIC),UPDATE_SERVICE=serviceLocator.obtain(Services.UPDATE_TOPIC),TOPIC_REMOVAL=serviceLocator.obtain(Services.TOPIC_REMOVAL),TOPIC_WILL_REGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_REGISTRATION),TOPIC_WILL_DEREGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_DEREGISTRATION),UPDATE_SOURCE_REGISTRATION=serviceLocator.obtain(Services.UPDATE_SOURCE_REGISTRATION),valueCache=new ValueCache,universalUpdater=new UniversalUpdater(internal);internal.getServiceRegistry().add(Services.UPDATE_SOURCE_STATE,{onRequest:function(internal,message,callback){callback.respond(),conversationSet.respond(message.cid,{old:message.old,current:message.current})}}),internal.getServiceRegistry().add(Services.MISSING_TOPIC,{onRequest:function(internal,request,callback){conversationSet.respond(request.cid,{request:request,callback:function(val){callback.respond(val)}})}}),this.add=function(){var path,details,content,emitter=new Emitter,result=new Result(emitter);switch(arguments.length){case 1:path=arguments[0],details=deriveDetails();break;case 2:path=arguments[0],details=deriveDetails(arguments[1]),content=details.content;break;case 3:path=arguments[0],details=deriveDetails(arguments[1]),content=arguments[2];break;default:return emitter.error({id:0,reason:"Incorrect number of parameters supplied to add() function"}),result}return internal.checkConnected(emitter)&&(logger.debug("Adding topic",path),ADD_SERVICE.send({path:path,details:details,content:content},function(err,result){if(err)emitter.error(err);else switch(result.status){case 0:case 1:logger.debug("Topic add complete",path),valueCache.put(path,content),emitter.emit("complete",{topic:path,added:!0});break;case 2:result.reason===AddResult.EXISTS?(logger.debug("Topic add complete (already exists)",path),valueCache.put(path,content),emitter.emit("complete",{topic:path,added:!1})):(logger.debug("Topic add failed",path),emitter.error(result.reason));break;case 3:emitter.error({id:0,reason:"Cache failure"})}})),result},this.remove=function(path){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Removing topic",path);try{REMOVE_SERVICE.send({selector:parseSelector(path)},function(error,result){error?(logger.debug("Topic removal failed",path),emitter.error(error)):(logger.debug("Topic removal complete",path),emitter.emit("complete"))})}catch(err){logger.debug("Error parsing selector",path),emitter.error(err)}}return result},this.removeSelector=function(expression){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Removing topics",expression);try{TOPIC_REMOVAL.send({selector:parseSelector(expression)},function(err){err?(logger.debug("Topic removal failed",expression),emitter.error(err)):(logger.debug("Topic removal complete",expression),emitter.emit("complete"))})}catch(err){logger.debug("Error parsing selector",expression),emitter.error(err)}}return result},this.removeWithSession=function(path){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Registering removeWithSession",path);var params=new WillParams(path,WillParams.Will.REMOVE_TOPICS);TOPIC_WILL_REGISTRATION.send(params,function(err,result){if(err)logger.debug("removeWithSession registration failed",path),emitter.error(err);else if(result===WillResult.SUCCESS){logger.debug("removeWithSession registration complete",path);var registered=!0,dEmitter=new Emitter,dResult=new Result(dEmitter),deregister=function(){return registered&&internal.checkConnected(dEmitter)&&(logger.debug("Deregistering removeWithSession",path),TOPIC_WILL_DEREGISTRATION.send(params,function(err,result){err?dEmitter.error(err):(registered=!1,dEmitter.emit("complete",{topic:path}))})),dResult};emitter.emit("complete",{deregister:deregister})}else logger.debug("removeWithSession registration failed",path),emitter.error(new Error("REGISTRATION_CONFLICT"))})}return result},this.update=function(path,content){var emitter=new Emitter,result=new Result(emitter);if(internal.checkConnected(emitter)){logger.debug("Updating topic",path);var callback=function(error,result){error?(logger.debug("Update failed",path),emitter.error(error)):result.isError?(logger.debug("Update failed",path),emitter.error(result.reason)):(logger.debug("Update complete",path),emitter.emit("complete",path))};util.isMetadataValue(content)?UPDATE_SERVICE.send({path:path,update:new Update(content)},callback):universalUpdater.update(path,content,callback)}return result},this.registerUpdateSource=function(path,handler){var emitter=new Emitter,result=new Result(emitter),conversations=internal.getConversationSet(),cid=conversations.new(updateResponseHandler(internal,valueCache,path,handler));return internal.checkConnected(emitter)&&UPDATE_SOURCE_REGISTRATION.send({cid:cid,path:path},function(err,state){err||"closed"===state?(conversations.discard(cid,err),emitter.error(err)):(conversations.respond(cid,{old:"init",current:state}),emitter.emit("complete"))}),result},this.addMissingTopicHandler=function(path,handler){var emitter=new Emitter,result=new Result(emitter);if(!handler)return emitter.error(new Error("Missing Topic handler is null or undefined")),result;if(internal.checkConnected(emitter)){var adapter={active:function(close){logger.debug("Missing Topic Handler registered for "+path),handler.onRegister(path,close)},respond:function(response){logger.debug("Missing Topic Handler notification for "+response.request.sessionID+" using "+response.request.selector),handler.onMissingTopic({path:response.request.selector.prefix,selector:response.request.selector,sessionID:response.request.sessionID,proceed:function(){response.callback(!0)},cancel:function(){response.callback(!1)}})},close:function(err){logger.debug("Missing Topic Handler closed for "+path),err?handler.onError(path,err):handler.onClose(path)}},params={definition:Services.MISSING_TOPIC,group:ControlGroup.DEFAULT,path:path};return registerTopicHandler(internal,params,adapter)}return result}})},{"../../features/topic-control":52,"content/record-content/record-content":74,"control/control-group":81,"control/registration":82,"events/emitter":103,"events/result":104,"features/topic-control/universal-updater":113,"features/topic-control/value-cache":114,"features/update-response-handler":122,"metadata/util":134,"services/add-topic/add-topic-failure-reason":153,"services/services":221,"services/wills/topic-will-parameters":251,"services/wills/will-registration-result":253,"topics/details/topic-details":260,"topics/topic-selector-parser":268,"update/update":276,"util/interface":280,"util/logger":281}],113:[function(require,module,exports){var Services=require("services/services"),DataTypes=require("data/datatypes");module.exports=function(internal){function dataToBytes(d){return d.$buffer.slice(d.$offset,d.$length)}var SET_SERVICE=internal.getServiceLocator().obtain(Services.UPDATE_TOPIC_SET);this.update=function(topic,content,callback){var datatype=DataTypes.get(content),value=datatype.from(content);SET_SERVICE.send({path:topic,bytes:dataToBytes(value)},callback)}}},{"data/datatypes":94,"services/services":221}],114:[function(require,module,exports){var canonicalise=require("topics/topic-path-utils").canonicalise;module.exports=function(){var cache={};this.get=function(path){return cache[canonicalise(path)]},this.put=function(path,value){cache[canonicalise(path)]=value},this.remove=function(selector){for(var k in cache)selector.selects(k)&&delete cache[k]}}},{"topics/topic-path-utils":267}],115:[function(require,module,exports){var implements=require("util/interface").implements,Emitter=require("events/emitter"),View=require("features/topics/view"),Services=require("services/services"),parseSelector=require("topics/topic-selector-parser"),SubscriptionProxy=require("features/topics/subscription-proxy"),FetchStream=require("features/topics/fetch-stream"),Topics=require("../../features/topics"),requireNonNull=require("util/require-non-null"),logger=require("util/logger").create("Session");module.exports=implements(Topics,function(internal){var unsubscribe=internal.getServiceLocator().obtain(Services.UNSUBSCRIBE),subscribe=internal.getServiceLocator().obtain(Services.SUBSCRIBE),fetch=internal.getServiceLocator().obtain(Services.FETCH),streamRegistry=internal.getStreamRegistry();this.subscribe=function(topic,callback){logger.debug("Subscribing",topic);var selector=parseSelector(topic),proxy=new SubscriptionProxy(streamRegistry,selector,(!1),callback);return internal.checkConnected(proxy.emitter)&&subscribe.send(selector),proxy.subscription},this.unsubscribe=function(topic){logger.debug("Unubscribing",topic),unsubscribe.send(parseSelector(topic))},this.stream=function(topic,callback){logger.debug("Establishing topic stream",topic);var fallback=!1,selector="";topic&&"function"!=typeof topic?selector=parseSelector(topic):(callback=topic,fallback=!0);var proxy=new SubscriptionProxy(streamRegistry,selector,fallback,callback);return proxy.subscription},this.fetch=function(selector){logger.debug("Fetch request for: ",selector),requireNonNull(selector,"Selector"),selector=parseSelector(selector);var emitter=new Emitter,stream=new FetchStream(emitter);if(internal.checkConnected(emitter)){var cid=internal.getConversationSet().new({onOpen:function(cid){},onResponse:function(cid,path,content){return path?(emitter.emit("value",content,path),!1):1===content.length&&1===content[0]?(emitter.close(),!0):(emitter.error(new Error("Unexpected end of fetch stream")),!0)},onDiscard:function(err){emitter.error(err)}});fetch.send({cid:cid,selector:selector},function(err){err&&emitter.error(err)})}return stream},this.view=function(selector,callback){var s=this.subscribe(selector);return new View(s,callback)}})},{"../../features/topics":53,"events/emitter":103,"features/topics/fetch-stream":116,"features/topics/subscription-proxy":117,"features/topics/view":121,"services/services":221,"topics/topic-selector-parser":268,"util/interface":280,"util/logger":281,"util/require-non-null":286}],116:[function(require,module,exports){var implements=require("util/interface").implements,FetchStream=require("../../../events/fetch-stream");module.exports=implements(FetchStream,function(emitter){emitter.assign(this)})},{"../../../events/fetch-stream":42,"util/interface":280}],117:[function(require,module,exports){var SubscriptionImpl=require("features/topics/subscription"),Emitter=require("events/emitter");module.exports=function(registry,selector,fallback,callback){var emitter=new Emitter,stream=emitter.get(),self=this,subscription=new SubscriptionImpl(registry,stream,fallback,selector),pending=!0;stream.on("close",function(){registry.remove(self)}),this.subscription=subscription,this.emitter=emitter,this.selects=function(){return!0},this.onOpen=function(){emitter.emit("open",subscription)},this.onDelta=function(topic,details,value){emitter.emit("update",value,topic)},this.onValue=function(topic,details,value){emitter.emit("update",value,topic)},this.onSubscription=function(topic,details){emitter.emit("subscribe",details,topic)},this.onUnsubscription=function(topic,details,reason){emitter.emit("unsubscribe",reason,topic)},callback?(subscription.on("update",callback),fallback?registry.addFallback(self):registry.add(selector,self)):subscription.on=function(event,fn){return pending&&(fallback?registry.addFallback(self):registry.add(selector,self),pending=!1),stream.on.call(subscription,event,fn)}}},{"events/emitter":103,"features/topics/subscription":118}],118:[function(require,module,exports){var implements=require("util/interface").implements,Subscription=require("../../../events/subscription"),TypedSubscriptionProxy=require("features/topics/typed-subscription-proxy"),View=require("features/topics/view"),Emitter=require("events/emitter"),util=require("metadata/util");module.exports=implements(Subscription,function SubscriptionImpl(registry,stream,fallback,selector){for(var fn in stream)this[fn]=stream[fn];this.selector=selector;var self=this;this.view=function(){return new View(self)},this.asType=function(datatype,callback){var proxy=new TypedSubscriptionProxy(registry,selector,datatype,fallback,callback);return proxy.subscription},this.transform=function(fn){var e=new Emitter;return fn=util.isMetadata(fn)?fn.parse.bind(fn):fn,self.on("open",function(selector,s){e.emit("open",selector,self)}),self.on("close",function(){e.emit("close")}),self.on("update",function(update,topic){e.emit("update",fn(update),topic)}),self.on("subscribe",function(details){e.emit("subscribe",details)}),self.on("unsubscribe",function(reason,topic){e.emit("unsubscribe",reason,topic)}),new SubscriptionImpl(registry,e.get(),selector)}})},{"../../../events/subscription":45,"events/emitter":103,"features/topics/typed-subscription-proxy":119,"features/topics/view":121,"metadata/util":134,"util/interface":280}],119:[function(require,module,exports){var TypedSubscriptionImpl=require("features/topics/typed-subscription"),TopicType=require("../../../topics/topics").TopicType,Emitter=require("events/emitter");module.exports=function(registry,selector,datatype,fallback,callback){var emitter=new Emitter,stream=emitter.get(),self=this,subscription=new TypedSubscriptionImpl(registry,stream,selector),pending=!0;stream.on("close",function(){registry.remove(self)}),this.subscription=subscription,this.emitter=emitter,this.selects=function(details){if(details)return details.type===TopicType[datatype.name().toUpperCase()];return!1},this.onOpen=function(){emitter.emit("open",subscription)},this.onDelta=function(topic,details,received,delta,oldValue,newValue){emitter.emit("value",topic,details,newValue,oldValue)},this.onValue=function(topic,details,received,oldValue,newValue){emitter.emit("value",topic,details,newValue,oldValue)},this.onSubscription=function(topic,details){emitter.emit("subscribe",topic,details)},this.onUnsubscription=function(topic,details,reason){emitter.emit("unsubscribe",topic,details,reason)},callback?(subscription.on("value",callback),fallback?registry.addFallback(self):registry.add(selector,self)):subscription.on=function(event,fn){return pending&&(fallback?registry.addFallback(self):registry.add(selector,self),pending=!1),stream.on.call(subscription,event,fn)}}},{"../../../topics/topics":299,"events/emitter":103,"features/topics/typed-subscription":120}],120:[function(require,module,exports){var implements=require("util/interface").implements,TypedSubscription=(require("features/topics/typed-subscription-proxy"),require("../../../events/typed-subscription"));module.exports=implements(TypedSubscription,function(registry,stream,selector){for(var fn in stream)this[fn]=stream[fn];this.selector=selector})},{"../../../events/typed-subscription":46,"features/topics/typed-subscription-proxy":119,"util/interface":280}],121:[function(require,module,exports){function ViewImpl(subscription){var emitter=Emitter.assign(this),data={};subscription.on("update",function(value,topic){for(var parts=topic.split("/"),child=data,i=0;i<parts.length-1;i++)void 0===child[parts[i]]&&(child[parts[i]]={}),child=child[parts[i]];child[parts[i]]=value,emitter.emit("update",data)}),subscription.on("unsubscribe",function(reason,topic){if(2===reason.id){for(var parts=topic.split("/"),child=data,i=0;i<parts.length-1&&void 0!==child[parts[i]];i++)child=child[parts[i]];delete child[parts[i]],emitter.emit("update",data)}}),subscription.on("close",emitter.close),this.get=function(){return data}}var implements=require("util/interface").implements,Emitter=require("events/emitter"),View=require("../../../events/view");module.exports=implements(View,ViewImpl)},{"../../../events/view":47,"events/emitter":103,"util/interface":280}],122:[function(require,module,exports){function dataToBytes(d){return d.$buffer.slice(d.$offset,d.$length)}function clearCache(cache,path){var selector=parseSelector("?"+canonicalise(path)+"//");cache.remove(selector)}function Updater(cid,dispatch){var self=this;this.isClosed=!1,this.update=function(topic,value){var emitter=new Emitter,result=new Result(emitter);return self.isClosed?emitter.error(new Error("Updater is closed")):topic?void 0===value||null===value?emitter.error(new Error("Update cannot be null")):dispatch(emitter,cid,topic,value):emitter.error(new Error("Topic can not be null or empty")),result}}var parseSelector=require("topics/topic-selector-parser"),canonicalise=require("topics/topic-path-utils").canonicalise,Services=require("services/services"),DataTypes=require("data/datatypes"),Emitter=require("events/emitter"),Result=require("events/result"),Update=require("update/update"),util=require("metadata/util");module.exports=function(internal,valueCache,topic,handler){var close,updater,UPDATE_SOURCE_DEREGISTRATION=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_DEREGISTRATION),UPDATE_SOURCE_UPDATE=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_UPDATE),UPDATE_SOURCE_DELTA=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_DELTA),UPDATE_SOURCE_SET=internal.getServiceLocator().obtain(Services.UPDATE_SOURCE_SET),dispatch=function(emitter,cid,path,content){var callback=function(err,result){err?emitter.error(err):result.error?emitter.error(new Error("Topic update error for topic "+path+" : "+result.error)):emitter.emit("complete")};if(internal.checkConnected(emitter))if(util.isMetadataValue(content))UPDATE_SOURCE_UPDATE.send({cid:cid,path:path,update:new Update.Update(content)},callback);else{var datatype=DataTypes.get(content),value=datatype.from(content),prev=valueCache.get(path);if(prev){var deltaType=datatype.deltaType("binary"),delta=deltaType.diff(prev,value);if(delta===deltaType.noChange())return void callback(null,{});UPDATE_SOURCE_DELTA.send({id:0,cid:cid,path:path,bytes:dataToBytes(delta)},callback)}else UPDATE_SOURCE_SET.send({cid:cid,path:path,bytes:dataToBytes(value)},callback);valueCache.put(path,value)}},state="init";return{onOpen:function(cid){close=function(){var emitter=new Emitter,result=new Result(emitter);return UPDATE_SOURCE_DEREGISTRATION.send({cid:cid},function(err){err?(internal.getConversationSet().discard(cid,err),emitter.error(err)):(internal.getConversationSet().respond(cid,{old:state,current:"closed"}),emitter.emit("complete"))}),result}},onResponse:function(cid,change){if(change.old!==state)throw new Error("Inconsistent server/client update source state");switch("init"===state&&"closed"!==change.current&&handler.onRegister(topic,close),updater&&(updater.isClosed=!0),state=change.current){case"active":return updater=new Updater(cid,dispatch),clearCache(valueCache,topic),handler.onActive(topic,updater),!1;case"standby":return handler.onStandBy(topic),!1;default:return clearCache(valueCache,topic),handler.onClose(topic),!0}},onDiscard:function(cid,reason){state="closed",updater&&(updater.isClosed=!0),clearCache(valueCache,topic),handler.onClose(topic,reason)}}}},{"data/datatypes":94,"events/emitter":103,"events/result":104,"metadata/util":134,"services/services":221,"topics/topic-path-utils":267,"topics/topic-selector-parser":268,"update/update":276}],123:[function(require,module,exports){function BufferInputStream(buffer){if(null===buffer||void 0===buffer)throw new Error("Undefined buffer for InputStream");this.buffer=buffer,this.count=buffer.length,this.mark=0,this.pos=0}var Long=require("long");BufferInputStream.prototype.read=function(){return this.pos<this.count?255&this.buffer[this.pos++]:-1},BufferInputStream.prototype.readMany=function(length){if(length=Math.min(length,this.count-this.pos),length<0)throw new Error("Length out of bounds");var buffer=this.buffer.slice(this.pos,this.pos+length);return this.pos+=length,buffer},BufferInputStream.prototype.readUntil=function(delim){for(var found=this.count,i=this.pos;i<this.count;i++)if(this.buffer[i]===delim){found=i;break}var buffer=this.buffer.slice(this.pos,found);return found===this.count?this.pos=found:this.pos=found+1,buffer},BufferInputStream.prototype.readInt8=function(){return this.buffer.readInt8(this.pos++)},BufferInputStream.prototype.readInt32=function(){var i=this.buffer.readInt32BE(this.pos);return this.pos+=4,i},BufferInputStream.prototype.readInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!1)},BufferInputStream.prototype.readUInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!0)},BufferInputStream.prototype.hasRemaining=function(){return this.pos<this.buffer.length},module.exports=BufferInputStream},{long:11}],124:[function(require,module,exports){(function(Buffer){function ensureCapacity(bos,min){min-bos.buffer.length>0&&grow(bos,min)}function grow(bos,minCapacity){var oldCapacity=bos.buffer.length,newCapacity=oldCapacity<<1;newCapacity-minCapacity<0&&(newCapacity=minCapacity);try{var replacement=new Buffer(newCapacity);bos.buffer.copy(replacement),bos.buffer=replacement}catch(e){throw new Error("Unable to resize BufferOutputStream to "+newCapacity)}}function BufferOutputStream(initial){Buffer.isBuffer(initial)?(this.buffer=initial,this.count=initial.length):(this.buffer=new Buffer(initial||32),this.count=0)}BufferOutputStream.prototype.write=function(val){ensureCapacity(this,this.count+1),this.buffer[this.count++]=val},BufferOutputStream.prototype.writeMany=function(buffer,offset,length){offset=offset||0,length=length||buffer.length,ensureCapacity(this,this.count+length),buffer.copy(this.buffer,this.count,offset,offset+length),this.count+=length},BufferOutputStream.prototype.writeString=function(val){var length=Buffer.byteLength(val);ensureCapacity(this,this.count+length),this.buffer.write(val,this.count,length),this.count+=length},BufferOutputStream.prototype.writeInt8=function(val){ensureCapacity(this,this.count+1),this.buffer.writeInt8(val,this.count++)},BufferOutputStream.prototype.writeInt32=function(val){ensureCapacity(this,this.count+4),this.buffer.writeInt32BE(val,this.count),this.count+=4},BufferOutputStream.prototype.writeInt64=function(val){ensureCapacity(this,this.count+8),this.buffer.writeInt32BE(val.getHighBits(),this.count),this.buffer.writeInt32BE(val.getLowBits(),this.count+4),this.count+=8},BufferOutputStream.prototype.getBuffer=function(){return this.buffer.slice(0,this.count)},BufferOutputStream.prototype.getBase64=function(){return this.getBuffer().toString("base64")},module.exports=BufferOutputStream}).call(this,require("buffer").Buffer)},{buffer:2}],125:[function(require,module,exports){(function(Buffer){var Long=require("long"),x80=Long.fromNumber(128),x7F=Long.fromNumber(127),x7FInv=x7F.not(),readOneByte=function(input){var i=input.read();if(i===-1)throw new Error("End of stream");return i},codec={};codec.readInt64=function(input){for(var result=Long.fromNumber(0),shift=0;shift<64;){var i=readOneByte(input),l=Long.fromNumber(i);if(result=result.or(l.and(x7F).shiftLeft(shift)),l.and(x80).equals(0))return result;shift+=7}throw"Malformed int64"},codec.writeInt64=function(bos,value){for(var int64=value instanceof Long?value:Long.fromNumber(value,!1);;){if(int64.and(x7FInv).equals(0))return void bos.write(int64.toInt());bos.write(int64.and(x7F).or(x80).toInt()),int64=int64.shiftRightUnsigned(7)}},codec.readInt32=function(bis){for(var shift=0,result=0;shift<32;){var i=readOneByte(bis);if(result|=(127&i)<<shift,0===(128&i))return result;shift+=7}throw"Malformed int32"},codec.writeInt32=function(bos,value){for(;;){if(0===(value&-128))return void bos.write(value);bos.write(127&value|128),value>>>=7}},codec.writeByte=function(bos,value){bos.writeInt8(value),0!==(value&-128)&&bos.write(1)},codec.readByte=function(bis){var b1=bis.readInt8();if(0===(b1&-128))return b1;var b2=readOneByte(bis);if(1!==b2)throw"Malformed byte";return 128|b1},codec.readBytes=function(bis){var length=codec.readInt32(bis);return bis.readMany(length)},codec.writeBytes=function(bos,value){codec.writeInt32(bos,value.length),bos.writeMany(value)},codec.readString=function(bis){var buffer=codec.readBytes(bis);return buffer?buffer.toString("utf8"):""},codec.writeString=function(bos,value){codec.writeBytes(bos,new Buffer(value,"utf8"))},codec.writeCollection=function(bos,arr,write){codec.writeInt32(bos,arr.length);for(var i=0;i<arr.length;++i)write(bos,arr[i])},codec.readCollection=function(bis,read){for(var length=codec.readInt32(bis),arr=[],i=0;i<length;++i)arr.push(read(bis));return arr},codec.readDictionary=function(bis,read){for(var length=codec.readInt32(bis),dict={},i=0;i<length;++i){var k=codec.readString(bis);dict[k]=read(bis)}return dict},codec.writeDictionary=function(bos,dict,write){codec.writeInt32(bos,Object.keys(dict).length);for(var k in dict)codec.writeString(bos,k),write(bos,dict[k])},codec.readBoolean=function(bis){var b=bis.readInt8();if(0===b)return!1;return!0},codec.writeBoolean=function(bos,value){value?bos.writeInt8(1):bos.writeInt8(0)},module.exports=codec}).call(this,require("buffer").Buffer)},{buffer:2,long:11}],126:[function(require,module,exports){function roundTimeStamp(timestamp){return timestamp>>TIMESTAMP_ROUNDING}function mask(p,capacity){return p&capacity-1}var findNextPowerOfTwo=require("util/math").findNextPowerOfTwo,curryR=require("util/function").curryR,ofSize=require("util/array").ofSize,fill=require("util/array").fill,TIMESTAMP_ROUNDING=10;module.exports=function(minimumMessages,minimumTimeIndex){function removeElements(newElementsHead){var newSize,messagesHead=messagesMask(tail-size);messagesHead<newElementsHead?(fill(messages,null,messagesHead,newElementsHead),newSize=size-newElementsHead+messagesHead):messagesHead>newElementsHead?(fill(messages,null,messagesHead,messagesLength),fill(messages,null,0,newElementsHead),newSize=size-messagesHead+newElementsHead):(fill(messages,null),newSize=0),size=newSize}var messagesLength=findNextPowerOfTwo(minimumMessages),indexCapacity=findNextPowerOfTwo(minimumTimeIndex),messagesMask=curryR(mask,messagesLength),indexMask=curryR(mask,indexCapacity),messages=ofSize(messagesLength),indices=ofSize(indexCapacity,-1),times=ofSize(indexCapacity),timesHead=0,timesTail=0,tail=messagesMask(0),size=0;this.size=function(){return size},this.put=function(message){if(messages[tail]=message,tail=messagesMask(tail+1),size<messagesLength)size+=1;else for(;indices[timesHead]===tail;)indices[timesHead]=-1,timesHead=indexMask(timesHead+1)},this.recover=function(n,consumer){if(n<0||n>size)return!1;for(var i=n;i>=1;--i)consumer(messages[messagesMask(tail-i)]);return!0},this.clear=function(){fill(messages,null),fill(indices,-1),timesHead=0,timesTail=0,size=0},this.markTime=function(timestamp){if(size>0){var h=timesHead,t=timesTail,firstIndex=indices[h],roundedTimestamp=roundTimeStamp(timestamp);if(firstIndex>=0){var indexLast=indexMask(t-1);if(indices[indexLast]===tail)return;if(times[indexLast]===roundedTimestamp)return void(indices[indexLast]=tail)}timesTail=indexMask(t+1),times[t]=roundedTimestamp,indices[t]=tail,h===t&&firstIndex>=0&&(removeElements(firstIndex),timesHead=timesTail)}},this.flush=function(timestamp){if(0===size||indices[timesHead]<0)return;var i=timesTail,roundedTimestamp=roundTimeStamp(timestamp);do{var previousI=i;if(i=indexMask(i-1),times[i]<=roundedTimestamp)return removeElements(indices[i]),timesHead<=previousI?fill(indices,-1,timesHead,previousI):(fill(indices,-1,timesHead,indexCapacity),fill(indices,-1,0,previousI)),void(timesHead=previousI)}while(i!==timesHead)}}},{"util/array":277,"util/function":279,"util/math":282}],127:[function(require,module,exports){module.exports=function(val,scale){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Decimal metadata must be given a numeric default value");if(void 0!==scale&&"number"!=typeof scale)throw new Error("Decimal metadata must be given a numeric scale");if(this.value=val||0,void 0===scale){var str=this.value+"",i=str.indexOf(".");this.scale=i>-1?str.length-(i+1):2}else this.scale=scale;this.getDetails=function(){return{type:"decimalString",name:"decimalString",default:self.value,scale:self.scale}},this.parse=function(buffer){var str=buffer.toString(),i=str.indexOf(".");return+str.substr(0,i+this.scale+1)}}},{}],128:[function(require,module,exports){module.exports=function(val){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Integer metadata must be given a numeric default value");this.value=parseInt(val,10)||0,this.getDetails=function(){return{type:"integerString",name:"integerString",default:self.value}},this.parse=function(buffer){return parseInt(buffer.toString(),10)}}},{}],129:[function(require,module,exports){var MRecordContent=(require("util/interface").implements,require("../../metadata/metadata"),require("./record-content")),MStateless=require("./stateless"),MDecimal=require("./decimal"),MInteger=require("./integer"),MString=require("./string");module.exports={RecordContent:MRecordContent,Stateless:MStateless,Decimal:MDecimal,Integer:MInteger,String:MString}},{"../../metadata/metadata":54,"./decimal":127,"./integer":128,"./record-content":130,"./stateless":131,"./string":132,"util/interface":280}],130:[function(require,module,exports){function occurs(m,n){var min=1,max=1;if(void 0!==m){if("string"==typeof m){var i=m.indexOf(".");if(i!==-1){var j=m.lastIndexOf(".");min=m.substring(0,i),max=m.substring(j+1),"*"===max&&(max=-1)}else min=m,max=m}else"number"==typeof m?(min=m,max=void 0!==n&&"number"==typeof n?n:m):void 0!==m.min&&(min=m.min,max=m.max);void 0===max&&(max=min),min=parseInt(min,10),max=parseInt(max,10)}return{min:min,max:max,toString:function(){var min=this.min,max=this.max>-1?this.max:"*";return min===max?""+min:min+".."+max}}}var implements=require("util/interface").implements,Metadata=require("../../metadata/metadata"),RecordContentParser=require("content/structured-record-content/parser"),RecordContentBuilder=require("content/structured-record-content/builder"),MDecimal=require("./decimal"),MInteger=require("./integer"),MString=require("./string"),util=require("./util-single-value"),count=0,MFieldImpl=implements(Metadata.RecordContent.Field,function(name,type,occurs){if(this.name=name,this.occurs=occurs,type){var t=util.deriveMetadata(type);if(util.getType(t)!==util.Type.SINGLE_VALUE)throw new Error("Record fields can only have single values (string, integer or decimal)");this.type=t}else this.type=new MString;this.getDetails=function(){var details=this.type.getDetails();return details.name=name,details.multiplicity=occurs.toString(),details}}),MRecordImpl=implements(Metadata.RecordContent.Record,function(name,m){var fields={},order=[];this.name=name,this.occurs=m,this.getField=function(name){switch(typeof name){case"string":return fields[name];case"number":return fields[order[name]]}return},this.getFields=function(){return order.map(function(name){return fields[name]})},this.addField=function(name,type,m){if(fields[name])throw new Error("Field metadata already exists for: "+name);var previous=fields[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Fields cannot be added after a repeating field");var field=new MFieldImpl(name,type,occurs(m));return fields[name]=field,order.push(name),field},this.getDetails=function(){return{name:name,multiplicity:m.toString()}}}),MRecordContentImpl=implements(Metadata.RecordContent,function(name){var parser=new RecordContentParser(this),self=this,records={},order=[];name=name||"MRecordData"+count++,this.addRecord=function(name,m,fields){if(records[name])throw new Error("Record metadata already exists for: "+name);var previous=records[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Records cannot be added after a repeating record");var record=new MRecordImpl(name,occurs(m));if(records[name]=record,order.push(name),void 0!==fields)for(var field in fields)record.addField(field,fields[field]);return record},this.getRecord=function(name){switch(typeof name){case"string":return records[name];case"number":return records[order[name]]}return},this.getRecords=function(){return order.map(function(name){return records[name]})},this.occurs=occurs,this.name=name,this.string=function(val){return new MString(val)},this.integer=function(val){return new MInteger(val)},this.decimal=function(val,scale){return new MDecimal(val,scale)},this.getDetails=function(){return{name:name}},this.builder=function(){return new RecordContentBuilder(self)},this.parse=function(buffer){return parser.parse(buffer)}});module.exports=MRecordContentImpl},{"../../metadata/metadata":54,"./decimal":127,"./integer":128,"./string":132,"./util-single-value":133,"content/structured-record-content/builder":76,"content/structured-record-content/parser":77,"util/interface":280}],131:[function(require,module,exports){var details={type:"stateless",name:"stateless"};module.exports=function(){this.getDetails=function(){return details},this.parse=function(buffer){return buffer}}},{}],132:[function(require,module,exports){module.exports=function(val){var self=this;this.value=void 0===val?"":""+val,this.getDetails=function(){return{type:"string",name:"string",default:self.value}},this.parse=function(buffer){return buffer.toString()}}},{}],133:[function(require,module,exports){function createFromSingleValue(value){switch(typeof value){case"string":return new MString(value);case"number":var str=""+value,i=str.indexOf(".");return i>-1?new MDecimal(value,str.length-(i+1)):new MInteger(value)}throw new Error("Invalid Single Value type",value)}function getType(metadata){if(metadata instanceof MDecimal||metadata instanceof MInteger||metadata instanceof MString)return Type.SINGLE_VALUE;if(metadata instanceof MStateless)return Type.STATELESS;throw new Error("Unknown metadata type")}function isMetadata(value){return value instanceof MStateless||value instanceof MDecimal||value instanceof MInteger||value instanceof MString}function isMetadataValue(value){return isMetadata(value)||"string"==typeof value||"number"==typeof value||"boolean"==typeof value||void 0===value}function deriveMetadata(value){if(void 0===value)return new MStateless;if(isMetadata(value))return value;return createFromSingleValue(value)}var MStateless=require("./stateless"),MDecimal=require("./decimal"),MInteger=require("./integer"),MString=require("./string"),Type=require("../../topics/topics").TopicType;module.exports={Type:Type,getType:getType,isMetadata:isMetadata,isMetadataValue:isMetadataValue,deriveMetadata:deriveMetadata}},{"../../topics/topics":299,"./decimal":127,"./integer":128,"./stateless":131,"./string":132}],134:[function(require,module,exports){function getType(metadata){return MRecordContent.isPrototypeOf(metadata)?Type.RECORD:util.getType(metadata)}function isMetadata(value){return MRecordContent.isPrototypeOf(value)||util.isMetadata(value)}function isMetadataValue(value){return MRecordContent.isPrototypeOf(value)||util.isMetadataValue(value)||cutil.isRecordContent(value)}function deriveMetadata(value){if(isMetadata(value))return value;return util.deriveMetadata(value)}var Type=require("../../topics/topics").TopicType,util=require("./util-single-value"),cutil=require("content/util"),MRecordContent=require("./record-content");module.exports={Type:Type,getType:getType,isMetadata:isMetadata,isMetadataValue:isMetadataValue,deriveMetadata:deriveMetadata}},{"../../topics/topics":299,"./record-content":130,"./util-single-value":133,"content/util":79}],135:[function(require,module,exports){function createConnectionRequest(){return{type:consts.TYPE,version:consts.CURRENT_VERSION,capabilities:consts.CAPABILITIES}}function createReconnectionRequest(token,availableClientSequence,lastServerSequence){var req=createConnectionRequest();return req.token=token,req.availableClientSequence=availableClientSequence,req.lastServerSequence=lastServerSequence,req}var consts=require("protocol/consts");module.exports={connect:createConnectionRequest,reconnect:createReconnectionRequest}},{"protocol/consts":137}],136:[function(require,module,exports){function deserialise(buffer){var input=new BufferInputStream(buffer),protocol=input.read();if(protocol!==consts.PROTOCOL_BYTE)throw new Error("Unrecognised protocol byte: "+protocol);var version=input.read();if(version<consts.CURRENT_VERSION)throw new Error("Unrecognised protocol version: "+version);if(version>consts.CURRENT_VERSION)throw new Error("Unsupported protocol version: "+version);var responseCode=BEES.read(input,ResponseCode);if(ResponseCode.isSuccess(responseCode)){var sessionID=new SessionId(input.readUInt64(),input.readUInt64()),sessionToken=SessionTokenDeserialiser(input),systemPingPeriod=input.readInt64(),recoverySequence=0;return responseCode===ResponseCode.RECONNECTED&&(recoverySequence=input.readInt32()),{response:responseCode,identity:sessionID,token:sessionToken,systemPingPeriod:systemPingPeriod,version:version,success:!0,sequence:recoverySequence}}return{response:responseCode,version:version,identity:null,token:null,systemPingPeriod:null,success:!1,sequence:0}}var BufferInputStream=require("io/buffer-input-stream"),BEES=require("serialisers/byte-encoded-enum-serialiser"),SessionId=require("session/session-id"),SessionTokenDeserialiser=require("session/session-token-deserialiser"),ResponseCode=require("protocol/response-code"),consts=require("protocol/consts");module.exports=deserialise},{"io/buffer-input-stream":123,"protocol/consts":137,"protocol/response-code":138,"serialisers/byte-encoded-enum-serialiser":151,"session/session-id":255,"session/session-token-deserialiser":257}],137:[function(require,module,exports){module.exports={TYPE:"WB",CAPABILITIES:8,PROTOCOL_BYTE:35,CURRENT_VERSION:9}},{}],138:[function(require,module,exports){function code(id,message){return{id:id,message:message}}var ResponseCode={OK:code(100,"Connected successfully"),DOWNGRADE:code(102,"Server does not support the requested protocol level"),RECONNECTED:code(105,"Reconnected successfully"),RECONNECTED_WITH_MESSAGE_LOSS:code(106,"Reconnected with message loss"),REJECTED:code(111,"Connection rejected"),CONNECTION_UNSUPPORTED:code(112,"Connection type not supported by connector"),LICENSE_EXCEEDED:code(113,"Connection rejected due to license limit"),RECONNECTION_UNSUPPORTED:code(114,"Reconnection not supported by connector"),CONNECTION_PROTOCOL_ERROR:code(115,"Connection failed - protocol error"),AUTHENTICATION_FAILED:code(116,"Connection failed - authentication failed"),UNKNOWN_SESSION:code(117,"Reconnection failed - the session is unknown"),RECONNECTION_FAILED_MESSAGE_LOSS:code(118,"Reconnection failed due to message loss"),ERROR:code(127,"Connection failed due to server error")};ResponseCode.isSuccess=function(code){switch(code){case ResponseCode.OK:case ResponseCode.RECONNECTED:case ResponseCode.RECONNECTED_WITH_MESSAGE_LOSS:return!0;default:return!1}},module.exports=ResponseCode},{}],139:[function(require,module,exports){var HashMap=require("hashmap"),Arrays=require("util/array");module.exports=function(topicCache){var streams=new HashMap,fallbacks=[],self=this;this.add=function(selector,stream){var existing=streams.get(selector);existing?existing.push(stream):streams.set(selector,[stream]),topicCache.newStream(selector,stream,self),stream.onOpen()},this.addFallback=function(stream){fallbacks.push(stream)},this.getFallbacks=function(details){return fallbacks.filter(function(fallback){return fallback.selects(details)})},this.remove=function(stream){Arrays.remove(fallbacks,stream),streams.forEach(function(existing,selector){Arrays.remove(existing,stream)&&topicCache.removeStream(stream,self),0===existing.length&&streams.remove(selector)})},this.streamsFor=function(topic,details){var combined=[];return streams.count()>0&&streams.forEach(function(existing,selector){selector.selects(topic)&&(combined=combined.concat(existing.filter(function(stream){return stream.selects(details)})))}),combined}}},{hashmap:8,"util/array":277}],140:[function(require,module,exports){var TopicCacheEntry=require("routing/topic-cache-entry");module.exports=function(details,streams,datatype){TopicCacheEntry.call(this,details,streams);var value,deltaType=datatype.deltaType("binary");this.handleValue=function(received,registry,errorHandler){var oldValue=value;try{value=datatype.readValue(received),this.notifyValue(received,oldValue,value,registry)}catch(e){errorHandler(e)}},this.handleDelta=function(received,registry,errorHandler){var oldValue=value;try{var delta=deltaType.readDelta(received);value=deltaType.apply(oldValue,delta),this.notifyDelta(received,delta,oldValue,value,registry)}catch(e){errorHandler(e)}},this.notifyValueToNewStream=function(path,details,stream){value&&stream.onValue(path,details,value.$buffer,null,value)}}},{"routing/topic-cache-entry":141}],141:[function(require,module,exports){var UnsubscribeReason=require("../../topics/topics").UnsubscribeReason,Arrays=require("util/array");module.exports=function(info,streams){function proxies(details,registry){var p=streams;return 0===p.length&&(p=registry.getFallbacks(details)),p}var self=this;this.getTopicPath=function(){return info.path},this.getTopicDetails=function(){return info.details},this.notifyInitialSubscription=function(registry){proxies(info.details,registry).forEach(function(proxy){proxy.onSubscription(info.path,info.details)})},this.notifySubscription=function(proxy){proxy.onSubscription(info.path,info.details),self.notifyValueToNewStream(info.path,info.details,proxy)},this.notifyUnsubscription=function(reason,registry){proxies(info.details,registry).forEach(function(proxy){proxy.onUnsubscription(info.path,info.details,reason)})},this.notifyValue=function(content,oldValue,newValue,registry){proxies(info.details,registry).forEach(function(proxy){proxy.onValue(info.path,info.details,content,oldValue,newValue)})},this.notifyDelta=function(content,delta,oldValue,newValue,registry){proxies(info.details,registry).forEach(function(proxy){proxy.onDelta(info.path,info.details,content,delta,oldValue,newValue)})},this.addStream=function(stream,registry){0===streams.length&&registry.getFallbacks(info.details).forEach(function(fallback){fallback.onUnsubscription(info.path,info.details,UnsubscribeReason.STREAM_CHANGE)}),streams.indexOf(stream)<0&&(streams.push(stream),self.notifySubscription(stream))},this.removeStream=function(stream,registry){Arrays.remove(streams,stream),0===streams.length&&registry.getFallbacks(info.details).forEach(function(fallback){self.notifySubscription(fallback)})},this.removeAllStreams=function(){streams.length=0}}},{"../../topics/topics":299,"util/array":277}],142:[function(require,module,exports){var TopicCacheEntry=require("routing/topic-cache-entry");module.exports=function(details,streams){TopicCacheEntry.call(this,details,streams),this.handleValue=function(received,registry,errorHandler){this.notifyValue(received,null,received,registry)},this.handleDelta=function(received,registry,errorHandler){this.notifyDelta(received,null,null,received,registry)},this.notifyValueToNewStream=function(path,stream){}}},{"routing/topic-cache-entry":141}],143:[function(require,module,exports){var TopicCacheEntry=require("routing/topic-cache-entry");module.exports=function(details,streams){TopicCacheEntry.call(this,details,streams);var value;this.handleValue=function(received,registry,errorHandler){this.notifyValue(received,value,received,registry),value=received},this.handleDelta=function(received,registry,errorHandler){this.notifyDelta(received,null,value,received,registry),value=received},this.notifyValueToNewStream=function(path,details,stream){value&&stream.onValue(path,details,value,null,value)}}},{"routing/topic-cache-entry":141}],144:[function(require,module,exports){var NoValueEntry=require("routing/topic-cache-no-value-entry"),DatatypeEntry=require("routing/topic-cache-datatype-entry"),SingleEntry=require("routing/topic-cache-single-value-entry"),UnsubscribeReason=require("../../topics/topics").UnsubscribeReason,TopicType=require("../../topics/topics").TopicType;module.exports=function(datatypes){var byPath={},byId={};this.handleSubscription=function(info,registry){var path=info.path,existing=byPath[path];existing&&existing.notifyUnsubscription(UnsubscribeReason.SUBSCRIPTION_REFRESH,registry);var entry,streams=registry.streamsFor(path,info.details);switch(info.details.type){case TopicType.JSON:entry=new DatatypeEntry(info,streams,datatypes.json());break;case TopicType.BINARY:entry=new DatatypeEntry(info,streams,datatypes.binary());break;case TopicType.SINGLE_VALUE:entry=new SingleEntry(info,streams);break;default:entry=new NoValueEntry(info,streams)}byId[info.id]=entry,byPath[path]=entry,entry.notifyInitialSubscription(registry)},this.handleValue=function(session,path,content,registry){var errorHandler=session.getErrorHandler(),entry=byPath[path];entry?entry.handleValue(content,registry,errorHandler):errorHandler(new Error("Data loss on topic "+path+" - possibly due to reconnection"))},this.handleDelta=function(session,path,delta,registry){var errorHandler=session.getErrorHandler(),entry=byPath[path];entry?entry.handleDelta(delta,registry,errorHandler):errorHandler(new Error("Data loss on topic "+path+" - possibly due to reconnection"))},this.handleUnsubscription=function(id,reason,registry){var entry=byId[id];if(delete byId[id],entry){var path=entry.getTopicPath();delete byPath[path],entry.notifyUnsubscription(reason,registry)}},this.newStream=function(selector,stream,registry){for(var path in byPath){var entry=byPath[path];selector.selects(path)&&stream.selects(entry.getTopicDetails())&&entry.addStream(stream,registry)}},this.removeStream=function(stream,registry){for(var path in byPath)byPath[path].removeStream(stream,registry)},this.removeAllStreams=function(){for(var path in byPath)byPath[path].removeAllStreams()},this.clear=function(){byPath={},byId={}}}},{"../../topics/topics":299,"routing/topic-cache-datatype-entry":140,"routing/topic-cache-no-value-entry":142,"routing/topic-cache-single-value-entry":143}],145:[function(require,module,exports){var HeadersTunnel=require("v4-stack/headers-tunnel"),Message=require("v4-stack/message"),log=require("util/logger").create("V4 Client Routing");module.exports=function(session,serviceAdapter,conversationSet,cache,registry){this.route=function(message){if(message.isTopicMessage())if(message.type===Message.types.FETCH_REPLY){var cid=HeadersTunnel.cidFromHeaders(message.headers);conversationSet.respond(cid,message.topic,message.data)}else message.type===Message.types.TOPIC_LOAD?cache.handleValue(session,message.topic,message.data,registry):message.type===Message.types.DELTA&&cache.handleDelta(session,message.topic,message.data,registry);else message.isServiceMessage()?serviceAdapter.onMessage(message.type,message.getInputStream()):log.debug("Unhandled V4 message: "+message.type,message)},this.subscribe=function(info){cache.handleSubscription(info,registry)},this.unsubscribe=function(id,reason){cache.handleUnsubscription(id,reason,registry)}}},{"util/logger":281,"v4-stack/headers-tunnel":293,"v4-stack/message":294}],146:[function(require,module,exports){module.exports={ATTR:"$",CHAR:"_"}},{}],147:[function(require,module,exports){function createRecordSchema(metadata){if(0===metadata.getRecords().length)return null;var schema={message:{record:[]}};return schema.message[ATTR]={topicDataType:"record",name:metadata.name},metadata.getRecords().forEach(function(record){var rschema={field:[]};rschema[ATTR]=record.getDetails(),record.getFields().forEach(function(field){rschema.field.push(createSingleValueSchema(field).field)}),schema.message.record.push(rschema)}),schema}function createSingleValueSchema(metadata){var schema={field:{}};return schema.field[ATTR]=metadata.getDetails(),schema}function create(meta){switch(util.getType(meta)){case util.Type.RECORD:return createRecordSchema(meta);case util.Type.SINGLE_VALUE:return createSingleValueSchema(meta)}return null}var util=require("metadata/util"),ATTR=require("schema/consts").ATTR;module.exports=create},{"metadata/util":134,"schema/consts":146}],148:[function(require,module,exports){var xmljson=require("./xmljson"),Codec=require("io/codec"),serialiser={read:function(input){return xmljson.xml2json(Codec.readString(input))},write:function(output,schema){schema&&(schema.field||schema.message)&&Codec.writeString(output,xmljson.json2xml(schema))}};module.exports=serialiser},{"./xmljson":149,"io/codec":125}],149:[function(require,module,exports){function attrs_str2js(str){for(var js={},pairs=str.split(" "),i=0;i<pairs.length;i++){var pair=pairs[i].split("=");js[pair[0]]=pair[1].match(/"(.*)"/)[1]}return js}function escapeEntities(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function attrs_obj2arr(obj){var attrs=[];if("object"==typeof obj)for(var key in obj)attrs.push(""+key+'="'+escapeEntities(obj[key])+'"');return attrs}function xml2json(xml,pos){var js={};if(void 0===pos){pos={idx:0,isRoot:!0};var preamble=xml.match(/<\?.*?\?>/);preamble&&(xml=xml.substr(preamble[0].length))}for(var elem_match=null;;){if(elem_match=xml.substr(pos.idx).match(/<.*?>/),!elem_match)break;pos.idx+=elem_match[0].length;var elem=elem_match[0].trim();if("</"===elem.substr(0,2))return js;var name=elem.match(/\b(.+?)\b/)[0],attrs_match=elem.match(/<.+?\b(.*)\/?>/),attrs_str="";attrs_match&&(attrs_str=attrs_match[1].trim());var child_count,attrs=attrs_str2js(attrs_str);"/>"===elem.substr(-2)?pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push({}),js[name][child_count-1][ATTR]=attrs):pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push(xml2json(xml,pos)),js[name][child_count-1][ATTR]=attrs)}return js}function json2xml(obj,recur){var str="";recur||(str='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>');for(var key in obj){if(key===ATTR)continue;var val=obj[key];val instanceof Array||(val=Array(val));for(var i=0;i<val.length;i++){var attrs=attrs_obj2arr(val[i][ATTR]);str+="<"+key,attrs&&attrs.length>0&&(str+=" ",str+=attrs.join(" "));var child_str=json2xml(val[i],!0);child_str&&child_str.length>0?(str+=">",str+=child_str,str+="</"+key+">"):str+="/>"}}return str}var ATTR=(require("../metadata/metadata"),require("../schema/schema"),require("../schema/consts").ATTR);module.exports={xml2json:xml2json,json2xml:json2xml}},{"../metadata/metadata":129,"../schema/consts":146,"../schema/schema":147}],150:[function(require,module,exports){var Codec=require("io/codec"),serialiser={read:function(input){return 1===Codec.readByte(input)},write:function(output,val){Codec.writeByte(output,val?1:0)}};module.exports=serialiser},{"io/codec":125}],151:[function(require,module,exports){var serialiser={read:function(bis,enums){var k,i=bis.read();for(k in enums){var e=enums[k];if(e===i||void 0!==e.id&&e.id===i)return e}throw new Error("Unable to decode enum value "+i)},write:function(bos,val){val.id?bos.write(val.id):bos.write(val)}};module.exports=serialiser},{}],152:[function(require,module,exports){var Codec=require("io/codec"),serialiser={read:function(input,Enum){var i=Codec.readByte(input);for(var k in Enum)if(Enum[k]===i||void 0!==Enum[k].id&&Enum[k].id===i)return k;throw new Error("Unknown id ("+i+") for enum")},write:function(output,id){Codec.writeByte(output,id)}};module.exports=serialiser},{"io/codec":125}],153:[function(require,module,exports){module.exports={EXISTS:{id:1,reason:"The topic already exists with the same details"},EXISTS_MISMATCH:{id:2,reason:"The topic already exists, with different details"},INVALID_PATH:{id:3,reason:"The topic path is invalid"},INVALID_DETAILS:{id:4,reason:"The topic details are invalid"},USER_CODE_ERROR:{id:5,reason:"A user supplied class could not be found or instantiated"},TOPIC_NOT_FOUND:{id:6,reason:"A referenced topic could not be found"},PERMISSIONS_FAILURE:{id:7,reason:"Invalid permissions to add a topic at the specified path"},INITIALISE_ERROR:{id:8,reason:"The topic could not be initialised, supplied value may be of the wrong format"},UNEXPECTED_ERROR:{id:9,reason:"An unexpected error occured while creating the topic"}}},{}],154:[function(require,module,exports){var Codec=require("io/codec"),ContentSerialiser=(require("io/buffer-output-stream"),require("content/util"),require("content/serialiser")),BEES=require("serialisers/byte-encoded-enum-serialiser"),AddTopicFailureReason=require("services/add-topic/add-topic-failure-reason"),TopicDetailsSerialiser=require("topics/details/topic-details-serialiser"),Status={OK:0,OK_CACHED:1,FAILURE:2,CACHE_FAILURE:3},serialiser={read:function(input){var status=Codec.readByte(input),reason="";return status===Status.FAILURE&&(reason=BEES.read(input,AddTopicFailureReason)),{status:status,reason:reason}},write:function(output,req){Codec.writeString(output,req.path),Codec.writeInt32(output,0),TopicDetailsSerialiser.write(output,req.details),req.content?(Codec.writeBoolean(output,!0),ContentSerialiser.write(output,req.content)):Codec.writeBoolean(output,!1)}};module.exports=serialiser},{"content/serialiser":75,"content/util":79,"io/buffer-output-stream":124,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151,"services/add-topic/add-topic-failure-reason":153,"topics/details/topic-details-serialiser":259}],155:[function(require,module,exports){function AddTopic(){}module.exports=AddTopic},{}],156:[function(require,module,exports){var BEES=require("serialisers/byte-encoded-enum-serialiser"),Codec=require("io/codec"),Type={NONE:0,PLAIN:1,CUSTOM:2},serialiser={read:function(input){var type=BEES.read(input,Type);switch(type){case Type.NONE:return null;case Type.PLAIN:return Codec.readString(input);case Type.CUSTOM:return Codec.readBytes(input)}},write:function(input,credentials){credentials?"string"==typeof credentials?(BEES.write(input,Type.PLAIN),Codec.writeString(input,credentials)):(BEES.write(input,Type.CUSTOM),Codec.writeBytes(input,credentials)):(BEES.write(input,Type.NONE),Codec.writeInt32(input,0))}};module.exports=serialiser},{"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],157:[function(require,module,exports){var Codec=require("io/codec"),ErrorReportSerialiser=require("../error-report-serialiser"),SecurityCommandScriptResult=require("./security-command-script-result"),serialiser={read:function(input){var errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new SecurityCommandScriptResult(errors)},write:function(output,value){Codec.writeCollection(output,value.errors,ErrorReportSerialiser.write)}};module.exports=serialiser},{"../error-report-serialiser":197,"./security-command-script-result":158,"io/codec":125}],158:[function(require,module,exports){function SecurityCommandScriptResult(errors){this.errors=requireNonNull(errors)}var requireNonNull=require("util/require-non-null");SecurityCommandScriptResult.prototype.toString=function(){return"SecurityCommandScriptResult ["+this.errors+"]"},module.exports=SecurityCommandScriptResult},{"util/require-non-null":286}],159:[function(require,module,exports){var SecurityCommandScript=require("./security-command-script"),Codec=require("io/codec"),serialiser={read:function(input){var script=Codec.readString(input);return new SecurityCommandScript(script)},write:function(output,value){Codec.writeString(output,value.script)}};module.exports=serialiser},{"./security-command-script":160,"io/codec":125}],160:[function(require,module,exports){function SecurityCommandScript(script){this.script=requireNonNull(script,"script")}var requireNonNull=require("util/require-non-null");SecurityCommandScript.prototype.toString=function(){return"SecurityCommandScript ["+this.script+"]"},module.exports=SecurityCommandScript},{"util/require-non-null":286}],161:[function(require,module,exports){var Codec=require("io/codec"),Configuration=require("features/security").SystemAuthentication,ByteEncodedEnumSerialiser=require("serialisers/byte-encoded-enum-serialiser"),SystemPrincipalSerialiser=require("./system-principal-serialiser"),serialiser={read:function(input){var principals=Codec.readCollection(input,SystemPrincipalSerialiser.read),action=ByteEncodedEnumSerialiser.read(input,Configuration.CONNECTION_ACTION),roles=Codec.readCollection(input,Codec.readString);return new Configuration(principals,action.value,roles)},write:function(output,value){Codec.writeCollection(output,value.principals,SystemPrincipalSerialiser.write);var action=Configuration.CONNECTION_ACTION.fromString(value.anonymous.action);Codec.writeByte(output,action.id),Codec.writeCollection(output,value.anonymous.roles,Codec.writeString)}};module.exports=serialiser},{"./system-principal-serialiser":162,"features/security":108,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],162:[function(require,module,exports){var Codec=require("io/codec"),SystemPrincipal=require("features/security").SystemPrincipal,serialiser={read:function(input){var name=Codec.readString(input),roles=Codec.readCollection(input,Codec.readString);return new SystemPrincipal(name,roles)},write:function(output,principal){Codec.writeString(output,principal.name),Codec.writeCollection(output,principal.roles,Codec.writeString)}};module.exports=serialiser},{"features/security":108,"io/codec":125}],163:[function(require,module,exports){var CredentialsSerialiser=require("services/authentication/credentials-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){Codec.readString(input),CredentialsSerialiser.read(input)},write:function(output,req){Codec.writeString(output,req.principal),CredentialsSerialiser.write(output,req.credentials)}};module.exports=serialiser},{"io/codec":125,"services/authentication/credentials-serialiser":156}],164:[function(require,module,exports){},{}],165:[function(require,module,exports){var Codec=require("io/codec"),ByteEncodedEnumSerialiser=require("serialisers/byte-encoded-enum-serialiser"),CommandError=require("./command-error"),serialiser={read:function(input){var message=Codec.readString(input),type=ByteEncodedEnumSerialiser.read(input,CommandError.ErrorType);return new CommandError(type,message)},write:function(out,error){Codec.writeString(out,error.message),ByteEncodedEnumSerialiser.write(out,error.type)}};module.exports=serialiser},{"./command-error":166,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],166:[function(require,module,exports){function ErrorType(reason){this.reason=reason,this.id=reason.id,this.asCommandError=function(){return new CommandError(this)}}function CommandError(type,message){this.type=type,this.message=message||type.reason.reason}var ErrorReasons=require("client/errors");CommandError.prototype.toString=function(){return this.message},CommandError.ErrorType={COMMUNICATION_FAILURE:new ErrorType(ErrorReasons.COMMUNICATION_FAILURE),ACCESS_DENIED:new ErrorType(ErrorReasons.ACCESS_DENIED),TOPIC_TREE_REGISTATION_CONFLICT:new ErrorType(ErrorReasons.TOPIC_TREE_REGISTRATION_CONFLICT)},module.exports=CommandError},{"client/errors":63}],167:[function(require,module,exports){var ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),CommandHeader=require("./command-header"),Codec=require("io/codec"),CommandHeaderSerialiser={read:function(input){var service=Codec.readInt32(input),cid=ConversationIDSerialiser.read(input);return new CommandHeader(service,cid)},write:function(out,header){Codec.writeInt32(out,header.service),ConversationIDSerialiser.write(out,header.cid)}};module.exports=CommandHeaderSerialiser},{"./command-header":168,"conversation/conversation-id-serialiser":83,"io/codec":125}],168:[function(require,module,exports){function CommandHeader(service,cid){this.service=service,this.cid=cid}require("v4-stack/message");CommandHeader.prototype.toString=function(){return"<"+this.service+", "+this.cid.toString()+">"},CommandHeader.createRequestHeader=function(service,cid){return new CommandHeader(service,cid)},CommandHeader.prototype.createResponseHeader=function(){return new CommandHeader(this.service,this.cid)},CommandHeader.prototype.createErrorHeader=function(){return new CommandHeader(this.service,this.cid)},module.exports=CommandHeader},{"v4-stack/message":294}],169:[function(require,module,exports){var ClientFilterSubscribeRequest=require("services/control-client/client-filter-subscribe-request"),TopicSelectorSerialiser=require("topics/topic-selector-serialiser"),Codec=require("io/codec");module.exports={read:function(input){var filter=Codec.readString(input),selector=TopicSelectorSerialiser.read(input);return new ClientFilterSubscribeRequest(filter,selector)},write:function(output,request){Codec.writeString(output,request.filter),TopicSelectorSerialiser.write(output,request.selector)}}},{"io/codec":125,"services/control-client/client-filter-subscribe-request":170,"topics/topic-selector-serialiser":269}],170:[function(require,module,exports){module.exports=function(filter,selector){this.filter=filter,this.selector=selector}},{}],171:[function(require,module,exports){var ClientFilterSubscribeResponse=require("services/control-client/client-filter-subscribe-response"),ErrorReportSerialiser=require("services/error-report-serialiser"),Codec=require("io/codec");module.exports={read:function(input){var error=Codec.readByte(input);if(error){var errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new ClientFilterSubscribeResponse(0,errors)}var numSelected=Codec.readInt32(input);return new ClientFilterSubscribeResponse(numSelected,[])},write:function(output,response){response.isSuccess()?(Codec.writeByte(output,0),Codec.writeInt32(output,response.selected)):(Codec.writeByte(output,1),Codec.writeCollection(output,response.errors,ErrorReportSerialiser.write))}}},{"io/codec":125,"services/control-client/client-filter-subscribe-response":172,"services/error-report-serialiser":197}],172:[function(require,module,exports){module.exports=function(selected,errors){this.selected=selected,this.errors=errors,this.isSuccess=function(){return 0===errors.length}}},{}],173:[function(require,module,exports){var ClientSubscribeRequest=require("services/control-client/client-subscribe-request"),TopicSelectorSerialiser=require("topics/topic-selector-serialiser"),SessionIdSerialiser=require("session/session-id-serialiser");module.exports={read:function(input){var sessionID=SessionIdSerialiser.read(input),selector=TopicSelectorSerialiser.read(input);return new ClientSubscribeRequest(sessionID,selector)},write:function(output,request){SessionIdSerialiser.write(output,request.sessionID),TopicSelectorSerialiser.write(output,request.selector)}}},{"services/control-client/client-subscribe-request":174,"session/session-id-serialiser":254,"topics/topic-selector-serialiser":269}],174:[function(require,module,exports){module.exports=function(sessionID,selector){this.sessionID=sessionID,this.selector=selector}},{}],175:[function(require,module,exports){var ControlGroupSerialiser=require("control/control-group-serialiser"),BEES=require("serialisers/byte-encoded-enum-serialiser"),Services=require("services/services"),Codec=require("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input);return{definition:definition,group:group}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group)}};module.exports=serialiser},{"control/control-group-serialiser":80,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151,"services/services":221}],176:[function(require,module,exports){function ControlRegistrationParams(definition,group){this.definition=definition,this.group=group}module.exports=ControlRegistrationParams},{}],177:[function(require,module,exports){var ControlRegistrationParamsSerialiser=require("services/control/control-registration-params-serialiser"),ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),serialiser={read:function(input){var params=ControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){ControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":83,"services/control/control-registration-params-serialiser":175}],178:[function(require,module,exports){function ControlRegistrationRequest(params,cid){this.params=params,this.cid=cid}module.exports=ControlRegistrationRequest},{}],179:[function(require,module,exports){var Codec=require("io/codec"),SessionSerialiser=require("session/session-id-serialiser"),serialiser={read:function(input){return Codec.readBoolean(input)?{properties:Codec.readDictionary(input,Codec.readString)}:null},write:function(output,request){if(void 0===request.sessionID||null===request.sessionID)throw new Error("session ID is null or undefined");SessionSerialiser.write(output,request.sessionID),void 0!==request.propertyKeys&&null!==request.propertyKeys?Codec.writeCollection(output,request.propertyKeys,Codec.writeString):Codec.writeCollection(output,[],Codec.writeString)}};module.exports=serialiser},{"io/codec":125,"session/session-id-serialiser":254}],180:[function(require,module,exports){function GetSessionProperties(){}module.exports=GetSessionProperties},{}],181:[function(require,module,exports){var ControlGroupSerialiser=require("control/control-group-serialiser"),BEES=require("serialisers/byte-encoded-enum-serialiser"),Services=require("services/services"),Codec=require("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input),path=Codec.readString(input),keys=Codec.readCollection(input,Codec.readString);return{definition:definition,group:group,path:path,keys:keys}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group),Codec.writeString(output,params.path),Codec.writeCollection(output,params.keys,Codec.writeString)}};module.exports=serialiser},{"control/control-group-serialiser":80,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151,"services/services":221}],182:[function(require,module,exports){function MessageReceiverControlRegistrationParams(definition,group,path,keys){this.definition=definition,this.group=group,this.path=path,this.keys=keys}module.exports=MessageReceiverControlRegistrationParams},{}],183:[function(require,module,exports){var MessageReceiverControlRegistrationParamsSerialiser=require("services/control/message-receiver-control-registration-params-serialiser"),ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),serialiser=(require("io/codec"),{read:function(input){var params=MessageReceiverControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){MessageReceiverControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}});module.exports=serialiser},{"conversation/conversation-id-serialiser":83,"io/codec":125,"services/control/message-receiver-control-registration-params-serialiser":181}],184:[function(require,module,exports){function MessageReceiverControlRegistrationRequest(){}module.exports=MessageReceiverControlRegistrationRequest},{}],185:[function(require,module,exports){var SessionCloseReason={CONNECTION_LOST:0,IO_EXCEPTION:1,CLIENT_UNRESPONSIVE:2,MESSAGE_QUEUE_LIMIT_REACHED:3,CLOSED_BY_CLIENT:4,MESSAGE_TOO_LARGE:5,INTERNAL_ERROR:6,INVALID_INBOUND_MESSAGE:7,ABORT:8,LOST_MESSAGES:9,SERVER_CLOSING:10,CLOSED_BY_CONTROLLER:11};module.exports=SessionCloseReason},{}],186:[function(require,module,exports){var SessionPropertiesEventSerialiser=require("services/control/session-properties-event-serialiser"),ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec");module.exports={read:function(input){var cid=ConversationIDSerialiser.read(input),events=Codec.readCollection(input,SessionPropertiesEventSerialiser.read);return{cid:cid,events:events}},write:function(output,batch){ConversationIDSerialiser.write(output,batch.cid),Codec.writeCollection(output,batch.events)}}},{"conversation/conversation-id-serialiser":83,"io/codec":125,"services/control/session-properties-event-serialiser":188}],187:[function(require,module,exports){module.exports=function(cid,events){this.cid=cid,this.events=events}},{}],188:[function(require,module,exports){var SessionIdSerialiser=(require("../../../features/client-control-options"),require("conversation/conversation-id-serialiser"),require("session/session-id-serialiser")),SessionPropertiesEventType=require("services/control/session-properties-event-type"),SessionCloseReason=require("services/control/session-close-reason"),Codec=require("io/codec"),BEES=require("serialisers/byte-encoded-enum-serialiser"),serialiser={read:function(input){var result={sessionId:SessionIdSerialiser.read(input),type:BEES.read(input,SessionPropertiesEventType)};switch(result.type){case SessionPropertiesEventType.OPEN:result.oldProperties=Codec.readDictionary(input,Codec.readString);break;case SessionPropertiesEventType.UPDATE:result.updateType=Codec.readByte(input),result.oldProperties=Codec.readDictionary(input,Codec.readString),result.newProperties=Codec.readDictionary(input,Codec.readString);break;case SessionPropertiesEventType.CLOSE:result.closeReason=BEES.read(input,SessionCloseReason),result.oldProperties=Codec.readDictionary(input,Codec.readString);break;default:throw new Error("Unknown session properties event type: "+result.type)}return result},write:function(output,request){}};module.exports=serialiser},{"../../../features/client-control-options":48,"conversation/conversation-id-serialiser":83,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151,"services/control/session-close-reason":185,"services/control/session-properties-event-type":189,"session/session-id-serialiser":254}],189:[function(require,module,exports){var SessionPropertiesEventType={OPEN:0,UPDATE:1,CLOSE:2};module.exports=SessionPropertiesEventType},{}],190:[function(require,module,exports){function SessionPropertiesEvent(){}module.exports=SessionPropertiesEvent},{}],191:[function(require,module,exports){var ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){},write:function(output,request){request.properties?(Codec.writeInt32(output,0),Codec.writeCollection(output,request.properties,Codec.writeString)):Codec.writeInt32(output,1),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":83,"io/codec":125}],192:[function(require,module,exports){function SetSessionPropertiesListener(){}module.exports=SetSessionPropertiesListener},{}],193:[function(require,module,exports){var ControlGroupSerialiser=require("control/control-group-serialiser"),BEES=require("serialisers/byte-encoded-enum-serialiser"),Services=require("services/services"),Codec=require("io/codec"),serialiser={read:function(input){var definition=BEES.read(input,Services),group=ControlGroupSerialiser.read(input),path=Codec.readString(input);return{definition:definition,group:group,path:path}},write:function(output,params){Codec.writeInt32(output,params.definition.id),ControlGroupSerialiser.write(output,params.group),Codec.writeString(output,params.path)}};module.exports=serialiser},{"control/control-group-serialiser":80,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151,"services/services":221}],194:[function(require,module,exports){function TopicControlRegistrationParams(definition,group,path){this.definition=definition,this.group=group,this.path=path}module.exports=TopicControlRegistrationParams},{}],195:[function(require,module,exports){var TopicControlRegistrationParamsSerialiser=require("services/control/topic-control-registration-params-serialiser"),ConversationIDSerialiser=require("conversation/conversation-id-serialiser"),serialiser={read:function(input){var params=TopicControlRegistrationParamsSerialiser.read(input),cid=ConversationIDSerialiser.read(input);return{params:params,cid:cid}},write:function(output,request){TopicControlRegistrationParamsSerialiser.write(output,request.params),ConversationIDSerialiser.write(output,request.cid)}};module.exports=serialiser},{"conversation/conversation-id-serialiser":83,"services/control/topic-control-registration-params-serialiser":193}],196:[function(require,module,exports){function TopicControlRegistrationRequest(){}module.exports=TopicControlRegistrationRequest},{}],197:[function(require,module,exports){var Codec=require("io/codec"),ErrorReport=require("services/error-report"),serialiser={read:function(input){var message=Codec.readString(input),line=Codec.readInt32(input),column=Codec.readInt32(input);return new ErrorReport(message,line,column)},write:function(output,value){Codec.writeString(output,value.message),Codec.writeInt32(output,value.line),Codec.writeInt32(output,value.column)}};module.exports=serialiser},{"io/codec":125,"services/error-report":198}],198:[function(require,module,exports){var implements=require("util/interface").implements,requireNonNull=require("util/require-non-null"),ErrorReport=require("../../error-report");module.exports=implements(ErrorReport,function(message,line,column){this.message=requireNonNull(message),this.line=line||0,this.column=column||0,this.toString=function(){return"ErrorReport ["+this.message+" at ["+this.line+":"+this.column+"]]"}})},{"../../error-report":41,"util/interface":280,"util/require-non-null":286}],199:[function(require,module,exports){var TopicSelectorSerialiser=require("topics/topic-selector-serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser"),FetchRequest=require("services/fetch/fetch-request");module.exports={read:function(input){var selector=TopicSelectorSerialiser.read(input),cid=CIDSerialiser.read(input);return new FetchRequest(cid,selector)},write:function(output,request){TopicSelectorSerialiser.write(output,request.selector),CIDSerialiser.write(output,request.cid)}}},{"conversation/conversation-id-serialiser":83,"services/fetch/fetch-request":200,"topics/topic-selector-serialiser":269}],200:[function(require,module,exports){module.exports=function(cid,selector){this.cid=cid,this.selector=selector}},{}],201:[function(require,module,exports){var Codec=require("io/codec"),TopicDetailsSerialiser=(require("./get-topic-details"),require("topics/details/topic-details-serialiser")),serialiser={read:function(input){return TopicDetailsSerialiser.read(input)},write:function(output,request){Codec.writeString(output,request.topic_name),Codec.writeByte(output,request.level)}};module.exports=serialiser},{"./get-topic-details":202,"io/codec":125,"topics/details/topic-details-serialiser":259}],202:[function(require,module,exports){function GetTopicDetails(){}module.exports=GetTopicDetails},{}],203:[function(require,module,exports){var TopicSelectorSerialiser=require("topics/topic-selector-serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser"),SessionSerialiser=require("session/session-id-serialiser");module.exports={read:function(input){var sessionID=SessionSerialiser.read(input),selector=TopicSelectorSerialiser.read(input),cid=CIDSerialiser.read(input);return{sessionID:sessionID,selector:selector,cid:cid}},write:function(output,req){SessionSerialiser.write(output,req.sessionID),TopicSelectorSerialiser.write(output,req.selector),CIDSerialiser.write(output,req.cid)}}},{"conversation/conversation-id-serialiser":83,"session/session-id-serialiser":254,"topics/topic-selector-serialiser":269}],204:[function(require,module,exports){module.exports=function(sessionID,selector){this.sessionID=sessionID,this.selector=selector}},{}],205:[function(require,module,exports){var Codec=(require("./remove-topic"),require("io/codec")),serialiser={read:function(input){},write:function(output,req){Codec.writeString(output,req.selector.expression)}};module.exports=serialiser},{"./remove-topic":206,"io/codec":125}],206:[function(require,module,exports){function RemoveTopic(){}module.exports=RemoveTopic},{}],207:[function(require,module,exports){var TopicPermission=require("features/security").TopicPermission,GlobalPermission=require("features/security").GlobalPermission,Converter=require("serialisers/enum-converter"),curryR=require("util/function").curryR,Codec=require("io/codec"),writeGlobalPerm=curryR(Converter.write,GlobalPermission),writeTopicPerm=curryR(Converter.write,TopicPermission),readGlobalPerm=curryR(Converter.read,GlobalPermission),readTopicPerm=curryR(Converter.read,TopicPermission),writeTopicPerms=curryR(Codec.writeCollection,writeTopicPerm),readTopicPerms=curryR(Codec.readCollection,readTopicPerm),serialiser={read:function(input){return{name:Codec.readString(input),global:Codec.readCollection(input,readGlobalPerm),default:Codec.readCollection(input,readTopicPerm),topic:Codec.readDictionary(input,readTopicPerms),roles:Codec.readCollection(input,Codec.readString)}},write:function(output,role){Codec.writeString(output,role.name),Codec.writeCollection(output,role.global,writeGlobalPerm),Codec.writeCollection(output,role.default,writeTopicPerm),Codec.writeDictionary(output,role.topic,writeTopicPerms),Codec.writeCollection(output,role.roles,Codec.writeString)}};module.exports=serialiser},{"features/security":108,"io/codec":125,"serialisers/enum-converter":152,"util/function":279}],208:[function(require,module,exports){var Configuration=require("features/security").Configuration,RoleSerialiser=require("services/security/role-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){var anonymous=Codec.readCollection(input,Codec.readString),named=Codec.readCollection(input,Codec.readString),roles=Codec.readCollection(input,RoleSerialiser.read);return new Configuration(anonymous,named,roles)},write:function(output,config){Codec.writeCollection(output,config.anonymous,Codec.writeString),Codec.writeCollection(output,config.named,Codec.writeString),Codec.writeCollection(output,config.roles,RoleSerialiser.write)}};module.exports=serialiser},{"features/security":108,"io/codec":125,"services/security/role-serialiser":207}],209:[function(require,module,exports){var OptionsSerialiser=(require("./filter-send-request"),require("./send-options-serialiser")),ContentSerialiser=require("content/serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){var filter=Codec.readString(input),path=Codec.readString(input),content=ContentSerialiser.read(input),options=OptionsSerialiser.read(input),cid=CIDSerialiser.read(input);return{cid:cid,path:path,filter:filter,message:content,options:options}},write:function(output,req){Codec.writeString(output,req.filter),Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),OptionsSerialiser.write(output,req.options),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./filter-send-request":210,"./send-options-serialiser":213,"content/serialiser":75,"conversation/conversation-id-serialiser":83,"io/codec":125}],210:[function(require,module,exports){function FilterSendRequest(path,message,filter){this.path=path,this.message=message,this.filter=filter}module.exports=FilterSendRequest},{}],211:[function(require,module,exports){var Codec=require("io/codec"),ErrorReportSerialiser=require("../error-report-serialiser"),FilterSendResult=require("./filter-send-result"),serialiser={read:function(input){var sent=Codec.readInt32(input),errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new FilterSendResult(sent,errors)},write:function(output,req){Codec.writeInt32(output,req.sent),Codec.writeCollection(output,req.errors,ErrorReportSerialiser.write)}};module.exports=serialiser},{"../error-report-serialiser":197,"./filter-send-result":212,"io/codec":125}],212:[function(require,module,exports){function FilterSendResult(sent,errors){this.sent=requireNonNull(sent),this.errors=requireNonNull(errors)}var requireNonNull=require("util/require-non-null");FilterSendResult.prototype.toString=function(){return"FilterSendResult ["+this.sent+" sent, errors="+this.errors+"]"},module.exports=FilterSendResult},{"util/require-non-null":286}],213:[function(require,module,exports){var BEES=require("serialisers/byte-encoded-enum-serialiser"),Codec=require("io/codec"),Priority=require("../../../features/messages").Priority,serialiser={read:function(input){var priority=BEES.read(input,Priority),headers=Codec.readCollection(input,Codec.readString);return{priority:priority,headers:headers}},write:function(output,req){BEES.write(output,req.priority),Codec.writeCollection(output,req.headers,Codec.writeString)}};module.exports=serialiser},{"../../../features/messages":50,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],214:[function(require,module,exports){var OptionsSerialiser=(require("./send-request"),require("./send-options-serialiser")),ContentSerialiser=require("content/serialiser"),Codec=require("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),options=OptionsSerialiser.read(input);return{path:path,content:content,options:options}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),OptionsSerialiser.write(output,req.options)}};module.exports=serialiser},{"./send-options-serialiser":213,"./send-request":215,"content/serialiser":75,"io/codec":125}],215:[function(require,module,exports){function SendRequest(path,message){this.path=path,this.message=message}module.exports=SendRequest},{}],216:[function(require,module,exports){var OptionsSerialiser=(require("./session-forward-send-request"),require("./send-options-serialiser")),ContentSerialiser=require("content/serialiser"),SessionSerialiser=require("session/session-id-serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),sender=SessionSerialiser.read(input),options=OptionsSerialiser.read(input),sessionProperties=Codec.readDictionary(input,Codec.readString),cid=CIDSerialiser.read(input);return{cid:cid,path:path,sender:sender,message:content,options:options,sessionProperties:sessionProperties}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),SessionSerialiser.write(output,req.session),OptionsSerialiser.write(output,req.options),Codec.writeDictionary(output,req.sessionProperties,Codec.writeString),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./send-options-serialiser":213,"./session-forward-send-request":217,"content/serialiser":75,"conversation/conversation-id-serialiser":83,"io/codec":125,"session/session-id-serialiser":254}],217:[function(require,module,exports){function SessionForwardSendRequest(path,message,recipient,sessionProperties){this.path=path,this.message=message,this.recipient=recipient,this.sessionProperties=sessionProperties}module.exports=SessionForwardSendRequest},{}],218:[function(require,module,exports){var OptionsSerialiser=(require("./session-send-request"),require("./send-options-serialiser")),ContentSerialiser=require("content/serialiser"),SessionSerialiser=require("session/session-id-serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),content=ContentSerialiser.read(input),sender=SessionSerialiser.read(input),options=OptionsSerialiser.read(input),cid=CIDSerialiser.read(input);return{cid:cid,path:path,sender:sender,message:content,options:options}},write:function(output,req){Codec.writeString(output,req.path),ContentSerialiser.write(output,req.content),SessionSerialiser.write(output,req.session),OptionsSerialiser.write(output,req.options),CIDSerialiser.write(output,req.cid)}};module.exports=serialiser},{"./send-options-serialiser":213,"./session-send-request":219,"content/serialiser":75,"conversation/conversation-id-serialiser":83,"io/codec":125,"session/session-id-serialiser":254}],219:[function(require,module,exports){function SessionSendRequest(path,message,recipient){this.path=path,this.message=message,this.recipient=recipient}module.exports=SessionSendRequest},{}],220:[function(require,module,exports){var HashMap=require("hashmap"),CommandHeader=require("services/command-header"),CommandHeaderSerialiser=require("services/command-header-serialiser"),CommandError=require("services/command-error"),CommandErrorSerialiser=require("services/command-error-serialiser"),TopicSelector=require("../../selectors/topic-selector"),TopicSelectorSerialiser=require("topics/topic-selector-serialiser"),ErrorReport=require("services/error-report"),ErrorReportSerialiser=require("services/error-report-serialiser.js"),serialisers=new HashMap;serialisers.set(CommandError,CommandErrorSerialiser),serialisers.set(CommandHeader,CommandHeaderSerialiser),serialisers.set(TopicSelector,TopicSelectorSerialiser),serialisers.set(ErrorReport,ErrorReportSerialiser),serialisers.set(null,{read:function(){return null},write:function(){}}),serialisers.set(Boolean,require("serialisers/boolean-serialiser")),serialisers.set(require("services/fetch/fetch-request"),require("services/fetch/fetch-request-serialiser")),serialisers.set(require("./subscription-notification/subscription-notification"),require("./subscription-notification/subscription-notification-serialiser")),serialisers.set(require("./unsubscription-notification/unsubscription-notification"),require("./unsubscription-notification/unsubscription-notification-serialiser")),serialisers.set(require("./get-topic-details/get-topic-details"),require("./get-topic-details/get-topic-details-serialiser")),serialisers.set(require("./add-topic/add-topic"),require("./add-topic/add-topic-serialiser")),serialisers.set(require("./remove-topic/remove-topic"),require("./remove-topic/remove-topic-serialiser")),serialisers.set(require("./update-topic/update-topic-request"),require("./update-topic/update-topic-request-serialiser")),serialisers.set(require("./update-topic/update-topic-response"),require("./update-topic/update-topic-response-serialiser")),serialisers.set(require("./wills/topic-will-parameters"),require("./wills/topic-will-parameters-serialiser")),serialisers.set(require("./wills/will-registration-result"),require("./wills/will-registration-result-serialiser")),serialisers.set(require("./send/send-request"),require("./send/send-request-serialiser")),serialisers.set(require("./send/session-send-request"),require("./send/session-send-request-serialiser"));var security=require("../../features/security");serialisers.set(security.SystemAuthenticationConfiguration,require("./authentication/system-authentication-configuration-serialiser")),serialisers.set(security.SecurityConfiguration,require("./security/security-configuration-serialiser")),serialisers.set(security.SystemPrincipal,require("./authentication/system-principal-serialiser")),serialisers.set(require("./authentication/security-command-script"),require("./authentication/security-command-script-serialiser")),serialisers.set(require("./authentication/security-command-script-result"),require("./authentication/security-command-script-result-serialiser")),serialisers.set(require("session/session-id"),require("session/session-id-serialiser")),serialisers.set(require("services/control/topic-control-registration-request"),require("services/control/topic-control-registration-request-serialiser")),serialisers.set(require("services/control/topic-control-registration-params"),require("services/control/topic-control-registration-params-serialiser")),serialisers.set(require("services/control/control-registration-request"),require("services/control/control-registration-request-serialiser")),serialisers.set(require("services/control/control-registration-request"),require("services/control/control-registration-request-serialiser")),serialisers.set(require("services/change-principal/change-principal-request"),require("services/change-principal/change-principal-request-serialiser")),serialisers.set(require("./send/session-forward-send-request"),require("./send/session-forward-send-request-serialiser")),serialisers.set(require("services/control/message-receiver-control-registration-request"),require("services/control/message-receiver-control-registration-request-serialiser")),serialisers.set(require("services/control/message-receiver-control-registration-params"),require("services/control/message-receiver-control-registration-params-serialiser")),serialisers.set(require("./send/filter-send-request"),require("./send/filter-send-request-serialiser")),serialisers.set(require("./send/filter-send-result"),require("./send/filter-send-result-serialiser")),serialisers.set(require("services/control/get-session-properties"),require("services/control/get-session-properties-serialiser")),serialisers.set(require("services/control/set-session-properties-listener"),require("services/control/set-session-properties-listener-serialiser")),serialisers.set(require("services/control/session-properties-event"),require("services/control/session-properties-event-serialiser")),serialisers.set(require("services/control/session-properties-event-batch"),require("services/control/session-properties-event-batch-serialiser")),serialisers.set(require("services/topic-update/update-source-registration-request"),require("services/topic-update/update-source-registration-request-serialiser")),serialisers.set(require("services/topic-update/update-source-deregistration-request"),require("services/topic-update/update-source-deregistration-request-serialiser")),serialisers.set(require("services/topic-update/update-source-state-request"),require("services/topic-update/update-source-state-request-serialiser")),serialisers.set(require("services/topic-update/update-source-state"),require("services/topic-update/update-source-state-serialiser")),serialisers.set(require("services/topic-update/update-source-update"),require("services/topic-update/update-source-update-serialiser")),serialisers.set(require("services/topic-update/update-source-update-response"),require("services/topic-update/update-source-update-response-serialiser")),serialisers.set(require("services/update-topic/update-topic-set-request"),require("services/update-topic/update-topic-set-request-serialiser")),serialisers.set(require("services/update-topic/update-topic-delta-request"),require("services/update-topic/update-topic-delta-request-serialiser")),serialisers.set(require("services/topic-update/update-source-set-request"),require("services/topic-update/update-source-set-request-serialiser")),serialisers.set(require("services/topic-update/update-source-delta-request"),require("services/topic-update/update-source-delta-request-serialiser")),serialisers.set(require("services/missing-topic/missing-topic-request"),require("services/missing-topic/missing-topic-request-serialiser")),serialisers.set(require("services/control-client/client-subscribe-request"),require("services/control-client/client-subscribe-request-serialiser")),serialisers.set(require("services/control-client/client-filter-subscribe-request"),require("services/control-client/client-filter-subscribe-request-serialiser")),serialisers.set(require("services/control-client/client-filter-subscribe-response"),require("services/control-client/client-filter-subscribe-response-serialiser")),module.exports=serialisers},{"../../features/security":51,"../../selectors/topic-selector":296,"./add-topic/add-topic":155,"./add-topic/add-topic-serialiser":154,"./authentication/security-command-script":160,"./authentication/security-command-script-result":158,"./authentication/security-command-script-result-serialiser":157,"./authentication/security-command-script-serialiser":159,"./authentication/system-authentication-configuration-serialiser":161,"./authentication/system-principal-serialiser":162,"./get-topic-details/get-topic-details":202,"./get-topic-details/get-topic-details-serialiser":201,"./remove-topic/remove-topic":206,"./remove-topic/remove-topic-serialiser":205,"./security/security-configuration-serialiser":208,"./send/filter-send-request":210,"./send/filter-send-request-serialiser":209,"./send/filter-send-result":212,"./send/filter-send-result-serialiser":211,"./send/send-request":215,"./send/send-request-serialiser":214,"./send/session-forward-send-request":217,"./send/session-forward-send-request-serialiser":216,"./send/session-send-request":219,"./send/session-send-request-serialiser":218,"./subscription-notification/subscription-notification":223,"./subscription-notification/subscription-notification-serialiser":222,"./unsubscription-notification/unsubscription-notification":241,"./unsubscription-notification/unsubscription-notification-serialiser":240,"./update-topic/update-topic-request":245,"./update-topic/update-topic-request-serialiser":244,"./update-topic/update-topic-response":247,"./update-topic/update-topic-response-serialiser":246,"./wills/topic-will-parameters":251,"./wills/topic-will-parameters-serialiser":250,"./wills/will-registration-result":253,"./wills/will-registration-result-serialiser":252,hashmap:8,"serialisers/boolean-serialiser":150,"services/change-principal/change-principal-request":164,"services/change-principal/change-principal-request-serialiser":163,"services/command-error":166,"services/command-error-serialiser":165,"services/command-header":168,"services/command-header-serialiser":167,"services/control-client/client-filter-subscribe-request":170,"services/control-client/client-filter-subscribe-request-serialiser":169,"services/control-client/client-filter-subscribe-response":172,"services/control-client/client-filter-subscribe-response-serialiser":171,"services/control-client/client-subscribe-request":174,"services/control-client/client-subscribe-request-serialiser":173,"services/control/control-registration-request":178,"services/control/control-registration-request-serialiser":177,"services/control/get-session-properties":180,"services/control/get-session-properties-serialiser":179,"services/control/message-receiver-control-registration-params":182,"services/control/message-receiver-control-registration-params-serialiser":181,"services/control/message-receiver-control-registration-request":184,"services/control/message-receiver-control-registration-request-serialiser":183,"services/control/session-properties-event":190,"services/control/session-properties-event-batch":187,"services/control/session-properties-event-batch-serialiser":186,"services/control/session-properties-event-serialiser":188,"services/control/set-session-properties-listener":192,"services/control/set-session-properties-listener-serialiser":191,"services/control/topic-control-registration-params":194,"services/control/topic-control-registration-params-serialiser":193,"services/control/topic-control-registration-request":196,"services/control/topic-control-registration-request-serialiser":195,"services/error-report":198,"services/error-report-serialiser.js":197,"services/fetch/fetch-request":200,"services/fetch/fetch-request-serialiser":199,"services/missing-topic/missing-topic-request":204,"services/missing-topic/missing-topic-request-serialiser":203,"services/topic-update/update-source-delta-request":225,"services/topic-update/update-source-delta-request-serialiser":224,"services/topic-update/update-source-deregistration-request":227,"services/topic-update/update-source-deregistration-request-serialiser":226,"services/topic-update/update-source-registration-request":229,"services/topic-update/update-source-registration-request-serialiser":228,"services/topic-update/update-source-set-request":231,"services/topic-update/update-source-set-request-serialiser":230,"services/topic-update/update-source-state":235,"services/topic-update/update-source-state-request":233,"services/topic-update/update-source-state-request-serialiser":232,"services/topic-update/update-source-state-serialiser":234,"services/topic-update/update-source-update":239,"services/topic-update/update-source-update-response":237,"services/topic-update/update-source-update-response-serialiser":236,"services/topic-update/update-source-update-serialiser":238,"services/update-topic/update-topic-delta-request":243,"services/update-topic/update-topic-delta-request-serialiser":242,"services/update-topic/update-topic-set-request":249,"services/update-topic/update-topic-set-request-serialiser":248,"session/session-id":255,"session/session-id-serialiser":254,"topics/topic-selector-serialiser":269}],221:[function(require,module,exports){var TopicSelector=require("../../selectors/topic-selector"),FetchRequest=require("services/fetch/fetch-request"),SubscriptionNotification=require("services/subscription-notification/subscription-notification"),UnsubscriptionNotification=require("services/unsubscription-notification/unsubscription-notification"),GetTopicDetails=require("services/get-topic-details/get-topic-details"),AddTopic=require("services/add-topic/add-topic"),RemoveTopic=require("services/remove-topic/remove-topic"),UpdateTopicRequest=require("services/update-topic/update-topic-request"),UpdateTopicSetRequest=require("services/update-topic/update-topic-set-request"),UpdateTopicDeltaRequest=require("services/update-topic/update-topic-delta-request"),UpdateTopicResponse=require("services/update-topic/update-topic-response"),ClientSubscribeRequest=require("services/control-client/client-subscribe-request"),ClientFilterSubscribeRequest=require("services/control-client/client-filter-subscribe-request"),ClientFilterSubscribeResponse=require("services/control-client/client-filter-subscribe-response"),SecurityCommandScript=require("services/authentication/security-command-script"),SecurityCommandScriptResult=require("services/authentication/security-command-script-result"),SecurityConfiguration=require("../../features/security").SecurityConfiguration,SystemAuthenticationConfiguration=require("../../features/security").SystemAuthenticationConfiguration,TopicWillParameters=require("services/wills/topic-will-parameters"),WillRegistrationResult=require("services/wills/will-registration-result"),SendRequest=require("services/send/send-request"),SessionSendRequest=require("services/send/session-send-request"),TopicControlRegistrationRequest=require("services/control/topic-control-registration-request"),TopicControlRegistrationParams=require("services/control/topic-control-registration-params"),UpdateSourceRegistrationRequest=require("services/topic-update/update-source-registration-request"),UpdateSourceDeregistrationRequest=require("services/topic-update/update-source-deregistration-request"),UpdateSourceUpdate=require("services/topic-update/update-source-update"),UpdateSourceSetRequest=require("services/topic-update/update-source-set-request"),UpdateSourceDeltaRequest=require("services/topic-update/update-source-delta-request"),UpdateSourceUpdateResponse=require("services/topic-update/update-source-update-response"),UpdateSourceStateRequest=require("services/topic-update/update-source-state-request"),UpdateSourceState=require("services/topic-update/update-source-state"),ControlRegistrationRequest=require("services/control/control-registration-request"),ControlRegistrationParams=require("services/control/control-registration-params"),ChangePrincipalRequest=require("services/change-principal/change-principal-request"),SessionForwardSendRequest=require("services/send/session-forward-send-request"),MessageReceiverControlRegistrationRequest=require("services/control/message-receiver-control-registration-request"),MessageReceiverControlRegistrationParams=require("services/control/message-receiver-control-registration-params"),FilterSendRequest=require("services/send/filter-send-request"),FilterSendResult=require("services/send/filter-send-result"),GetSessionProperties=require("services/control/get-session-properties"),SetSessionPropertiesListener=require("services/control/set-session-properties-listener"),SessionPropertiesEvent=require("services/control/session-properties-event"),SessionPropertiesEventBatch=require("services/control/session-properties-event-batch"),MissingTopicRequest=require("services/missing-topic/missing-topic-request");module.exports={FETCH:{id:2,name:"Fetch",request:FetchRequest,response:null},SUBSCRIBE:{id:3,name:"Subscribe",request:TopicSelector,response:null},UNSUBSCRIBE:{id:4,name:"Unsubscribe",request:TopicSelector,response:null},SUBSCRIBE_CLIENT:{id:10,name:"Subscribe session",request:ClientSubscribeRequest,response:null},UNSUBSCRIBE_CLIENT:{id:11,name:"Unsubscribe session",request:ClientSubscribeRequest,response:null},SEND:{id:6,name:"Send",request:SendRequest,response:null},SEND_TO_SESSION:{id:28,name:"Send to session",request:SessionSendRequest,response:null},SUBSCRIPTION_NOTIFICATION:{id:40,name:"Subscription Notification",request:SubscriptionNotification,response:null},GET_TOPIC_DETAILS:{id:41,name:"Get Topic Details",request:GetTopicDetails,response:GetTopicDetails},UNSUBSCRIPTION_NOTIFICATION:{id:42,name:"Unsubscription Notification",request:UnsubscriptionNotification,response:null},ADD_TOPIC:{id:46,name:"Add Topic",request:AddTopic,response:AddTopic},REMOVE_TOPIC:{id:47,name:"Remove Topic",request:RemoveTopic,response:null},MISSING_TOPIC:{id:50,name:"Missing topic",request:MissingTopicRequest,response:Boolean},TOPIC_SCOPED_WILL_REGISTRATION:{id:53,name:"Topic Will Registration",request:TopicWillParameters,response:WillRegistrationResult},TOPIC_SCOPED_WILL_DEREGISTRATION:{id:54,name:"Topic Will Deregistration",request:TopicWillParameters,response:null},SYSTEM_PING:{id:55,name:"System Ping",request:null,response:null},USER_PING:{id:56,name:"User Ping",request:null,response:null},CHANGE_PRINCIPAL:{id:5,name:"Change Principal",request:ChangePrincipalRequest,response:Boolean},GET_SYSTEM_AUTHENTICATION:{id:57,name:"Get System Authentication",request:null,response:SystemAuthenticationConfiguration},UPDATE_SYSTEM_AUTHENTICATION:{id:58,name:"Update System Authentication",request:SecurityCommandScript,response:SecurityCommandScriptResult},GET_SECURITY_CONFIGURATION:{id:59,name:"Get Security Configuration",request:null,response:SecurityConfiguration},UPDATE_SECURITY_CONFIGURATION:{id:60,name:"Update Security Configuration",request:SecurityCommandScript,response:SecurityCommandScriptResult},UPDATE_TOPIC:{id:61,name:"Update Topic",request:UpdateTopicRequest,response:UpdateTopicResponse},SERVER_CONTROL_REGISTRATION:{id:18,name:"Server Control Registration",request:ControlRegistrationRequest,response:null},SERVER_CONTROL_DEREGISTRATION:{id:19,name:"Server Control Deregistration",request:ControlRegistrationParams,response:null},TOPIC_CONTROL_REGISTRATION:{id:20,name:"Topic Control Registration",request:TopicControlRegistrationRequest,response:null},TOPIC_CONTROL_DEREGISTRATION:{id:21,name:"Topic Control Deregistration",request:TopicControlRegistrationParams,response:null},UPDATE_SOURCE_REGISTRATION:{id:30,name:"Update Source Registration",request:UpdateSourceRegistrationRequest,response:UpdateSourceState},UPDATE_SOURCE_DEREGISTRATION:{id:31,name:"Update Source Deregistration",request:UpdateSourceDeregistrationRequest,response:null},UPDATE_SOURCE_STATE:{id:32,name:"Update Source State",request:UpdateSourceStateRequest,response:null},UPDATE_SOURCE_UPDATE:{id:35,name:"Update Source Update",request:UpdateSourceUpdate,response:UpdateSourceUpdateResponse},SEND_RECEIVER_CLIENT:{id:62,name:"Control Client Send Service",request:SessionForwardSendRequest,response:null},MESSAGE_RECEIVER_CONTROL_REGISTRATION:{id:63,name:"Message Receiver Control Registration",request:MessageReceiverControlRegistrationRequest,response:null},MESSAGE_RECEIVER_CONTROL_DEREGISTRATION:{id:64,name:"Message Receiver Control Deregistration",request:MessageReceiverControlRegistrationParams,response:null},FILTER_SUBSCRIBE:{id:65,name:"Subscribe to filter",request:ClientFilterSubscribeRequest,response:ClientFilterSubscribeResponse},FILTER_UNSUBSCRIBE:{id:66,name:"Unsubscribe from filter",request:ClientFilterSubscribeRequest,response:ClientFilterSubscribeResponse},SEND_TO_FILTER:{id:29,name:"Send to filter",request:FilterSendRequest,response:FilterSendResult},GET_SESSION_PROPERTIES:{id:67,name:"Get session properties",request:GetSessionProperties,response:GetSessionProperties},SESSION_PROPERTIES_REGISTRATION:{id:69,name:"Set session properties listener - legacy, see SESSION_PROPERTIES_REGISTRATION_2",request:SetSessionPropertiesListener,response:null},SESSION_PROPERTIES_EVENT:{id:70,name:"Session properties event - legacy, see SESSION_PROPERTIES_EVENT_2",request:SessionPropertiesEvent,response:null},UPDATE_SOURCE_SET:{id:77,name:"Update source set",request:UpdateSourceSetRequest,response:UpdateSourceUpdateResponse},UPDATE_SOURCE_DELTA:{id:78,name:"Update source delta",request:UpdateSourceDeltaRequest,response:UpdateSourceUpdateResponse},UPDATE_TOPIC_SET:{id:79,name:"Update topic set",request:UpdateTopicSetRequest,response:UpdateTopicResponse},UPDATE_TOPIC_DELTA:{id:80,name:"Update topic delta",request:UpdateTopicDeltaRequest,response:UpdateTopicResponse},SESSION_PROPERTIES_REGISTRATION_2:{id:81,name:"Session Properties registration 2",request:SetSessionPropertiesListener,response:null},SESSION_PROPERTIES_EVENT_2:{id:82,name:"Session Properties event 2",request:SessionPropertiesEventBatch,response:null},TOPIC_REMOVAL:{id:83,name:"Topic removal",request:RemoveTopic,response:null}}},{"../../features/security":51,"../../selectors/topic-selector":296,"services/add-topic/add-topic":155,"services/authentication/security-command-script":160,"services/authentication/security-command-script-result":158,"services/change-principal/change-principal-request":164,"services/control-client/client-filter-subscribe-request":170,"services/control-client/client-filter-subscribe-response":172,"services/control-client/client-subscribe-request":174,"services/control/control-registration-params":176,"services/control/control-registration-request":178,"services/control/get-session-properties":180,"services/control/message-receiver-control-registration-params":182,"services/control/message-receiver-control-registration-request":184,"services/control/session-properties-event":190,"services/control/session-properties-event-batch":187,"services/control/set-session-properties-listener":192,"services/control/topic-control-registration-params":194,"services/control/topic-control-registration-request":196,"services/fetch/fetch-request":200,"services/get-topic-details/get-topic-details":202,"services/missing-topic/missing-topic-request":204,"services/remove-topic/remove-topic":206,"services/send/filter-send-request":210,"services/send/filter-send-result":212,"services/send/send-request":215,"services/send/session-forward-send-request":217,"services/send/session-send-request":219,"services/subscription-notification/subscription-notification":223,"services/topic-update/update-source-delta-request":225,"services/topic-update/update-source-deregistration-request":227,"services/topic-update/update-source-registration-request":229,"services/topic-update/update-source-set-request":231,"services/topic-update/update-source-state":235,"services/topic-update/update-source-state-request":233,"services/topic-update/update-source-update":239,"services/topic-update/update-source-update-response":237,"services/unsubscription-notification/unsubscription-notification":241,"services/update-topic/update-topic-delta-request":243,"services/update-topic/update-topic-request":245,"services/update-topic/update-topic-response":247,"services/update-topic/update-topic-set-request":249,"services/wills/topic-will-parameters":251,"services/wills/will-registration-result":253}],222:[function(require,module,exports){var TopicInfoSerialiser=require("topics/details/topic-info-serialiser"),SubscriptionNotification=require("./subscription-notification");module.exports={read:function(input){var info=TopicInfoSerialiser.read(input);return new SubscriptionNotification(info)},write:function(out,notification){TopicInfoSerialiser.write(out,notification.info)}}},{"./subscription-notification":223,"topics/details/topic-info-serialiser":262}],223:[function(require,module,exports){function SubscriptionNotification(info){this.info=info}module.exports=SubscriptionNotification},{}],224:[function(require,module,exports){var CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec");module.exports={read:function(bis){return{cid:CIDSerialiser.read(bis),path:bis.readString(),id:bis.readInt32(),bytes:bis.readBytes()}},write:function(bos,req){CIDSerialiser.write(bos,req.cid),Codec.writeString(bos,req.path),Codec.writeInt32(bos,req.id),Codec.writeBytes(bos,req.bytes)}}},{"conversation/conversation-id-serialiser":83,"io/codec":125}],225:[function(require,module,exports){module.exports=function(cid,path,id,bytes){this.cid=cid,this.path=path,this.id=id,this.bytes=bytes}},{}],226:[function(require,module,exports){var CIDSerialiser=require("conversation/conversation-id-serialiser");module.exports={read:function(input){var cid=CIDSerialiser.read(input);return{cid:cid}},write:function(output,req){CIDSerialiser.write(output,req.cid)}}},{"conversation/conversation-id-serialiser":83}],227:[function(require,module,exports){module.exports=function(cid){this.cid=cid}},{}],228:[function(require,module,exports){var CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec");module.exports={read:function(input){var cid=CIDSerialiser.read(input),path=Codec.readString(input);return{cid:cid,path:path}},write:function(output,req){CIDSerialiser.write(output,req.cid),Codec.writeString(output,req.path)}}},{"conversation/conversation-id-serialiser":83,"io/codec":125}],229:[function(require,module,exports){module.exports=function(cid,path){this.cid=cid,this.path=path}},{}],230:[function(require,module,exports){var CIDSerialiser=require("conversation/conversation-id-serialiser"),Codec=require("io/codec");module.exports={read:function(bis){return{cid:CIDSerialiser.read(bis),path:bis.readString(),bytes:bis.readBytes()}},write:function(bos,req){CIDSerialiser.write(bos,req.cid),Codec.writeString(bos,req.path),Codec.writeBytes(bos,req.bytes)}}},{"conversation/conversation-id-serialiser":83,"io/codec":125}],231:[function(require,module,exports){module.exports=function(cid,path,bytes){this.cid=cid,this.path=path,this.bytes=bytes}},{}],232:[function(require,module,exports){var UpdateStateSerialiser=require("services/topic-update/update-source-state-serialiser"),CIDSerialiser=require("conversation/conversation-id-serialiser");module.exports={read:function(input){var cid=CIDSerialiser.read(input),old=UpdateStateSerialiser.read(input),current=UpdateStateSerialiser.read(input);return{cid:cid,old:old,current:current}},write:function(output,req){CIDSerialiser.write(output,req.cid),UpdateStateSerialiser.write(output,req.old),UpdateStateSerialiser.write(output,req.current)}}},{"conversation/conversation-id-serialiser":83,"services/topic-update/update-source-state-serialiser":234}],233:[function(require,module,exports){module.exports=function(cid,old,current){this.cid=cid,this.old=old,this.current=current}},{}],234:[function(require,module,exports){var EnumSerialiser=require("serialisers/enum-converter"),State={init:0,active:1,closed:2,standby:3};module.exports={read:function(input){return EnumSerialiser.read(input,State)},write:function(output,req){EnumSerialiser.write(output,req,State)}}},{"serialisers/enum-converter":152}],235:[function(require,module,exports){module.exports=function(state){this.state=state}},{}],236:[function(require,module,exports){var UpdateSourceUpdateResponse=require("services/topic-update/update-source-update-response"),EnumSerialiser=require("serialisers/enum-converter"),Codec=require("io/codec"),ResponseCodes={SUCCESS:0,INCOMPATIBLE_UPDATE:1,UPDATE_FAILED:2,INVALID_UPDATER:3,MISSING_TOPIC:4,INVALID_ADDRESS:5,DUPLICATES:6,EXCLUSIVE_UPDATER_CONFLICT:7};module.exports={read:function(input){if(0===Codec.readByte(input))return new UpdateSourceUpdateResponse;var error=EnumSerialiser.read(input,ResponseCodes);return new UpdateSourceUpdateResponse(error)},write:function(output,req){req.error?(Codec.writeByte(output,1),EnumSerialiser.write(output,req.error,ResponseCodes)):Codec.writeByte(output,0)}}},{"io/codec":125,"serialisers/enum-converter":152,"services/topic-update/update-source-update-response":237}],237:[function(require,module,exports){module.exports=function(error){this.error=error}},{}],238:[function(require,module,exports){var CIDSerialiser=require("conversation/conversation-id-serialiser"),UpdateSerialiser=require("update/serialiser"),Codec=require("io/codec");module.exports={read:function(input){var cid=CIDSerialiser.read(input),path=Codec.readString(input),val=UpdateSerialiser.read(input);return{cid:cid,path:path,update:val}},write:function(output,req){CIDSerialiser.write(output,req.cid),Codec.writeString(output,req.path),UpdateSerialiser.write(output,req.update)}}},{"conversation/conversation-id-serialiser":83,"io/codec":125,"update/serialiser":275}],239:[function(require,module,exports){module.exports=function(cid,path,update){this.cid=cid,this.path=path,this.update=update}},{}],240:[function(require,module,exports){var UnsubscribeReason=require("../../../topics/topics").UnsubscribeReason,TopicIdSerialiser=require("topics/details/topic-id-serialiser"),UnsubscriptionNotification=require("./unsubscription-notification"),ByteEncodedEnumSerialiser=require("serialisers/byte-encoded-enum-serialiser");module.exports={read:function(input){var id=TopicIdSerialiser.read(input),reason=ByteEncodedEnumSerialiser.read(input,UnsubscribeReason);return new UnsubscriptionNotification(id,reason)},write:function(out,notification){TopicIdSerialiser.write(out,notification.id),ByteEncodedEnumSerialiser.write(out,notification.reason)}}},{"../../../topics/topics":299,"./unsubscription-notification":241,"serialisers/byte-encoded-enum-serialiser":151,"topics/details/topic-id-serialiser":261}],241:[function(require,module,exports){function UnsubscriptionNotification(id,reason){this.id=id,this.reason=reason}module.exports=UnsubscriptionNotification},{}],242:[function(require,module,exports){var Codec=require("io/codec");module.exports={read:function(bis){return{path:bis.readString(),id:bis.readInt32(),bytes:bis.readBytes()}},write:function(bos,req){Codec.writeString(bos,req.path),Codec.writeInt32(bos,req.id),Codec.writeBytes(bos,req.bytes)}}},{"io/codec":125}],243:[function(require,module,exports){module.exports=function(path,id,bytes){this.path=path,this.id=id,this.bytes=bytes}},{}],244:[function(require,module,exports){var UpdateSerialiser=require("../../update/serialiser"),Codec=require("io/codec");module.exports={read:function(input){return{path:Codec.readString(input),update:UpdateSerialiser.read(input)}},write:function(output,request){Codec.writeString(output,request.path),UpdateSerialiser.write(output,request.update)}}},{"../../update/serialiser":275,"io/codec":125}],245:[function(require,module,exports){module.exports=function(path,update){this.path=path,this.update=update}},{}],246:[function(require,module,exports){var BEES=(require("io/codec"),require("serialisers/byte-encoded-enum-serialiser")),UpdateTopicResponse=require("./update-topic-response");module.exports={read:function(input){var reason=BEES.read(input,UpdateTopicResponse);return{reason:reason,isError:reason!==UpdateTopicResponse.SUCCESS}},write:function(output,request){BEES.write(output,request.reason)}}},{"./update-topic-response":247,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],247:[function(require,module,exports){module.exports={SUCCESS:{id:0,reason:"The update was succesful"},INCOMPATIBLE_UPDATE:{id:1,reason:"The update value was incompatible with the topic type"},UPDATE_FAILED:{id:2,reason:"The update could not be applied"},INVALID_UPDATER:{id:3,reason:"The updater was invalid for updating this topic"},MISSING_TOPIC:{id:4,reason:"The specified topic does not exist"},INVALID_ADDRESS:{id:5,reason:"The update for a Paged Topic contained an invalid index"},DUPLICATES:{id:6,reason:"The update for a Paged Topic contained invalid duplicate items"},EXCLUSIVE_UPDATER_CONFLICT:{id:7,reason:"An exclusive update source is already registered for the topic branch"},DELTA_WITHOUT_VALUE:{id:8,reason:"A delta was applied to a topic that does not yet have a value"}}},{}],248:[function(require,module,exports){var Codec=require("io/codec");module.exports={read:function(bis){return{path:bis.readString(),bytes:bis.readBytes()}},write:function(bos,req){Codec.writeString(bos,req.path),Codec.writeBytes(bos,req.bytes)}}},{"io/codec":125}],249:[function(require,module,exports){module.exports=function(path,bytes){this.path=path,this.bytes=bytes}},{}],250:[function(require,module,exports){var BEES=require("serialisers/byte-encoded-enum-serialiser"),TopicWillParameters=require("./topic-will-parameters"),Codec=require("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),will=BEES.read(input,TopicWillParameters.Will);return new TopicWillParameters(path,will)},write:function(out,params){Codec.writeString(out,params.path),BEES.write(out,params.will)}};module.exports=serialiser},{"./topic-will-parameters":251,"io/codec":125,"serialisers/byte-encoded-enum-serialiser":151}],251:[function(require,module,exports){function TopicWillParameters(path,will){this.path=path,this.will=will}var Will={REMOVE_TOPICS:0};TopicWillParameters.prototype.toString=function(){return"TopicWillParams ["+this.will+", "+this.path+"]"},TopicWillParameters.Will=Will,module.exports=TopicWillParameters},{}],252:[function(require,module,exports){var BEES=require("serialisers/byte-encoded-enum-serialiser"),WillRegistrationResult=require("./will-registration-result"),serialiser={read:function(input){return BEES.read(input,WillRegistrationResult)},write:function(output,result){BEES.write(output,result)}};module.exports=serialiser},{"./will-registration-result":253,"serialisers/byte-encoded-enum-serialiser":151}],253:[function(require,module,exports){var WillRegistrationResult={SUCCESS:0,GROUP_CONFLICT:1,TOPIC_TREE_CONFLICT:2};WillRegistrationResult.toString=function(){return"WillRegistrationResult"},module.exports=WillRegistrationResult},{}],254:[function(require,module,exports){var SessionID=require("session/session-id"),Codec=require("io/codec"),serialiser={read:function(input){var server=Codec.readInt64(input),value=Codec.readInt64(input);return new SessionID(server,value)},write:function(output,sessionID){Codec.writeInt64(output,sessionID.server),Codec.writeInt64(output,sessionID.value)}};module.exports=serialiser},{"io/codec":125,"session/session-id":255}],255:[function(require,module,exports){function SessionId(server,value){this.server=server,this.value=value}var Long=require("long"),padding="0000000000000000";SessionId.prototype.toString=function(){var server=padding+this.server.toUnsigned().toString(16),client=padding+this.value.toUnsigned().toString(16);return(server.substr(server.length-16)+"-"+client.substr(client.length-16)).toLowerCase()},SessionId.prototype.toValue=function(){return this.toString()},SessionId.fromString=function(str){var sessionId,parts=str.split("-");try{var server=Long.fromString(parts[0],!1,16),value=Long.fromString(parts[1],!1,16);sessionId=new SessionId(server,value)}catch(e){throw new Error("SessionId must consist of two hexadecimal parts, joined with a '-'")}return sessionId},SessionId.prototype.equals=function(sessionid){if(!(sessionid instanceof SessionId&&sessionid.server instanceof Long&&sessionid.value instanceof Long))return!1;return 0===this.server.compare(sessionid.server)&&0===this.value.compare(sessionid.value)},SessionId.validate=function(str){if(str instanceof SessionId)return str;if(0===str.length||str.indexOf("-")<0||str.indexOf(" ")>=0)return!1;try{return SessionId.fromString(str)}catch(e){return!1}},module.exports=SessionId},{long:11}],256:[function(require,module,exports){function SessionImpl(options){var emitter=new Emitter((void 0),(void 0),["connect","reconnect","disconnect"]),serviceRegistry=new ServiceRegistry,conversationSet=new DelegatingConversationSet(LoggingErrorHandler);options=new Options("string"==typeof options?{host:options}:options),serviceRegistry.add(Services.USER_PING,PingService),serviceRegistry.add(Services.SYSTEM_PING,MonitoredPingService),serviceRegistry.add(Services.SUBSCRIPTION_NOTIFICATION,NotifySubscriptionService),serviceRegistry.add(Services.UNSUBSCRIPTION_NOTIFICATION,NotifyUnsubscriptionService);var internalSession=new InternalSession(conversationSet,serviceRegistry,ConnectionFactory,options),session=new Session(internalSession,emitter,options.with({credentials:void 0}));session.on("error",internalSession.close),internalSession.on({connect:function(sessionID){session.sessionID=sessionID.toString(),emitter.emit("connect",session)},reconnect:function(){emitter.emit("reconnect")},disconnect:function(reason){emitter.emit("disconnect",reason)},error:function(err){emitter.emit("error",err)},close:function(reason){emitter.emit("close",reason)}}),this.connect=function(){internalSession.connect()},this.get=function(){return session}}var Emitter=require("events/emitter"),InternalSession=require("client/internal-session"),ServiceRegistry=require("client/service-registry"),ConnectionFactory=require("v4-stack/connection-factory"),LoggingErrorHandler=require("conversation/logging-error-handler"),DelegatingConversationSet=require("conversation/delegating-conversation-set"),Services=require("services/services"),MonitoredPingService=require("client/services/monitored-ping-service"),PingService=require("client/services/ping-service"),NotifySubscriptionService=require("client/services/notify-subscription-service"),NotifyUnsubscriptionService=require("client/services/notify-unsubscription-service"),Options=require("../../options"),Session=require("../../session");module.exports=SessionImpl},{"../../options":295,"../../session":298,"client/internal-session":64,"client/service-registry":67,"client/services/monitored-ping-service":68,"client/services/notify-subscription-service":69,"client/services/notify-unsubscription-service":70,"client/services/ping-service":71,"conversation/delegating-conversation-set":87,"conversation/logging-error-handler":88,"events/emitter":103,"services/services":221,"v4-stack/connection-factory":290}],257:[function(require,module,exports){function readToken(input){return new SessionToken(input.readMany(SessionToken.TOKEN_LENGTH))}var SessionToken=require("session/session-token");module.exports=readToken},{"session/session-token":258}],258:[function(require,module,exports){(function(Buffer){function SessionToken(external){this.put=function(destination){destination.writeBytes(external)},this.toString=function(){return external.toString("ascii")}}var TOKEN_LENGTH=24;SessionToken.fromExternalString=function(external){return new SessionToken(new Buffer(external,"ascii"))},SessionToken.TOKEN_LENGTH=TOKEN_LENGTH,module.exports=SessionToken}).call(this,require("buffer").Buffer)},{buffer:2}],259:[function(require,module,exports){var Codec=require("io/codec"),serialiser=require("schema/serialiser"),BEES=require("serialisers/byte-encoded-enum-serialiser"),TopicType=require("../../../topics/topics").TopicType;module.exports={read:function(input){var details={};return Codec.readBoolean(input)&&(details.type=BEES.read(input,TopicType),Codec.readBoolean(input)&&(details.schema=serialiser.read(input))),details},write:function(output,details){details?(Codec.writeBoolean(output,!0),BEES.write(output,details.type),details.schema&&(Codec.writeBoolean(output,!0),serialiser.write(output,details.schema)),Codec.writeBoolean(output,!1)):Codec.writeBoolean(output,!1)}}},{"../../../topics/topics":299,"io/codec":125,"schema/serialiser":148,"serialisers/byte-encoded-enum-serialiser":151}],260:[function(require,module,exports){var TopicType=require("../../../topics/topics").TopicType,DataTypes=require("data/datatypes"),schema=require("schema/schema"),util=require("metadata/util");module.exports.deriveDetails=function(value){var details={};for(var t in TopicType)if(TopicType[t]===value)return{type:value};if(util.isMetadataValue(value)){var meta=util.deriveMetadata(value);details.type=util.getType(meta),details.schema=schema(meta)}else{var datatype=DataTypes.get(value);details.type=TopicType[datatype.name().toUpperCase()],details.schema={},details.content=datatype.from(value)}return details}},{"../../../topics/topics":299,"data/datatypes":94,"metadata/util":134,"schema/schema":147}],261:[function(require,module,exports){var Codec=require("io/codec"),serialiser={read:function(bis){return Codec.readInt32(bis)},write:function(bos,id){Codec.writeInt32(bos,id)}};module.exports=serialiser},{"io/codec":125}],262:[function(require,module,exports){var Codec=require("io/codec"),TopicIdSerialiser=require("./topic-id-serialiser"),TopicDetailsSerialiser=require("./topic-details-serialiser"),serialiser={read:function(input){return{id:TopicIdSerialiser.read(input),path:Codec.readString(input),details:TopicDetailsSerialiser.read(input)}},write:function(out,info){TopicIdSerialiser.write(out,info.id),Codec.writeString(out,info.path),TopicDetailsSerialiser.write(out,info.details)}};module.exports=serialiser},{"./topic-details-serialiser":259,"./topic-id-serialiser":261,"io/codec":125}],263:[function(require,module,exports){function FullPathSelector(components){switch(components.qualifier){case DQ.MATCH:this.regex=regex(components.base);break;case DQ.DESCENDANTS_OF_MATCH:this.regex=regex(components.base+"/.+");break;case DQ.MATCH_AND_DESCENDANTS:this.regex=regex(components.base+"(?:$|/.+)")}TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=require("inherits"),regex=require("util/regex"),utils=require("topics/topic-path-utils"),TopicSelector=require("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(FullPathSelector,TopicSelector),FullPathSelector.prototype.doSelects=function(topicPath){return this.regex(topicPath)},module.exports=FullPathSelector},{"../../selectors/topic-selector":296,inherits:9,"topics/topic-path-utils":267,"util/regex":285}],264:[function(require,module,exports){function TopicPathSelector(components){var remainder=components.remainder;if(components.type===TopicSelector.Type.PATH){if(""===components.prefix)throw new Error("Topic path must have at least one part: "+remainder);if(components.prefix.indexOf("//")>-1)throw new Error("Topic path contains empty part: "+remainder)}this.qualifier=components.qualifier,this.path=components.prefix,TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=require("inherits"),utils=require("topics/topic-path-utils"),TopicSelector=require("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(TopicPathSelector,TopicSelector),TopicPathSelector.prototype.doSelects=function(topicPath){var match=this.path===topicPath,descendants=0===topicPath.indexOf(this.path+"/");switch(this.qualifier){case DQ.MATCH:return match;case DQ.DESCENDANTS_OF_MATCH:return descendants;case DQ.MATCH_AND_DESCENDANTS:return match||descendants;default:return!1}},module.exports=TopicPathSelector},{"../../selectors/topic-selector":296,inherits:9,"topics/topic-path-utils":267}],265:[function(require,module,exports){function extractCommonPrefix(selectors){if(0===selectors.length)return"";var minimum=2147483647,prefixes=[],i=0;selectors.forEach(function(selector){var part=utils.split(selector.prefix);minimum=Math.min(minimum,part.length),prefixes[i++]=part});var composite=[];assembly:for(var j=0;j<minimum;++j){for(var part=prefixes[0][j],k=0;k<prefixes.length;++k)if(part!==prefixes[k][j])break assembly;composite.push(part),composite.push(utils.PATH_SEPARATOR)}return utils.canonicalise(composite.join(""))}function SelectorSet(selectors){var expanded=[];selectors.forEach(function(selector){selector instanceof SelectorSet?selector.selectors.forEach(function(nested){expanded.push(nested)}):expanded.push(selector)}),this.selectors=expanded;var remainder=expanded.join(DELIMITER),prefix=extractCommonPrefix(expanded);TopicSelector.call(this,TopicSelector.Type.SELECTOR_SET,prefix,TopicSelector.Prefix.SELECTOR_SET+remainder)}var inherits=require("inherits"),utils=require("topics/topic-path-utils"),TopicSelector=require("../../selectors/topic-selector"),DELIMITER="////";SelectorSet.DELIMITER=DELIMITER,inherits(SelectorSet,TopicSelector),SelectorSet.prototype.selects=function(topicPath){for(var i=0;i<this.selectors.length;++i)if(this.selectors[i].selects(topicPath))return!0;return!1},module.exports=SelectorSet},{"../../selectors/topic-selector":296,inherits:9,"topics/topic-path-utils":267}],266:[function(require,module,exports){function SplitPathSelector(components){this.qualifier=components.qualifier,this.patterns=[];var parts=utils.split(components.base);parts.forEach(function(p){this.patterns.push(regex(p))}.bind(this)),TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=require("inherits"),regex=require("util/regex"),utils=require("topics/topic-path-utils"),TopicSelector=require("../../selectors/topic-selector"),DQ=utils.DescendantQualifier;inherits(SplitPathSelector,TopicSelector),SplitPathSelector.prototype.doSelects=function(topicPath){var length=this.patterns.length,parts=topicPath.split(utils.PATH_SEPARATOR);switch(this.qualifier){case DQ.MATCH:if(parts.length!==length)return!1;break;case DQ.DESCENDANTS_OF_MATCH:if(parts.length<=length)return!1;break;case DQ.MATCH_AND_DESCENDANTS:if(parts.length<length)return!1}for(var i=0;i<length;++i)if(!this.patterns[i](parts[i]))return!1;return!0},module.exports=SplitPathSelector},{"../../selectors/topic-selector":296,inherits:9,"topics/topic-path-utils":267,"util/regex":285}],267:[function(require,module,exports){function split(path){return path.split(PATH_SEPARATOR)}function canonicalise(path){if(!path)return"";var l=path.length,s=l>0&&path.charAt(0)===PATH_SEPARATOR?1:0,e=l>1&&path.charAt(l-1)===PATH_SEPARATOR?1:0;return path.substring(s,l-e)}function DQ(descendants){this.includesDescendants=descendants}var PATH_SEPARATOR="/",qualifiers={MATCH:new DQ((!1)),DESCENDANTS_OF_MATCH:new DQ((!0)),MATCH_AND_DESCENDANTS:new DQ((!0))};module.exports={split:split,canonicalise:canonicalise,PATH_SEPARATOR:PATH_SEPARATOR,DescendantQualifier:qualifiers}},{}],268:[function(require,module,exports){function parse(expression){if(!expression)throw new Error("Empty topic selector expression");if(arguments.length>1&&(expression=arr.argumentsToArray(arguments)),expression instanceof Array){var actual=[];return expression.forEach(function(s){s instanceof TopicSelector?actual.push(s):actual.push(parse(s))}),new SelectorSet(actual)}if("string"==typeof expression){var components=getComponents(expression);if(isTopicPath(components))return new PathSelector(components);switch(components.type){case T.SPLIT_PATH_PATTERN:return new SplitPathSelector(components);case T.FULL_PATH_PATTERN:return new FullPathSelector(components);case T.SELECTOR_SET:var parts=split(components.remainder,SelectorSet.DELIMITER),selectors=[];return parts.forEach(function(e){selectors.push(parse(e))}),new SelectorSet(selectors)}}throw new Error("Topic selector expression must be a string or array")}function getComponents(expression){var type=getType(expression);null===type&&(expression=P.PATH+expression,type=T.PATH);var qualifier,prefix,base,remainder=expression.substring(1);return type===T.PATH?(base=remainder,qualifier=DQ.MATCH):"/"===remainder[remainder.length-1]?"/"===remainder[remainder.length-2]?(qualifier=DQ.MATCH_AND_DESCENDANTS,base=utils.canonicalise(remainder.substring(0,remainder.length-2))):(qualifier=DQ.DESCENDANTS_OF_MATCH,base=utils.canonicalise(remainder.substring(0,remainder.length-1))):(base=utils.canonicalise(remainder),qualifier=DQ.MATCH),prefix=type===T.PATH?utils.canonicalise(remainder):extractPrefixFromRegex(base),{type:type,base:base,prefix:prefix,remainder:remainder,qualifier:qualifier,expression:type+remainder}}function isTopicPath(c){if(c.type===T.PATH)return!0;if(c.type===T.SELECTOR_SET||""===c.prefix)return!1;return c.prefix===c.base}function getType(expression){switch(expression[0]){case P.PATH:return T.PATH;case P.SPLIT_PATH_PATTERN:return T.SPLIT_PATH_PATTERN;case P.FULL_PATH_PATTERN:return T.FULL_PATH_PATTERN;case P.SELECTOR_SET:return T.SELECTOR_SET;case"$":case"%":case"&":case"<":throw new Error("Invalid expression type: "+expression);default:return null}}function extractPrefixFromRegex(remainder){for(var buffer=[],composite=[],validator=normal,i=0,l=remainder.length;i<l;++i){var char=remainder[i];if("\\"===char&&i<l-1){var next=remainder[i+1];if(validator===normal&&"Q"===next)validator=quoted;else if(validator===quoted&&"E"===next)validator=normal;else{if(!(next<"a"||next>"z")||!(next<"A"||next>"Z")){buffer.length=0;break}buffer.push(next)}i++}else{if(!validator(char)){buffer.length=0;break}char===utils.PATH_SEPARATOR&&(composite.push(buffer.join("")),buffer.length=0),buffer.push(char)}}return composite.push(buffer.join("")),utils.canonicalise(composite.join(""))}var split=require("util/string").split,cache=require("util/memoize"),arr=require("util/array"),TopicSelector=require("../../selectors/topic-selector"),utils=require("topics/topic-path-utils"),PathSelector=require("topics/path-selector"),SplitPathSelector=require("topics/split-path-selector"),FullPathSelector=require("topics/full-path-selector"),SelectorSet=require("topics/selector-set"),T=TopicSelector.Type,P=TopicSelector.Prefix,DQ=utils.DescendantQualifier,metaChars=["*",".","+","?","^","$","{","}","(",")","[","]","\\"],normal=function(c){return metaChars.indexOf(c)===-1},quoted=function(c){return!0};module.exports=cache(parse)},{"../../selectors/topic-selector":296,"topics/full-path-selector":263,"topics/path-selector":264,"topics/selector-set":265,"topics/split-path-selector":266,"topics/topic-path-utils":267,"util/array":277,"util/memoize":283,"util/string":287}],269:[function(require,module,exports){var Codec=require("io/codec"),parser=require("./topic-selector-parser"),topicSelectorSerialiser={read:function(input){return parser(Codec.readString(input))},write:function(out,selector){Codec.writeString(out,selector.expression)}};module.exports=topicSelectorSerialiser},{"./topic-selector-parser":268,"io/codec":125}],270:[function(require,module,exports){function parseResponse(onHandshakeSuccess,onHandshakeError,message){logger.trace("Received connection handshake response");var response;try{response=connectionResponseDeserialiser(message)}catch(e){return onHandshakeError(e),null}return onHandshakeSuccess(response)}var connectionResponseDeserialiser=require("protocol/connection-response-deserialiser"),logger=require("util/logger").create("Parsing");module.exports={connectionResponse:parseResponse}},{"protocol/connection-response-deserialiser":136,"util/logger":281}],271:[function(require,module,exports){function websocketSubTransportFactoryProvider(){return"undefined"!=typeof window&&window.WebSocket?(log.debug("Using native websocket"),{constructor:window.WebSocket,enabled:!0}):"function"==typeof NodeWebSocket?(log.debug("Using Node WS library"),{constructor:NodeWebSocket,enabled:!0}):(log.debug("Websocket transport not available"),{enabled:!1})}function xhrSubTransportFactoryProvider(){return"undefined"!=typeof window&&window.XMLHttpRequest?(log.debug("Using native XHR"),{constructor:window.XMLHttpRequest,enabled:!0}):(log.debug("XHR transport not available"),{enabled:!1})}var NodeWebSocket=require("ws"),log=require("util/logger").create("Transports");module.exports={WS:websocketSubTransportFactoryProvider(),XHR:xhrSubTransportFactoryProvider(),WEBSOCKET:websocketSubTransportFactoryProvider(),HTTP_POLLING:xhrSubTransportFactoryProvider()}},{"util/logger":281,ws:1}],272:[function(require,module,exports){function filterTransports(requestedTransports,subtransports){return requestedTransports.filter(function(name){return name&&knownTransports.hasOwnProperty(name)}).filter(function(name){return subtransports[name].enabled})}function isCascadableResponse(response){return response===ResponseCode.ERROR}function createTransport(subtransports,options,name){var transport=knownTransports[name],subtransport=subtransports[name];if(transport&&subtransport&&subtransport.enabled)return new transport(options,subtransport.constructor);throw new Error("Unknown transport name: "+name)}function CascadeDriver(subtransports,opts,transports,cascadeNotifications){function onData(data){emitter.emit("data",data)}function onClose(reason){if(!responseReceived&&cascade(!0))return;emitter.emit("close",reason)}function onError(error){emitter.emit("error",error)}function onConnectionResponse(response){if(responseReceived=!0,isCascadableResponse(response.response)&&cascade())return;return onHandshakeSuccess(response)}function onParsingError(error){if(responseReceived=!0,!cascade())return onHandshakeError(error)}function closeQuietly(){transport&&(transport.off("data",onData),transport.off("close",onClose),transport.off("error",onError),transport.close(),transport=null)}function selectTransport(suppressClose){if(0===transports.length)return self.name=null,transport=null,logger.debug("Transports exhausted"),cascadeNotifications.emit("transports-exhausted"),suppressClose||emitter.emit("close"),null;return self.name=transports.shift(),transport=transportFactory(self.name),logger.debug("Selecting transport",self.name),cascadeNotifications.emit("transport-selected",self.name),transport}function internalConnect(){responseReceived=!1,logger.debug("Attempting to connect"),cascadeNotifications.emit("cascading-connect"),transport.on("data",onData),transport.on("close",onClose),transport.on("error",onError);try{transport.connect(req,parsing.connectionResponse.bind(null,onConnectionResponse,onParsingError))}catch(e){if(!cascade())throw e}return!0}function cascade(suppressClose){if(closeQuietly(),!selectTransport(suppressClose))return!1;return cascadeNotifications.emit("cascade"),internalConnect()}var emitter=Emitter.assign(this),self=this;this.name=null;var req=null,onHandshakeSuccess=null,onHandshakeError=null,responseReceived=!1,transportFactory=createTransport.bind(null,subtransports,opts),transport=selectTransport();this.connect=function(request,handshake,handshakeError){req=request,onHandshakeSuccess=handshake,onHandshakeError=handshakeError,internalConnect()},this.dispatch=function(message){if(null===transport)throw new Error("Unable to send message when no transport is set");transport.dispatch(message)},this.close=function(){null!==transport&&(responseReceived=!0,transport.close(),transport=null)}}function Transports(subtransports){var emitter=Emitter.assign(this);this.get=function(options){var validTransports=filterTransports(options.transports,subtransports);if(0===validTransports.length)return null;return new CascadeDriver(subtransports,options,validTransports,emitter)}}var WSTransport=require("transports/ws"),XHRTransport=require("transports/xhr"),Emitter=(require("v4-stack/credential-tunnel").encodeAsString,require("events/emitter")),ResponseCode=(require("util/queue"),require("protocol/response-code")),standardSubtransports=(require("io/buffer-input-stream"),require("io/buffer-output-stream"),require("transports/subtransports")),parsing=require("transports/parsing"),logger=require("util/logger").create("Cascading"),knownTransports={WS:WSTransport,XHR:XHRTransport,WEBSOCKET:WSTransport,HTTP_POLLING:XHRTransport};Transports.create=function(subtransports){return new Transports(subtransports?subtransports:standardSubtransports)},module.exports=Transports},{"events/emitter":103,"io/buffer-input-stream":123,"io/buffer-output-stream":124,"protocol/response-code":138,"transports/parsing":270,"transports/subtransports":271,"transports/ws":273,"transports/xhr":274,"util/logger":281,"util/queue":284,"v4-stack/credential-tunnel":292}],273:[function(require,module,exports){(function(Buffer){function constructURI(req,opts){var scheme=opts.secure?"wss":"ws",uri=scheme+"://"+opts.host+":"+opts.port+opts.path;return uri+="?ty="+req.type,uri+="&v="+req.version,uri+="&ca="+req.capabilities,uri+="&r="+opts.reconnect.timeout,req.token&&(uri+="&c="+encodeURIComponent(req.token),uri+="&cs="+req.availableClientSequence,uri+="&ss="+req.lastServerSequence),opts.principal&&(uri+="&username="+encodeURIComponent(opts.principal),uri+="&password="+encodeURIComponent(encodeAsString(opts.credentials))),uri}function WSTransport(opts,constructor){var socket,emitter=Emitter.assign(this),handler=function(message){emitter.emit("data",new Buffer(new Uint8Array(message.data)))};this.connect=function(req,handshake){try{var uri=constructURI(req,opts);socket=new constructor(uri),log.debug("Created websocket",uri)}catch(error){throw new Error("Unable to construct WebSocket",error)}socket.binaryType="arraybuffer",socket.onmessage=function(msg){socket.onmessage=handler,handshake(new Buffer(new Uint8Array(msg.data)))},socket.onclose=emitter.close,socket.onerror=emitter.error},this.dispatch=function(message){log.trace("Sending websocket message");try{return socket.send(message),!0}catch(err){return log.error("Websocket send error",err),!1}},this.close=function(){log.debug("Closing websocket"),socket.close()}}var encodeAsString=require("v4-stack/credential-tunnel").encodeAsString,Emitter=require("events/emitter"),log=require("util/logger").create("Websocket transport");require("util/logger").curry;module.exports=WSTransport}).call(this,require("buffer").Buffer)},{buffer:2,"events/emitter":103,"util/logger":281,"v4-stack/credential-tunnel":292}],274:[function(require,module,exports){(function(Buffer){function constructURI(req,opts){var scheme=opts.secure?"https":"http",uri=scheme+"://"+opts.host+":"+opts.port+opts.path,headers={m:"0",ty:"B",ca:req.capabilities,r:opts.reconnect.timeout,v:req.version};return req.token&&(headers.c=encodeURIComponent(req.token),headers.cs=req.availableClientSequence,headers.ss=req.lastServerSequence),opts.principal&&(headers.username=encodeURIComponent(opts.principal),headers.password=encodeURIComponent(encodeAsString(opts.credentials))),{uri:uri,headers:headers}}function XHRTransport(opts,xhr){var token,URI,emitter=Emitter.assign(this),pollSequence=0,pingSequence=0,pollRequest=null,aborted=!1,isSending=!1,protocolVersion=null,self=this,queue=Queue.create(),constructor=xhr;this.connect=function(req,handshake){try{var url=constructURI(req,opts);protocolVersion=url.headers.v,URI=url.uri;var request=this.createRequest(url.headers,url.uri);log.debug("Created XHR",url.uri),request.onreadystatechange=function(){if(4===request.readyState)if(200===request.status){var handShakeData=request.responseText,serverResponse=handshake(new Buffer(handShakeData,"binary"));if(!serverResponse)return;token=serverResponse.token;var responseCode=serverResponse.response,isSuccesss=ResponseCode.isSuccess(responseCode);isSuccesss?self.poll():(log.debug(responseCode.id+" - "+responseCode.message),emitter.close())}else emitter.close()},request.send(null)}catch(error){throw new Error("Unable to create polling transport",error)}},this.close=function(){log.trace("Closing XHR transport"),pollRequest&&(aborted=!0,pollRequest.abort()),queue=Queue.create(),emitter.close()},this.createRequest=function(headers,uri){var request=new constructor;request.open("POST",uri,!0),request.overrideMimeType("text/plain; charset=x-user-defined");for(var header in headers)try{request.setRequestHeader(header,headers[header])}catch(e){log.warn("Can't set header "+header+":"+headers.join(":"))}return request},this.poll=function(){var request=this.createRequest({m:"1",c:token,s:pollSequence++,v:protocolVersion},URI);request.onreadystatechange=function(){if(4===request.readyState)if("reconnect"===request.getResponseHeader("diffusion-connection"))emitter.close();else if(200===request.status){for(var data=request.responseText,bis=new BufferInputStream(new Buffer(data,"base64"));bis.pos!==bis.count;){var type=bis.read(),length=bis.readInt32(),body=bis.readMany(length),payload=new Buffer(body.length+1);payload.writeInt8(type),body.copy(payload,1),emitter.emit("data",payload)}self.poll()}else emitter.close()},pollRequest=request,request.send(null)},this.dispatch=function(message){if(aborted)return!1;if(queue.add(message),isSending)return!0;self.flush()},this.flush=function(){if(queue.isEmpty())return;var buffer=drainToBuffer(queue.drain()),request=this.createRequest({m:"2",c:token,s:pingSequence++,v:protocolVersion},URI);request.onreadystatechange=function(){4===request.readyState&&("reconnect"===request.getResponseHeader("diffusion-connection")?emitter.close():200===request.status?(isSending=!1,self.flush()):emitter.close())},isSending=!0,request.send(buffer)}}function drainToBuffer(messages){for(var messagesBOS=new BufferOutputStream,i=0;i<messages.length;i++){var msg=messages[i];messagesBOS.writeInt32(msg.length),messagesBOS.writeMany(msg,0,msg.length)}return messagesBOS.getBuffer()}var encodeAsString=require("v4-stack/credential-tunnel").encodeAsString,Emitter=require("events/emitter"),Queue=require("util/queue"),ResponseCode=require("protocol/response-code"),BufferInputStream=require("io/buffer-input-stream"),BufferOutputStream=require("io/buffer-output-stream"),log=require("util/logger").create("XHR transport");module.exports=XHRTransport}).call(this,require("buffer").Buffer)},{buffer:2,"events/emitter":103,"io/buffer-input-stream":123,"io/buffer-output-stream":124,"protocol/response-code":138,"util/logger":281,"util/queue":284,"v4-stack/credential-tunnel":292}],275:[function(require,module,exports){var Update=require("./update"),BEES=require("serialisers/byte-encoded-enum-serialiser"),ContentSerialiser=require("../content/serialiser");module.exports={read:function(input){var type=BEES.read(Update.Type,input);switch(type){case Update.Type.CONTENT:var data=ContentSerialiser.read(input);return new Update(data);default:throw new Error("Received unimplemented update type "+type)}},write:function(output,update){switch(output.write(update.type),update.type){case Update.Type.CONTENT:output.write(output,update.action),ContentSerialiser.write(output,update.data);break;default:throw new Error("Trying to write unimplemented update type "+update.type)}}}},{"../content/serialiser":75,"./update":276,"serialisers/byte-encoded-enum-serialiser":151}],276:[function(require,module,exports){var UpdateType={CONTENT:0,PAGED_RECORD_ORDERED:1,PAGED_STRING_ORDERED:2,PAGED_RECORD_UNORDERED:3,PAGED_STRING_UNORDERED:4},UpdateAction={UPDATE:0,REPLACE:1},Update=function(data,type,action){this.data=data,this.type=void 0!==type?type:UpdateType.CONTENT,this.action=void 0!==action?action:UpdateAction.UPDATE};module.exports={Type:UpdateType,Update:Update}},{}],277:[function(require,module,exports){function remove(arr,e){var i=arr.indexOf(e);if(i>-1)return arr.splice(i,1),!0;return!1}function fill(array,value,start,end){start=start||0,end=end||array.length;for(var i=start;i<end;++i)array[i]=value}function ofSize(size,initialValue){var a=[];return a.length=size,void 0!==initialValue&&fill(a,initialValue),a}function argumentsToArray(args){return s.call(args,0)}var s=Array.prototype.slice;module.exports={fill:fill,ofSize:ofSize,remove:remove,argumentsToArray:argumentsToArray}},{}],278:[function(require,module,exports){function FSM(initial,states){var emitter=Emitter.assign(this),current=states[initial];this.state=initial,this.change=function(state){if(this.state===state)return!0;if(states[state]&&("*"===current||current.indexOf(state)>-1))return emitter.emit("change",this.state,state),current=states[state],this.state=state,!0;return!1}}var Emitter=require("events/emitter");module.exports={create:function(initial,states){return new FSM(initial,states)}}},{"events/emitter":103}],279:[function(require,module,exports){function curry(){var args=a2a(arguments),fn=args.shift();return function(){return callWithArguments(fn,args.concat(a2a(arguments)))}}function curryR(){var args=a2a(arguments),fn=args.shift();return function(){return callWithArguments(fn,a2a(arguments).concat(args))}}function callWithArguments(f,args,count){switch(count=void 0===count?args.length:count){case 0:return f();case 1:return f(args[0]);case 2:return f(args[0],args[1]);case 3:return f(args[0],args[1],args[2]);case 4:return f(args[0],args[1],args[2],args[3]);case 5:return f(args[0],args[1],args[2],args[3],args[4]);case 6:return f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return f.apply(f,args)}function newWithArguments(f,args,count){function Proxy(){f.apply(this,args)}switch(count=void 0===count?args.length:count){case 0:return new f;case 1:return new f(args[0]);case 2:return new f(args[0],args[1]);case 3:return new f(args[0],args[1],args[2]);case 4:return new f(args[0],args[1],args[2],args[3]);case 5:return new f(args[0],args[1],args[2],args[3],args[4]);case 6:return new f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return Proxy.prototype=f.prototype,new Proxy}var a2a=require("util/array").argumentsToArray;module.exports={curry:curry,curryR:curryR,callWithArguments:callWithArguments,newWithArguments:newWithArguments}},{"util/array":277}],280:[function(require,module,exports){function interface(){var args=array.argumentsToArray(arguments),name=args.shift(),members=args.pop()||[];args.forEach(function(ex){members=members.concat(ex.members)});var boundMembers=members.map(function(member){return{name:member,check:function(impl){return void 0===impl[member]},throw:function(){throw new Error(name+"#"+member+'" must be implemented')}}}),filter=function(implementation){return boundMembers.filter(function(member){return member.check(implementation)})};return filter.toString=function(){return name},filter.members=members,filter}function implements(){var constructor,args=Array.prototype.slice.call(arguments,0),impl=args.pop(),unsatisfied=[];if(impl instanceof Function)constructor=impl,impl=constructor.prototype;else{constructor=impl.__constructor||function(){};for(var m in constructor.prototype)impl[m]=constructor.prototype[m]}if(args.forEach(function(interface){unsatisfied=unsatisfied.concat(interface(impl))}),constructor.prototype=impl,0===unsatisfied.length)return constructor;var proxy=function(){var instance=functions.newWithArguments(constructor,arguments);return unsatisfied.forEach(function(m){m.check(instance)&&m.throw()}),instance};return proxy.toString=function(){return constructor.toString()},proxy.isPrototypeOf=function(c){return c instanceof constructor},proxy.__constructor=constructor,proxy}var functions=require("util/function"),array=require("util/array");module.exports={interface:interface,implements:implements}},{"util/array":277,"util/function":279}],281:[function(require,module,exports){function d(){return new Date}function log(level,prefix){var c="|"+level.toUpperCase()+"|"+prefix+"|";return function(msg,arg){arg?logger[level](d()+c+msg,arg):logger[level](d()+c+msg)}}function create(classname){var l={};return methods.forEach(function(m){l[m]=log(m,classname)}),l}var logger=require("loglevel"),methods=["trace","debug","info","warn","error"];module.exports={create:create,setLevel:logger.setLevel}},{loglevel:10}],282:[function(require,module,exports){module.exports.approximateSquareRoot=function(value){if(value<0)throw new Error("Value must be greater or equal to 0");if(0===value)return 0;for(var result=1,i=value;i>0;i>>=2)result*=2;return result},module.exports.findNextPowerOfTwo=function(value){if(value<0||value>1<<30)throw new Error("Illegal argument: "+value);return value--,value|=value>>1,value|=value>>2,value|=value>>4,value|=value>>8,value|=value>>16,value++,value}},{}],283:[function(require,module,exports){function defaultCacheKey(args){return args}function memoize(f,cache,matcher){matcher=matcher||defaultCacheKey,cache=cache||{};var c=function(){var args=a2a(arguments),a=matcher(args),r=cache[a];if(r)return r;return r=f.apply(f,args),cache[a]=r,r};return c._uncached=f,c}var a2a=require("./array").argumentsToArray;module.exports=memoize;
},{"./array":277}],284:[function(require,module,exports){function Queue(){var messages=[];this.length=function(){return messages.length},this.add=function(message){messages.push(message)},this.drain=function(){return messages.splice(0,messages.length)},this.isEmpty=function(){return 0===messages.length}}module.exports={create:function(){return new Queue}}},{}],285:[function(require,module,exports){function regex(s,context){if(context=context||"",""===s)throw new Error("Empty regular expression ["+context+"]");try{var r=new RegExp(s);return function(test){var m=r.exec(test);return m&&m[0]===test}}catch(e){throw new Error("Bad regular expression ["+e.message+", "+context+"]")}}module.exports=regex},{}],286:[function(require,module,exports){function requireNonNull(value,what){if("undefined"==typeof value||null===value)throw new Error(what+" is null");return value}module.exports=requireNonNull},{}],287:[function(require,module,exports){function split(str,delim){if(""===str)return[];for(var parts=[],l=delim.length,i=str.lastIndexOf(delim);i>-1;)parts.push(str.substring(i+l,str.length)),str=str.substring(0,i),i=str.lastIndexOf(delim);return parts.push(str),parts.reverse()}module.exports={split:split}},{}],288:[function(require,module,exports){function AliasMap(){var aliases={};this.establish=function(topic){var bang=topic.indexOf("!");if(bang!==-1){if(0===bang)return aliases[topic.substring(1)];var alias=topic.substring(bang+1);return topic=topic.substring(0,bang),aliases[alias]=topic,topic}return topic}}AliasMap.create=function(){return new AliasMap},module.exports=AliasMap},{}],289:[function(require,module,exports){function reason(id,message,canReconnect){return{id:id,message:message,canReconnect:canReconnect}}var CloseReason={CLOSED_BY_CLIENT:reason(0,"The session was closed by the client",!1),CLOSED_BY_SERVER:reason(1,"The session was closed by the server",!1),RECONNECT_ABORTED:reason(2,"Client aborted a reconnect attempt",!1),CONNECTION_TIMEOUT:reason(3,"The connection attempt timed out",!1),HANDSHAKE_REJECTED:reason(4,"The connection handshake was rejected by the server",!1),HANDSHAKE_ERROR:reason(5,"There was an error parsing the handshake response",!1),TRANSPORT_ERROR:reason(6,"There was an unexpected error with the connection",!0),CONNECTION_ERROR:reason(7,"A connection to the server was unable to be established",!0),IDLE_CONNECTION:reason(8,"The activity monitor detected the connection was idle",!0),LOST_MESSAGES:reason(16,"Loss of messages has been detected",!1)};module.exports=CloseReason},{}],290:[function(require,module,exports){var Connection=require("v4-stack/connection");module.exports.create=function(aliases,transports){return new Connection(aliases,transports)}},{"v4-stack/connection":291}],291:[function(require,module,exports){(function(global){function Connection(aliases,transports,reconnectTimeout,recoveryBufferSize){function onData(data){logger.trace("Received message from transport",data);try{var message=Message.parse(data);message.topic&&(message.topic=aliases.establish(message.topic)),self.lastReceivedSequence++,emitter.emit("data",message)}catch(e){logger.warn("Unable to parse message",e),fsm.change("closed")&&(closeReason=CloseReason.CONNECTION_ERROR,transport.close())}}function onClose(reason){fsm.change("disconnected")||fsm.change("closed")?(clearInterval(scheduledRecoveryBufferTrim),clearTimeout(scheduledClose),logger.trace("Transport closed: ",closeReason),"disconnected"===fsm.state?emitter.emit("disconnect",closeReason):emitter.close(closeReason)):logger.debug("Unable to disconnect, current state: ",fsm.state)}function onHandshakeSuccess(response){if(response.response===ResponseCode.RECONNECTED){var messageDelta=lastSentSequence-response.sequence+1;if(!recoveryBuffer.recover(messageDelta,dispatch)){var outboundLoss=lastSentSequence-recoveryBuffer.size()-response.sequence+1;return logger.warn("Unable to reconnect due to lost messages ("+outboundLoss+")"),fsm.change("disconnected")&&(closeReason=CloseReason.LOST_MESSAGES,transport.close()),response}recoveryBuffer.clear(),lastSentSequence=response.sequence-1}return response.success&&fsm.change("connected")?(logger.trace("Connection response: ",response.response),closeReason=CloseReason.TRANSPORT_ERROR,emitter.emit("connect",response)):(logger.debug("Connection response: ",response.response),closeReason=CloseReason.HANDSHAKE_REJECTED,transport.close()),clearTimeout(scheduledClose),response}function onHandshakeError(error){return closeReason=CloseReason.HANDSHAKE_ERROR,clearTimeout(scheduledClose),void logger.trace("Unable to deserialise handshake response",error)}function dispatch(message){var bos=new BufferOutputStream;Message.writeToBuffer(message,bos),lastSentSequence+=1,recoveryBuffer.put(message),recoveryBuffer.markTime(Date.now()),transport.dispatch(bos.getBuffer())}var emitter=Emitter.assign(this),fsm=FSM.create("disconnected",{connecting:["connected","disconnected","closed"],connected:["disconnecting","disconnected","closed"],disconnecting:["disconnected"],disconnected:["connecting","closed"],closed:[]}),lastSentSequence=0;this.lastReceivedSequence=0;var scheduledRecoveryBufferTrim,scheduledClose,closeReason,recoveryBuffer=new RecoveryBuffer(recoveryBufferSize,RECOVERY_BUFFER_INDEX_SIZE),transport=null,self=this;fsm.on("change",function(previous,current){logger.debug("State changed: "+previous+" -> "+current)}),this.connect=function(request,opts,timeout){if("disconnected"!==fsm.state)return void logger.warn("Cannot connect, current state: ",fsm.state);fsm.change("connecting")&&(timeout=void 0===timeout?CONNECT_TIMEOUT:timeout,closeReason=CloseReason.CONNECTION_ERROR,transport=transports.get(opts),transport.on("data",onData),transport.on("close",onClose),transport.connect(request,onHandshakeSuccess,onHandshakeError),scheduledClose=setTimeout(function(){logger.debug("Timed out connection attempt after "+timeout),closeReason=CloseReason.CONNECTION_TIMEOUT,transport.close()},timeout),scheduledRecoveryBufferTrim=setInterval(function(){"connected"===fsm.state&&recoveryBuffer.flush(Date.now()-reconnectTimeout)},reconnectTimeout))},this.resetSequences=function(){recoveryBuffer.clear(),lastSentSequence=0,this.lastReceivedSequence=0},this.getAvailableSequence=function(){return lastSentSequence+1-recoveryBuffer.size()},this.send=function(message){if("connected"===fsm.state)return dispatch(message);return!1},this.close=function(reason){closeReason=reason,fsm.change("disconnecting")&&(dispatch(Message.create(Message.types.CLOSE_REQUEST)),scheduledClose=setTimeout(transport.close,CLOSE_TIMEOUT))},this.closeIdleConnection=function(){fsm.change("disconnecting")&&(logger.debug("Connection detected as idle"),closeReason=CloseReason.IDLE_CONNECTION,transport.close())},this.getState=function(){return fsm.state}}var RecoveryBuffer=require("message-queue/recovery-buffer"),BufferOutputStream=require("io/buffer-output-stream"),ResponseCode=require("protocol/response-code"),CloseReason=require("v4-stack/close-reason"),Message=require("v4-stack/message"),Emitter=require("events/emitter"),logger=require("util/logger").create("Connection"),FSM=(require("util/function").curry,require("util/fsm")),CLOSE_TIMEOUT=global.DIFFUSION_CLOSE_TIMEOUT||1e3,CONNECT_TIMEOUT=global.DIFFUSION_CONNECT_TIMEOUT||1e4,RECOVERY_BUFFER_INDEX_SIZE=global.DIFFUSION_RECOVERY_BUFFER_INDEX_SIZE||8;module.exports=Connection}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"events/emitter":103,"io/buffer-output-stream":124,"message-queue/recovery-buffer":126,"protocol/response-code":138,"util/fsm":278,"util/function":279,"util/logger":281,"v4-stack/close-reason":289,"v4-stack/message":294}],292:[function(require,module,exports){(function(Buffer){function encodeAsString(password){var bos=new BufferOutputStream;return serialiser.write(bos,password),bos.getBase64()}function decodeAsString(s){if(s){var bis=new BufferInputStream(new Buffer(s,"base64"));return serialiser.read(bis)}return null}var BufferOutputStream=require("io/buffer-output-stream"),BufferInputStream=require("io/buffer-input-stream"),serialiser=require("services/authentication/credentials-serialiser");module.exports={encodeAsString:encodeAsString,decodeAsString:decodeAsString}}).call(this,require("buffer").Buffer)},{buffer:2,"io/buffer-input-stream":123,"io/buffer-output-stream":124,"services/authentication/credentials-serialiser":156}],293:[function(require,module,exports){var ConversationId=require("conversation/conversation-id");module.exports={cidFromHeaders:function(headers){if(!headers||0===headers.length)throw new Error("Empty headers, expected at least 1");return ConversationId.fromString(headers[headers.length-1])}}},{"conversation/conversation-id":84}],294:[function(require,module,exports){(function(Buffer){function parseServiceMessage(type,bis){var headers=[],body=bis.readMany(bis.count),fields={};return new Message(type,encoding.NONE,fields,body,headers)}function writeToBuffer(message,bos){bos.write(message.type),bos.writeString(getHeaderString(message)),bos.writeMany(message.getBuffer())}function WriteableMessage(fields){Message.call(this,fields.type,fields.encoding,fields,fields.buffer,fields.headers),BufferOutputStream.call(this,fields.buffer)}function Message(type,encoding,fields,data,headers){this.type=type,this.encoding=encoding;for(var f in fields)this[f]=fields[f];this.data=data,this.headers=headers}var inherits=require("inherits"),BufferOutputStream=require("io/buffer-output-stream"),BufferInputStream=require("io/buffer-input-stream"),systemHeaders={0:[],1:[],2:[],20:["topic"],21:["topic"],22:["topic_set"],23:["topic_set"],24:["timestamp","queue_size"],25:["timestamp"],26:["username","password"],27:["username","password"],28:[],29:[],30:["topic","ack_id"],31:["topic","ack_id"],32:["ack_id"],33:["topic"],34:["topic"],35:["topic","topic_status"],36:["topic","command"],40:["topic","command_topic_category","command_topic_type"],41:["topic","notification_type"]},types={SERVICE_REQUEST:0,SERVICE_RESPONSE:1,SERVICE_ERROR:2,TOPIC_LOAD:20,DELTA:21,SUBSCRIBE:22,UNSUBSCRIBE:23,PING_SERVER:24,PING_CLIENT:25,CREDENTIALS:26,CREDENTIALS_REJECTED:27,ABORT_NOTIFICATION:28,CLOSE_REQUEST:29,TOPIC_LOAD_ACK_REQUIRED:30,DELTA_ACK_REQUIRED:31,ACK:32,FETCH:33,FETCH_REPLY:34,TOPIC_STATUS_NOTIFICATION:35,COMMAND_MESSAGE:36,COMMAND_TOPIC_LOAD:40,COMMAND_TOPIC_NOTIFICATION:41},encoding={NONE:0,ENCRYPTION_REQUESTED:1,COMPRESSION_REQUESTED:2,BASE64_REQUESTED:3,ENCRYPTED:17,COMPRESSED:18,BASE64:19},parse=function(buffer){var bis=new BufferInputStream(buffer),type=bis.read();if(void 0===systemHeaders[type])throw new Error("Invalid message type: "+type);if(type===types.SERVICE_REQUEST||type===types.SERVICE_RESPONSE||type===types.SERVICE_ERROR)return parseServiceMessage(type,bis);var headers=bis.readUntil(1).toString().split(""),body=bis.readMany(bis.count),fields={};return systemHeaders[type]&&systemHeaders[type].forEach(function(key){fields[key]=headers.shift()}),new Message(type,encoding.NONE,fields,body,headers)},create=function(type){var fields;if(void 0===type||"number"==typeof type&&void 0===systemHeaders[type])throw"Invalid message type: "+type;return fields=type instanceof Object?type:{type:type},fields.encoding=fields.encoding||0,fields.headers=fields.headers||[],fields.buffer=fields.buffer||new Buffer(0),new WriteableMessage(fields)},getHeaderString=function(message){var sh=[],headers="";if(systemHeaders[message.type].forEach(function(h){sh.push(message[h])}),message.headers.forEach(function(h){sh.push(h)}),0===systemHeaders[message.type].length)return headers;return sh.length>0&&(headers=sh.join(""),headers+=""),headers};inherits(WriteableMessage,BufferOutputStream),Message.prototype.isTopicMessage=function(){return void 0!==this.topic},Message.prototype.isServiceMessage=function(){return this.type===types.SERVICE_REQUEST||this.type===types.SERVICE_RESPONSE||this.type===types.SERVICE_ERROR},Message.prototype.getInputStream=function(){return new BufferInputStream(this.data)},module.exports={types:types,parse:parse,create:create,encoding:encoding,getHeaderString:getHeaderString,writeToBuffer:writeToBuffer}}).call(this,require("buffer").Buffer)},{buffer:2,inherits:9,"io/buffer-input-stream":123,"io/buffer-output-stream":124}],295:[function(require,module,exports){function Options(options){if(options=options||{},void 0===options.host)options.host=DEFAULT_HOST;else if(options.host.indexOf(":")>-1){var parts=options.host.split(":");void 0===options.port&&(options.port=parseInt(parts[1])),options.host=parts[0]}void 0===options.path?options.path=DEFAULT_PATH:("/"!==options.path[0]&&(options.path="/"+options.path),options.path.substring(options.path.length-DEFAULT_PATH.length)!==DEFAULT_PATH&&("/"===options.path[options.path.length-1]&&(options.path=options.path.substring(0,options.path.length-1)),options.path=options.path+DEFAULT_PATH)),isNaN(parseInt(options.port,10))?options.port=void 0:options.port=parseInt(options.port,10),void 0===options.secure&&(void 0===options.port?options.secure=DEFAULT_SECURE:options.secure=options.port===DEFAULT_SECURE_PORT),void 0===options.port&&(options.port=options.secure?DEFAULT_SECURE_PORT:DEFAULT_PORT),this.host=options.host,this.port=options.port,this.path=options.path,this.secure=options.secure,void 0===options.reconnect||"boolean"==typeof options.reconnect&&options.reconnect?this.reconnect={timeout:DEFAULT_RECONNECT_TIMEOUT,strategy:DEFAULT_RECONNECT_STRATEGY}:"number"==typeof options.reconnect?this.reconnect={timeout:options.reconnect,strategy:DEFAULT_RECONNECT_STRATEGY}:"function"==typeof options.reconnect?this.reconnect={timeout:DEFAULT_RECONNECT_TIMEOUT,strategy:options.reconnect}:"object"==typeof options.reconnect?this.reconnect={timeout:void 0===options.reconnect.timeout?DEFAULT_RECONNECT_TIMEOUT:options.reconnect.timeout,strategy:options.reconnect.strategy||DEFAULT_RECONNECT_STRATEGY}:this.reconnect={timeout:0,strategy:DEFAULT_ABORT_STRATEGY},void 0!==options.principal&&(this.principal=options.principal||DEFAULT_PRINCIPAL,this.credentials=options.credentials||DEFAULT_PASSWORD),"string"==typeof options.transports?this.transports=[options.transports]:"object"==typeof options.transports&&options.transports instanceof Array&&options.transports.length>0?this.transports=options.transports.slice():this.transports=DEFAULT_TRANSPORTS.slice(),this.transports=this.transports.slice().map(function(t){return t.toUpperCase()}),this.activityMonitor=void 0!==options.activityMonitor?options.activityMonitor:DEFAULT_ACTIVITY_MONITOR}var DEFAULT_HOST="localhost",DEFAULT_PORT=80,DEFAULT_SECURE_PORT=443,DEFAULT_SECURE=!0,DEFAULT_PATH="/diffusion";"undefined"!=typeof window&&(window.location.hostname&&(DEFAULT_HOST=window.location.hostname),"http:"===window.location.protocol&&(DEFAULT_SECURE=!1,window.location.port&&(DEFAULT_PORT=parseInt(window.location.port))),"https:"===window.location.protocol&&(DEFAULT_SECURE=!0,window.location.port&&(DEFAULT_SECURE_PORT=parseInt(window.location.port))));var DEFAULT_RECONNECT_TIMEOUT=6e4,DEFAULT_RECONNECT_STRATEGY=function(start){setTimeout(start,5e3)},DEFAULT_ABORT_STRATEGY=function(start,abort){abort()},DEFAULT_PRINCIPAL="",DEFAULT_PASSWORD="",DEFAULT_ACTIVITY_MONITOR=!0,DEFAULT_TRANSPORTS=["WEBSOCKET"];Options.prototype.with=function(options){var k,o={};for(k in this)o[k]=this[k];for(k in options)o[k]=options[k];return new Options(o)},module.exports=Options},{}],296:[function(require,module,exports){function TopicSelector(type,prefix,expression){this.type=type,this.prefix=prefix,this.expression=expression}var util=require("topics/topic-path-utils");TopicSelector.Prefix={PATH:">",SPLIT_PATH_PATTERN:"?",FULL_PATH_PATTERN:"*",SELECTOR_SET:"#"},TopicSelector.Type={PATH:TopicSelector.Prefix.PATH,SPLIT_PATH_PATTERN:TopicSelector.Prefix.SPLIT_PATH_PATTERN,FULL_PATH_PATTERN:TopicSelector.Prefix.FULL_PATH_PATTERN,SELECTOR_SET:TopicSelector.Prefix.SELECTOR_SET},TopicSelector.prototype.selects=function(topicPath){var canonical=util.canonicalise(topicPath);return 0===canonical.indexOf(this.prefix)&&this.doSelects(canonical)},TopicSelector.prototype.toString=function(){return this.expression},module.exports=TopicSelector},{"topics/topic-path-utils":267}],297:[function(require,module,exports){var parser=require("topics/topic-selector-parser"),topicSelectors={parse:function(expression){return parser(expression)}};module.exports=topicSelectors},{"topics/topic-selector-parser":268}],298:[function(require,module,exports){function Session(internalSession,emitter,options){this.sessionID=void 0,this.options=options;var self=this;emitter.assign(self),features.forEach(function(feature){var instance=new feature(internalSession);for(var k in instance)self[k]=instance[k]}),this.close=function(){return internalSession.close(),self},this.isConnected=function(){return internalSession.isConnected()},this.isClosed=function(){var state=internalSession.getState();return"closing"===state||"closed"===state},this.security=new Security(internalSession,this),this.topics=new TopicControl(internalSession,this),this.messages=new Messages(internalSession,this),this.clients=new ClientControl(internalSession,this),this.toString=function(){return"Session<"+self.sessionID+" "+internalSession.getState()+">"}}var Messages=require("features/messages"),Security=require("features/security").Security,TopicControl=require("features/topic-control"),ClientControl=require("features/client-control"),features=[require("features/topics")];module.exports=Session},{"features/client-control":106,"features/messages":107,"features/security":108,"features/topic-control":112,"features/topics":115}],299:[function(require,module,exports){function type(id,stateful,functional){return{id:id,stateful:stateful,functional:functional}}function reason(id,message){return{id:id,message:message}}module.exports.TopicType={STATELESS:type(1,!1,!1),SINGLE_VALUE:type(3,!0,!1),RECORD:type(4,!0,!1),PROTOCOL_BUFFER:type(5,!0,!1),CUSTOM:type(6,!0,!1),SLAVE:type(7,!0,!1),SERVICE:type(8,!1,!0),PAGED_STRING:type(9,!1,!0),PAGED_RECORD:type(10,!1,!0),TOPIC_NOTIFY:type(11,!1,!0),ROUTING:type(12,!1,!0),CHILD_LIST:type(13,!1,!0),BINARY:type(14,!0,!1),JSON:type(15,!0,!1)},module.exports.UnsubscribeReason={SUBSCRIPTION_REFRESH:reason(void 0,"The server has re-subscribed this session"),STREAM_CHANGE:reason(void 0,"A more specific stream has been registered to the same path"),REQUESTED:reason(0,"The unsubscription was requested by this client"),CONTROL:reason(1,"The server or another client unsubscribed this client"),REMOVED:reason(2,"The topic was removed"),AUTHORIZATION:reason(3,"Not authorized to subscribe to this topic")}},{}]},{},[40])(40)});